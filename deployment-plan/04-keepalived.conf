# Keepalived Configuration for PostgreSQL VIP
# Place at /etc/keepalived/keepalived.conf on each node
# This config follows the Patroni leader

# Script to check if this node is Patroni leader
vrrp_script check_patroni {
    script "/usr/local/bin/check_patroni.sh"
    interval 2
    weight 50
    fall 2
    rise 2
}

vrrp_instance POSTGRES_VIP {
    state BACKUP
    interface eth0          # Change to your interface name
    virtual_router_id 51
    priority 100            # Can be same on all nodes (script decides)
    advert_int 1

    authentication {
        auth_type PASS
        auth_pass cold_ha_secret  # Change this password
    }

    virtual_ipaddress {
        192.168.15.200/24   # PostgreSQL VIP
    }

    track_script {
        check_patroni
    }

    # Notify scripts (optional)
    notify_master "/usr/local/bin/notify_master.sh"
    notify_backup "/usr/local/bin/notify_backup.sh"
    notify_fault "/usr/local/bin/notify_fault.sh"
}

---
# Check Patroni Script
# Place at /usr/local/bin/check_patroni.sh
# Make executable: chmod +x /usr/local/bin/check_patroni.sh

#!/bin/bash
# Check if this node is Patroni leader
# Returns 0 (success) if leader, 1 (failure) if not

RESPONSE=$(curl -s http://localhost:8008/leader 2>/dev/null)

if [ $? -eq 0 ]; then
    # Check if response indicates this node is leader
    if echo "$RESPONSE" | grep -q '"role":"master"'; then
        exit 0  # This is the leader
    fi
fi

exit 1  # Not the leader

---
# Notify Master Script
# Place at /usr/local/bin/notify_master.sh

#!/bin/bash
echo "$(date) - Became MASTER for PostgreSQL VIP" >> /var/log/keepalived-notify.log

---
# Notify Backup Script
# Place at /usr/local/bin/notify_backup.sh

#!/bin/bash
echo "$(date) - Became BACKUP for PostgreSQL VIP" >> /var/log/keepalived-notify.log

---
# Notify Fault Script
# Place at /usr/local/bin/notify_fault.sh

#!/bin/bash
echo "$(date) - FAULT state for PostgreSQL VIP" >> /var/log/keepalived-notify.log
