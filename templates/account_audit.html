<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png?v=2">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Trail - Cold Storage</title>
    <link rel="stylesheet" href="/static/css/bootstrap-icons.min.css">
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link href="/static/css/arbitrary.css" rel="stylesheet">
    <link href="/static/css/fonts.css" rel="stylesheet">
    <link href="/static/css/dark-mode.css" rel="stylesheet">
    <link href="/static/css/inventory-theme.css" rel="stylesheet">

    <style>
        * {
            font-family: 'Space Grotesk', sans-serif;
        }
        .neu-border {
            border: 1px solid var(--border-color, #e0e6ed);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-radius: 16px;
            transition: all 0.2s ease;
        }
        .neu-border:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        .neu-input {
            border: 1px solid var(--border-color, #e0e6ed);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            padding: 0.75rem;
            font-size: 1rem;
            border-radius: 8px;
            background-color: #ffffff;
            color: #2c3e50;
        }
        .neu-button {
            border: 1px solid var(--border-color, #e0e6ed);
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .neu-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-charge { background: #fecaca; color: #991b1b; }
        .badge-payment { background: #bbf7d0; color: #166534; }
        .badge-credit { background: #bfdbfe; color: #1e40af; }
        .badge-refund { background: #fef08a; color: #854d0e; }
        .badge-debt { background: #e9d5ff; color: #6b21a8; }
        .badge-online { background: #cffafe; color: #0e7490; }
        #mainContent {
            display: none;
        }
        #loadingScreen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 12px;
            overflow: hidden;
        }
        th, td {
            border-bottom: 1px solid #e0e6ed;
            padding: 0.75rem;
            text-align: left;
        }
        th {
            background: #f8fafb;
            font-weight: 700;
        }
        tr:nth-child(even) {
            background: #fafafa;
        }
        @media (max-width: 1023px) {
            .neu-button { padding: 0.5rem 0.75rem; font-size: 0.875rem; }
            h1 { font-size: 1.5rem !important; }
        }
    </style>
    <script src="/static/js/prefetch.js?v=5"></script>
    <script src="/static/js/theme.js"></script>
</head>
<body class="bg-[#f8fafb] min-h-screen p-4 md:p-8">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="max-w-7xl mx-auto">
        <div class="neu-border bg-white p-6 md:p-8 text-center">
            <i class="bi bi-hourglass-split text-4xl animate-pulse"></i>
            <p class="mt-4">Verifying permissions...</p>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 md:mb-8 neu-border bg-white p-4 md:p-6 gap-4">
            <div>
                <div class="flex items-center gap-3">
                    <i class="bi bi-journal-text text-3xl md:text-4xl text-blue-600"></i>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold">Audit Trail</h1>
                        <p class="text-gray-600 text-sm md:text-base">Complete ledger history of all transactions</p>
                    </div>
                </div>
            </div>
            <div class="flex gap-2 items-center">
                <button onclick="theme.toggle()" class="neu-button bg-gray-100" title="Toggle Dark Mode">
                    <i class="bi bi-moon-fill theme-icon-moon"></i>
                    <i class="bi bi-sun-fill theme-icon-sun hidden"></i>
                </button>
                <button class="neu-button bg-gray-100" onclick="history.back()">
                    <span>Back</span> <i class="bi bi-arrow-right"></i>
                </button>
                <a href="/rent-management" class="neu-button bg-gray-200">
                    <i class="bi bi-arrow-left"></i> Back
                </a>
            </div>
        </header>

        <!-- Summary Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-6 mb-6 md:mb-8">
            <div class="neu-border bg-gradient-to-br from-red-400 to-red-600 text-white p-3 md:p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs md:text-sm opacity-90">Total Charges</p>
                        <p class="text-xl md:text-3xl font-bold mt-1 md:mt-2" id="totalCharges">₹0</p>
                    </div>
                    <i class="bi bi-arrow-up-circle text-3xl md:text-5xl opacity-50"></i>
                </div>
            </div>

            <div class="neu-border bg-gradient-to-br from-green-400 to-green-600 text-white p-3 md:p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs md:text-sm opacity-90">Total Payments</p>
                        <p class="text-xl md:text-3xl font-bold mt-1 md:mt-2" id="totalPayments">₹0</p>
                    </div>
                    <i class="bi bi-arrow-down-circle text-3xl md:text-5xl opacity-50"></i>
                </div>
            </div>

            <div class="neu-border bg-gradient-to-br from-blue-400 to-blue-600 text-white p-3 md:p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs md:text-sm opacity-90">Total Credits</p>
                        <p class="text-xl md:text-3xl font-bold mt-1 md:mt-2" id="totalCredits">₹0</p>
                    </div>
                    <i class="bi bi-gift text-3xl md:text-5xl opacity-50"></i>
                </div>
            </div>

            <div class="neu-border bg-gradient-to-br from-purple-400 to-purple-600 text-white p-3 md:p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs md:text-sm opacity-90">Total Entries</p>
                        <p class="text-xl md:text-3xl font-bold mt-1 md:mt-2" id="totalEntries">0</p>
                    </div>
                    <i class="bi bi-list-ul text-3xl md:text-5xl opacity-50"></i>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="neu-border bg-white p-4 md:p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Customer Phone</label>
                    <input type="text" id="filterPhone" class="w-full neu-input" placeholder="Phone number">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Entry Type</label>
                    <select id="filterType" class="w-full neu-input">
                        <option value="">All Types</option>
                        <option value="CHARGE">Charge</option>
                        <option value="PAYMENT">Payment</option>
                        <option value="CREDIT">Credit</option>
                        <option value="REFUND">Refund</option>
                        <option value="DEBT_APPROVAL">Debt Approval</option>
                        <option value="ONLINE_PAYMENT">Online Payment</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">From Date</label>
                    <input type="date" id="filterStartDate" class="w-full neu-input">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">To Date</label>
                    <input type="date" id="filterEndDate" class="w-full neu-input">
                </div>
                <div class="flex items-end gap-2">
                    <button onclick="loadAuditData()" class="neu-button bg-blue-500 text-white flex-1">
                        <i class="bi bi-search"></i> Search
                    </button>
                    <button onclick="clearFilters()" class="neu-button bg-gray-300">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Audit Table -->
        <div class="neu-border bg-white p-4 md:p-6">
            <div class="table-container">
                <table id="auditTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>S/O</th>
                            <th>Phone</th>
                            <th>Type</th>
                            <th class="text-right">Credit</th>
                            <th class="text-right">Balance</th>
                            <th>By</th>
                            <th>Payment Type</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <tbody id="auditTableBody">
                        <tr>
                            <td colspan="10" class="text-center py-8">
                                <i class="bi bi-hourglass-split text-4xl text-gray-400"></i>
                                <p class="text-gray-600 mt-2">Loading audit data...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="flex justify-between items-center mt-4">
                <p class="text-sm text-gray-600" id="paginationInfo">Showing 0-0 of 0 entries</p>
                <div class="flex gap-2">
                    <button onclick="previousPage()" class="neu-button bg-gray-200" id="prevBtn" disabled>
                        <i class="bi bi-chevron-left"></i> Previous
                    </button>
                    <button onclick="nextPage()" class="neu-button bg-gray-200" id="nextBtn" disabled>
                        Next <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        let currentPage = 0;
        const pageSize = 50;
        let totalEntries = 0;

        // Decode JWT to get user info
        function decodeToken() {
            if (!token) {
                window.location.href = '/login';
                return null;
            }

            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));

                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error('Error decoding token:', error);
                window.location.href = '/login';
                return null;
            }
        }

        // Check admin/accountant permission
        async function checkAdminPermission() {
            const user = decodeToken();
            if (!user) return false;

            if (user.role === 'admin' || user.role === 'accountant' || user.has_accountant_access) {
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                return true;
            }

            alert('Access denied. Admin or Accountant access required.');
            window.location.href = '/dashboard';
            return false;
        }

        // Load audit data
        async function loadAuditData() {
            const phone = document.getElementById('filterPhone').value.trim();
            const entryType = document.getElementById('filterType').value;
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;

            let url = `/api/ledger/audit?limit=${pageSize}&offset=${currentPage * pageSize}`;
            if (phone) url += `&phone=${encodeURIComponent(phone)}`;
            if (entryType) url += `&type=${encodeURIComponent(entryType)}`;
            if (startDate) url += `&start_date=${encodeURIComponent(startDate)}`;
            if (endDate) url += `&end_date=${encodeURIComponent(endDate)}`;

            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }
                    if (response.status === 403) {
                        alert('Access denied. Admin access required.');
                        window.location.href = '/dashboard';
                        return;
                    }
                    throw new Error('Failed to load audit data');
                }

                const entries = await response.json();
                renderAuditTable(entries || []);
                updateSummary(entries || []);

            } catch (error) {
                console.error('Error loading audit data:', error);
                document.getElementById('auditTableBody').innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center py-8 text-red-500">
                            <i class="bi bi-exclamation-triangle text-4xl"></i>
                            <p class="mt-2">Error loading audit data</p>
                        </td>
                    </tr>
                `;
            }
        }

        // Render audit table
        function renderAuditTable(entries) {
            const tbody = document.getElementById('auditTableBody');

            if (!entries || entries.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center py-8">
                            <i class="bi bi-inbox text-4xl text-gray-400"></i>
                            <p class="text-gray-600 mt-2">No entries found</p>
                        </td>
                    </tr>
                `;
                updatePagination(0);
                return;
            }

            tbody.innerHTML = entries.map(entry => `
                <tr>
                    <td class="whitespace-nowrap">${formatDate(entry.date)}</td>
                    <td>${escapeHtml(entry.customer_name)}</td>
                    <td>${escapeHtml(entry.customer_so || '-')}</td>
                    <td>${escapeHtml(entry.customer_phone)}</td>
                    <td><span class="badge ${getBadgeClass(entry.entry_type)}">${entry.entry_type}</span></td>
                    <td class="text-right ${entry.credit > 0 ? 'text-green-600 font-semibold' : ''}">${entry.credit > 0 ? '₹' + formatNumber(entry.credit) : '-'}</td>
                    <td class="text-right font-semibold ${entry.running_balance > 0 ? 'text-red-600' : 'text-green-600'}">₹${formatNumber(entry.running_balance)}</td>
                    <td class="whitespace-nowrap">${escapeHtml(entry.created_by_name || '-')}</td>
                    <td>${getPaymentTypeBadge(entry.payment_type)}</td>
                    <td class="text-sm">${escapeHtml(entry.remarks || '-')}</td>
                </tr>
            `).join('');

            updatePagination(entries.length);
        }

        function getPaymentTypeBadge(type) {
            if (!type) return '-';
            if (type === 'Cash') {
                return '<span class="badge badge-payment">Cash</span>';
            } else if (type === 'Online') {
                return '<span class="badge badge-online">Online</span>';
            }
            return escapeHtml(type);
        }

        // Update summary cards
        function updateSummary(entries) {
            let totalCharges = 0, totalPayments = 0, totalCredits = 0;

            entries.forEach(entry => {
                if (entry.entry_type === 'CHARGE') totalCharges += entry.debit;
                if (entry.entry_type === 'PAYMENT') totalPayments += entry.credit;
                if (entry.entry_type === 'CREDIT') totalCredits += entry.credit;
            });

            document.getElementById('totalCharges').textContent = '₹' + formatNumber(totalCharges);
            document.getElementById('totalPayments').textContent = '₹' + formatNumber(totalPayments);
            document.getElementById('totalCredits').textContent = '₹' + formatNumber(totalCredits);
            document.getElementById('totalEntries').textContent = entries.length;
        }

        // Update pagination info
        function updatePagination(count) {
            const start = currentPage * pageSize + 1;
            const end = currentPage * pageSize + count;
            document.getElementById('paginationInfo').textContent = `Showing ${count > 0 ? start : 0}-${end} entries`;

            document.getElementById('prevBtn').disabled = currentPage === 0;
            document.getElementById('nextBtn').disabled = count < pageSize;
        }

        function previousPage() {
            if (currentPage > 0) {
                currentPage--;
                loadAuditData();
            }
        }

        function nextPage() {
            currentPage++;
            loadAuditData();
        }

        function clearFilters() {
            document.getElementById('filterPhone').value = '';
            document.getElementById('filterType').value = '';
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            currentPage = 0;
            loadAuditData();
        }

        // Helper functions
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' }) +
                   ' ' + date.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
        }

        function formatNumber(num) {
            return num.toLocaleString('en-IN', { maximumFractionDigits: 2 });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getBadgeClass(type) {
            const classes = {
                'CHARGE': 'badge-charge',
                'PAYMENT': 'badge-payment',
                'CREDIT': 'badge-credit',
                'REFUND': 'badge-refund',
                'DEBT_APPROVAL': 'badge-debt',
                'ONLINE_PAYMENT': 'badge-online'
            };
            return classes[type] || '';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            if (await checkAdminPermission()) {
                loadAuditData();
            }
        });
    </script>
</body>
</html>
