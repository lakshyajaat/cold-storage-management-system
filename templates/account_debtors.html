<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png?v=2">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debtors List - Cold Storage</title>
    <link rel="stylesheet" href="/static/css/bootstrap-icons.min.css">
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link href="/static/css/arbitrary.css" rel="stylesheet">
    <link href="/static/css/fonts.css" rel="stylesheet">
    <link href="/static/css/dark-mode.css" rel="stylesheet">
    <link href="/static/css/inventory-theme.css" rel="stylesheet">

    <style>
        * {
            font-family: 'Space Grotesk', sans-serif;
        }
        .neu-border {
            border: 1px solid var(--border-color, #e0e6ed);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-radius: 16px;
            transition: all 0.2s ease;
        }
        .neu-border:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        .neu-input {
            border: 1px solid var(--border-color, #e0e6ed);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            padding: 0.75rem;
            font-size: 1rem;
            border-radius: 8px;
            background-color: #ffffff;
            color: #2c3e50;
        }
        .neu-button {
            border: 1px solid var(--border-color, #e0e6ed);
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .neu-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .debtor-card {
            border: 1px solid var(--border-color, #e0e6ed);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 1rem;
            background: white;
            border-radius: 12px;
        }
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-pending { background: #fef08a; color: #854d0e; }
        .badge-approved { background: #bbf7d0; color: #166534; }
        .badge-rejected { background: #fecaca; color: #991b1b; }
        #mainContent {
            display: none;
        }
        #loadingScreen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        @media (max-width: 1023px) {
            .neu-button { padding: 0.5rem 0.75rem; font-size: 0.875rem; }
            h1 { font-size: 1.5rem !important; }
        }
    </style>
    <script src="/static/js/prefetch.js?v=5"></script>
    <script src="/static/js/theme.js"></script>
</head>
<body class="bg-[#f8fafb] min-h-screen p-4 md:p-8">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="max-w-7xl mx-auto">
        <div class="neu-border bg-white p-6 md:p-8 text-center">
            <i class="bi bi-hourglass-split text-4xl animate-pulse"></i>
            <p class="mt-4">Verifying permissions...</p>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 md:mb-8 neu-border bg-white p-4 md:p-6 gap-4">
            <div>
                <div class="flex items-center gap-3">
                    <i class="bi bi-exclamation-triangle text-3xl md:text-4xl text-red-600"></i>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold">Debtors List</h1>
                        <p class="text-gray-600 text-sm md:text-base">Customers with outstanding balances</p>
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="theme.toggle()" class="neu-button bg-gray-200" title="Toggle Dark Mode">
                    <i class="bi bi-moon-fill theme-icon-moon"></i>
                    <i class="bi bi-sun-fill theme-icon-sun hidden"></i>
                </button>
                <a href="/rent-management" class="neu-button bg-gray-200">
                    <i class="bi bi-arrow-left"></i> Back
                </a>
            </div>
        </header>

        <!-- Summary Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-6 mb-6 md:mb-8">
            <div class="neu-border bg-gradient-to-br from-red-400 to-red-600 text-white p-3 md:p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs md:text-sm opacity-90">Total Outstanding</p>
                        <p class="text-xl md:text-3xl font-bold mt-1 md:mt-2" id="totalOutstanding">‚Çπ0</p>
                    </div>
                    <i class="bi bi-cash-stack text-3xl md:text-5xl opacity-50"></i>
                </div>
            </div>

            <div class="neu-border bg-gradient-to-br from-yellow-400 to-yellow-600 text-white p-3 md:p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs md:text-sm opacity-90">Total Debtors</p>
                        <p class="text-xl md:text-3xl font-bold mt-1 md:mt-2" id="totalDebtors">0</p>
                    </div>
                    <i class="bi bi-people text-3xl md:text-5xl opacity-50"></i>
                </div>
            </div>

            <div class="neu-border bg-gradient-to-br from-orange-400 to-orange-600 text-white p-3 md:p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs md:text-sm opacity-90">Pending Requests</p>
                        <p class="text-xl md:text-3xl font-bold mt-1 md:mt-2" id="pendingRequests">0</p>
                    </div>
                    <i class="bi bi-hourglass-split text-3xl md:text-5xl opacity-50"></i>
                </div>
            </div>

            <div class="neu-border bg-gradient-to-br from-blue-400 to-blue-600 text-white p-3 md:p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs md:text-sm opacity-90">Avg Balance</p>
                        <p class="text-xl md:text-3xl font-bold mt-1 md:mt-2" id="avgBalance">‚Çπ0</p>
                    </div>
                    <i class="bi bi-calculator text-3xl md:text-5xl opacity-50"></i>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex flex-wrap gap-2 mb-6">
            <button onclick="showTab('debtors')" class="neu-button bg-blue-500 text-white" id="tabDebtors">
                <i class="bi bi-people"></i> Debtors List
            </button>
            <button onclick="showTab('creditOut')" class="neu-button bg-gray-200" id="tabCreditOut">
                <i class="bi bi-box-arrow-right"></i> Items Out on Credit (<span id="creditOutCount">0</span>)
            </button>
            <button onclick="showTab('requests')" class="neu-button bg-gray-200" id="tabRequests">
                <i class="bi bi-hourglass-split"></i> Pending Requests
            </button>
            <button onclick="showTab('allRequests')" class="neu-button bg-gray-200" id="tabAllRequests">
                <i class="bi bi-list-check"></i> All Requests
            </button>
        </div>

        <!-- Search -->
        <div class="neu-border bg-white p-4 mb-6">
            <div class="flex gap-4">
                <input type="text" id="searchInput" class="flex-1 neu-input" placeholder="Search by name or phone..." oninput="filterResults()">
                <button onclick="loadData()" class="neu-button bg-blue-500 text-white">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Debtors List -->
        <div id="debtorsContainer">
            <div class="text-center py-12">
                <i class="bi bi-hourglass-split text-6xl text-gray-400"></i>
                <p class="text-gray-600 mt-4">Loading debtors...</p>
            </div>
        </div>

        <!-- Items Out on Credit (via Admin Approval) -->
        <div id="creditOutContainer" class="hidden">
            <div class="text-center py-12">
                <i class="bi bi-hourglass-split text-6xl text-gray-400"></i>
                <p class="text-gray-600 mt-4">Loading credit items...</p>
            </div>
        </div>

        <!-- Pending Requests -->
        <div id="requestsContainer" class="hidden">
            <div class="text-center py-12">
                <i class="bi bi-hourglass-split text-6xl text-gray-400"></i>
                <p class="text-gray-600 mt-4">Loading pending requests...</p>
            </div>
        </div>

        <!-- All Requests (with status) -->
        <div id="allRequestsContainer" class="hidden">
            <div class="text-center py-12">
                <i class="bi bi-hourglass-split text-6xl text-gray-400"></i>
                <p class="text-gray-600 mt-4">Loading all requests...</p>
            </div>
        </div>
    </div>

    <!-- Approve/Reject Modal -->
    <div id="actionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white neu-border p-6 max-w-md w-full">
            <h3 class="text-xl font-bold mb-4" id="modalTitle">Debt Request</h3>
            <div class="space-y-3 mb-6" id="modalContent"></div>
            <div id="rejectReasonContainer" class="hidden mb-4">
                <label class="block text-sm font-semibold mb-2">Rejection Reason *</label>
                <textarea id="rejectReason" class="w-full neu-input" rows="3" placeholder="Enter reason for rejection"></textarea>
            </div>
            <div class="flex gap-4">
                <button onclick="approveRequest()" id="approveBtn" class="flex-1 neu-button bg-green-500 text-white">
                    <i class="bi bi-check-circle"></i> Approve
                </button>
                <button onclick="showRejectForm()" id="rejectBtn" class="flex-1 neu-button bg-red-500 text-white">
                    <i class="bi bi-x-circle"></i> Reject
                </button>
                <button onclick="closeModal()" class="flex-1 neu-button bg-gray-300">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        let allDebtors = [];
        let allRequests = []; // Pending requests
        let allHistoryRequests = []; // All requests (pending, approved, rejected)
        let creditOutItems = []; // Items taken out via admin approval (used debt requests)
        let rentPerItem = 160; // Default, will be updated from accounts summary
        let currentRequestId = null;
        let currentTab = 'debtors';

        // Decode JWT
        function decodeToken() {
            if (!token) {
                window.location.href = '/login';
                return null;
            }
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error('Error decoding token:', error);
                window.location.href = '/login';
                return null;
            }
        }

        // Check admin permission
        async function checkAdminPermission() {
            const user = decodeToken();
            if (!user) return false;

            if (user.role === 'admin') {
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                return true;
            }

            alert('Access denied. Admin access required.');
            window.location.href = '/dashboard';
            return false;
        }

        // Load all data
        async function loadData() {
            await Promise.all([loadDebtors(), loadPendingRequests(), loadAllRequests(), loadCreditOut()]);
        }

        // Load debtors from accounts summary (rent system balances)
        async function loadDebtors() {
            try {
                const response = await fetch('/api/accounts/summary', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    if (response.status === 401) window.location.href = '/login';
                    throw new Error('Failed to load debtors');
                }

                const summary = await response.json();
                // Update rent per item from summary
                if (summary.rent_per_item) {
                    rentPerItem = summary.rent_per_item;
                }
                // Filter customers with positive balance (owe money) and transform to expected format
                allDebtors = (summary.customers || [])
                    .filter(c => c.balance > 0)
                    .map(c => ({
                        customer_name: c.name,
                        customer_phone: c.phone,
                        customer_so: c.so || '',
                        current_balance: c.balance,
                        entry_count: c.thocks ? c.thocks.length : 0
                    }))
                    .sort((a, b) => b.current_balance - a.current_balance);

                renderDebtors(allDebtors);
                updateSummary();

            } catch (error) {
                console.error('Error loading debtors:', error);
                document.getElementById('debtorsContainer').innerHTML = `
                    <div class="neu-border bg-white p-8 text-center text-red-500">
                        <i class="bi bi-exclamation-triangle text-4xl"></i>
                        <p class="mt-2">Error loading debtors</p>
                    </div>
                `;
            }
        }

        // Load pending debt requests
        async function loadPendingRequests() {
            try {
                const response = await fetch('/api/debt-requests/pending', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    if (response.status === 401) window.location.href = '/login';
                    throw new Error('Failed to load requests');
                }

                const data = await response.json();
                allRequests = data.requests || [];
                renderRequests(allRequests);
                document.getElementById('pendingRequests').textContent = allRequests.length;

            } catch (error) {
                console.error('Error loading requests:', error);
                document.getElementById('requestsContainer').innerHTML = `
                    <div class="neu-border bg-white p-8 text-center text-red-500">
                        <i class="bi bi-exclamation-triangle text-4xl"></i>
                        <p class="mt-2">Error loading requests</p>
                    </div>
                `;
            }
        }

        // Load all debt requests (pending, approved, rejected)
        async function loadAllRequests() {
            try {
                const response = await fetch('/api/debt-requests', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    if (response.status === 401) window.location.href = '/login';
                    throw new Error('Failed to load all requests');
                }

                allHistoryRequests = await response.json() || [];
                renderAllRequests(allHistoryRequests);

            } catch (error) {
                console.error('Error loading all requests:', error);
                document.getElementById('allRequestsContainer').innerHTML = `
                    <div class="neu-border bg-white p-8 text-center text-red-500">
                        <i class="bi bi-exclamation-triangle text-4xl"></i>
                        <p class="mt-2">Error loading requests history</p>
                    </div>
                `;
            }
        }

        // Load items taken out via admin approval (used debt requests)
        async function loadCreditOut() {
            try {
                const response = await fetch('/api/debt-requests', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    if (response.status === 401) window.location.href = '/login';
                    throw new Error('Failed to load credit items');
                }

                const allReqs = await response.json() || [];
                // Filter for ONLY used requests (items actually taken out on credit)
                // 'approved' means approved but not yet picked up
                // 'used' means items were actually taken out
                creditOutItems = allReqs.filter(r => r.status === 'used');
                renderCreditOut(creditOutItems);
                document.getElementById('creditOutCount').textContent = creditOutItems.length;

            } catch (error) {
                console.error('Error loading credit out items:', error);
                document.getElementById('creditOutContainer').innerHTML = `
                    <div class="neu-border bg-white p-8 text-center text-red-500">
                        <i class="bi bi-exclamation-triangle text-4xl"></i>
                        <p class="mt-2">Error loading credit items</p>
                    </div>
                `;
            }
        }

        // Render items taken out on credit
        function renderCreditOut(items) {
            const container = document.getElementById('creditOutContainer');

            if (!items || items.length === 0) {
                container.innerHTML = `
                    <div class="neu-border bg-white p-8 text-center">
                        <i class="bi bi-check-circle text-6xl text-green-500"></i>
                        <p class="text-gray-600 mt-4">No items taken out on credit</p>
                    </div>
                `;
                return;
            }

            // Calculate total items and credit value (items √ó rent per item)
            const totalItems = items.reduce((sum, r) => sum + (r.requested_quantity || 0), 0);
            const totalCreditValue = totalItems * rentPerItem;

            container.innerHTML = `
                <div class="neu-border bg-orange-100 p-4 mb-4">
                    <div class="flex flex-wrap gap-6">
                        <div>
                            <p class="text-sm text-orange-700">Total Items Out on Credit</p>
                            <p class="text-2xl font-bold text-orange-800">${totalItems} items</p>
                        </div>
                        <div>
                            <p class="text-sm text-orange-700">Total Credit Value</p>
                            <p class="text-2xl font-bold text-red-600">‚Çπ${formatNumber(totalCreditValue)}</p>
                        </div>
                    </div>
                </div>
                ${items.map(item => {
                    const itemCreditValue = (item.requested_quantity || 0) * rentPerItem;
                    return `
                    <div class="debtor-card p-4 border-l-4 border-red-500">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div class="flex-1">
                                <h3 class="text-lg font-bold">${escapeHtml(item.customer_name)}</h3>
                                <p class="text-sm text-gray-600">${item.customer_so ? 'S/O ' + escapeHtml(item.customer_so) : ''}</p>
                                <p class="text-sm text-gray-500">
                                    <i class="bi bi-telephone"></i> ${escapeHtml(item.customer_phone)}
                                    | <i class="bi bi-truck"></i> ${escapeHtml(item.thock_number)}
                                </p>
                                <p class="text-sm text-gray-500">
                                    Approved by: ${escapeHtml(item.approved_by_name || '-')} | ${formatDate(item.approved_at)}
                                </p>
                            </div>
                            <div class="text-center">
                                <p class="text-3xl font-bold text-orange-600">${item.requested_quantity}</p>
                                <p class="text-sm text-gray-500">items</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xl font-bold text-red-600">‚Çπ${formatNumber(itemCreditValue)}</p>
                                <p class="text-sm text-gray-500">credit value</p>
                                <span class="badge bg-red-200 text-red-800">üì¶ TAKEN OUT</span>
                            </div>
                            <div class="flex gap-2">
                                <a href="/rent-management?phone=${encodeURIComponent(item.customer_phone)}" class="neu-button bg-blue-500 text-white text-sm">
                                    <i class="bi bi-cash-stack"></i> Collect
                                </a>
                            </div>
                        </div>
                    </div>
                `}).join('')}
            `;
        }

        // Render all requests with status
        function renderAllRequests(requests) {
            const container = document.getElementById('allRequestsContainer');

            if (!requests || requests.length === 0) {
                container.innerHTML = `
                    <div class="neu-border bg-white p-8 text-center">
                        <i class="bi bi-inbox text-6xl text-gray-400"></i>
                        <p class="text-gray-600 mt-4">No debt requests found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = requests.map(req => {
                let statusBadge = '';
                let statusColor = '';
                if (req.status === 'pending') {
                    statusBadge = '<span class="badge badge-pending">‚è≥ Pending</span>';
                    statusColor = 'border-l-4 border-yellow-500';
                } else if (req.status === 'approved') {
                    statusBadge = '<span class="badge badge-approved">‚úÖ Approved</span>';
                    statusColor = 'border-l-4 border-green-500';
                } else if (req.status === 'rejected') {
                    statusBadge = '<span class="badge badge-rejected">‚ùå Rejected</span>';
                    statusColor = 'border-l-4 border-red-500';
                }

                return `
                <div class="debtor-card p-4 ${statusColor}">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div class="flex-1">
                            <h3 class="text-lg font-bold">${escapeHtml(req.customer_name)}</h3>
                            <p class="text-sm text-gray-600">${req.customer_so ? 'S/O ' + escapeHtml(req.customer_so) : ''}</p>
                            <p class="text-sm text-gray-500">
                                <i class="bi bi-telephone"></i> ${escapeHtml(req.customer_phone)}
                                | <i class="bi bi-truck"></i> ${escapeHtml(req.thock_number)}
                            </p>
                            <p class="text-sm text-gray-500">
                                Requested by: ${escapeHtml(req.requested_by_name)} | ${formatDate(req.created_at)}
                            </p>
                            ${req.status === 'rejected' && req.rejection_reason ? `<p class="text-sm text-red-600 mt-1"><i class="bi bi-info-circle"></i> Reason: ${escapeHtml(req.rejection_reason)}</p>` : ''}
                            ${req.status === 'approved' ? `<p class="text-sm text-green-600 mt-1"><i class="bi bi-check-circle"></i> Approved by: ${escapeHtml(req.approved_by_name || 'Admin')} on ${formatDate(req.updated_at)}</p>` : ''}
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold">Qty: ${req.requested_quantity}</p>
                            <p class="text-lg font-bold text-red-600">Balance: ‚Çπ${formatNumber(req.current_balance)}</p>
                            ${statusBadge}
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // Render debtors
        function renderDebtors(debtors) {
            const container = document.getElementById('debtorsContainer');

            if (!debtors || debtors.length === 0) {
                container.innerHTML = `
                    <div class="neu-border bg-white p-8 text-center">
                        <i class="bi bi-check-circle text-6xl text-green-500"></i>
                        <p class="text-gray-600 mt-4">No outstanding balances!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = debtors.map(debtor => `
                <div class="debtor-card p-4">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div class="flex-1">
                            <h3 class="text-lg font-bold">${escapeHtml(debtor.customer_name)}</h3>
                            <p class="text-sm text-gray-600">${debtor.customer_so ? 'S/O ' + escapeHtml(debtor.customer_so) : ''}</p>
                            <p class="text-sm text-gray-500"><i class="bi bi-telephone"></i> ${escapeHtml(debtor.customer_phone)}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-red-600">‚Çπ${formatNumber(debtor.current_balance)}</p>
                            <p class="text-sm text-gray-500">${debtor.entry_count} transactions</p>
                        </div>
                        <div class="flex gap-2">
                            <a href="/rent-management?phone=${encodeURIComponent(debtor.customer_phone)}" class="neu-button bg-blue-500 text-white text-sm">
                                <i class="bi bi-eye"></i> View
                            </a>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Render pending requests
        function renderRequests(requests) {
            const container = document.getElementById('requestsContainer');

            if (!requests || requests.length === 0) {
                container.innerHTML = `
                    <div class="neu-border bg-white p-8 text-center">
                        <i class="bi bi-inbox text-6xl text-gray-400"></i>
                        <p class="text-gray-600 mt-4">No pending debt requests</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = requests.map(req => `
                <div class="debtor-card p-4">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div class="flex-1">
                            <h3 class="text-lg font-bold">${escapeHtml(req.customer_name)}</h3>
                            <p class="text-sm text-gray-600">${req.customer_so ? 'S/O ' + escapeHtml(req.customer_so) : ''}</p>
                            <p class="text-sm text-gray-500">
                                <i class="bi bi-telephone"></i> ${escapeHtml(req.customer_phone)}
                                | <i class="bi bi-truck"></i> ${escapeHtml(req.thock_number)}
                            </p>
                            <p class="text-sm text-gray-500">
                                Requested by: ${escapeHtml(req.requested_by_name)} | ${formatDate(req.created_at)}
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold">Qty: ${req.requested_quantity}</p>
                            <p class="text-lg font-bold text-red-600">Balance: ‚Çπ${formatNumber(req.current_balance)}</p>
                            <span class="badge badge-pending">Pending</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openActionModal(${req.id})" class="neu-button bg-green-500 text-white text-sm">
                                <i class="bi bi-check-circle"></i> Review
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Update summary
        function updateSummary() {
            const totalOutstanding = allDebtors.reduce((sum, d) => sum + d.current_balance, 0);
            const avgBalance = allDebtors.length > 0 ? totalOutstanding / allDebtors.length : 0;

            document.getElementById('totalOutstanding').textContent = '‚Çπ' + formatNumber(totalOutstanding);
            document.getElementById('totalDebtors').textContent = allDebtors.length;
            document.getElementById('avgBalance').textContent = '‚Çπ' + formatNumber(avgBalance);
        }

        // Tab switching
        function showTab(tab) {
            currentTab = tab;
            document.getElementById('debtorsContainer').classList.toggle('hidden', tab !== 'debtors');
            document.getElementById('creditOutContainer').classList.toggle('hidden', tab !== 'creditOut');
            document.getElementById('requestsContainer').classList.toggle('hidden', tab !== 'requests');
            document.getElementById('allRequestsContainer').classList.toggle('hidden', tab !== 'allRequests');

            document.getElementById('tabDebtors').classList.toggle('bg-blue-500', tab === 'debtors');
            document.getElementById('tabDebtors').classList.toggle('text-white', tab === 'debtors');
            document.getElementById('tabDebtors').classList.toggle('bg-gray-200', tab !== 'debtors');

            document.getElementById('tabCreditOut').classList.toggle('bg-orange-500', tab === 'creditOut');
            document.getElementById('tabCreditOut').classList.toggle('text-white', tab === 'creditOut');
            document.getElementById('tabCreditOut').classList.toggle('bg-gray-200', tab !== 'creditOut');

            document.getElementById('tabRequests').classList.toggle('bg-blue-500', tab === 'requests');
            document.getElementById('tabRequests').classList.toggle('text-white', tab === 'requests');
            document.getElementById('tabRequests').classList.toggle('bg-gray-200', tab !== 'requests');

            document.getElementById('tabAllRequests').classList.toggle('bg-blue-500', tab === 'allRequests');
            document.getElementById('tabAllRequests').classList.toggle('text-white', tab === 'allRequests');
            document.getElementById('tabAllRequests').classList.toggle('bg-gray-200', tab !== 'allRequests');
        }

        // Filter results
        function filterResults() {
            const search = document.getElementById('searchInput').value.toLowerCase();

            if (currentTab === 'debtors') {
                const filtered = allDebtors.filter(d =>
                    d.customer_name.toLowerCase().includes(search) ||
                    d.customer_phone.includes(search)
                );
                renderDebtors(filtered);
            } else if (currentTab === 'creditOut') {
                const filtered = creditOutItems.filter(r =>
                    r.customer_name.toLowerCase().includes(search) ||
                    r.customer_phone.includes(search) ||
                    r.thock_number.toLowerCase().includes(search)
                );
                renderCreditOut(filtered);
            } else if (currentTab === 'requests') {
                const filtered = allRequests.filter(r =>
                    r.customer_name.toLowerCase().includes(search) ||
                    r.customer_phone.includes(search) ||
                    r.thock_number.toLowerCase().includes(search)
                );
                renderRequests(filtered);
            } else if (currentTab === 'allRequests') {
                const filtered = allHistoryRequests.filter(r =>
                    r.customer_name.toLowerCase().includes(search) ||
                    r.customer_phone.includes(search) ||
                    r.thock_number.toLowerCase().includes(search)
                );
                renderAllRequests(filtered);
            }
        }

        // Action modal
        function openActionModal(requestId) {
            currentRequestId = requestId;
            const request = allRequests.find(r => r.id === requestId);
            if (!request) return;

            document.getElementById('modalTitle').textContent = 'Debt Request #' + requestId;
            document.getElementById('modalContent').innerHTML = `
                <p><strong>Customer:</strong> ${escapeHtml(request.customer_name)}</p>
                <p><strong>S/O:</strong> ${escapeHtml(request.customer_so || '-')}</p>
                <p><strong>Phone:</strong> ${escapeHtml(request.customer_phone)}</p>
                <p><strong>Thock:</strong> ${escapeHtml(request.thock_number)}</p>
                <p><strong>Requested Qty:</strong> ${request.requested_quantity}</p>
                <p><strong>Current Balance:</strong> <span class="text-red-600 font-bold">‚Çπ${formatNumber(request.current_balance)}</span></p>
                <p><strong>Requested By:</strong> ${escapeHtml(request.requested_by_name)}</p>
                <p><strong>Requested At:</strong> ${formatDate(request.created_at)}</p>
            `;
            document.getElementById('rejectReasonContainer').classList.add('hidden');
            document.getElementById('approveBtn').classList.remove('hidden');
            document.getElementById('rejectBtn').classList.remove('hidden');
            document.getElementById('actionModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('actionModal').classList.add('hidden');
            currentRequestId = null;
        }

        function showRejectForm() {
            document.getElementById('rejectReasonContainer').classList.remove('hidden');
            document.getElementById('approveBtn').classList.add('hidden');
            document.getElementById('rejectBtn').innerHTML = '<i class="bi bi-x-circle"></i> Confirm Reject';
            document.getElementById('rejectBtn').onclick = rejectRequest;
        }

        async function approveRequest() {
            if (!currentRequestId) return;

            const request = allRequests.find(r => r.id === currentRequestId);
            if (!request) return;

            try {
                // First approve the debt request
                const approveResponse = await fetch(`/api/debt-requests/${currentRequestId}/approve`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!approveResponse.ok) {
                    const error = await approveResponse.text();
                    throw new Error(error);
                }

                // Get customer ID from phone number
                const customerResponse = await fetch(`/api/customers/search?phone=${encodeURIComponent(request.customer_phone)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!customerResponse.ok) {
                    alert('Debt request approved! Note: Could not find customer - employee can create gate pass manually.');
                    closeModal();
                    loadData();
                    return;
                }

                const customers = await customerResponse.json();
                const customer = customers.find(c => c.phone === request.customer_phone);

                if (!customer) {
                    alert('Debt request approved! Note: Customer not found - employee can create gate pass manually.');
                    closeModal();
                    loadData();
                    return;
                }

                // Create a gate pass for the approved request
                const gatePassResponse = await fetch('/api/gate-passes', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        customer_id: customer.id,
                        thock_number: request.thock_number,
                        requested_quantity: request.requested_quantity,
                        payment_verified: true,
                        payment_amount: 0,
                        remarks: `Debt Approval #${currentRequestId} | Recipient: ${request.customer_name}`
                    })
                });

                if (!gatePassResponse.ok) {
                    const error = await gatePassResponse.text();
                    console.error('Gate pass creation failed:', error);
                    alert('Debt request approved! Note: Gate pass creation failed - ' + error);
                } else {
                    const gatePass = await gatePassResponse.json();

                    // Mark the debt request as 'used' now that gate pass is created
                    try {
                        await fetch(`/api/debt-requests/${currentRequestId}/use`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                gate_pass_id: gatePass.id
                            })
                        });
                    } catch (err) {
                        console.error('Failed to mark debt as used:', err);
                    }

                    alert(`Debt request approved and Gate Pass #${gatePass.id} created successfully!`);
                }

                closeModal();
                loadData();

            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function rejectRequest() {
            if (!currentRequestId) return;

            const reason = document.getElementById('rejectReason').value.trim();
            if (!reason) {
                alert('Please enter a rejection reason');
                return;
            }

            try {
                const response = await fetch(`/api/debt-requests/${currentRequestId}/reject`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ rejection_reason: reason })
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                alert('Debt request rejected');
                closeModal();
                loadData();

            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Helper functions
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function formatNumber(num) {
            return num.toLocaleString('en-IN', { maximumFractionDigits: 2 });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            if (await checkAdminPermission()) {
                loadData();
            }
        });
    </script>
</body>
</html>
