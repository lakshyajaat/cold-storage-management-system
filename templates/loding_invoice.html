<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§ó‡•Å‡§°‡§º ‡§ï‡•É‡§™‡§æ ‡§ï‡•ã‡§≤‡•ç‡§° ‡§∏‡•ç‡§ü‡•ã‡§∞ - ‡§™‡•ç‡§∞‡§µ‡•á‡§∂ ‡§∞‡§∏‡•Ä‡§¶</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Arial', 'Noto Sans Devanagari', sans-serif;
            padding: 10px;
            background: #f5f5f5;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
        }
        .invoice-wrapper {
            display: flex;
            flex-direction: row;
            gap: 15px;
            justify-content: center;
            align-items: flex-start;
        }
        .invoice {
            background: white;
            border: 3px solid #000;
            padding: 15px;
            flex: 1;
            max-width: 48%;
        }
        .header {
            text-align: center;
            border-bottom: 3px solid #000;
            padding-bottom: 8px;
            margin-bottom: 12px;
        }
        .header h1 {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 3px;
        }
        .header .subtitle {
            font-size: 13px;
            margin: 2px 0;
        }
        .header .mobile {
            font-size: 14px;
            font-weight: bold;
            margin-top: 4px;
        }
        .info-section {
            border: 2px solid #000;
            padding: 10px;
            margin-bottom: 12px;
        }
        .info-section h3 {
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 8px;
            text-align: center;
            background: #000;
            color: white;
            padding: 4px;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 12px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 4px;
        }
        .info-label {
            font-weight: bold;
        }
        .info-value {
            text-align: right;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
            font-size: 11px;
        }
        th, td {
            border: 2px solid #000;
            padding: 5px;
            text-align: center;
        }
        th {
            background: #000;
            color: white;
            font-weight: bold;
        }
        .total-row {
            background: #f0f0f0;
            font-weight: bold;
        }
        .terms {
            border: 2px solid #000;
            padding: 10px;
            margin: 12px 0;
            font-size: 10px;
        }
        .terms h3 {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 6px;
            text-align: center;
        }
        .terms ol {
            margin-left: 15px;
        }
        .terms li {
            margin-bottom: 4px;
            line-height: 1.4;
        }
        .signature-section {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 10px;
            border-top: 2px solid #000;
        }
        .signature-box {
            text-align: center;
            flex: 1;
        }
        .signature-line {
            border-top: 2px solid #000;
            margin-top: 40px;
            padding-top: 5px;
            font-size: 11px;
            font-weight: bold;
        }
        .buttons {
            text-align: center;
            margin: 20px 0;
        }
        .btn {
            background: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: 3px solid #000;
            font-size: 16px;
            cursor: pointer;
            margin: 0 10px;
            font-weight: bold;
            box-shadow: 4px 4px 0 #000;
        }
        .btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #000;
        }
        .btn-secondary {
            background: #666;
        }
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
        }
        @media print {
            @page {
                size: landscape;
                margin: 8mm;
            }
            body {
                background: white;
                padding: 0;
            }
            .buttons {
                display: none;
            }
            .invoice-wrapper {
                gap: 8px;
            }
            .invoice {
                padding: 10px;
                max-width: 49%;
            }
            .header h1 {
                font-size: 18px;
            }
            table, .info-row, .terms {
                font-size: 9px;
            }
        }
    </style>
<script src="/static/js/prefetch.js?v=2"></script>
    <script src="/static/js/theme.js"></script>
</head>
<body>
    <div class="container">
        <div id="loading" class="loading">
            <p>‡§∞‡§∏‡•Ä‡§¶ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...</p>
        </div>

        <div id="invoiceContent" style="display: none;">
            <div class="buttons">
                <button class="btn" onclick="window.print()">
                    üñ®Ô∏è ‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü ‡§ï‡§∞‡•á‡§Ç
                </button>
                <button class="btn btn-secondary" onclick="window.history.back()">
                    ‚Üê ‡§µ‡§æ‡§™‡§∏ ‡§ú‡§æ‡§è‡§Ç
                </button>
            </div>

            <div class="invoice-wrapper">
                <!-- First Copy -->
                <div class="invoice">
                    <div class="header">
                        <h1>‡§ó‡•Å‡§°‡§º ‡§ï‡•É‡§™‡§æ ‡§ï‡•ã‡§≤‡•ç‡§° ‡§∏‡•ç‡§ü‡•ã‡§∞</h1>
                        <div class="subtitle">Gud Kripa Cold Store</div>
                        <div class="subtitle">‡§ï‡•ã‡§≤‡•ç‡§° ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏/‡§ó‡•ã‡§¶‡§æ‡§Æ | Cold Store License/Warehouse</div>
                        <div class="mobile">Mobile: 7505837172</div>
                    </div>

                    <div class="info-section">
                        <h3>‡§Æ‡•Ç‡§≤ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä | Basic Information</h3>
                        <div class="info-row">
                            <span class="info-label">‡§ï‡•ç‡§∞. | Sr. No.:</span>
                            <span class="info-value" id="invoiceNumber1">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ | Customer Name:</span>
                            <span class="info-value" id="customerName1">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">‡§´‡•ã‡§® | Phone:</span>
                            <span class="info-value" id="customerPhone1">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">‡§ó‡•ç‡§∞‡§æ‡§Æ ‡§µ ‡§™‡§§‡§æ | Village & Address:</span>
                            <span class="info-value" id="customerVillage1">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">‡§µ‡§ø‡§ï‡§æ‡§∏‡§ñ‡§£‡•ç‡§° | Development Block:</span>
                            <span class="info-value">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">‡§ú‡§®‡§™‡§¶ | District:</span>
                            <span class="info-value">‡§ú‡§æ‡§≤‡•å‡§® (‡§ï‡§æ‡§≤‡§™‡•Ä) | Jalaun (Kalpi)</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï | Date:</span>
                            <span class="info-value" id="invoiceDate1">-</span>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>‡§ï‡•ç‡§∞.<br>Sr. No.</th>
                                <th>‡§•‡•ã‡§ï ‡§®‡§Ç.<br>Thok No.</th>
                                <th>‡§ï‡•Å‡§≤ ‡§≠‡§∞‡§§‡•Ä ‡§¨‡•ã‡§∞‡•á<br>Total Bags</th>
                                <th>‡§¨‡•ã‡§∞‡•Ä ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ<br>Sold Qty</th>
                                <th>‡§∂‡•á‡§∑ ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ<br>Remaining</th>
                                <th>‡§≠‡§æ‡§°‡§º‡§æ<br>Rent (‚Çπ)</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTable1">
                            <tr>
                                <td colspan="6">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="terms">
                        <h3>‡§®‡§ø‡§Ø‡§Æ ‡§è‡§µ‡§Ç ‡§∂‡§∞‡•ç‡§§‡•á‡§Ç | Terms and Conditions</h3>
                        <ol>
                            <li>‡§Ø‡§¶‡§ø ‡§™‡•ç‡§∞‡§§‡§ø‡§®‡§ø‡§ß‡§ø ‡§ï‡•á ‡§ï‡§ü‡•å‡§§‡•Ä ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§ï‡•ã‡§à ‡§≠‡•Ä ‡§Ü‡§≤‡•Ç ‡§ï‡•Ä ‡§¨‡•Ä‡§Æ‡§æ ‡§¶‡§æ‡§µ‡•á ‡§ï‡§æ ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§ó‡§æ‡•§</li>
                            <li>‡§Ø‡§¶‡§ø ‡§ï‡•ã‡§à ‡§≠‡•Ä ‡§™‡•ç‡§∞‡§æ‡§ï‡•É‡§§‡§ø‡§ï ‡§Ü‡§™‡§¶‡§æ ‡§ï‡•á ‡§ï‡§æ‡§∞‡§£ ‡§Ü‡§≤‡•Ç ‡§ï‡•Ä ‡§ï‡•ç‡§∑‡§§‡§ø ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§ï‡•ã‡§≤‡•ç‡§° ‡§ï‡•Ä ‡§ú‡§ø‡§Æ‡•ç‡§Æ‡•á‡§¶‡§æ‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§ó‡•Ä‡•§</li>
                            <li>‡§Ü‡§≤‡•Ç ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à ‡§ï‡§ü‡•å‡§§‡•Ä ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§ï‡•ã‡§≤‡•ç‡§° ‡§ï‡•Ä ‡§ï‡•ã‡§à ‡§ú‡§ø‡§Æ‡•ç‡§Æ‡•á‡§¶‡§æ‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§ó‡•Ä‡•§</li>
                            <li>‡§Ø‡§¶‡§ø ‡§â‡§ö‡§ø‡§§ ‡§∏‡§Æ‡§Ø ‡§™‡§∞ ‡§≠‡§æ‡§°‡§º‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§® ‡§π‡•ã‡§®‡•á ‡§™‡§∞ 15 ‡§¶‡§ø‡§® ‡§ï‡•Ä ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§Æ‡•ã‡§π‡§≤‡§§ ‡§¶‡•Ä ‡§ú‡§æ‡§è‡§ó‡•Ä‡•§</li>
                            <li>‡§Ø‡§¶‡§ø 15 ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§≠‡§æ‡§°‡§º‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§® ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§Ü‡§≤‡•Ç ‡§ï‡•Ä ‡§®‡•Ä‡§≤‡§æ‡§Æ‡•Ä ‡§ï‡•Ä ‡§ú‡§æ‡§è‡§ó‡•Ä‡•§</li>
                            <li>‡§Ü‡§≤‡•Ç 15 ‡§ú‡•Ç‡§® ‡§§‡§ï ‡§®‡§ø‡§ï‡§æ‡§≤‡§®‡§æ ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø ‡§π‡•à ‡§Ö‡§®‡•ç‡§Ø‡§•‡§æ 1-‡§ú‡•Å‡§≤‡§æ‡§à ‡§∏‡•á ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§≠‡§æ‡§°‡§º‡§æ ‡§≤‡§æ‡§ó‡•Ç ‡§π‡•ã‡§ó‡§æ‡•§</li>
                        </ol>
                    </div>

                    <div class="signature-section">
                        <div class="signature-box">
                            <div class="signature-line">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡•á ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞<br>Customer's Signature</div>
                        </div>
                        <div class="signature-box">
                            <div class="signature-line">‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§ï ‡§ï‡•á ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞<br>Manager's Signature<br><span id="employeeName1" style="font-size: 10px;">-</span></div>
                        </div>
                    </div>
                </div>

                <!-- Second Copy -->
                <div class="invoice">
                    <div class="header">
                        <h1>‡§ó‡•Å‡§°‡§º ‡§ï‡•É‡§™‡§æ ‡§ï‡•ã‡§≤‡•ç‡§° ‡§∏‡•ç‡§ü‡•ã‡§∞</h1>
                        <div class="subtitle">Gud Kripa Cold Store</div>
                        <div class="subtitle">‡§ï‡•ã‡§≤‡•ç‡§° ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§≤‡§æ‡§á‡§∏‡•á‡§Ç‡§∏/‡§ó‡•ã‡§¶‡§æ‡§Æ | Cold Store License/Warehouse</div>
                        <div class="mobile">Mobile: 7505837172</div>
                    </div>

                    <div class="info-section">
                        <h3>‡§Æ‡•Ç‡§≤ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä | Basic Information</h3>
                        <div class="info-row">
                            <span class="info-label">‡§ï‡•ç‡§∞. | Sr. No.:</span>
                            <span class="info-value" id="invoiceNumber2">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ | Customer Name:</span>
                            <span class="info-value" id="customerName2">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">‡§´‡•ã‡§® | Phone:</span>
                            <span class="info-value" id="customerPhone2">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">‡§ó‡•ç‡§∞‡§æ‡§Æ ‡§µ ‡§™‡§§‡§æ | Village & Address:</span>
                            <span class="info-value" id="customerVillage2">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">‡§µ‡§ø‡§ï‡§æ‡§∏‡§ñ‡§£‡•ç‡§° | Development Block:</span>
                            <span class="info-value">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">‡§ú‡§®‡§™‡§¶ | District:</span>
                            <span class="info-value">‡§ú‡§æ‡§≤‡•å‡§® (‡§ï‡§æ‡§≤‡§™‡•Ä) | Jalaun (Kalpi)</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï | Date:</span>
                            <span class="info-value" id="invoiceDate2">-</span>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>‡§ï‡•ç‡§∞.<br>Sr. No.</th>
                                <th>‡§•‡•ã‡§ï ‡§®‡§Ç.<br>Thok No.</th>
                                <th>‡§ï‡•Å‡§≤ ‡§≠‡§∞‡§§‡•Ä ‡§¨‡•ã‡§∞‡•á<br>Total Bags</th>
                                <th>‡§¨‡•ã‡§∞‡•Ä ‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ<br>Sold Qty</th>
                                <th>‡§∂‡•á‡§∑ ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ<br>Remaining</th>
                                <th>‡§≠‡§æ‡§°‡§º‡§æ<br>Rent (‚Çπ)</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTable2">
                            <tr>
                                <td colspan="6">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="terms">
                        <h3>‡§®‡§ø‡§Ø‡§Æ ‡§è‡§µ‡§Ç ‡§∂‡§∞‡•ç‡§§‡•á‡§Ç | Terms and Conditions</h3>
                        <ol>
                            <li>‡§Ø‡§¶‡§ø ‡§™‡•ç‡§∞‡§§‡§ø‡§®‡§ø‡§ß‡§ø ‡§ï‡•á ‡§ï‡§ü‡•å‡§§‡•Ä ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§ï‡•ã‡§à ‡§≠‡•Ä ‡§Ü‡§≤‡•Ç ‡§ï‡•Ä ‡§¨‡•Ä‡§Æ‡§æ ‡§¶‡§æ‡§µ‡•á ‡§ï‡§æ ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§ó‡§æ‡•§</li>
                            <li>‡§Ø‡§¶‡§ø ‡§ï‡•ã‡§à ‡§≠‡•Ä ‡§™‡•ç‡§∞‡§æ‡§ï‡•É‡§§‡§ø‡§ï ‡§Ü‡§™‡§¶‡§æ ‡§ï‡•á ‡§ï‡§æ‡§∞‡§£ ‡§Ü‡§≤‡•Ç ‡§ï‡•Ä ‡§ï‡•ç‡§∑‡§§‡§ø ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§ï‡•ã‡§≤‡•ç‡§° ‡§ï‡•Ä ‡§ú‡§ø‡§Æ‡•ç‡§Æ‡•á‡§¶‡§æ‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§ó‡•Ä‡•§</li>
                            <li>‡§Ü‡§≤‡•Ç ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à ‡§ï‡§ü‡•å‡§§‡•Ä ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§ï‡•ã‡§≤‡•ç‡§° ‡§ï‡•Ä ‡§ï‡•ã‡§à ‡§ú‡§ø‡§Æ‡•ç‡§Æ‡•á‡§¶‡§æ‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§ó‡•Ä‡•§</li>
                            <li>‡§Ø‡§¶‡§ø ‡§â‡§ö‡§ø‡§§ ‡§∏‡§Æ‡§Ø ‡§™‡§∞ ‡§≠‡§æ‡§°‡§º‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§® ‡§π‡•ã‡§®‡•á ‡§™‡§∞ 15 ‡§¶‡§ø‡§® ‡§ï‡•Ä ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§Æ‡•ã‡§π‡§≤‡§§ ‡§¶‡•Ä ‡§ú‡§æ‡§è‡§ó‡•Ä‡•§</li>
                            <li>‡§Ø‡§¶‡§ø 15 ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§≠‡§æ‡§°‡§º‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§® ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§Ü‡§≤‡•Ç ‡§ï‡•Ä ‡§®‡•Ä‡§≤‡§æ‡§Æ‡•Ä ‡§ï‡•Ä ‡§ú‡§æ‡§è‡§ó‡•Ä‡•§</li>
                            <li>‡§Ü‡§≤‡•Ç 15 ‡§ú‡•Ç‡§® ‡§§‡§ï ‡§®‡§ø‡§ï‡§æ‡§≤‡§®‡§æ ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø ‡§π‡•à ‡§Ö‡§®‡•ç‡§Ø‡§•‡§æ 1-‡§ú‡•Å‡§≤‡§æ‡§à ‡§∏‡•á ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§≠‡§æ‡§°‡§º‡§æ ‡§≤‡§æ‡§ó‡•Ç ‡§π‡•ã‡§ó‡§æ‡•§</li>
                        </ol>
                    </div>

                    <div class="signature-section">
                        <div class="signature-box">
                            <div class="signature-line">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡•á ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞<br>Customer's Signature</div>
                        </div>
                        <div class="signature-box">
                            <div class="signature-line">‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§ï ‡§ï‡•á ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞<br>Manager's Signature<br><span id="employeeName2" style="font-size: 10px;">-</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const entryId = urlParams.get('entry_id');
        const roomEntryId = urlParams.get('room_entry_id');

        // Capitalize first letter function
        function capitalizeText(text) {
            if (!text || text.length === 0) return text;
            return text.charAt(0).toUpperCase() + text.slice(1);
        }

        // Decode JWT to get employee details
        function getEmployeeFromToken() {
            if (!token) return null;

            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));

                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error('Error decoding token:', error);
                return null;
            }
        }

        async function loadInvoice() {
            try {
                if (!entryId || !roomEntryId) {
                    document.getElementById('loading').innerHTML = `
                        <p style="color: orange; font-weight: bold;">‡§∞‡§∏‡•Ä‡§¶ ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø</p>
                        <p style="margin-top: 10px;">‡§á‡§∏ ‡§™‡•É‡§∑‡•ç‡§† ‡§ï‡•ã Entry Room ‡§∏‡•á ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è‡•§</p>
                        <button class="btn" onclick="window.location.href='/entry-room'" style="margin-top: 20px;">
                            ‚Üê Entry Room ‡§™‡§∞ ‡§ú‡§æ‡§è‡§Ç
                        </button>
                    `;
                    return;
                }

                // Fetch entry details
                const entryResponse = await fetch(`/api/entries/${entryId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const entry = await entryResponse.json();

                // Fetch rent per item from system settings
                const settingsResponse = await fetch('/api/settings/rent_per_item', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const rentSetting = await settingsResponse.json();
                const rentPerItem = parseFloat(rentSetting.setting_value);

                // Fetch all entries and room entries for this phone number
                const [allEntriesResponse, roomEntriesResponse] = await Promise.all([
                    fetch(`/api/entries`, { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch(`/api/room-entries`, { headers: { 'Authorization': `Bearer ${token}` } })
                ]);
                const allEntries = await allEntriesResponse.json();
                const roomEntries = roomEntriesResponse.ok ? await roomEntriesResponse.json() || [] : [];

                // Build map of thock_number -> stored quantity from room_entries
                const thockStoredQty = {};
                roomEntries.forEach(re => {
                    if (!thockStoredQty[re.thock_number]) {
                        thockStoredQty[re.thock_number] = 0;
                    }
                    thockStoredQty[re.thock_number] += re.quantity || 0;
                });

                // Filter entries by phone number
                const customerEntries = allEntries.filter(e => e.phone === entry.phone);

                // Get employee details
                const employee = getEmployeeFromToken();

                // Fetch employee name from API
                let employeeName = 'N/A';
                if (employee?.user_id) {
                    try {
                        const userResponse = await fetch(`/api/users/${employee.user_id}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (userResponse.ok) {
                            const user = await userResponse.json();
                            employeeName = capitalizeText(user.name);
                        }
                    } catch (error) {
                        console.error('Error fetching employee name:', error);
                    }
                }

                // Format date as DD/MM/YYYY
                const invoiceDate = new Date().toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });

                // Calculate total amount using stored quantity from room_entries
                let totalRent = 0;
                const items = customerEntries.map(e => {
                    // Use stored quantity from room_entries for rent calculation
                    const storedQty = thockStoredQty[e.thock_number] || 0;
                    const expectedQty = e.expected_quantity || 0;
                    const amount = storedQty * rentPerItem;
                    totalRent += amount;
                    // Display: "300 ‚Üí 250" showing expected vs stored
                    const qtyDisplay = expectedQty !== storedQty
                        ? `${expectedQty} ‚Üí ${storedQty}`
                        : storedQty;
                    return {
                        entry_id: e.id,
                        thock_number: e.thock_number,
                        quantity: storedQty,
                        qtyDisplay: qtyDisplay, // For UI display
                        rate: rentPerItem,
                        amount: amount
                    };
                });

                // Save invoice to database
                const invoice = await saveInvoice(entry.id, employee.user_id, totalRent, items);

                // Populate both invoices
                populateInvoice('1', entry, customerEntries, rentPerItem, invoiceDate, employeeName, invoice.invoice_number, thockStoredQty);
                populateInvoice('2', entry, customerEntries, rentPerItem, invoiceDate, employeeName, invoice.invoice_number, thockStoredQty);

                // Update status to "Ready for Exit"
                await updateEntryStatus(entryId, 'READY', 'Invoice generated - Ready for exit');

                // Show invoice
                document.getElementById('loading').style.display = 'none';
                document.getElementById('invoiceContent').style.display = 'block';

            } catch (error) {
                console.error('Error loading invoice:', error);
                document.getElementById('loading').innerHTML = `
                    <p style="color: red;">‡§∞‡§∏‡•Ä‡§¶ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message}</p>
                    <button class="btn btn-secondary" onclick="window.history.back()">‡§µ‡§æ‡§™‡§∏ ‡§ú‡§æ‡§è‡§Ç</button>
                `;
            }
        }

        async function saveInvoice(customerId, employeeId, totalAmount, items) {
            try {
                const response = await fetch('/api/invoices', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        customer_id: customerId,
                        employee_id: employeeId,
                        total_amount: totalAmount,
                        notes: 'Invoice generated from loading invoice page',
                        items: items
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to save invoice');
                }

                return await response.json();
            } catch (error) {
                console.error('Error saving invoice:', error);
                return { invoice_number: 'TEMP-' + Date.now() };
            }
        }

        function populateInvoice(suffix, entry, customerEntries, rentPerItem, invoiceDate, employeeName, invoiceNumber, thockStoredQty) {
            // Populate invoice number
            document.getElementById('invoiceNumber' + suffix).textContent = invoiceNumber;

            // Populate customer info
            document.getElementById('customerName' + suffix).textContent = capitalizeText(entry.name);
            document.getElementById('customerPhone' + suffix).textContent = entry.phone;
            document.getElementById('customerVillage' + suffix).textContent = capitalizeText(entry.village) || 'N/A';
            document.getElementById('invoiceDate' + suffix).textContent = invoiceDate;
            document.getElementById('employeeName' + suffix).textContent = employeeName;

            // Populate items table using stored quantity from room_entries
            let totalRent = 0;
            const itemsTableHtml = customerEntries.map((e, index) => {
                // Use stored quantity from room_entries for rent calculation
                const storedQty = thockStoredQty[e.thock_number] || 0;
                const expectedQty = e.expected_quantity || 0;
                const rent = storedQty * rentPerItem;
                totalRent += rent;
                const thockColor = getThockColor(e.thock_number);
                // Display: "300 ‚Üí 250" showing expected vs stored
                const qtyDisplay = expectedQty !== storedQty
                    ? `${expectedQty} ‚Üí ${storedQty}`
                    : storedQty;

                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td style="color: ${thockColor === 'text-green-600' ? 'green' : 'orange'}; font-weight: bold;">${e.thock_number}</td>
                        <td>${qtyDisplay}</td>
                        <td>0</td>
                        <td>${storedQty}</td>
                        <td>‚Çπ${rent.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');

            // Add total row
            const totalRow = `
                <tr class="total-row">
                    <td colspan="5" style="text-align: right;"><strong>‡§ï‡•Å‡§≤ ‡§≠‡§æ‡§°‡§º‡§æ | Total Rent:</strong></td>
                    <td><strong>‚Çπ${totalRent.toLocaleString('en-IN', {minimumFractionDigits: 2})}</strong></td>
                </tr>
            `;

            document.getElementById('itemsTable' + suffix).innerHTML = itemsTableHtml + totalRow;
        }

        async function updateEntryStatus(entryId, eventType, notes) {
            try {
                await fetch('/api/entry-events', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        entry_id: entryId,
                        event_type: eventType,
                        status: 'READY',
                        notes: notes
                    })
                });
            } catch (error) {
                console.error('Error updating status:', error);
            }
        }

        function getThockColor(thockNumber) {
            const numMatch = thockNumber.match(/^(\d+)/);
            if (numMatch) {
                const num = parseInt(numMatch[1]);
                return num <= 1500 ? 'text-green-600' : 'text-orange-600';
            }
            return 'text-gray-700';
        }

        // Load invoice on page load
        window.addEventListener('load', loadInvoice);
    </script>
</body>
</html>
