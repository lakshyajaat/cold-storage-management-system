<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png?v=2">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n-page-title="page_title_gate_pass">Gate Pass Entry - Cold Storage</title>
    <link rel="stylesheet" href="/static/css/bootstrap-icons.min.css">
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link href="/static/css/arbitrary.css" rel="stylesheet">
    <link href="/static/css/fonts.css" rel="stylesheet">
    <link href="/static/css/dark-mode.css" rel="stylesheet">
    <link href="/static/css/responsive.css" rel="stylesheet">

    <style>
        * {
            font-family: 'Space Grotesk', sans-serif;
        }

        /* Tablet/Phone Portrait Optimizations */
        @media (max-width: 1023px) and (orientation: portrait) {
            .neu-input {
                padding: 0.625rem;
                font-size: 1rem;
            }
        }
        .neu-border {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            transition: all 0.2s ease;
        }
        .neu-border:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #000;
        }
        .neu-input {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            padding: 0.75rem;
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        .neu-input:focus {
            outline: none;
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #000;
        }
        .neu-button {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .neu-button:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #000;
        }
        .neu-button:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 #000;
        }
        .hidden { display: none; }
        .cursor-pointer { cursor: pointer; }
        .search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 4px;
        }
        .search-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 2px solid #eee;
            transition: background 0.2s;
        }
        .search-item:hover {
            background: #FEF3C7;
            font-weight: 600;
        }
        .search-item:last-child {
            border-bottom: none;
        }
        .lang-selector {
            border: 2px solid #000;
            box-shadow: 2px 2px 0px #000;
        }
    </style>
    <script src="/static/js/theme.js"></script>
</head>
<body class="bg-[#FFF9E6] min-h-screen p-2 sm:p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 md:mb-8 neu-border bg-white p-3 md:p-6 gap-3 md:gap-4">
            <div>
                <div class="flex items-center gap-2 md:gap-3">
                    <i class="bi bi-box-arrow-right text-2xl md:text-4xl text-red-600"></i>
                    <div>
                        <h1 class="text-xl md:text-3xl font-bold" data-i18n="gate_pass_title">Gate Pass Entry</h1>
                        <p class="text-gray-600 text-xs md:text-base hidden sm:block" data-i18n="issue_gate_pass_subtitle">Issue gate pass for item withdrawal</p>
                    </div>
                </div>
            </div>
            <div class="flex gap-2 md:gap-3 items-center w-full md:w-auto justify-end">
                <select id="langSelector" onchange="i18n.setLanguage(this.value)"
                        class="lang-selector bg-white px-2 md:px-3 py-2 text-sm font-medium cursor-pointer">
                    <option value="en">EN</option>
                    <option value="hi">‡§π‡§ø‡§Ç</option>
                </select>
                <!-- Theme Toggle -->
                <button onclick="theme.toggle()" class="neu-border bg-gray-200 px-2 md:px-3 py-2" title="Toggle Dark Mode">
                    <i class="bi bi-moon-fill theme-icon-moon"></i>
                    <i class="bi bi-sun-fill theme-icon-sun hidden"></i>
                </button>
                <button onclick="goBack()" class="neu-button bg-gray-200 px-3 md:px-4 py-2">
                    <i class="bi bi-arrow-left"></i> <span class="hidden sm:inline" data-i18n="back">Back</span>
                </button>
            </div>
        </header>

        <!-- Main Content Grid: Form (Left) + Recent Gate Passes (Right) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-8 mb-4 md:mb-8">
            <!-- Gate Pass Form (Left) -->
            <div class="neu-border bg-white p-3 md:p-6">
                <h2 class="text-lg md:text-2xl font-bold mb-4 md:mb-6 flex items-center gap-2">
                    <i class="bi bi-card-checklist"></i>
                    <span data-i18n="gate_pass_details">Gate Pass Details</span>
                </h2>

                <form id="gatePassForm" onsubmit="submitGatePass(event)">
                    <div class="grid grid-cols-1 gap-4 mb-6">
                        <div class="relative">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <span data-i18n="search_customer">Search Customer</span> * <span class="text-sm text-gray-500" data-i18n="search_customer_hint">(Phone / Name / Truck)</span>
                            </label>
                            <input
                                type="text"
                                id="customerSearch"
                                required
                                class="w-full neu-input"
                                data-i18n-placeholder="search_placeholder"
                                placeholder="Search by phone, name, or truck number"
                                autocomplete="off"
                                onfocus="showCustomerDropdown()"
                                oninput="filterCustomers()"
                            >
                            <div id="customerDropdown" class="search-dropdown hidden">
                                <div id="customerList"></div>
                            </div>
                            <input type="hidden" id="customerId">
                            <input type="hidden" id="customerPhone">
                        </div>

                        <div id="customerInfo" class="hidden p-4 bg-blue-50 neu-border">
                            <p class="text-sm font-semibold text-gray-700 mb-2" data-i18n="selected_customer">Selected Customer:</p>
                            <p class="text-lg font-bold" id="customerName"></p>
                            <p class="text-sm text-gray-600"><span data-i18n="phone">Phone</span>: <span id="customerPhoneDisplay"></span></p>
                            <p class="text-sm text-gray-600"><span data-i18n="village">Village</span>: <span id="customerVillage"></span></p>
                        </div>

                        <div class="relative">
                            <label class="block text-sm font-semibold text-gray-700 mb-2" data-i18n="thock_no_required">
                                Thok NO *
                            </label>
                            <input
                                type="text"
                                id="thockNumber"
                                required
                                class="w-full neu-input"
                                data-i18n-placeholder="enter_truck_or_select"
                                placeholder="Enter truck number or select from customer's entries"
                                autocomplete="off"
                                onfocus="showTruckDropdown()"
                                oninput="filterThockNumbers()"
                                onchange="checkThockNumber()"
                            >
                            <div id="truckDropdown" class="search-dropdown hidden">
                                <div id="truckList"></div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <span data-i18n="recipient_name">Recipient Name</span> <span class="text-sm text-gray-500" data-i18n="recipient_who_receives">(Who will receive items)</span>
                            </label>
                            <input
                                type="text"
                                id="recipientName"
                                class="w-full neu-input"
                                data-i18n-placeholder="name_of_person_receiving"
                                placeholder="Name of person receiving items"
                            >
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2" data-i18n="requested_quantity_required">
                                Requested Quantity *
                            </label>
                            <input
                                type="number"
                                id="requestedQuantity"
                                required
                                min="1"
                                class="w-full neu-input"
                                data-i18n-placeholder="enter_quantity"
                                placeholder="Enter quantity"
                                oninput="validateQuantityAndPayment()"
                            >
                            <div class="mt-2 space-y-1">
                                <p class="text-xs text-gray-600">
                                    üì¶ <span data-i18n="available_in_inventory">Available in inventory:</span> <span id="availableQuantity" class="font-bold text-blue-600">-</span> <span data-i18n="items">items</span>
                                </p>
                                <p class="text-xs text-gray-600">
                                    üí∞ <span data-i18n="can_take_out_payment">Can take out (based on payment):</span> <span id="paymentAllowedQuantity" class="font-bold text-green-600">-</span> <span data-i18n="items">items</span>
                                </p>
                                <p id="debtRequestStatus" class="text-xs hidden">
                                    <!-- Debt request status will be shown here -->
                                </p>
                            </div>
                        </div>

                        <div id="validationMessage" class="hidden p-4 neu-border">
                            <p class="font-semibold flex items-center gap-2">
                                <i class="bi bi-info-circle"></i>
                                <span id="validationText"></span>
                            </p>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2" data-i18n="remarks_optional">
                                Remarks (Optional)
                            </label>
                            <textarea
                                id="remarks"
                                class="w-full neu-input"
                                rows="3"
                                data-i18n-placeholder="enter_remarks"
                                placeholder="Enter any remarks"
                            ></textarea>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <button type="submit" id="submitGatePassBtn" class="neu-button bg-red-500 text-white flex-1">
                            <i class="bi bi-check-circle"></i> <span data-i18n="issue_gate_pass">Issue Gate Pass</span>
                        </button>
                        <button type="button" onclick="resetForm()" class="neu-button bg-gray-300">
                            <i class="bi bi-x-circle"></i> <span data-i18n="reset">Reset</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Recent Gate Passes (Right) -->
            <div class="neu-border bg-white p-4 md:p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl md:text-2xl font-bold flex items-center gap-2">
                        <i class="bi bi-clock-history text-red-600"></i>
                        <span data-i18n="recent_gate_passes">Recent Gate Passes</span>
                    </h2>
                </div>
                <div id="recentGatePasses" class="overflow-x-auto" style="max-height: 700px;">
                    <table class="w-full text-sm min-w-[600px]">
                        <thead class="sticky top-0 bg-white">
                            <tr class="border-b-2 border-black">
                                <th class="text-left p-2 font-bold" data-i18n="thock_number">Thok NO</th>
                                <th class="text-left p-2 font-bold" data-i18n="customer_name">Customer</th>
                                <th class="text-left p-2 font-bold" data-i18n="recipient">Recipient</th>
                                <th class="text-left p-2 font-bold" data-i18n="qty">Req Qty</th>
                                <th class="text-left p-2 font-bold" data-i18n="picked_up">Picked Up</th>
                                <th class="text-left p-2 font-bold" data-i18n="status">Status</th>
                                <th class="text-left p-2 font-bold" data-i18n="expires_in">Expires In</th>
                                <th class="text-left p-2 font-bold" data-i18n="date">Date</th>
                                <th class="text-left p-2 font-bold" data-i18n="action">Action</th>
                            </tr>
                        </thead>
                        <tbody id="gatePassesTableBody">
                            <tr>
                                <td colspan="9" class="text-center p-4 text-gray-500" data-i18n="loading_gate_passes">Loading gate passes...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Customer Requests Pending Approval -->
        <div class="mt-6 md:mt-8 neu-border bg-white p-4 md:p-6" id="customerRequestsSection">
            <h2 class="text-xl md:text-2xl font-bold mb-4 md:mb-6 flex items-center gap-2">
                <i class="bi bi-person-check text-blue-600"></i>
                <span data-i18n="customer_requests_pending">Customer Requests Pending Approval</span>
            </h2>
            <div id="customerRequestsContainer" class="overflow-x-auto" style="max-height: 500px;">
                <table class="w-full text-sm min-w-[600px]">
                    <thead class="sticky top-0 bg-white">
                        <tr class="border-b-2 border-black">
                            <th class="text-left p-2 font-bold" data-i18n="date">Date</th>
                            <th class="text-left p-2 font-bold" data-i18n="customer_name">Customer</th>
                            <th class="text-left p-2 font-bold" data-i18n="phone">Phone</th>
                            <th class="text-left p-2 font-bold" data-i18n="thock_number">Thok NO</th>
                            <th class="text-left p-2 font-bold" data-i18n="qty_requested">Qty Requested</th>
                            <th class="text-left p-2 font-bold" data-i18n="expires_in">Expires In</th>
                            <th class="text-left p-2 font-bold" data-i18n="remarks">Remarks</th>
                            <th class="text-left p-2 font-bold" data-i18n="action">Action</th>
                        </tr>
                    </thead>
                    <tbody id="customerRequestsTableBody">
                        <tr>
                            <td colspan="8" class="text-center p-4 text-gray-500" data-i18n="loading_customer_requests">Loading customer requests...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Approval Modal -->
        <div id="approvalModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="neu-border bg-white p-8 max-w-md w-full mx-4">
                <h3 class="text-2xl font-bold mb-6 flex items-center gap-2">
                    <i class="bi bi-check-circle text-green-600"></i>
                    <span data-i18n="approve_customer_request">Approve Customer Request</span>
                </h3>
                <form id="approvalForm" onsubmit="submitApproval(event)">
                    <input type="hidden" id="approvalGatePassId">

                    <div class="mb-4 p-4 bg-blue-50 neu-border">
                        <p class="text-sm text-gray-600" data-i18n="customer_colon">Customer:</p>
                        <p class="font-bold" id="approvalCustomerName"></p>
                        <p class="text-sm text-gray-600 mt-2" data-i18n="truck_colon">Truck:</p>
                        <p class="font-bold" id="approvalThockNumber"></p>
                        <p class="text-sm text-gray-600 mt-2" data-i18n="requested_colon">Requested:</p>
                        <p class="font-bold text-xl" id="approvalRequestedQty"></p>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-semibold text-gray-700 mb-2" data-i18n="approved_quantity_required">
                            Approved Quantity *
                        </label>
                        <input
                            type="number"
                            id="approvalApprovedQty"
                            required
                            min="1"
                            class="w-full neu-input"
                            data-i18n-placeholder="enter_approved_qty"
                            placeholder="Enter approved quantity"
                        >
                    </div>

                    <!-- Pickup Gatar Selection -->
                    <div class="mb-4 p-4 bg-yellow-50 neu-border">
                        <p class="text-sm text-gray-600 font-semibold mb-2">
                            <i class="bi bi-geo-alt"></i> <span data-i18n="select_pickup_gatars_required">Select Pickup Gatar(s) *</span>
                        </p>
                        <div id="approvalGatarDisplay" class="text-sm max-h-48 overflow-y-auto">
                            <p class="text-gray-500" data-i18n="loading_storage">Loading storage locations...</p>
                        </div>
                        <input type="hidden" id="approvalGateNo" value="">
                        <p class="text-xs text-gray-500 mt-2">
                            <i class="bi bi-info-circle"></i> <span data-i18n="selected_gatars_freed">Selected gatars will be freed after pickup</span>
                        </p>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-2" data-i18n="remarks_optional_lower">
                            Remarks (optional)
                        </label>
                        <textarea
                            id="approvalRemarks"
                            class="w-full neu-input"
                            rows="3"
                            data-i18n-placeholder="add_any_remarks"
                            placeholder="Add any remarks"
                        ></textarea>
                    </div>

                    <div class="flex gap-4">
                        <button type="submit" id="submitApprovalBtn" class="neu-button bg-green-500 text-white flex-1">
                            <i class="bi bi-check-circle"></i> <span data-i18n="approve">Approve</span>
                        </button>
                        <button type="button" onclick="closeApprovalModal()" class="neu-button bg-gray-300">
                            <i class="bi bi-x-circle"></i> <span data-i18n="cancel">Cancel</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Success Message -->
        <div id="successMessage" class="hidden mt-6 neu-border bg-green-100 p-8">
            <h3 class="text-2xl font-bold text-green-700 mb-4 flex items-center gap-2">
                <i class="bi bi-check-circle-fill"></i>
                <span data-i18n="gate_pass_issued_success">Gate Pass Issued Successfully!</span>
            </h3>
            <div class="p-6 bg-white neu-border mb-4">
                <p class="text-lg text-gray-700 mb-2" data-i18n="gate_pass_id">Gate Pass ID:</p>
                <p class="text-4xl font-bold text-green-700" id="issuedGatePassId"></p>
            </div>
            <button onclick="resetForm()" class="neu-button bg-green-500 text-white w-full">
                <i class="bi bi-plus-circle"></i> <span data-i18n="issue_another_gate_pass">Issue Another Gate Pass</span>
            </button>
        </div>

        <!-- Debt Approval Request Modal -->
        <div id="debtApprovalModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white neu-border p-6 max-w-md w-full">
                <h3 class="text-xl font-bold mb-4 flex items-center gap-2 text-red-600">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    Outstanding Balance
                </h3>
                <div class="mb-4 p-4 bg-red-50 rounded-lg">
                    <p class="text-lg">Customer owes:</p>
                    <p class="text-3xl font-bold text-red-600" id="debtAmountDisplay">‚Çπ0</p>
                </div>
                <div class="space-y-2 mb-6">
                    <p><strong>Customer:</strong> <span id="debtCustomerName">-</span></p>
                    <p><strong>Phone:</strong> <span id="debtCustomerPhone">-</span></p>
                    <p><strong>Thock:</strong> <span id="debtThockNumber">-</span></p>
                    <p><strong>Requested Qty:</strong> <span id="debtRequestedQty">0</span></p>
                </div>
                <div id="debtApprovalStatus" class="mb-4 hidden">
                    <div class="p-3 bg-green-100 rounded-lg text-green-800">
                        <i class="bi bi-check-circle-fill"></i> Debt approval found! You can proceed.
                    </div>
                </div>
                <div id="debtRequestActions" class="flex flex-col gap-3">
                    <button onclick="requestDebtApproval()" id="requestDebtBtn" class="neu-button bg-orange-500 text-white w-full">
                        <i class="bi bi-send"></i> Request Admin Approval
                    </button>
                    <p class="text-sm text-gray-500 text-center">Or collect payment first:</p>
                    <a href="/rent-management" class="neu-button bg-blue-500 text-white w-full text-center">
                        <i class="bi bi-cash-stack"></i> Go to Payment Collection
                    </a>
                    <button onclick="closeDebtModal()" class="neu-button bg-gray-300 w-full">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                </div>
                <div id="debtProceedActions" class="hidden flex flex-col gap-3">
                    <button onclick="proceedWithDebtApproval()" class="neu-button bg-green-500 text-white w-full">
                        <i class="bi bi-check-circle"></i> Proceed with Gate Pass
                    </button>
                    <button onclick="closeDebtModal()" class="neu-button bg-gray-300 w-full">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- i18n Script -->
    <script src="/static/js/prefetch.js?v=5"></script>
    <script src="/static/js/i18n.js"></script>

    <script>
        const token = localStorage.getItem('token');
        let allCustomers = [];
        let allEntries = [];
        let customerPayments = [];
        let isSubmittingGatePass = false; // Debounce flag for gate pass submission
        let isSubmittingApproval = false; // Debounce flag for approval submission
        let customerRentRate = 0; // Loaded from API
        let totalRentOwed = 0;
        let totalPaid = 0;
        let balanceDue = 0;
        let selectedThockEntry = null; // Track the selected truck's entry
        let cachedRoomEntries = []; // Cache room entries - ALWAYS use this for inventory, NEVER expected_quantity

        // Fuzzy match function
        function fuzzyMatch(searchTerm, targetText) {
            if (!searchTerm) return true;
            if (!targetText) return false;

            searchTerm = searchTerm.toLowerCase();
            targetText = targetText.toLowerCase();

            // Exact substring match first (fast path)
            if (targetText.includes(searchTerm)) return true;

            // Fuzzy matching: all characters must appear in order
            let searchIndex = 0;
            for (let i = 0; i < targetText.length && searchIndex < searchTerm.length; i++) {
                if (targetText[i] === searchTerm[searchIndex]) {
                    searchIndex++;
                }
            }

            return searchIndex === searchTerm.length;
        }

        // Load rent rate from system settings
        async function loadRentRate() {
            try {
                const response = await fetch('/api/settings/rent_per_item', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    console.error('Failed to load rent rate, using default');
                    return;
                }

                const setting = await response.json();
                const rate = parseFloat(setting.setting_value);

                if (!isNaN(rate) && rate > 0) {
                    customerRentRate = rate;
                    console.log('Rent rate loaded from settings: ‚Çπ' + rate + '/item');
                }
            } catch (error) {
                console.error('Error loading rent rate:', error);
            }
        }

        // Load all customers on page load
        async function loadAllCustomers() {
            try {
                const response = await fetch('/api/customers', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) return;

                allCustomers = await response.json();
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }

        // Load all entries on page load
        async function loadAllEntries() {
            try {
                const response = await fetch('/api/entries', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) return;

                allEntries = await response.json();
            } catch (error) {
                console.error('Error loading entries:', error);
            }
        }

        // Show customer dropdown
        function showCustomerDropdown() {
            filterCustomers();
            document.getElementById('customerDropdown').classList.remove('hidden');
        }

        // Filter and display customers
        function filterCustomers() {
            const searchTerm = document.getElementById('customerSearch').value;

            const filtered = allCustomers.filter(customer => {
                return fuzzyMatch(searchTerm, customer.phone) ||
                       fuzzyMatch(searchTerm, customer.name) ||
                       fuzzyMatch(searchTerm, customer.village);
            });

            // Also search in entries by truck number to find customers
            const entriesFiltered = allEntries.filter(entry =>
                fuzzyMatch(searchTerm, entry.thock_number)
            );

            // Merge customer IDs from entries
            entriesFiltered.forEach(entry => {
                const customer = allCustomers.find(c => c.phone === entry.phone);
                if (customer && !filtered.find(c => c.id === customer.id)) {
                    filtered.push(customer);
                }
            });

            // Limit to 50 results
            const displayCustomers = filtered.slice(0, 50);

            const customerList = document.getElementById('customerList');
            customerList.innerHTML = displayCustomers.map(customer => {
                const displayText = `${customer.name} - ${customer.phone}${customer.village ? ' (' + customer.village + ')' : ''}`;
                return `<div class="search-item" onclick='selectCustomer(${JSON.stringify(customer)})'>${displayText}</div>`;
            }).join('');

            if (displayCustomers.length === 0 && searchTerm.length >= 2) {
                customerList.innerHTML = '<div class="search-item" style="color: #999;">' + i18n.t('no_customers_found', 'No customers found') + '</div>';
            } else if (searchTerm.length === 0) {
                customerList.innerHTML = '<div class="search-item" style="color: #999;">' + i18n.t('start_typing_to_search', 'Start typing to search...') + '</div>';
            }
        }

        // Select a customer
        async function selectCustomer(customer) {
            document.getElementById('customerId').value = customer.id;
            document.getElementById('customerPhone').value = customer.phone;
            document.getElementById('customerName').textContent = customer.name;
            document.getElementById('customerPhoneDisplay').textContent = customer.phone;
            document.getElementById('customerVillage').textContent = customer.village || 'N/A';
            document.getElementById('customerSearch').value = `${customer.name} - ${customer.phone}`;

            document.getElementById('customerDropdown').classList.add('hidden');
            document.getElementById('customerInfo').classList.remove('hidden');

            // Clear truck number to show new dropdown
            document.getElementById('thockNumber').value = '';

            // Calculate available inventory for this customer
            calculateAvailableInventory(customer.id);

            // Load customer payments to calculate payment-based availability
            await loadCustomerPayments(customer.phone);

            // Check and display debt request status for this customer
            await checkAndDisplayDebtRequestStatus(customer.phone);
        }

        // Calculate available inventory for customer (from current room_entries)
        async function calculateAvailableInventory(customerId) {
            // Get all entries for this customer
            const customerEntries = allEntries.filter(entry => entry.customer_id == customerId);

            // Get truck numbers for this customer
            const thockNumbers = customerEntries.map(entry => entry.thock_number);

            // Fetch current room entries to get ACTUAL inventory (reduced after pickups)
            try {
                const response = await fetch('/api/room-entries', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const allRoomEntries = await response.json();

                    // CACHE room entries globally for use in validateQuantityAndPayment
                    cachedRoomEntries = allRoomEntries;

                    // Filter room entries for this customer's trucks
                    const customerRoomEntries = allRoomEntries.filter(re =>
                        thockNumbers.includes(re.thock_number)
                    );

                    // Sum up CURRENT quantities (already reduced after pickups)
                    const totalInInventory = customerRoomEntries.reduce((sum, re) => {
                        return sum + (re.quantity || 0);
                    }, 0);

                    // Update the display
                    const availableSpan = document.getElementById('availableQuantity');
                    if (totalInInventory > 0) {
                        availableSpan.textContent = totalInInventory;
                        availableSpan.classList.remove('text-red-600');
                        availableSpan.classList.add('text-blue-600');
                    } else {
                        availableSpan.textContent = '0';
                        availableSpan.classList.remove('text-blue-600');
                        availableSpan.classList.add('text-red-600');
                    }
                } else {
                    // API failed - show 0, NEVER use expected_quantity
                    console.error('Room entries API returned non-ok status');
                    cachedRoomEntries = [];
                    document.getElementById('availableQuantity').textContent = '0';
                }
            } catch (error) {
                console.error('Error fetching room entries:', error);
                // Error - show 0, NEVER use expected_quantity
                cachedRoomEntries = [];
                document.getElementById('availableQuantity').textContent = '0';
            }
        }

        // Load customer balance from accounts summary (same source as rent management page)
        async function loadCustomerPayments(phone) {
            try {
                const response = await fetch(`/api/accounts/summary`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const summary = await response.json();

                    // Find the customer by phone number
                    const customerAccount = summary.customers.find(c => c.phone === phone);

                    if (customerAccount) {
                        // Use the balance directly from the accounts summary (same as rent management page)
                        totalRentOwed = customerAccount.total_rent || 0;
                        totalPaid = customerAccount.total_paid || 0;
                        balanceDue = customerAccount.balance || 0;

                        console.log('Customer account from summary:', {
                            phone: phone,
                            totalRentOwed: totalRentOwed,
                            totalPaid: totalPaid,
                            balanceDue: balanceDue
                        });
                    } else {
                        totalRentOwed = 0;
                        totalPaid = 0;
                        balanceDue = 0;
                    }
                } else {
                    customerPayments = [];
                    totalRentOwed = 0;
                    totalPaid = 0;
                    balanceDue = 0;
                }

                // Update availability display
                updateAvailabilityDisplay();

            } catch (error) {
                console.error('Error loading customer account:', error);
                customerPayments = [];
                totalRentOwed = 0;
                totalPaid = 0;
                balanceDue = 0;
                document.getElementById('paymentAllowedQuantity').textContent = 'N/A';
            }
        }

        // Calculate how much customer can take based on payments and balance
        function calculatePaymentBasedAvailability() {
            const customerId = document.getElementById('customerId').value;
            if (!customerId) return 0;

            // Balance and totals are already calculated by loadCustomerPayments() using backend data
            // Just update the display
            updateAvailabilityDisplay();

            // Return payment-based allowance
            return Math.floor(totalPaid / customerRentRate);
        }

        // Validate quantity and payment in real-time
        function validateQuantityAndPayment() {
            const requestedQty = parseInt(document.getElementById('requestedQuantity').value) || 0;
            const paymentAmount = 0; // Payment field removed - always 0
            const customerId = document.getElementById('customerId').value;

            if (!customerId || requestedQty === 0) {
                hideValidationMessage();
                return;
            }

            // Get available inventory from CACHED room_entries - NEVER use expected_quantity
            const customerEntries = allEntries.filter(entry => entry.customer_id == customerId);
            const thockNumbers = customerEntries.map(entry => entry.thock_number);

            let totalInInventory;
            if (selectedThockEntry) {
                // Specific truck selected - use only that truck's room_entries quantity
                const truckRoomEntries = cachedRoomEntries.filter(re =>
                    re.thock_number === selectedThockEntry.thock_number
                );
                totalInInventory = truckRoomEntries.reduce((sum, re) => sum + (re.quantity || 0), 0);
            } else {
                // No truck selected - use total room_entries for all customer trucks
                const customerRoomEntries = cachedRoomEntries.filter(re =>
                    thockNumbers.includes(re.thock_number)
                );
                totalInInventory = customerRoomEntries.reduce((sum, re) => sum + (re.quantity || 0), 0);
            }

            // PROPORTIONAL: Customer can take items based on what they've paid
            // Calculate items paid for
            const totalExpectedItems = customerEntries.reduce((sum, e) => sum + (e.expected_quantity || 0), 0);

            // Use configured rent rate (‚Çπ160/item) to calculate items paid for
            let itemsPaidFor = 0;
            if (customerRentRate > 0) {
                itemsPaidFor = Math.floor(totalPaid / customerRentRate);
            } else if (balanceDue <= 0) {
                // No rent rate configured and no balance - can take all
                itemsPaidFor = totalExpectedItems;
            }

            // Allowed = min(items paid for, available inventory)
            const allowedItems = Math.min(itemsPaidFor, totalInInventory);

            // Validation checks
            if (requestedQty > totalInInventory) {
                if (selectedThockEntry) {
                    showValidationMessage(
                        `‚ö†Ô∏è Thok ${selectedThockEntry.thock_number} has only ${totalInInventory} items!`,
                        'bg-red-100',
                        'text-red-700'
                    );
                } else {
                    showValidationMessage('‚ö†Ô∏è Requested quantity exceeds available inventory!', 'bg-red-100', 'text-red-700');
                }
            } else if (requestedQty > itemsPaidFor) {
                // Customer requesting more than they've paid for
                showValidationMessage(
                    `‚ö†Ô∏è Customer has paid for ${itemsPaidFor} items only. Pay ‚Çπ${balanceDue.toFixed(0)} more to take all.`,
                    'bg-yellow-100',
                    'text-yellow-700'
                );
            } else {
                // Approved - customer requesting within what they've paid for
                if (balanceDue < 0) {
                    showValidationMessage(
                        `‚úì Approved! Customer has ‚Çπ${Math.abs(balanceDue).toFixed(0)} advance credit.`,
                        'bg-green-100',
                        'text-green-700'
                    );
                } else if (balanceDue > 0) {
                    showValidationMessage(
                        `‚úì Approved! Paid for ${itemsPaidFor} items. (‚Çπ${balanceDue.toFixed(0)} balance remaining)`,
                        'bg-green-100',
                        'text-green-700'
                    );
                } else {
                    showValidationMessage(
                        `‚úì Approved! Balance is clear.`,
                        'bg-green-100',
                        'text-green-700'
                    );
                }
            }
        }

        function showValidationMessage(message, bgClass, textClass) {
            const validationMsg = document.getElementById('validationMessage');
            const validationText = document.getElementById('validationText');

            validationMsg.className = `p-4 neu-border ${bgClass}`;
            validationText.className = `font-semibold ${textClass}`;
            validationText.textContent = message;
            validationMsg.classList.remove('hidden');
        }

        function hideValidationMessage() {
            document.getElementById('validationMessage').classList.add('hidden');
        }


        // Show truck number dropdown
        function showTruckDropdown() {
            filterThockNumbers();
            document.getElementById('truckDropdown').classList.remove('hidden');
        }

        // Filter and display truck numbers from customer's entries
        function filterThockNumbers() {
            const searchTerm = document.getElementById('thockNumber').value;
            const customerId = document.getElementById('customerId').value;

            if (!customerId) {
                document.getElementById('truckList').innerHTML =
                    '<div class="search-item" style="color: #999;">' + i18n.t('select_customer_first', 'Please select a customer first') + '</div>';
                return;
            }

            // Filter entries by selected customer
            const customerEntries = allEntries.filter(entry => entry.customer_id == customerId);

            // Further filter by search term if provided
            const filtered = customerEntries.filter(entry =>
                fuzzyMatch(searchTerm, entry.thock_number)
            );

            // Limit to 50 results
            const displayTrucks = filtered.slice(0, 50);

            const truckList = document.getElementById('truckList');

            if (displayTrucks.length === 0 && customerEntries.length === 0) {
                truckList.innerHTML = '<div class="search-item" style="color: #999;">' + i18n.t('no_entries_for_customer', 'No entries found for this customer') + '</div>';
            } else if (displayTrucks.length === 0 && searchTerm) {
                truckList.innerHTML = '<div class="search-item" style="color: #999;">' + i18n.t('no_matching_trucks', 'No matching truck numbers') + '</div>';
            } else {
                truckList.innerHTML = displayTrucks.map(entry => {
                    // Display both expected and actual if different
                    const actualQty = entry.actual_quantity || 0;
                    const expectedQty = entry.expected_quantity || 0;
                    const qtyDisplay = actualQty > 0 && expectedQty !== actualQty
                        ? `${expectedQty} ‚Üí ${actualQty}`
                        : (actualQty > 0 ? actualQty : expectedQty);
                    const displayText = `${entry.thock_number} - ${qtyDisplay} ${i18n.t('items', 'items')}`;
                    return `<div class="search-item" onclick='selectThockNumber("${entry.thock_number}")'>${displayText}</div>`;
                }).join('');

                if (!searchTerm && displayTrucks.length > 0) {
                    truckList.innerHTML = '<div class="search-item" style="color: #666; font-weight: 600;">' + i18n.t('customer_thock_numbers', "Customer's Truck Numbers:") + '</div>' + truckList.innerHTML;
                }
            }
        }

        // Select a truck number
        function selectThockNumber(thockNumber) {
            document.getElementById('thockNumber').value = thockNumber;
            document.getElementById('truckDropdown').classList.add('hidden');

            // Find the entry for this truck
            const customerId = document.getElementById('customerId').value;
            if (customerId) {
                selectedThockEntry = allEntries.find(entry =>
                    entry.customer_id == customerId && entry.thock_number === thockNumber
                );

                // Update availability displays
                updateAvailabilityDisplay();
            }
        }

        // Check truck number when manually typed
        function checkThockNumber() {
            const thockNumber = document.getElementById('thockNumber').value.trim();
            const customerId = document.getElementById('customerId').value;

            if (!customerId || !thockNumber) {
                selectedThockEntry = null;
                updateAvailabilityDisplay();
                return;
            }

            // Try to find matching entry for this truck number
            selectedThockEntry = allEntries.find(entry =>
                entry.customer_id == customerId && entry.thock_number === thockNumber
            );

            // Update availability displays
            updateAvailabilityDisplay();
        }

        // Update availability displays based on selected truck (using current room_entries)
        async function updateAvailabilityDisplay() {
            const customerId = document.getElementById('customerId').value;
            if (!customerId) return;

            // Get customer entries
            const customerEntries = allEntries.filter(entry => entry.customer_id == customerId);

            // Fetch current room entries to get ACTUAL inventory
            try {
                const response = await fetch('/api/room-entries', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                let availableInventory = 0;
                let allRoomEntries = [];
                if (response.ok) {
                    allRoomEntries = await response.json();
                    console.log('All room entries:', allRoomEntries.length);
                    console.log('Customer entries:', customerEntries.map(e => e.thock_number));

                    if (selectedThockEntry) {
                        // Specific truck selected - sum room entries for this truck only
                        const truckRoomEntries = allRoomEntries.filter(re =>
                            re.thock_number === selectedThockEntry.thock_number
                        );
                        console.log('Selected thock:', selectedThockEntry.thock_number, 'Room entries found:', truckRoomEntries.length);
                        availableInventory = truckRoomEntries.reduce((sum, re) => sum + (re.quantity || 0), 0);
                    } else {
                        // No truck selected - sum all room entries for customer's trucks
                        const thockNumbers = customerEntries.map(e => e.thock_number);
                        const customerRoomEntries = allRoomEntries.filter(re =>
                            thockNumbers.includes(re.thock_number)
                        );
                        console.log('Customer thocks:', thockNumbers, 'Room entries found:', customerRoomEntries.length);
                        availableInventory = customerRoomEntries.reduce((sum, re) => sum + (re.quantity || 0), 0);
                    }
                } else {
                    console.error('Room entries API failed');
                    availableInventory = 0;
                }

                // Update inventory display
                document.getElementById('availableQuantity').textContent = availableInventory;

                // PROPORTIONAL: Customer can take out items based on how much they paid
                // Calculate total expected items for this customer (customerEntries already defined above)
                const totalExpectedItems = customerEntries.reduce((sum, e) => sum + (e.expected_quantity || 0), 0);

                // Calculate total current inventory across all customer's thoks (only items in rooms)
                const allThockNumbers = customerEntries.map(e => e.thock_number);
                const allCustomerRoomEntries = allRoomEntries.filter(re => allThockNumbers.includes(re.thock_number));
                const totalCurrentInventory = allCustomerRoomEntries.reduce((sum, re) => sum + (re.quantity || 0), 0);
                const itemsAlreadyTakenOut = totalExpectedItems - totalCurrentInventory;

                // Use configured rent rate (‚Çπ160/item) to calculate items paid for
                let canTakeOut = 0;
                let itemsPaidFor = 0;
                if (customerRentRate > 0) {
                    itemsPaidFor = Math.floor(totalPaid / customerRentRate);
                    // Can take out = MIN(available inventory, items paid for - items already taken out)
                    const paidAllowance = Math.max(0, itemsPaidFor - itemsAlreadyTakenOut);
                    canTakeOut = Math.min(availableInventory, paidAllowance);
                } else if (balanceDue <= 0) {
                    // No rent rate configured and no balance - can take all available
                    canTakeOut = availableInventory;
                    itemsPaidFor = totalExpectedItems;
                }

                // Update display - show total items customer can take out (based on payment)
                const paymentSpan = document.getElementById('paymentAllowedQuantity');
                if (balanceDue > 0) {
                    paymentSpan.textContent = `${canTakeOut} (‚Çπ${balanceDue.toFixed(0)} due)`;
                    paymentSpan.classList.remove('text-green-600');
                    paymentSpan.classList.add('text-yellow-600');
                } else if (balanceDue < 0) {
                    paymentSpan.textContent = `${canTakeOut} (‚Çπ${Math.abs(balanceDue).toFixed(0)} advance)`;
                    paymentSpan.classList.remove('text-yellow-600');
                    paymentSpan.classList.add('text-green-600');
                } else {
                    paymentSpan.textContent = canTakeOut;
                    paymentSpan.classList.remove('text-yellow-600', 'text-red-600');
                    paymentSpan.classList.add('text-green-600');
                }
            } catch (error) {
                console.error('Error fetching room entries:', error);
                // Error - show 0, NEVER use expected_quantity
                document.getElementById('availableQuantity').textContent = '0';
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            const customerInput = document.getElementById('customerSearch');
            const customerDropdown = document.getElementById('customerDropdown');
            if (customerInput && customerDropdown &&
                !customerInput.contains(e.target) && !customerDropdown.contains(e.target)) {
                customerDropdown.classList.add('hidden');
            }

            const truckInput = document.getElementById('thockNumber');
            const truckDropdown = document.getElementById('truckDropdown');
            if (truckInput && truckDropdown &&
                !truckInput.contains(e.target) && !truckDropdown.contains(e.target)) {
                truckDropdown.classList.add('hidden');
            }
        });

        async function submitGatePass(event) {
            event.preventDefault();

            // Debounce - prevent double submission
            if (isSubmittingGatePass) {
                console.log('Gate pass submission already in progress, ignoring');
                return;
            }

            const submitBtn = document.getElementById('submitGatePassBtn');
            const originalBtnText = submitBtn.innerHTML;

            const customerId = parseInt(document.getElementById('customerId').value);
            if (!customerId) {
                alert(i18n.t('select_valid_customer', 'Please search and select a valid customer first'));
                return;
            }

            const requestedQty = parseInt(document.getElementById('requestedQuantity').value);
            const paymentAmount = 0; // Payment field removed - always 0

            // Get available inventory from CACHED room_entries - NEVER use expected_quantity
            const customerEntries = allEntries.filter(entry => entry.customer_id == customerId);
            const thockNumbers = customerEntries.map(entry => entry.thock_number);

            let totalInInventory;
            if (selectedThockEntry) {
                // Specific truck selected - use only that truck's room_entries quantity
                const truckRoomEntries = cachedRoomEntries.filter(re =>
                    re.thock_number === selectedThockEntry.thock_number
                );
                totalInInventory = truckRoomEntries.reduce((sum, re) => sum + (re.quantity || 0), 0);
            } else {
                // No truck selected - use total room_entries for all customer trucks
                const customerRoomEntries = cachedRoomEntries.filter(re =>
                    thockNumbers.includes(re.thock_number)
                );
                totalInInventory = customerRoomEntries.reduce((sum, re) => sum + (re.quantity || 0), 0);
            }

            // Check inventory limit
            if (requestedQty > totalInInventory) {
                if (selectedThockEntry) {
                    alert(i18n.t('error', 'Error') + ': ' + i18n.t('truck_has_only_items', 'Truck {truck} has only {qty} items!').replace('{truck}', selectedThockEntry.thock_number).replace('{qty}', totalInInventory));
                } else {
                    alert(i18n.t('error', 'Error') + ': ' + i18n.t('qty_exceeds_inventory', 'Requested quantity exceeds available inventory!'));
                }
                return;
            }

            // PROPORTIONAL: Calculate how many items customer has paid for
            const totalExpectedItems = customerEntries.reduce((sum, e) => sum + (e.expected_quantity || 0), 0);

            // Use configured rent rate (‚Çπ160/item) to calculate items paid for
            let itemsPaidFor = 0;
            if (customerRentRate > 0) {
                itemsPaidFor = Math.floor(totalPaid / customerRentRate);
            } else if (balanceDue <= 0) {
                // No rent rate configured and no balance - can take all
                itemsPaidFor = totalExpectedItems;
            }

            // If customer requesting MORE than what they've paid for, require debt approval
            if (requestedQty > itemsPaidFor) {
                const phone = document.getElementById('customerPhone').value;
                const thockNumber = document.getElementById('thockNumber').value.trim();
                const customerName = document.getElementById('customerName').textContent;

                // Check if there's an approved debt request
                const debtCheck = await checkDebtApproval(phone, thockNumber);

                if (debtCheck && debtCheck.can_create_gate_pass && debtCheck.debt_request) {
                    // Approved debt request found - store data and show proceed option
                    pendingDebtData = { debtRequestId: debtCheck.debt_request.id };

                    // Show modal with approval status
                    showDebtModal(customerName, phone, thockNumber, requestedQty, balanceDue);
                    document.getElementById('debtApprovalStatus').classList.remove('hidden');
                    document.getElementById('debtRequestActions').classList.add('hidden');
                    document.getElementById('debtProceedActions').classList.remove('hidden');
                    return;
                } else {
                    // No approval - show modal to request approval
                    showDebtModal(customerName, phone, thockNumber, requestedQty, balanceDue);
                    return;
                }
            }
            // If requesting <= items paid for, proceed without debt approval

            const recipientName = document.getElementById('recipientName').value.trim();
            const remarks = document.getElementById('remarks').value.trim();

            // Combine recipient name and remarks
            let finalRemarks = '';
            if (recipientName) {
                finalRemarks = `Recipient: ${recipientName}`;
            }
            if (paymentAmount === 0) {
                finalRemarks += (finalRemarks ? ' | ' : '') + 'Payment: On Account / Credit';
            }
            if (remarks) {
                finalRemarks += (finalRemarks ? ' | ' : '') + remarks;
            }

            const gatePassData = {
                customer_id: customerId,
                thock_number: document.getElementById('thockNumber').value.trim(),
                entry_id: null,
                requested_quantity: requestedQty,
                payment_verified: true, // Always true now
                payment_amount: paymentAmount,
                remarks: finalRemarks
            };

            // Lock submission - disable button and show loading state
            isSubmittingGatePass = true;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Issuing...';

            try {
                const response = await fetch('/api/gate-passes', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(gatePassData)
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                const result = await response.json();
                showSuccess(result.id);
                loadRecentGatePasses();

            } catch (error) {
                alert(i18n.t('error_issuing_gate_pass', 'Error issuing gate pass') + ': ' + error.message);
                // Re-enable button on error
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                isSubmittingGatePass = false;
            }
        }

        function showSuccess(gatePassId) {
            document.getElementById('issuedGatePassId').textContent = '#' + gatePassId;
            document.getElementById('successMessage').classList.remove('hidden');
            document.getElementById('successMessage').scrollIntoView({ behavior: 'smooth', block: 'center' });

            // 5 second cooldown before allowing next submission
            const submitBtn = document.getElementById('submitGatePassBtn');
            if (submitBtn) {
                let countdown = 5;
                submitBtn.disabled = true;
                submitBtn.innerHTML = `<i class="bi bi-hourglass-split"></i> Wait ${countdown}s...`;

                const cooldownInterval = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        submitBtn.innerHTML = `<i class="bi bi-hourglass-split"></i> Wait ${countdown}s...`;
                    } else {
                        clearInterval(cooldownInterval);
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> <span data-i18n="issue_gate_pass">Issue Gate Pass</span>';
                        isSubmittingGatePass = false;
                    }
                }, 1000);
            }
        }

        function resetForm() {
            document.getElementById('gatePassForm').reset();
            document.getElementById('successMessage').classList.add('hidden');
            document.getElementById('customerInfo').classList.add('hidden');
            document.getElementById('customerDropdown').classList.add('hidden');
            document.getElementById('truckDropdown').classList.add('hidden');
            document.getElementById('validationMessage').classList.add('hidden');
            document.getElementById('availableQuantity').textContent = '-';
            document.getElementById('paymentAllowedQuantity').textContent = '-';
            customerPayments = [];
            selectedThockEntry = null; // Clear selected truck

            // Reset submit button state
            const submitBtn = document.getElementById('submitGatePassBtn');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> <span data-i18n="issue_gate_pass">Issue Gate Pass</span>';
            }
            isSubmittingGatePass = false;

            loadRecentGatePasses();
        }

        async function loadRecentGatePasses() {
            try {
                const response = await fetch('/api/gate-passes', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('Failed to load gate passes');
                }

                const gatePasses = await response.json();
                displayRecentGatePasses(gatePasses || []);

            } catch (error) {
                console.error('Error loading gate passes:', error);
                document.getElementById('gatePassesTableBody').innerHTML =
                    '<tr><td colspan="6" class="text-center p-4 text-red-500">' + i18n.t('failed_load_gate_passes', 'Failed to load gate passes') + '</td></tr>';
            }
        }

        // Calculate remaining time until expiration
        function getRemainingTime(expiresAt) {
            if (!expiresAt) return { text: 'N/A', color: 'text-gray-500' };

            const now = new Date();
            const expires = new Date(expiresAt);
            const diff = expires - now;

            if (diff <= 0) {
                return { text: i18n.t('expired', 'EXPIRED').toUpperCase(), color: 'text-red-600 font-bold' };
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

            let color = 'text-green-600'; // >24h
            if (hours < 6) {
                color = 'text-red-600 font-bold'; // <6h critical
            } else if (hours < 12) {
                color = 'text-orange-600 font-bold'; // <12h warning
            } else if (hours < 24) {
                color = 'text-yellow-600'; // <24h caution
            }

            return {
                text: `${hours}h ${minutes}m`,
                color: color
            };
        }

        function displayRecentGatePasses(gatePasses) {
            const tbody = document.getElementById('gatePassesTableBody');

            if (gatePasses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center p-4 text-gray-500">' + i18n.t('no_gate_passes_yet', 'No gate passes yet') + '</td></tr>';
                return;
            }

            const recentPasses = gatePasses.slice(0, 15);

            tbody.innerHTML = recentPasses.map(gp => {
                const statusColors = {
                    'pending': 'bg-yellow-100 text-yellow-700',
                    'approved': 'bg-blue-100 text-blue-700',
                    'completed': 'bg-green-100 text-green-700',
                    'expired': 'bg-red-100 text-red-700',
                    'rejected': 'bg-red-200 text-red-900',
                    'cancelled': 'bg-gray-100 text-gray-700',
                    'partially_completed': 'bg-orange-100 text-orange-700'
                };

                const statusColor = statusColors[gp.status] || 'bg-gray-100 text-gray-700';

                const date = new Date(gp.issued_at);
                const formattedDate = date.toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // Extract recipient from remarks
                let recipient = '-';
                if (gp.remarks) {
                    const match = gp.remarks.match(/Recipient:\s*([^|]+)/i);
                    if (match) recipient = match[1].trim();
                }

                // Calculate remaining time for pending gate passes
                const remaining = gp.status === 'pending' ? getRemainingTime(gp.expires_at) : { text: '-', color: 'text-gray-400' };

                // Color code truck number based on expiration time
                const truckColor = gp.status === 'pending' ? remaining.color : 'text-gray-700';

                // Action buttons for pending gate passes
                let actionButtons = '-';
                if (gp.status === 'pending') {
                    actionButtons = `
                        <div class="flex gap-1">
                            <button onclick='acceptGatePass(${gp.id}, "${gp.thock_number}", ${gp.requested_quantity})'
                                    class="neu-button bg-green-500 text-white text-xs px-2 py-1"
                                    title="Accept">
                                <i class="bi bi-check-circle"></i>
                            </button>
                            <button onclick='declineGatePass(${gp.id}, "${gp.thock_number}")'
                                    class="neu-button bg-red-500 text-white text-xs px-2 py-1"
                                    title="Decline">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>
                    `;
                }

                // Calculate picked up quantity
                const pickedUp = gp.total_picked_up || 0;
                const pickedUpColor = pickedUp > 0 ? 'text-red-600 font-bold' : 'text-gray-400';

                return `
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="p-2 font-bold ${truckColor}">${gp.thock_number}</td>
                        <td class="p-2">${gp.customer_name}</td>
                        <td class="p-2 font-semibold text-purple-600">${recipient}</td>
                        <td class="p-2 font-bold">${gp.requested_quantity}</td>
                        <td class="p-2 ${pickedUpColor}">${pickedUp > 0 ? pickedUp : '-'}</td>
                        <td class="p-2"><span class="px-2 py-1 rounded text-xs font-bold ${statusColor}">${gp.status.toUpperCase()}</span></td>
                        <td class="p-2 text-xs ${remaining.color}">${remaining.text}</td>
                        <td class="p-2 text-xs">${formattedDate}</td>
                        <td class="p-2">${actionButtons}</td>
                    </tr>
                `;
            }).join('');
        }

        // Load customer requests pending approval
        async function loadCustomerRequests() {
            try {
                const response = await fetch('/api/gate-passes', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('Failed to load customer requests');
                }

                const gatePasses = await response.json();

                // Filter only pending customer requests
                const customerRequests = gatePasses.filter(gp =>
                    gp.status === 'pending' && gp.request_source === 'customer_portal'
                );

                displayCustomerRequests(customerRequests || []);

            } catch (error) {
                console.error('Error loading customer requests:', error);
                document.getElementById('customerRequestsTableBody').innerHTML =
                    '<tr><td colspan="7" class="text-center p-4 text-red-500">' + i18n.t('failed_load_customer_requests', 'Failed to load customer requests') + '</td></tr>';
            }
        }

        function displayCustomerRequests(requests) {
            const tbody = document.getElementById('customerRequestsTableBody');
            const section = document.getElementById('customerRequestsSection');

            if (requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-gray-500">' + i18n.t('no_customer_requests', 'No customer requests pending approval') + '</td></tr>';
                return;
            }

            tbody.innerHTML = requests.map(req => {
                const date = new Date(req.issued_at);
                const formattedDate = date.toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // Calculate remaining time for customer requests
                const remaining = getRemainingTime(req.expires_at);

                return `
                    <tr class="border-b border-gray-200 hover:bg-blue-50">
                        <td class="p-2 text-xs">${formattedDate}</td>
                        <td class="p-2 font-bold">${req.customer_name}</td>
                        <td class="p-2 text-sm">${req.customer_phone}</td>
                        <td class="p-2 font-bold text-blue-600">${req.thock_number}</td>
                        <td class="p-2 font-bold text-lg">${req.requested_quantity}</td>
                        <td class="p-2 text-xs font-bold ${remaining.color}">${remaining.text}</td>
                        <td class="p-2 text-sm">${req.remarks || '-'}</td>
                        <td class="p-2">
                            <button onclick='openApprovalModal(${JSON.stringify(req)})'
                                    class="neu-button bg-green-500 text-white text-xs px-3 py-1">
                                <i class="bi bi-check-circle"></i> Approve
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function openApprovalModal(request) {
            document.getElementById('approvalGatePassId').value = request.id;
            document.getElementById('approvalCustomerName').textContent = request.customer_name;
            document.getElementById('approvalThockNumber').textContent = request.thock_number;
            document.getElementById('approvalRequestedQty').textContent = request.requested_quantity + ' items';
            document.getElementById('approvalApprovedQty').value = request.requested_quantity;
            document.getElementById('approvalGateNo').value = '';
            document.getElementById('approvalRemarks').value = '';
            document.getElementById('approvalModal').classList.remove('hidden');

            // Load and display gatar storage locations
            await loadGatarForApproval(request.thock_number);
        }

        let approvalRoomEntries = []; // Store room entries for approval

        async function loadGatarForApproval(thockNumber) {
            const gatarDisplay = document.getElementById('approvalGatarDisplay');
            gatarDisplay.innerHTML = '<p class="text-gray-500">' + i18n.t('loading_storage', 'Loading storage locations...') + '</p>';

            try {
                const response = await fetch('/api/room-entries', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to fetch room entries');

                const roomEntries = await response.json();
                approvalRoomEntries = roomEntries.filter(re => re.thock_number === thockNumber && re.quantity > 0);

                if (approvalRoomEntries.length === 0) {
                    gatarDisplay.innerHTML = '<p class="text-red-500 font-bold">' + i18n.t('no_storage_locations', 'No storage locations found!') + '</p>';
                    return;
                }

                let html = '<div class="space-y-2">';
                let totalQty = 0;

                approvalRoomEntries.forEach((entry, index) => {
                    totalQty += entry.quantity;
                    html += `
                        <label class="flex justify-between items-center p-2 bg-white rounded border cursor-pointer hover:bg-blue-50 transition-colors">
                            <div class="flex items-center gap-2">
                                <input type="checkbox"
                                       class="gatar-checkbox w-4 h-4"
                                       data-index="${index}"
                                       data-room="${entry.room_no}"
                                       data-floor="${entry.floor}"
                                       data-gatar="${entry.gate_no || ''}"
                                       data-quantity="${entry.quantity}"
                                       data-entry-id="${entry.id}"
                                       onchange="updateSelectedGatars()">
                                <div>
                                    <span class="font-bold text-blue-600">Room ${entry.room_no}</span>
                                    <span class="text-gray-500 mx-1">|</span>
                                    <span>Floor ${entry.floor}</span>
                                    <span class="text-gray-500 mx-1">|</span>
                                    <span class="font-bold text-green-600">Gatar: ${entry.gate_no || 'N/A'}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="font-bold">${entry.quantity}</span>
                                <span class="text-gray-500 text-xs">items</span>
                            </div>
                        </label>
                    `;
                });

                html += `
                    <div class="mt-2 pt-2 border-t border-gray-300">
                        <div class="flex justify-between font-bold">
                            <span>${i18n.t('total_available', 'Total Available:')}</span>
                            <span class="text-green-600">${totalQty} ${i18n.t('items', 'items')}</span>
                        </div>
                        <div class="flex justify-between text-sm text-blue-600 mt-1">
                            <span>${i18n.t('selected_colon', 'Selected:')}</span>
                            <span id="selectedGatarCount">0 ${i18n.t('items', 'items')}</span>
                        </div>
                    </div>
                    <div class="mt-2 flex gap-2">
                        <button type="button" onclick="selectAllGatars()" class="text-xs px-2 py-1 bg-blue-500 text-white rounded">${i18n.t('select_all_btn', 'Select All')}</button>
                        <button type="button" onclick="clearAllGatars()" class="text-xs px-2 py-1 bg-gray-300 rounded">${i18n.t('clear_btn', 'Clear')}</button>
                    </div>
                </div>`;

                gatarDisplay.innerHTML = html;

            } catch (error) {
                console.error('Error loading gatar info:', error);
                gatarDisplay.innerHTML = '<p class="text-red-500">' + i18n.t('error_loading_storage', 'Error loading storage locations') + '</p>';
            }
        }

        function updateSelectedGatars() {
            const checkboxes = document.querySelectorAll('.gatar-checkbox:checked');
            let totalQty = 0;
            let selectedGatars = [];

            checkboxes.forEach(cb => {
                totalQty += parseInt(cb.dataset.quantity);
                if (cb.dataset.gatar) {
                    selectedGatars.push(cb.dataset.gatar);
                }
            });

            document.getElementById('selectedGatarCount').textContent = `${totalQty} ${i18n.t('items', 'items')} (${checkboxes.length})`;

            // Store selected gatars in hidden field
            document.getElementById('approvalGateNo').value = selectedGatars.join(', ');
        }

        function selectAllGatars() {
            document.querySelectorAll('.gatar-checkbox').forEach(cb => cb.checked = true);
            updateSelectedGatars();
        }

        function clearAllGatars() {
            document.querySelectorAll('.gatar-checkbox').forEach(cb => cb.checked = false);
            updateSelectedGatars();
        }

        function closeApprovalModal() {
            document.getElementById('approvalModal').classList.add('hidden');
            document.getElementById('approvalForm').reset();

            // Reset approval button state
            const submitBtn = document.getElementById('submitApprovalBtn');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> <span data-i18n="approve">Approve</span>';
            }
            isSubmittingApproval = false;
        }

        async function submitApproval(event) {
            event.preventDefault();

            // Debounce - prevent double submission
            if (isSubmittingApproval) {
                console.log('Approval submission already in progress, ignoring');
                return;
            }

            const submitBtn = document.getElementById('submitApprovalBtn');
            const originalBtnText = submitBtn.innerHTML;

            const gatePassId = document.getElementById('approvalGatePassId').value;
            const approvedQty = parseInt(document.getElementById('approvalApprovedQty').value);
            const gateNo = document.getElementById('approvalGateNo').value.trim();
            const remarks = document.getElementById('approvalRemarks').value;

            // Validate gatar selection
            const selectedCheckboxes = document.querySelectorAll('.gatar-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                alert(i18n.t('select_pickup_location', 'Please select at least one pickup gatar location!'));
                return;
            }

            // Calculate selected quantity
            let selectedQty = 0;
            selectedCheckboxes.forEach(cb => {
                selectedQty += parseInt(cb.dataset.quantity);
            });

            if (approvedQty > selectedQty) {
                alert(i18n.t('approved_exceeds_capacity', 'Approved quantity ({approved}) exceeds selected gatar capacity ({selected} items). Please select more gatars or reduce approved quantity.').replace('{approved}', approvedQty).replace('{selected}', selectedQty));
                return;
            }

            // Lock submission - disable button and show loading state
            isSubmittingApproval = true;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Approving...';

            try {
                const response = await fetch(`/api/gate-passes/${gatePassId}/approve`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        approved_quantity: approvedQty,
                        gate_no: gateNo || 'PICKUP',
                        status: 'pending',
                        request_source: 'employee',
                        remarks: remarks
                    })
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                // 5 second cooldown with success state
                let countdown = 5;
                submitBtn.innerHTML = `<i class="bi bi-check-circle"></i> Success! ${countdown}s...`;

                const cooldownInterval = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        submitBtn.innerHTML = `<i class="bi bi-check-circle"></i> Success! ${countdown}s...`;
                    } else {
                        clearInterval(cooldownInterval);
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                        isSubmittingApproval = false;
                        closeApprovalModal();
                        loadCustomerRequests(); // Reload customer requests
                        loadRecentGatePasses(); // Reload recent passes
                    }
                }, 1000);

                alert(i18n.t('customer_request_accepted', 'Customer request accepted!') + '\n' + i18n.t('pickup_from', 'Pickup from:') + ' ' + (gateNo || 'Selected gatars') + '\n' + i18n.t('quantity', 'Quantity') + ': ' + approvedQty + ' ' + i18n.t('items', 'items'));

            } catch (error) {
                alert(i18n.t('error_approving_request', 'Error approving request') + ': ' + error.message);
                // Re-enable button on error
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                isSubmittingApproval = false;
            }
        }

        // Accept gate pass directly (for Recent Gate Passes section)
        async function acceptGatePass(gatePassId, thockNumber, requestedQty) {
            if (!confirm(i18n.t('accept_gate_pass_confirm', 'Accept gate pass for truck {truck} ({qty} items)?').replace('{truck}', thockNumber).replace('{qty}', requestedQty))) {
                return;
            }

            try {
                const response = await fetch(`/api/gate-passes/${gatePassId}/approve`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        approved_quantity: requestedQty,
                        gate_no: 'APPROVED',
                        status: 'approved',
                        remarks: 'Approved by employee'
                    })
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                alert(i18n.t('gate_pass_approved_success', 'Gate pass for truck {truck} approved successfully!').replace('{truck}', thockNumber));
                loadRecentGatePasses();
            } catch (error) {
                alert(i18n.t('error_approving_gate_pass', 'Error approving gate pass') + ': ' + error.message);
            }
        }

        async function declineGatePass(gatePassId, thockNumber) {
            if (!confirm(i18n.t('reject_gate_pass_confirm', 'Are you sure you want to reject gate pass for truck {truck}?').replace('{truck}', thockNumber))) {
                return;
            }

            try {
                // Update gate pass status to 'rejected'
                const response = await fetch(`/api/gate-passes/${gatePassId}/approve`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        approved_quantity: 0,
                        gate_no: 'REJECTED',
                        status: 'rejected',
                        remarks: 'Rejected by employee'
                    })
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                alert(i18n.t('gate_pass_rejected', 'Gate pass rejected successfully.'));
                loadCustomerRequests(); // Reload customer requests
                loadRecentGatePasses(); // Reload recent passes

            } catch (error) {
                alert(i18n.t('error_rejecting_gate_pass', 'Error rejecting gate pass') + ': ' + error.message);
            }
        }

        function goBack() {
            window.history.back();
        }

        // Load on page load
        window.addEventListener('load', async function() {
            await loadRentRate();  // Wait for rent rate before other operations
            loadAllCustomers();
            loadAllEntries();
            loadRecentGatePasses();
            loadCustomerRequests(); // Load customer requests
        });

        // Auto-refresh gate passes and customer requests every 30 seconds
        setInterval(async () => {
            try {
                await loadRecentGatePasses();
                await loadCustomerRequests();
            } catch (e) {
                console.error('Auto-refresh failed:', e);
            }
        }, 30000);

        // ========== DEBT APPROVAL FUNCTIONS ==========

        let pendingDebtData = null; // Store data for when debt approval is found

        // Check if there's an approved debt request for this customer+thock
        async function checkDebtApproval(phone, thock) {
            try {
                const response = await fetch(`/api/debt-requests/check?phone=${encodeURIComponent(phone)}&thock=${encodeURIComponent(thock)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) return null;

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error checking debt approval:', error);
                return null;
            }
        }

        // Check and display debt request status for customer
        async function checkAndDisplayDebtRequestStatus(phone) {
            const statusEl = document.getElementById('debtRequestStatus');
            statusEl.classList.add('hidden');
            statusEl.innerHTML = '';

            try {
                // Fetch all debt requests for this customer
                const response = await fetch(`/api/debt-requests/customer?phone=${encodeURIComponent(phone)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) return;

                const requests = await response.json();
                if (!requests || requests.length === 0) return;

                // Show the most recent request status
                const latestRequest = requests[0]; // API returns sorted by date DESC
                let statusHtml = '';
                let statusClass = '';

                if (latestRequest.status === 'pending') {
                    statusHtml = `‚è≥ <span class="font-bold text-yellow-600">Debt Request Pending</span> - Waiting for admin approval (${latestRequest.requested_quantity} items)`;
                    statusClass = 'text-yellow-600';
                } else if (latestRequest.status === 'approved') {
                    statusHtml = `‚úÖ <span class="font-bold text-green-600">Debt Request Approved</span> - Can take ${latestRequest.requested_quantity} items (Thock: ${latestRequest.thock_number})`;
                    statusClass = 'text-green-600';
                } else if (latestRequest.status === 'rejected') {
                    statusHtml = `‚ùå <span class="font-bold text-red-600">Debt Request Rejected</span> - ${latestRequest.rejection_reason || 'No reason provided'}`;
                    statusClass = 'text-red-600';
                }

                if (statusHtml) {
                    statusEl.innerHTML = statusHtml;
                    statusEl.className = `text-xs ${statusClass}`;
                    statusEl.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error checking debt request status:', error);
            }
        }

        // Store debt modal data for request
        let debtModalData = null;

        // Show debt approval modal
        function showDebtModal(customerName, customerPhone, thockNumber, requestedQty, balanceAmount) {
            // Store data for later use in requestDebtApproval
            debtModalData = {
                customerName: customerName,
                customerPhone: customerPhone,
                thockNumber: thockNumber,
                requestedQty: requestedQty,
                balanceAmount: balanceAmount
            };

            document.getElementById('debtAmountDisplay').textContent = '‚Çπ' + balanceAmount.toLocaleString('en-IN', { maximumFractionDigits: 0 });
            document.getElementById('debtCustomerName').textContent = customerName;
            document.getElementById('debtCustomerPhone').textContent = customerPhone;
            document.getElementById('debtThockNumber').textContent = thockNumber;
            document.getElementById('debtRequestedQty').textContent = requestedQty;

            // Reset UI
            document.getElementById('debtApprovalStatus').classList.add('hidden');
            document.getElementById('debtRequestActions').classList.remove('hidden');
            document.getElementById('debtProceedActions').classList.add('hidden');

            document.getElementById('debtApprovalModal').classList.remove('hidden');
        }

        function closeDebtModal() {
            document.getElementById('debtApprovalModal').classList.add('hidden');
            pendingDebtData = null;
            debtModalData = null;
        }

        // Request debt approval from admin
        async function requestDebtApproval() {
            if (!debtModalData) {
                alert('Error: No debt request data available');
                return;
            }

            const btn = document.getElementById('requestDebtBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Requesting...';

            try {
                const response = await fetch('/api/debt-requests', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        customer_phone: debtModalData.customerPhone,
                        customer_name: debtModalData.customerName,
                        customer_so: '', // Can be added later
                        thock_number: debtModalData.thockNumber,
                        requested_quantity: debtModalData.requestedQty,
                        current_balance: debtModalData.balanceAmount
                    })
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                alert('Debt approval request sent to admin! Please wait for approval before issuing gate pass.');
                closeDebtModal();

            } catch (error) {
                alert('Error requesting approval: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-send"></i> Request Admin Approval';
            }
        }

        // Proceed with gate pass after debt approval is confirmed
        async function proceedWithDebtApproval() {
            if (!pendingDebtData) {
                closeDebtModal();
                return;
            }

            // Close modal and submit the gate pass
            closeDebtModal();

            // Re-run submitGatePass with debt approval flag
            await submitGatePassWithDebt(pendingDebtData.debtRequestId);
        }

        // Submit gate pass with debt approval
        async function submitGatePassWithDebt(debtRequestId) {
            const submitBtn = document.getElementById('submitGatePassBtn');
            const originalBtnText = submitBtn.innerHTML;

            const customerId = parseInt(document.getElementById('customerId').value);
            const requestedQty = parseInt(document.getElementById('requestedQty').value) || 0;
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value) || 0;
            const recipientName = document.getElementById('recipientName').value.trim();
            const remarks = document.getElementById('remarks').value.trim();

            let finalRemarks = '';
            if (recipientName) {
                finalRemarks = `Recipient: ${recipientName}`;
            }
            finalRemarks += (finalRemarks ? ' | ' : '') + 'DEBT APPROVED';
            if (remarks) {
                finalRemarks += ' | ' + remarks;
            }

            const gatePassData = {
                customer_id: customerId,
                thock_number: document.getElementById('thockNumber').value.trim(),
                entry_id: null,
                requested_quantity: requestedQty,
                payment_verified: true,
                payment_amount: paymentAmount,
                remarks: finalRemarks,
                debt_request_id: debtRequestId
            };

            isSubmittingGatePass = true;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Issuing...';

            try {
                const response = await fetch('/api/gate-passes', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(gatePassData)
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                const result = await response.json();
                showSuccess(result.id);
                loadRecentGatePasses();

            } catch (error) {
                alert(i18n.t('error_issuing_gate_pass', 'Error issuing gate pass') + ': ' + error.message);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                isSubmittingGatePass = false;
            }
        }
    </script>

</body>
</html>
