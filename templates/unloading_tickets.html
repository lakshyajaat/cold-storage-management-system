<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png?v=2">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n-page-title="page_title_unloading">Unloading Tickets - Cold Storage</title>
    <link rel="stylesheet" href="/static/css/bootstrap-icons.min.css">
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link href="/static/css/arbitrary.css" rel="stylesheet">
    <link href="/static/css/fonts.css" rel="stylesheet">
    <link href="/static/css/dark-mode.css" rel="stylesheet">

    <style>
        * {
            font-family: 'Space Grotesk', sans-serif;
        }
        .neu-border {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            transition: all 0.2s ease;
        }
        .neu-border:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #000;
        }
        .neu-input {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            padding: 0.75rem;
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        .neu-input:focus {
            outline: none;
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #000;
        }
        .neu-button {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .neu-button:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #000;
        }
        .neu-button:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 #000;
        }
        .hidden { display: none; }
        .clickable-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .clickable-row:hover {
            background-color: #FEF3C7;
        }
        .selected-ticket {
            background-color: #FDE68A !important;
            border-left: 4px solid #F59E0B;
        }
        .lang-selector {
            border: 2px solid #000;
            box-shadow: 2px 2px 0px #000;
        }
    </style>
    <script src="/static/js/theme.js"></script>
</head>
<body class="bg-[#FFF9E6] min-h-screen p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 md:mb-8 neu-border bg-white p-4 md:p-6 gap-4">
            <div>
                <div class="flex items-center gap-3">
                    <i class="bi bi-ticket-perforated text-3xl md:text-4xl text-purple-600"></i>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold" data-i18n="unloading_title">Unloading Tickets</h1>
                        <p class="text-gray-600 text-sm md:text-base" data-i18n="approve_process_passes">Approve and process gate passes</p>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 items-center w-full md:w-auto justify-end">
                <!-- Language Selector -->
                <select id="langSelector" onchange="i18n.setLanguage(this.value)"
                        class="lang-selector bg-white px-3 py-2 text-sm font-medium cursor-pointer">
                    <option value="en">EN</option>
                    <option value="hi">‡§π‡§ø‡§Ç</option>
                </select>
                <!-- Theme Toggle -->
                <button onclick="theme.toggle()" class="neu-border bg-gray-200 px-3 py-2" title="Toggle Dark Mode">
                    <i class="bi bi-moon-fill theme-icon-moon"></i>
                    <i class="bi bi-sun-fill theme-icon-sun hidden"></i>
                </button>
                <!-- Fullscreen Toggle (Tablets) -->
                <button onclick="goBack()" class="neu-button bg-gray-200">
                    <i class="bi bi-arrow-left"></i> <span data-i18n="back">Back</span>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-10 gap-4 md:gap-6">
            <!-- Left: Approval Form (60%) -->
            <div class="md:col-span-6">
                <div class="neu-border bg-white p-6">
                    <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                        <i class="bi bi-check2-circle text-green-600"></i>
                        <span data-i18n="approval_form">Approval Form</span>
                    </h2>

                    <div id="noSelection" class="p-8 text-center text-gray-500">
                        <i class="bi bi-hand-index text-6xl mb-4"></i>
                        <p data-i18n="select_gate_pass_approve">Select a gate pass to approve</p>
                    </div>

                    <form id="approvalForm" class="hidden" onsubmit="approveGatePass(event)">
                        <input type="hidden" id="gatePassId">

                        <!-- Customer Details -->
                        <div class="mb-4 p-4 bg-yellow-50 neu-border">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm font-semibold text-gray-700 mb-1"><span data-i18n="thock_number">Thok NO</span>:</p>
                                    <p class="text-xl font-bold text-purple-700" id="selectedTruckNumber">-</p>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-gray-700 mb-1"><span data-i18n="phone">Phone</span>:</p>
                                    <p class="text-lg font-bold text-blue-600" id="selectedPhone">-</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                                <div>
                                    <p class="text-sm font-semibold text-gray-700 mb-1"><span data-i18n="customer_name">Customer</span>:</p>
                                    <p class="font-bold" id="selectedCustomerName">-</p>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-gray-700 mb-1"><span data-i18n="village">Village</span>:</p>
                                    <p class="font-bold text-green-700" id="selectedVillage">-</p>
                                </div>
                            </div>
                        </div>

                        <!-- Storage Details -->
                        <div class="mb-4 p-4 bg-blue-50 neu-border">
                            <p class="text-sm font-semibold text-gray-700 mb-2"><span data-i18n="storage_details">Storage Details</span>:</p>
                            <div class="grid grid-cols-3 md:grid-cols-3 gap-4">
                                <div>
                                    <p class="text-xs text-gray-600"><span data-i18n="rooms">Rooms</span>:</p>
                                    <p class="font-bold text-lg text-blue-600" id="selectedRooms">-</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-600"><span data-i18n="floors">Floors</span>:</p>
                                    <p class="font-bold text-lg text-green-600" id="selectedFloors">-</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-600"><span data-i18n="gatars">Gatars</span>:</p>
                                    <p class="font-bold text-lg text-purple-600" id="selectedGatars">-</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                                <div>
                                    <p class="text-xs text-gray-600"><span data-i18n="quantity_breakdown">Quantity Breakdown</span>:</p>
                                    <p class="font-mono text-sm font-bold" id="selectedQtyBreakdown">-</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-600"><span data-i18n="remark">Remark</span>:</p>
                                    <p class="font-bold text-red-600" id="selectedRemark">-</p>
                                </div>
                            </div>
                        </div>

                        <!-- Pickup History (OUT) -->
                        <div class="mb-4 p-4 bg-red-50 neu-border" id="pickupHistorySection" style="display: none;">
                            <p class="text-sm font-semibold text-gray-700 mb-2">
                                <i class="bi bi-clock-history text-red-600"></i> <span data-i18n="pickup_history">Pickup History (OUT)</span>
                            </p>
                            <div id="pickupHistoryList" class="text-sm max-h-32 overflow-y-auto">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>

                        <div class="mb-4 p-3 bg-white neu-border">
                            <p class="text-sm font-semibold text-gray-700 mb-2"><span data-i18n="storage_location_label">Storage Location</span>:</p>
                            <div class="grid grid-cols-2 gap-3">
                                <!-- Left: Room Selection Display -->
                                <div>
                                    <p class="text-xs text-gray-600 mb-1 font-semibold" data-i18n="room_no">Room No</p>
                                    <div class="space-y-1">
                                        <div class="grid grid-cols-2 gap-1">
                                            <div class="location-box room-2 neu-border bg-gray-100 text-gray-400 py-2 text-center text-sm font-bold">
                                                Room 2
                                            </div>
                                            <div class="location-box room-1 neu-border bg-gray-100 text-gray-400 py-2 text-center text-sm font-bold">
                                                Room 1
                                            </div>
                                        </div>
                                        <div class="location-box room-g neu-border bg-gray-100 text-gray-400 py-2 text-center text-sm font-bold">
                                            Gallery
                                        </div>
                                        <div class="grid grid-cols-2 gap-1">
                                            <div class="location-box room-3 neu-border bg-gray-100 text-gray-400 py-2 text-center text-sm font-bold">
                                                Room 3
                                            </div>
                                            <div class="location-box room-4 neu-border bg-gray-100 text-gray-400 py-2 text-center text-sm font-bold">
                                                Room 4
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Right: Floor Display -->
                                <div>
                                    <p class="text-xs text-gray-600 mb-1 font-semibold" data-i18n="floor">Floor</p>
                                    <div class="grid grid-cols-1 gap-1">
                                        <div class="location-box floor-5 neu-border bg-gray-100 text-gray-400 py-2 text-center text-sm font-bold">5</div>
                                        <div class="location-box floor-4 neu-border bg-gray-100 text-gray-400 py-2 text-center text-sm font-bold">4</div>
                                        <div class="location-box floor-3 neu-border bg-gray-100 text-gray-400 py-2 text-center text-sm font-bold">3</div>
                                        <div class="location-box floor-2 neu-border bg-gray-100 text-gray-400 py-2 text-center text-sm font-bold">2</div>
                                        <div class="location-box floor-1 neu-border bg-gray-100 text-gray-400 py-2 text-center text-sm font-bold">1</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Gatar Display -->
                            <div class="mt-3">
                                <p class="text-xs text-gray-600 mb-1 font-semibold" data-i18n="gatar_no">Gatar No</p>
                                <div class="neu-border bg-gray-100 text-gray-700 p-2 text-center font-bold" id="selectedGatar">-</div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <span data-i18n="approved_quantity">Approved Quantity</span> *
                            </label>
                            <input
                                type="number"
                                id="approvedQuantity"
                                required
                                min="1"
                                class="w-full neu-input"
                                placeholder="Enter approved quantity"
                            >
                            <p class="text-xs text-gray-600 mt-1">
                                <span data-i18n="requested">Requested</span>: <span id="requestedQty" class="font-bold">-</span>
                            </p>
                        </div>

                        <!-- Pickup Gatar Selection - Visual Grid -->
                        <div class="mb-4 p-3 bg-green-50 neu-border">
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-semibold text-gray-700">
                                    <i class="bi bi-geo-alt"></i> <span data-i18n="select_pickup_gatar">Select Pickup Gatar(s)</span> *
                                </label>
                                <div class="flex gap-2">
                                    <button type="button" onclick="selectAllPickupGatars()" class="px-3 py-2 bg-blue-500 text-white rounded text-sm font-bold">
                                        <i class="bi bi-check-all"></i> <span data-i18n="select_all">All</span>
                                    </button>
                                    <button type="button" onclick="clearAllPickupGatars()" class="px-3 py-2 bg-red-100 text-red-600 rounded text-sm font-bold">
                                        <i class="bi bi-x-circle"></i> <span data-i18n="clear">Clear</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Selection Summary -->
                            <div id="pickupSelectionSummary" class="bg-white rounded p-2 mb-2 border border-green-300 text-center">
                                <p class="text-gray-500 text-sm" data-i18n="select_gate_pass_first">Select a gate pass first</p>
                            </div>

                            <!-- Gatar Grid Container -->
                            <div id="pickupGatarList" class="max-h-48 overflow-y-auto">
                                <!-- Will be populated by JavaScript -->
                            </div>

                            <input type="hidden" id="gateNo" value="">

                            <!-- Total Selected -->
                            <div class="mt-2 p-2 bg-blue-100 rounded text-center">
                                <span class="text-sm font-bold text-blue-800">
                                    <span data-i18n="total_selected">Total Selected</span>: <span id="selectedGatarCount" class="text-lg">0 <span data-i18n="items">items</span></span>
                                </span>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <span data-i18n="status">Status</span> *
                            </label>
                            <select id="status" required class="w-full neu-input">
                                <option value="approved" data-i18n="approved">Approved</option>
                                <option value="rejected" data-i18n="rejected">Rejected</option>
                            </select>
                <!-- Theme Toggle -->
                <button onclick="theme.toggle()" class="neu-border bg-gray-200 px-3 py-2" title="Toggle Dark Mode">
                    <i class="bi bi-moon-fill theme-icon-moon"></i>
                    <i class="bi bi-sun-fill theme-icon-sun hidden"></i>
                </button>
                <!-- Fullscreen Toggle (Tablets) -->
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-2" data-i18n="remarks">
                                Remarks
                            </label>
                            <textarea
                                id="approvalRemarks"
                                class="w-full neu-input"
                                rows="3"
                                placeholder="Enter remarks (optional)"
                            ></textarea>
                        </div>

                        <div class="flex gap-3">
                            <button type="submit" class="neu-button bg-green-500 text-white flex-1">
                                <i class="bi bi-check-circle"></i> <span data-i18n="approve">Approve</span>
                            </button>
                            <button type="button" onclick="clearSelection()" class="neu-button bg-gray-300">
                                <i class="bi bi-x-circle"></i> <span data-i18n="cancel">Cancel</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Approved Gate Passes -->
                <div class="neu-border bg-white p-6 mt-8">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <i class="bi bi-clipboard-check text-blue-600"></i>
                        <span data-i18n="approved_passes_pickup">Approved Passes - Record Pickup</span>
                    </h2>
                    <div id="approvedPasses" class="overflow-auto" style="max-height: 400px;">
                        <table class="w-full text-sm">
                            <thead class="sticky top-0 bg-white">
                                <tr class="border-b-2 border-black">
                                    <th class="text-left p-2 font-bold" data-i18n="thock_number">Thok</th>
                                    <th class="text-left p-2 font-bold" data-i18n="progress">Progress</th>
                                    <th class="text-left p-2 font-bold" data-i18n="action">Action</th>
                                </tr>
                            </thead>
                            <tbody id="approvedTableBody">
                                <tr>
                                    <td colspan="3" class="text-center p-4 text-gray-500" data-i18n="no_approved_passes">No approved passes</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right: Pending Tickets (40%) -->
            <div class="md:col-span-4">
                <div class="neu-border bg-white p-4">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-xl font-bold flex items-center gap-2">
                            <i class="bi bi-list-check text-yellow-600"></i>
                            <span data-i18n="pending_gate_passes">Pending Gate Passes</span>
                        </h2>
                        <button onclick="loadPendingGatePasses()" class="neu-button bg-blue-500 text-white text-sm px-3 py-2">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div id="pendingTickets" class="overflow-auto" style="max-height: 700px;">
                        <table class="w-full text-sm">
                            <thead class="sticky top-0 bg-white">
                                <tr class="border-b-2 border-black">
                                    <th class="text-left p-2 font-bold" data-i18n="thock_number">Thok</th>
                                    <th class="text-left p-2 font-bold" data-i18n="customer_name">Customer</th>
                                    <th class="text-left p-2 font-bold" data-i18n="qty">Qty</th>
                                    <th class="text-left p-2 font-bold" data-i18n="expires">Expires</th>
                                </tr>
                            </thead>
                            <tbody id="ticketsTableBody">
                                <tr>
                                    <td colspan="4" class="text-center p-4 text-gray-500" data-i18n="loading">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Record Pickup Modal -->
    <div id="pickupModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="neu-border bg-white p-4 md:p-8 max-w-md w-full mx-2 md:mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-6 flex items-center gap-2">
                <i class="bi bi-box-arrow-up text-green-600"></i>
                <span data-i18n="record_pickup_title">Record Pickup</span>
            </h3>
            <form id="pickupForm" onsubmit="submitPickup(event)">
                <input type="hidden" id="pickupGatePassId">

                <div class="mb-4 p-3 md:p-4 bg-blue-50 neu-border">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600"><span data-i18n="thock">Thok</span>:</p>
                            <p class="font-bold text-xl" id="pickupThockNumber"></p>
                            <p class="text-sm text-gray-600 mt-2"><span data-i18n="recipient">Recipient</span>:</p>
                            <p class="font-bold text-purple-600" id="pickupRecipient"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600"><span data-i18n="approved">Approved</span>:</p>
                            <p class="font-bold" id="pickupApprovedQty"></p>
                            <p class="text-sm text-gray-600 mt-1"><span data-i18n="pickup">Picked Up</span>:</p>
                            <p class="font-bold text-green-600" id="pickupAlreadyPickedUp"></p>
                            <p class="text-sm text-gray-600 mt-1"><span data-i18n="remaining_quantity">Remaining</span>:</p>
                            <p class="font-bold text-orange-600" id="pickupRemaining"></p>
                        </div>
                    </div>
                </div>

                <!-- Storage Location -->
                <div class="mb-4 p-4 bg-yellow-50 neu-border">
                    <p class="text-sm font-semibold text-gray-700 mb-2">üìç <span data-i18n="storage_location_items">Storage Location (Items are stored here)</span>:</p>
                    <div id="storageLocationInfo" class="text-center">
                        <span class="text-gray-500" data-i18n="loading">Loading...</span>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <span data-i18n="pickup_quantity">Pickup Quantity</span> *
                    </label>
                    <input
                        type="number"
                        id="pickupQuantity"
                        required
                        min="1"
                        class="w-full neu-input"
                        data-i18n-placeholder="enter_pickup_qty"
                        placeholder="Enter quantity being picked up now"
                    >
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2" data-i18n="room_no">Room No</label>
                        <select id="pickupRoomNo" class="w-full neu-input">
                            <option value="" data-i18n="select_room">Select Room</option>
                            <option value="1">Room 1</option>
                            <option value="2">Room 2</option>
                            <option value="3">Room 3</option>
                            <option value="4">Room 4</option>
                            <option value="G" data-i18n="gallery">Gallery</option>
                        </select>
                <!-- Theme Toggle -->
                <button onclick="theme.toggle()" class="neu-border bg-gray-200 px-3 py-2" title="Toggle Dark Mode">
                    <i class="bi bi-moon-fill theme-icon-moon"></i>
                    <i class="bi bi-sun-fill theme-icon-sun hidden"></i>
                </button>
                <!-- Fullscreen Toggle (Tablets) -->
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2" data-i18n="floor">Floor</label>
                        <select id="pickupFloor" class="w-full neu-input">
                            <option value="" data-i18n="select_floor">Select Floor</option>
                            <option value="1">Floor 1</option>
                            <option value="2">Floor 2</option>
                            <option value="3">Floor 3</option>
                            <option value="4">Floor 4</option>
                            <option value="5">Floor 5</option>
                        </select>
                <!-- Theme Toggle -->
                <button onclick="theme.toggle()" class="neu-border bg-gray-200 px-3 py-2" title="Toggle Dark Mode">
                    <i class="bi bi-moon-fill theme-icon-moon"></i>
                    <i class="bi bi-sun-fill theme-icon-sun hidden"></i>
                </button>
                <!-- Fullscreen Toggle (Tablets) -->
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2"><span data-i18n="remarks">Remarks</span> (<span data-i18n="any_notes">Optional</span>)</label>
                    <textarea id="pickupRemarks" class="w-full neu-input" rows="2" data-i18n-placeholder="any_notes" placeholder="Any notes"></textarea>
                </div>

                <div class="flex gap-4">
                    <button type="submit" class="neu-button bg-green-500 text-white flex-1">
                        <i class="bi bi-check-circle"></i> <span data-i18n="record_pickup">Record Pickup</span>
                    </button>
                    <button type="button" onclick="closePickupModal()" class="neu-button bg-gray-300">
                        <i class="bi bi-x-circle"></i> <span data-i18n="cancel">Cancel</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- i18n Script -->
    <script src="/static/js/prefetch.js?v=5"></script>
    <script src="/static/js/i18n.js"></script>
    <script>
        const token = localStorage.getItem('token');
        let selectedGatePass = null;
        let allGatePasses = [];
        let pickupRoomEntries = []; // Store room entries for pickup gatar selection

        async function loadPendingGatePasses() {
            try {
                const response = await fetch('/api/gate-passes/pending', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('Failed to load pending gate passes');
                }

                const gatePasses = await response.json();
                displayPendingTickets(gatePasses || []);

            } catch (error) {
                console.error('Error loading pending gate passes:', error);
                document.getElementById('ticketsTableBody').innerHTML =
                    `<tr><td colspan="7" class="text-center p-4 text-red-500">${i18n.t('failed_load_tickets', 'Failed to load tickets')}</td></tr>`;
            }
        }

        // Calculate remaining time until expiration
        function getRemainingTime(expiresAt) {
            if (!expiresAt) return { text: 'N/A', color: 'text-gray-500' };

            const now = new Date();
            const expires = new Date(expiresAt);
            const diff = expires - now;

            if (diff <= 0) {
                return { text: i18n.t('expired', 'EXPIRED').toUpperCase(), color: 'text-red-600 font-bold' };
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

            let color = 'text-green-600'; // >24h
            if (hours < 6) {
                color = 'text-red-600 font-bold'; // <6h critical
            } else if (hours < 12) {
                color = 'text-orange-600 font-bold'; // <12h warning
            } else if (hours < 24) {
                color = 'text-yellow-600'; // <24h caution
            }

            return {
                text: `${hours}h ${minutes}m`,
                color: color
            };
        }

        function displayPendingTickets(gatePasses) {
            const tbody = document.getElementById('ticketsTableBody');

            if (gatePasses.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-gray-500">${i18n.t('no_pending_tickets', 'No pending tickets')}</td></tr>`;
                return;
            }

            tbody.innerHTML = gatePasses.map(gp => {
                // Calculate remaining time
                const remaining = getRemainingTime(gp.expires_at);

                // If expired, add visual indicator
                const rowClass = gp.is_expired ? 'clickable-row border-b border-gray-200 bg-red-50 hover:bg-red-100' : 'clickable-row border-b border-gray-200 hover:bg-blue-50';

                // Color code truck number based on expiration time
                const truckColor = remaining.color;

                return `
                    <tr class="${rowClass} cursor-pointer"
                        onclick='selectTicket(${JSON.stringify(gp)})'>
                        <td class="p-2 font-bold ${truckColor}">${gp.thock_number}</td>
                        <td class="p-2 text-sm truncate max-w-[120px]" title="${gp.customer_name}">${gp.customer_name}</td>
                        <td class="p-2 font-bold">${gp.requested_quantity}</td>
                        <td class="p-2 text-xs font-bold ${remaining.color}">${remaining.text}</td>
                    </tr>
                `;
            }).join('');
        }

        // Store selected gatars with quantities
        let selectedPickupGatars = {};

        // Load pickup gatar options for a selected gate pass
        async function loadPickupGatars(thockNumber) {
            const container = document.getElementById('pickupGatarList');
            const summaryDiv = document.getElementById('pickupSelectionSummary');
            container.innerHTML = '<p class="text-gray-500 text-sm text-center p-4">Loading storage locations...</p>';
            summaryDiv.innerHTML = '<p class="text-gray-500 text-sm">Loading...</p>';
            selectedPickupGatars = {};

            try {
                const response = await fetch('/api/room-entries', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load room entries');

                const roomEntries = await response.json();
                pickupRoomEntries = roomEntries.filter(re => re.thock_number === thockNumber);

                if (pickupRoomEntries.length === 0) {
                    container.innerHTML = '<p class="text-red-500 text-sm text-center p-4">No storage locations found for this truck</p>';
                    summaryDiv.innerHTML = '<p class="text-red-500 text-sm">No items in storage</p>';
                    return;
                }

                // Group by Room and Floor
                const grouped = {};
                pickupRoomEntries.forEach((re, idx) => {
                    const key = `R${re.room_no}-F${re.floor}`;
                    if (!grouped[key]) {
                        grouped[key] = {
                            room: re.room_no,
                            floor: re.floor,
                            entries: []
                        };
                    }
                    grouped[key].entries.push({ ...re, idx });
                });

                // Create visual grid like room configurator
                let html = '';
                let cellIndex = 0;

                Object.keys(grouped).forEach(key => {
                    const group = grouped[key];
                    const totalQty = group.entries.reduce((sum, e) => sum + e.quantity, 0);

                    html += `
                        <div class="mb-3 bg-green-50 border-2 border-green-400 rounded-lg p-3">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <span class="text-green-800 font-bold">
                                        <i class="bi bi-geo-alt-fill mr-1"></i>
                                        Room ${group.room} - Floor ${group.floor}
                                    </span>
                                </div>
                                <span class="text-xs text-green-700 font-bold">${totalQty} items available</span>
                            </div>

                            <!-- Gatar Number Grid -->
                            <div class="bg-white rounded-lg p-2 border border-green-300">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-xs text-gray-500">
                                        <i class="bi bi-hand-index-thumb mr-1"></i> CLICK TO SELECT, THEN ENTER QTY
                                    </span>
                                </div>
                                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-2 max-h-60 overflow-y-auto">
                    `;

                    // Generate individual clickable cells for EACH gatar number
                    group.entries.forEach(re => {
                        // Split gate_no if it contains multiple numbers (comma or space separated)
                        const gateNos = re.gate_no.toString().split(/[,\s]+/).filter(g => g.trim());

                        gateNos.forEach(gateNo => {
                            const trimmedGate = gateNo.trim();
                            if (trimmedGate) {
                                html += `
                                    <div id="gatar-cell-${cellIndex}"
                                         class="gatar-cell p-2 rounded border-2 border-gray-200 transition-all bg-white"
                                         data-idx="${cellIndex}"
                                         data-room="${re.room_no}"
                                         data-floor="${re.floor}"
                                         data-gate="${trimmedGate}"
                                         data-entry-id="${re.id}">
                                        <div class="text-center cursor-pointer" onclick="toggleGatarCell(${cellIndex})">
                                            <span class="font-mono text-lg font-bold text-purple-700">${trimmedGate}</span>
                                        </div>
                                        <div id="qty-row-${cellIndex}" class="hidden mt-2">
                                            <input type="number"
                                                   id="qty-${cellIndex}"
                                                   class="w-full p-1 text-center border-2 border-green-400 rounded text-sm font-bold"
                                                   min="1"
                                                   placeholder="Qty"
                                                   onchange="updateGatarQty(${cellIndex})"
                                                   onclick="event.stopPropagation()">
                                        </div>
                                    </div>
                                `;
                                cellIndex++;
                            }
                        });
                    });

                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
                summaryDiv.innerHTML = '<p class="text-gray-500 text-sm">Click gatar ‚Üí Enter quantity</p>';

            } catch (error) {
                console.error('Error loading pickup gatars:', error);
                container.innerHTML = '<p class="text-red-500 text-sm text-center p-4">Failed to load storage locations</p>';
            }
        }

        function toggleGatarCell(idx) {
            const cell = document.getElementById(`gatar-cell-${idx}`);
            const qtyRow = document.getElementById(`qty-row-${idx}`);
            const qtyInput = document.getElementById(`qty-${idx}`);

            if (selectedPickupGatars[idx] !== undefined) {
                // Deselect
                delete selectedPickupGatars[idx];
                cell.classList.remove('border-green-500', 'bg-green-50');
                cell.classList.add('border-gray-200', 'bg-white');
                qtyRow.classList.add('hidden');
                qtyInput.value = '';
            } else {
                // Select - show quantity input
                selectedPickupGatars[idx] = 0;
                cell.classList.add('border-green-500', 'bg-green-50');
                cell.classList.remove('border-gray-200', 'bg-white');
                qtyRow.classList.remove('hidden');
                qtyInput.focus();
            }
            updatePickupGatarCount();
        }

        function updateGatarQty(idx) {
            const qtyInput = document.getElementById(`qty-${idx}`);
            const qty = parseInt(qtyInput.value) || 0;
            if (qty > 0) {
                selectedPickupGatars[idx] = qty;
            } else {
                selectedPickupGatars[idx] = 0;
            }
            updatePickupGatarCount();
        }

        function updatePickupGatarCount() {
            let totalItems = 0;
            let gatarDetails = [];
            let summaryParts = [];

            Object.keys(selectedPickupGatars).forEach(idx => {
                const cell = document.getElementById(`gatar-cell-${idx}`);
                if (cell) {
                    const qty = selectedPickupGatars[idx];
                    const gate = cell.dataset.gate;
                    totalItems += qty;
                    gatarDetails.push(`${gate}:${qty}`);
                    summaryParts.push(`<span class="inline-block bg-green-500 text-white px-2 py-1 rounded text-xs font-bold m-1">G${gate}: ${qty}</span>`);
                }
            });

            document.getElementById('selectedGatarCount').textContent = totalItems + ' items';
            document.getElementById('gateNo').value = gatarDetails.join(',');

            const summaryDiv = document.getElementById('pickupSelectionSummary');
            if (summaryParts.length > 0) {
                summaryDiv.innerHTML = summaryParts.join('');
            } else {
                summaryDiv.innerHTML = '<p class="text-gray-500 text-sm">Click on gatar numbers to select</p>';
            }
        }

        function selectAllPickupGatars() {
            document.querySelectorAll('.gatar-cell').forEach(cell => {
                const idx = parseInt(cell.dataset.idx);
                const qtyRow = document.getElementById(`qty-row-${idx}`);

                selectedPickupGatars[idx] = 0;
                cell.classList.add('border-green-500', 'bg-green-50');
                cell.classList.remove('border-gray-200', 'bg-white');
                qtyRow.classList.remove('hidden');
            });
            updatePickupGatarCount();
        }

        function clearAllPickupGatars() {
            document.querySelectorAll('.gatar-cell').forEach(cell => {
                const idx = parseInt(cell.dataset.idx);
                const qtyRow = document.getElementById(`qty-row-${idx}`);
                const qtyInput = document.getElementById(`qty-${idx}`);

                cell.classList.remove('border-green-500', 'bg-green-50');
                cell.classList.add('border-gray-200', 'bg-white');
                qtyRow.classList.add('hidden');
                if (qtyInput) qtyInput.value = '';
            });
            selectedPickupGatars = {};
            updatePickupGatarCount();
        }

        function selectTicket(gatePass) {
            selectedGatePass = gatePass;

            // Remove previous selection
            document.querySelectorAll('.clickable-row').forEach(row => {
                row.classList.remove('selected-ticket');
            });

            // Add selection to clicked row
            event.currentTarget.classList.add('selected-ticket');

            // Show approval form
            document.getElementById('noSelection').classList.add('hidden');
            document.getElementById('approvalForm').classList.remove('hidden');

            // Fill form
            document.getElementById('gatePassId').value = gatePass.id;
            document.getElementById('selectedTruckNumber').textContent = gatePass.thock_number;
            document.getElementById('selectedPhone').textContent = gatePass.customer_phone || '-';
            document.getElementById('selectedCustomerName').textContent = gatePass.customer_name || '-';
            document.getElementById('selectedVillage').textContent = gatePass.customer_village || '-';
            document.getElementById('selectedRooms').textContent = gatePass.rooms || '-';
            document.getElementById('selectedFloors').textContent = gatePass.floors || '-';
            document.getElementById('selectedGatars').textContent = gatePass.gatars || '-';
            document.getElementById('selectedRemark').textContent = gatePass.remark || '-';

            // Format quantity breakdown: "302 (30, 30, 30, ...)"
            const totalQty = gatePass.total_qty || gatePass.requested_quantity;
            const breakdown = gatePass.qty_breakdown || '';
            document.getElementById('selectedQtyBreakdown').textContent =
                breakdown ? `${totalQty} (${breakdown})` : `${totalQty}`;

            document.getElementById('requestedQty').textContent = gatePass.requested_quantity;
            document.getElementById('approvedQuantity').value = gatePass.requested_quantity;

            // Fill location information - Reset all boxes first
            document.querySelectorAll('.location-box').forEach(box => {
                box.classList.remove('bg-red-500', 'text-white');
                box.classList.add('bg-gray-100', 'text-gray-400');
            });

            // Highlight rooms from aggregated data
            if (gatePass.rooms) {
                const roomList = gatePass.rooms.split(',').map(r => r.trim().toLowerCase());
                roomList.forEach(room => {
                    let roomClass = `.room-${room}`;
                    if (room === 'g' || room === 'gallery') roomClass = '.room-g';
                    const roomBox = document.querySelector(roomClass);
                    if (roomBox) {
                        roomBox.classList.remove('bg-gray-100', 'text-gray-400');
                        roomBox.classList.add('bg-red-500', 'text-white');
                    }
                });
            }

            // Highlight floors from aggregated data
            if (gatePass.floors) {
                const floorList = gatePass.floors.split(',').map(f => f.trim());
                floorList.forEach(floor => {
                    const floorBox = document.querySelector(`.floor-${floor}`);
                    if (floorBox) {
                        floorBox.classList.remove('bg-gray-100', 'text-gray-400');
                        floorBox.classList.add('bg-red-500', 'text-white');
                    }
                });
            }

            // Display gatar in the location box
            const gatarElement = document.getElementById('selectedGatar');
            if (gatePass.gatars) {
                gatarElement.textContent = gatePass.gatars;
                gatarElement.classList.remove('bg-gray-100', 'text-gray-700');
                gatarElement.classList.add('bg-red-500', 'text-white');
            } else {
                gatarElement.textContent = '-';
                gatarElement.classList.remove('bg-red-500', 'text-white');
                gatarElement.classList.add('bg-gray-100', 'text-gray-700');
            }

            // Load pickup gatar options
            loadPickupGatars(gatePass.thock_number);

            // Load pickup history by thock number (shows all historical pickups)
            loadPickupHistory(gatePass.thock_number);
        }

        // Format date/time for display
        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('en-IN', {
                day: '2-digit',
                month: 'short',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Load and display pickup history for a thock number (across all gate passes)
        async function loadPickupHistory(thockNumber) {
            try {
                const res = await fetch(`/api/gate-passes/pickups/by-thock?thock_number=${encodeURIComponent(thockNumber)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const pickups = await res.json();
                    displayPickupHistory(pickups);
                } else {
                    document.getElementById('pickupHistorySection').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading pickup history:', error);
                document.getElementById('pickupHistorySection').style.display = 'none';
            }
        }

        function displayPickupHistory(pickups) {
            const section = document.getElementById('pickupHistorySection');
            const list = document.getElementById('pickupHistoryList');

            if (!pickups || pickups.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            list.innerHTML = pickups.map(p => {
                // Format gatar breakdown if available
                let gatarHtml = '';
                if (p.gatar_breakdown && p.gatar_breakdown.length > 0) {
                    const gatarList = p.gatar_breakdown.map(g =>
                        `<span class="bg-purple-100 text-purple-700 px-1 rounded">G${g.gatar_no}: ${g.quantity}</span>`
                    ).join(' ');
                    gatarHtml = `<div class="text-xs mt-1">${gatarList}</div>`;
                }

                return `
                <div class="py-2 border-b border-red-200 last:border-0">
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="font-bold text-red-600">${p.pickup_quantity} bags</span>
                            <span class="text-gray-600 ml-2">by ${p.picked_up_by_user_name || 'Unknown'}</span>
                        </div>
                        <div class="text-xs text-gray-500">
                            ${formatDateTime(p.pickup_time)}
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                        <span class="bg-gray-100 px-1 rounded">Room ${p.room_no || '-'}</span>
                        <span class="bg-gray-100 px-1 rounded ml-1">Floor ${p.floor || '-'}</span>
                        ${p.remarks ? `<span class="text-blue-600 ml-2">${p.remarks}</span>` : ''}
                    </div>
                    ${gatarHtml}
                </div>
            `}).join('');
        }

        function clearSelection() {
            selectedGatePass = null;
            pickupRoomEntries = [];

            // Remove selection
            document.querySelectorAll('.clickable-row').forEach(row => {
                row.classList.remove('selected-ticket');
            });

            // Hide approval form
            document.getElementById('noSelection').classList.remove('hidden');
            document.getElementById('approvalForm').classList.add('hidden');

            // Reset form
            document.getElementById('approvalForm').reset();

            // Reset new fields
            document.getElementById('selectedPhone').textContent = '-';
            document.getElementById('selectedCustomerName').textContent = '-';
            document.getElementById('selectedVillage').textContent = '-';
            document.getElementById('selectedRooms').textContent = '-';
            document.getElementById('selectedFloors').textContent = '-';
            document.getElementById('selectedGatars').textContent = '-';
            document.getElementById('selectedRemark').textContent = '-';
            document.getElementById('selectedQtyBreakdown').textContent = '-';

            // Hide pickup history
            document.getElementById('pickupHistorySection').style.display = 'none';

            // Reset location boxes
            document.querySelectorAll('.location-box').forEach(box => {
                box.classList.remove('bg-red-500', 'text-white');
                box.classList.add('bg-gray-100', 'text-gray-400');
            });
            const gatarElement = document.getElementById('selectedGatar');
            gatarElement.textContent = '-';
            gatarElement.classList.remove('bg-red-500', 'text-white');
            gatarElement.classList.add('bg-gray-100', 'text-gray-700');

            // Reset pickup gatar selection
            selectedPickupGatars = {};
            document.getElementById('pickupGatarList').innerHTML = '';
            document.getElementById('pickupSelectionSummary').innerHTML = '<p class="text-gray-500 text-sm">Select a gate pass first</p>';
            document.getElementById('selectedGatarCount').textContent = '0 items';
            document.getElementById('gateNo').value = '';
        }

        async function approveGatePass(event) {
            event.preventDefault();

            // Validate gatar selection (only for approvals, not rejections)
            const status = document.getElementById('status').value;
            if (status === 'approved') {
                const selectedCount = Object.keys(selectedPickupGatars).length;
                if (selectedCount === 0) {
                    alert(i18n.t('select_gatar_first', 'Please select at least one pickup gatar location!'));
                    return;
                }

                // Calculate total selected quantity
                const approvedQty = parseInt(document.getElementById('approvedQuantity').value);
                let selectedQty = 0;
                Object.values(selectedPickupGatars).forEach(qty => {
                    selectedQty += qty;
                });

                if (selectedQty === 0) {
                    alert(i18n.t('enter_qty_gatar', 'Please enter quantity for at least one gatar!'));
                    return;
                }

                if (approvedQty > selectedQty) {
                    alert(i18n.t('approved_exceeds_selected', `Approved quantity (${approvedQty}) exceeds selected gatar quantity (${selectedQty} items). Please increase gatar quantities or reduce approved quantity.`));
                    return;
                }
            }

            const gatePassId = parseInt(document.getElementById('gatePassId').value);
            const approvalData = {
                approved_quantity: parseInt(document.getElementById('approvedQuantity').value),
                gate_no: document.getElementById('gateNo').value.trim(),
                status: status,
                remarks: document.getElementById('approvalRemarks').value.trim()
            };

            try {
                const response = await fetch(`/api/gate-passes/${gatePassId}/approve`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(approvalData)
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                alert(i18n.t('gate_pass_approved', 'Gate pass approved successfully!'));
                clearSelection();
                loadPendingGatePasses();
                loadApprovedPasses();

            } catch (error) {
                alert(i18n.t('error_approving', 'Error approving gate pass') + ': ' + error.message);
            }
        }

        async function loadApprovedPasses() {
            try {
                const response = await fetch('/api/gate-passes', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) return;

                const allPasses = await response.json();
                const approvedPasses = allPasses.filter(gp => gp.status === 'approved');

                displayApprovedPasses(approvedPasses.slice(0, 10));

            } catch (error) {
                console.error('Error loading approved passes:', error);
            }
        }

        function displayApprovedPasses(passes) {
            const tbody = document.getElementById('approvedTableBody');

            // Include both approved and partially_completed gate passes
            const activePasses = passes.filter(gp =>
                gp.status === 'approved' || gp.status === 'partially_completed'
            );

            if (activePasses.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="text-center p-4 text-gray-500">${i18n.t('no_approved_waiting', 'No approved passes waiting for pickup')}</td></tr>`;
                return;
            }

            tbody.innerHTML = activePasses.map(gp => {
                const approvedQty = gp.approved_quantity || gp.requested_quantity;
                const pickedUp = gp.total_picked_up || 0;
                const remaining = approvedQty - pickedUp;

                // Progress bar color
                let progressColor = 'bg-orange-500';
                let progressPercent = (pickedUp / approvedQty) * 100;
                if (progressPercent >= 100) progressColor = 'bg-green-500';
                else if (progressPercent >= 50) progressColor = 'bg-yellow-500';

                // Action button - Record Pickup or Complete
                let actionBtn = '';
                if (remaining > 0) {
                    actionBtn = `
                        <button onclick='openPickupModal(${JSON.stringify(gp)})'
                            class="neu-button bg-blue-500 text-white text-xs px-2 py-1">
                            <i class="bi bi-box-arrow-up"></i> Pickup
                        </button>
                    `;
                } else {
                    actionBtn = `
                        <button onclick="completeGatePass(${gp.id})"
                            class="neu-button bg-green-500 text-white text-xs px-2 py-1">
                            <i class="bi bi-check-circle"></i> Complete
                        </button>
                    `;
                }

                return `
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="p-2 font-bold text-blue-600">${gp.thock_number}</td>
                        <td class="p-2">
                            <div class="flex items-center gap-2">
                                <span class="font-bold ${remaining === 0 ? 'text-green-600' : 'text-orange-600'}">${pickedUp}/${approvedQty}</span>
                                <div class="w-16 h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="${progressColor} h-full" style="width: ${progressPercent}%"></div>
                                </div>
                            </div>
                        </td>
                        <td class="p-2">${actionBtn}</td>
                    </tr>
                `;
            }).join('');
        }

        let currentPickupGatePass = null;

        async function openPickupModal(gatePass) {
            currentPickupGatePass = gatePass;
            const approvedQty = gatePass.approved_quantity || gatePass.requested_quantity;
            const pickedUp = gatePass.total_picked_up || 0;
            const remaining = approvedQty - pickedUp;

            // Extract recipient from remarks
            let recipient = '-';
            if (gatePass.remarks) {
                const match = gatePass.remarks.match(/Recipient:\s*([^|]+)/i);
                if (match) recipient = match[1].trim();
            }

            document.getElementById('pickupGatePassId').value = gatePass.id;
            document.getElementById('pickupThockNumber').textContent = gatePass.thock_number;
            document.getElementById('pickupRecipient').textContent = recipient;
            document.getElementById('pickupApprovedQty').textContent = approvedQty + ' items';
            document.getElementById('pickupAlreadyPickedUp').textContent = pickedUp + ' items';
            document.getElementById('pickupRemaining').textContent = remaining + ' items';
            document.getElementById('pickupQuantity').value = remaining;
            document.getElementById('pickupQuantity').max = remaining;
            document.getElementById('pickupRemarks').value = '';

            // Fetch storage location from room_entries
            document.getElementById('storageLocationInfo').innerHTML = '<span class="text-gray-500">Loading...</span>';
            try {
                const response = await fetch('/api/room-entries', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const roomEntries = await response.json();
                    const thockEntries = roomEntries.filter(re => re.thock_number === gatePass.thock_number);

                    if (thockEntries.length > 0) {
                        const locationHtml = thockEntries.map(re => `
                            <div class="inline-block m-1 p-2 bg-white neu-border text-sm">
                                <span class="font-bold text-blue-600">Room ${re.room_no}</span> |
                                <span class="font-bold text-green-600">Floor ${re.floor}</span> |
                                <span class="font-bold text-purple-600">Gate ${re.gate_no}</span> |
                                <span class="font-bold">${re.quantity} items</span>
                            </div>
                        `).join('');
                        document.getElementById('storageLocationInfo').innerHTML = locationHtml;

                        // Pre-fill room and floor from first entry
                        document.getElementById('pickupRoomNo').value = thockEntries[0].room_no || '';
                        document.getElementById('pickupFloor').value = thockEntries[0].floor || '';
                    } else {
                        document.getElementById('storageLocationInfo').innerHTML = '<span class="text-red-500">No storage location found</span>';
                        document.getElementById('pickupRoomNo').value = '';
                        document.getElementById('pickupFloor').value = '';
                    }
                }
            } catch (error) {
                console.error('Error fetching storage location:', error);
                document.getElementById('storageLocationInfo').innerHTML = '<span class="text-red-500">Failed to load</span>';
            }

            document.getElementById('pickupModal').classList.remove('hidden');
        }

        function closePickupModal() {
            document.getElementById('pickupModal').classList.add('hidden');
            currentPickupGatePass = null;
        }

        async function submitPickup(event) {
            event.preventDefault();

            const gatePassId = parseInt(document.getElementById('pickupGatePassId').value);

            // Build gatar breakdown array from selected gatars
            const gatarBreakdown = [];
            Object.keys(selectedPickupGatars).forEach(idx => {
                const qty = selectedPickupGatars[idx];
                if (qty > 0) {
                    const cell = document.getElementById(`gatar-cell-${idx}`);
                    if (cell) {
                        const gatarNo = parseInt(cell.dataset.gate);
                        if (!isNaN(gatarNo) && gatarNo > 0) {
                            gatarBreakdown.push({
                                gatar_no: gatarNo,
                                quantity: qty
                            });
                        }
                    }
                }
            });

            const pickupData = {
                gate_pass_id: gatePassId,
                pickup_quantity: parseInt(document.getElementById('pickupQuantity').value),
                room_no: document.getElementById('pickupRoomNo').value,
                floor: document.getElementById('pickupFloor').value,
                remarks: document.getElementById('pickupRemarks').value,
                gatar_breakdown: gatarBreakdown.length > 0 ? gatarBreakdown : undefined
            };

            try {
                const response = await fetch('/api/gate-passes/pickup', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(pickupData)
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                alert(i18n.t('pickup_recorded', 'Pickup recorded successfully! Inventory updated.'));
                closePickupModal();
                loadApprovedPasses();

            } catch (error) {
                alert(i18n.t('error_recording_pickup', 'Error recording pickup') + ': ' + error.message);
            }
        }

        async function completeGatePass(gatePassId) {
            if (!confirm(i18n.t('confirm_complete', 'Mark this gate pass as completed? All items have been picked up.'))) {
                return;
            }

            try {
                const response = await fetch(`/api/gate-passes/${gatePassId}/complete`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                alert(i18n.t('gate_pass_completed', 'Gate pass completed successfully!'));
                loadApprovedPasses();

            } catch (error) {
                alert(i18n.t('error_completing', 'Error completing gate pass') + ': ' + error.message);
            }
        }

        function goBack() {
            window.history.back();
        }

        // Load on page load
        window.addEventListener('load', function() {
            loadPendingGatePasses();
            loadApprovedPasses();

            // Auto-refresh every 10 seconds
            setInterval(() => {
                loadPendingGatePasses();
                loadApprovedPasses();
            }, 10000);
        });

    </script>

</body>
</html>
