<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png?v=2">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n-page-title="page_title_guard_register">Guard Register - Cold Storage</title>
    <link rel="stylesheet" href="/static/css/bootstrap-icons.min.css">
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link href="/static/css/arbitrary.css" rel="stylesheet">
    <link href="/static/css/fonts.css" rel="stylesheet">
    <link href="/static/css/dark-mode.css" rel="stylesheet">
    <link href="/static/css/inventory-theme.css" rel="stylesheet">

    <style>
        * {
            font-family: 'Space Grotesk', sans-serif;
        }
        .neu-border {
            border: 1px solid var(--border-color, #e0e6ed);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-radius: 16px;
            transition: all 0.2s ease;
        }
        .neu-border:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        .form-input {
            border: 1px solid var(--border-color, #e0e6ed);
            padding: 1rem 1rem;
            font-size: 1.2rem;
            width: 100%;
            min-height: 52px;
            border-radius: 10px;
        }
        .form-input:focus {
            outline: none;
            border-color: #4a90a4;
            box-shadow: 0 0 0 3px rgba(74, 144, 164, 0.15);
        }
        /* Phone-friendly larger touch targets */
        @media (max-width: 768px) {
            .form-input {
                font-size: 1.1rem;
                padding: 0.875rem 1rem;
            }
            .category-btn {
                padding: 1.25rem 1rem;
                font-size: 1rem;
            }
        }
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: block;
        }
        .category-btn {
            padding: 1rem 1.5rem;
            border: 1px solid var(--border-color, #e0e6ed);
            font-weight: 600;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s ease;
        }
        .category-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .category-btn.selected {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        .guard-badge {
            background: linear-gradient(135deg, #f39c12 0%, #e74c3c 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: none;
            box-shadow: 0 2px 8px rgba(243, 156, 18, 0.3);
        }
        .entry-row {
            border: 1px solid var(--border-color, #e0e6ed);
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: white;
            border-radius: 10px;
        }
        .status-pending {
            background: #FEF3C7;
            color: #92400E;
            border-radius: 6px;
        }
        .status-processed {
            background: #D1FAE5;
            color: #065F46;
            border-radius: 6px;
        }
        /* Village dropdown styles */
        .village-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-color, #e0e6ed);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-radius: 10px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 4px;
        }
        .village-item {
            padding: 0.875rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 1.1rem;
        }
        .village-item:hover, .village-item.highlighted {
            background: #fef3c7;
            font-weight: 600;
        }
    </style>
    <script src="/static/js/theme.js"></script>
</head>
<body class="bg-[#f8fafb] min-h-screen p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 neu-border bg-white p-4 md:p-6 gap-4">
            <div class="flex items-center gap-3">
                <i class="bi bi-truck text-3xl text-orange-600"></i>
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold" data-i18n="guard_register">Guard Register</h1>
                    <p class="text-gray-600 text-sm" data-i18n="register_vehicle_arrival">Register Vehicle Arrival</p>
                </div>
            </div>
            <nav class="flex gap-3 items-center">
                <select id="langSelector" onchange="i18n.setLanguage(this.value)"
                        class="border-2 border-black bg-white px-3 py-2 text-sm font-medium cursor-pointer shadow-[2px_2px_0px_#000]">
                    <option value="en">EN</option>
                    <option value="hi">हिं</option>
                </select>
                <!-- Theme Toggle -->
                <button onclick="theme.toggle()" class="neu-border bg-gray-200 px-3 py-2" title="Toggle Dark Mode">
                    <i class="bi bi-moon-fill theme-icon-moon"></i>
                    <i class="bi bi-sun-fill theme-icon-sun hidden"></i>
                </button>
                <!-- Fullscreen Toggle (Tablets) -->
                <button class="neu-border bg-orange-100 px-4 py-2" onclick="navigate('/guard/dashboard')">
                    <i class="bi bi-arrow-left"></i> <span data-i18n="back">Back</span>
                </button>
            </nav>
        </header>

        <!-- Token Color Display -->
        <div id="tokenColorBanner" class="neu-border p-3 mb-6 text-center flex items-center justify-center gap-4">
            <span class="font-bold" data-i18n="token_color">Token Color:</span>
            <span id="tokenColorDisplay" class="text-xl font-bold py-2 px-6 border-2 border-black">Loading...</span>
        </div>

        <!-- Registration Form -->
        <div class="neu-border bg-white p-4 md:p-6 mb-6">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-plus-circle text-green-600"></i>
                <span data-i18n="new_registration">New Registration</span>
            </h3>

            <form id="registerForm" onsubmit="submitEntry(event)">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <!-- Customer Search with Fuzzy Search -->
                    <div class="relative">
                        <label class="form-label" data-i18n="search_customer">Search Customer (Name / Phone / Village)</label>
                        <input type="text" id="mobile" class="form-input" required
                               maxlength="50"
                               placeholder="Search by name, phone or village..." data-i18n-placeholder="search_customer_placeholder"
                               oninput="debouncedSearchCustomers()"
                               onfocus="showCustomerDropdown()"
                               autocomplete="off">
                        <div id="customerDropdown" class="village-dropdown hidden"></div>
                        <div id="customerStatus" class="text-xs mt-1 hidden"></div>
                    </div>

                    <!-- Customer Name -->
                    <div>
                        <label class="form-label" data-i18n="customer_name">Customer Name (नाम)</label>
                        <input type="text" id="customerName" class="form-input" required
                               placeholder="Enter customer name" data-i18n-placeholder="enter_customer_name"
                               oninput="capitalizeFirstLetter(this)">
                    </div>

                    <!-- S/O (Son Of) - Optional -->
                    <div>
                        <label class="form-label" data-i18n="so">S/O (पिता का नाम)</label>
                        <input type="text" id="soField" class="form-input"
                               placeholder="Father's name (optional)" data-i18n-placeholder="enter_so"
                               oninput="capitalizeFirstLetter(this)">
                    </div>

                    <!-- Village (Searchable Dropdown) -->
                    <div class="relative">
                        <label class="form-label" data-i18n="village">Village (गाँव)</label>
                        <input type="text" id="village" class="form-input" required
                               placeholder="Search village" data-i18n-placeholder="search_village"
                               autocomplete="off"
                               onfocus="showVillageDropdown()"
                               oninput="filterVillages()">
                        <div id="villageDropdown" class="village-dropdown hidden"></div>
                    </div>

                    <!-- Driver Same as Customer Checkbox -->
                    <div class="flex flex-col justify-end">
                        <label class="flex items-center gap-3 cursor-pointer p-3 border-2 border-black bg-yellow-50 hover:bg-yellow-100">
                            <input type="checkbox" id="driverSameAsCustomer" checked
                                   class="w-5 h-5 accent-green-600" onchange="toggleDriverField()">
                            <span class="font-semibold" data-i18n="driver_same_as_customer">Driver = Customer (ड्राइवर = ग्राहक)</span>
                        </label>
                    </div>

                    <!-- Driver Number (hidden by default) -->
                    <div id="driverNoContainer" class="hidden">
                        <label class="form-label" data-i18n="driver_no">Driver No (ड्राइवर नं)</label>
                        <input type="tel" id="driverNo" class="form-input"
                               pattern="[0-9]{10}" maxlength="10"
                               placeholder="10 digit driver number" data-i18n-placeholder="enter_driver_no">
                    </div>

                    <!-- Remarks -->
                    <div>
                        <label class="form-label" data-i18n="remarks">Remarks (विशेष)</label>
                        <input type="text" id="remarks" class="form-input"
                               placeholder="Optional remarks" data-i18n-placeholder="optional_remarks">
                    </div>
                </div>

                <!-- Seed and Sell Quantities (4 each) -->
                <div class="mb-6">
                    <label class="form-label" data-i18n="quantities">Quantities / बोरी की संख्या</label>
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Seed Quantities (4 inputs) -->
                        <div class="bg-green-50 p-4 border-2 border-black">
                            <label class="block font-bold text-green-800 mb-2">
                                <i class="bi bi-flower1"></i> <span data-i18n="seed">Seed (बीज)</span>
                                <span id="seedTotal" class="text-sm bg-green-200 px-2 py-1 ml-2">= 0</span>
                            </label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" id="seed1" class="form-input bg-white text-center" min="0" max="9999"
                                       placeholder="0" value="" oninput="updateTotals()">
                                <input type="number" id="seed2" class="form-input bg-white text-center" min="0" max="9999"
                                       placeholder="0" value="" oninput="updateTotals()">
                                <input type="number" id="seed3" class="form-input bg-white text-center" min="0" max="9999"
                                       placeholder="0" value="" oninput="updateTotals()">
                                <input type="number" id="seed4" class="form-input bg-white text-center" min="0" max="9999"
                                       placeholder="0" value="" oninput="updateTotals()">
                            </div>
                        </div>
                        <!-- Sell Quantities (4 inputs) -->
                        <div class="bg-red-50 p-4 border-2 border-black">
                            <label class="block font-bold text-red-800 mb-2">
                                <i class="bi bi-shop"></i> <span data-i18n="sell">Sell (बिक्री)</span>
                                <span id="sellTotal" class="text-sm bg-red-200 px-2 py-1 ml-2">= 0</span>
                            </label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" id="sell1" class="form-input bg-white text-center" min="0" max="9999"
                                       placeholder="0" value="" oninput="updateTotals()">
                                <input type="number" id="sell2" class="form-input bg-white text-center" min="0" max="9999"
                                       placeholder="0" value="" oninput="updateTotals()">
                                <input type="number" id="sell3" class="form-input bg-white text-center" min="0" max="9999"
                                       placeholder="0" value="" oninput="updateTotals()">
                                <input type="number" id="sell4" class="form-input bg-white text-center" min="0" max="9999"
                                       placeholder="0" value="" oninput="updateTotals()">
                            </div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2" data-i18n="at_least_one_qty">At least one quantity must be greater than 0 / कम से कम एक संख्या 0 से अधिक होनी चाहिए</p>
                </div>

                <!-- Submit Button -->
                <button type="submit" id="submitBtn" class="w-full neu-border bg-green-400 py-4 text-xl font-bold flex items-center justify-center gap-2">
                    <i class="bi bi-check-circle"></i>
                    <span data-i18n="register_vehicle">Register Vehicle</span>
                </button>
            </form>
        </div>

        <!-- Today's Entries -->
        <div class="neu-border bg-white p-4 md:p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <i class="bi bi-list-ul text-blue-600"></i>
                    <span data-i18n="todays_entries">Today's Entries</span>
                    <span id="entryCount" class="text-sm bg-orange-200 px-2 py-1 border border-black">0</span>
                </h3>
                <div class="flex items-center gap-2">
                    <span id="entriesRefreshTimer" class="text-xs bg-blue-100 px-2 py-1 border border-black font-mono">5s</span>
                    <button onclick="loadEntries(); resetEntriesTimer();" class="text-sm bg-gray-200 px-3 py-1 border-2 border-black">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>

            <div id="entriesList" class="max-h-96 overflow-y-auto">
                <p class="text-gray-500 text-center py-4" data-i18n="loading">Loading...</p>
            </div>
        </div>
    </div>

    <!-- Success Modal with Token Number -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="neu-border bg-white p-8 max-w-sm mx-4 text-center">
            <div class="mb-4">
                <i class="bi bi-check-circle-fill text-6xl text-green-500"></i>
            </div>
            <h2 class="text-2xl font-bold mb-4" data-i18n="entry_registered">Entry Registered!</h2>
            <div class="mb-6">
                <p class="text-gray-600 mb-2" data-i18n="token_number_is">Token Number:</p>
                <div id="tokenNumberDisplay" class="text-6xl font-bold py-4 px-8 border-4 border-black inline-block">
                    --
                </div>
            </div>
            <p class="text-sm text-gray-500 mb-4" data-i18n="give_colored_token">Give the colored token to the customer</p>
            <button onclick="closeSuccessModal()" class="neu-border bg-green-400 px-6 py-3 font-bold">
                <i class="bi bi-check"></i> <span data-i18n="ok">OK</span>
            </button>
        </div>
    </div>

    <!-- i18n Script -->
    <script src="/static/js/prefetch.js?v=5"></script>
    <script src="/static/js/i18n.js"></script>
    <script>
        const token = localStorage.getItem('token');
        const userInfo = JSON.parse(localStorage.getItem('user') || '{}');
        const userRole = userInfo.role || '';
        const isAdmin = userRole === 'admin';
        let lookupTimeout = null;
        let villageHighlightIndex = -1;
        let allCustomers = []; // Pre-fetched customer data for fast search
        let customerSearchTimeout = null;

        // Load all customers on page load for fast search
        async function loadAllCustomers() {
            try {
                const res = await fetch('/api/customers', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    allCustomers = await res.json() || [];
                    console.log(`Loaded ${allCustomers.length} customers for search`);
                }
            } catch (error) {
                console.error('Error loading customers:', error);
                allCustomers = [];
            }
        }

        // Load customers on page load
        loadAllCustomers();

        // Debounced search - waits 150ms after user stops typing
        function debouncedSearchCustomers() {
            clearTimeout(customerSearchTimeout);
            customerSearchTimeout = setTimeout(searchCustomers, 150);
        }

        // Fuzzy match function for customer search
        function fuzzyMatchCustomer(searchTerm, customer) {
            if (!searchTerm) return true;
            searchTerm = searchTerm.toLowerCase();

            const phone = (customer.phone || '').toLowerCase();
            const name = (customer.name || '').toLowerCase();
            const village = (customer.village || '').toLowerCase();
            const so = (customer.so || '').toLowerCase();

            // Check if search term matches phone, name, village, or S/O
            if (phone.includes(searchTerm)) return true;
            if (name.includes(searchTerm)) return true;
            if (village.includes(searchTerm)) return true;
            if (so.includes(searchTerm)) return true;

            // Fuzzy matching on name
            let searchIndex = 0;
            for (let i = 0; i < name.length && searchIndex < searchTerm.length; i++) {
                if (name[i] === searchTerm[searchIndex]) {
                    searchIndex++;
                }
            }
            return searchIndex === searchTerm.length;
        }

        // Village list for dropdown
        const villages = ["Jahangirabad","Anupshahr","Achalpur","Ahamad Nagar Urf Touli","Ahar Bangar","Ahar Khadar","Akbarpur Urf Bachchikhera Bang","Alampur Urf Torai Bangar","Amarpur","Amba","Ametha","Aniwas","Anjni","Badarkha","Badshahpur Pauta","Bagsara","Bamanpur","Banawaripur","Barhpura","Begampur Urf Jairampur","Bhailai","Bhaipur","Bhiroli","Bhopur","Bibiyana","Bichaula","Bidhipur","Birauli","Borha","Chacharai","Charaura","Chhaturiya","Dabka","Daraura","Daravar","Davkora","Devakaranpur Urf Bajhera","Dugrau","Dungara Jogi","Enchora","Faridpur Bariyan","Fatahpur","Gahana Govardhanpur","Gangabas Pahara","Garhara","Godhana","Harchandpur","Hasanpur Bangar","Hisavati","Hoshiyarpur Urf Adhiyar","Jafrabad Urf Gangabas Bangar","Jahangirabad Rural","Jairampur Kudena","Jalilpur","Jamrau","Jasar","Jatpura","Jatvai","Jugasana Kalan","Jugasana Khurd","Karanpur Kalan","Karanpur Urf Nurpur","Karonji","Katiyavali","Khadana","Khalaur","Khalikabad/Dungrajat","Khalikpur","Khanpura","Khaunada","Khijarabad","Khushalgarh","Kishanpur Urf Kishan Khera","Kubari","Lachchhampur","Lachhoi","Madagavan","Madhogarh","Malakpur","Man Karora","Mau","Mauharsa","Maujpur","Mohammadpur Bangar","Mohammadpur Khadar","Mubarikpur","Mubarikpur Bangar","Muradnagar","Nagala Nalu","Navabpur Urf Dharampur","Navi Nagar","Pachdevra","Pagauna","Paharpur","Parali","Patrampur","Pipehara","Pootha","Rajapur","Rajaur","Rajner Urf Sorla","Rajpur","Raura","Rohallapur/Kharva","Ronda","Roopvas","Rooth Bangar","Rootha","Sahibad Urf Kakarai","Salamatpur","Salgavan","Sankhani","Shahjahanpur","Shekupur Raura","Sherpur Bangar","Shikoi","Shyampuri","Shyaurampur Jinai","Sihlinagar","Siraura Bangar","Soharkhan","Sunai","Sunana","Suratgarh Urf Lodhai","Telia Nagla","Titota Urf Birgaon","Ugevan","Abhaypur","Akapur Riyana","Alampur Nagla","Alavas Baturi","Amargarh","Amarthal Urf Unchagaon","Aurangabad Tahapur Bager","Aurangabad Tahapur Khader","B B Nagar","Badshahpur Gadia","Badshahpur Talab","Bahainpur","Baharmpur Urf Pali","Bahedi Khera","Bainipur","Balipur","Bamanpur Talluka","Bansuri","Barauli Basdevpur","Barhana","Barkatpur","Basi Bangar","Basi Khadar","Bathada Vajidpur","Bhadaura","Bhadoi Asarfpur","Bhagawantpur","Bhainsaura","Bhamrauli","Bhansa Khur","Bharkau","Bharra","Bhatpura","Bhaupur","Bhirawti","Bhurawala","Bigraon","Biharipur","Bihata","Chandpur Poothi","Chandyana","Chasi","Chatehra","Chhanaura","Chhatamwala","Chigrawati","Chitsona Alipur","Darauli","Darveshpur","Daulatpur Kalan","Dehra","Dhakauli","Dhakka","Dhakrauli","Dhalna","Dhaniyawali","Dulkhara","Eklaidi","Emamabad","Farida Bager","Farida Khadar","Fatehpur","Fatehpur Gujar","Fulaira","Gasupur","Ghansoorpur","Ghunghraoli","Ginaura Nagli","Giraura","Gulab Nagar","Guraoli","Hajipur","Harwanpur Urf Bhagawanpur","Hasanpur Ujarra","Hingbara","Ilna","Imalia","Ishanpur","Jadaul","Jadauli","Jalalpur","Jaria Alampur","Jawasa","Kachraut","Kalyanpur","Kamalpur","Kanauna","Kapsaipur","Karaitha","Karauthi","Karethha","Kariyari","Kaura Shamshadbad","Kesorpur Sathla","Khad Mohan Nagar","Khandoi","Khanpur Guntu","Khanpur Majra","Kharkali","Kharpur","Khijarpur","Kisola","Kriyawali","Kuchesar","Kurena","Ladana","Lalgarhi","Launga","Madangarh","Madona Jafrabad","Maduhasan Garhi Bager","Maduhasan Garhi Khadar","Mahav","Mahiuddinpur Bukalana","Mahuddinpur","Makri","Mangalpur","Mania Tikri","Manpur","Mathura Nagal","Maua Khera","Mavai","Mirzapur Nagli","Modh Allipur Urf Nima Patty Al","Mohamadpurbarwala","Mullani","Nagaur","Nagla Madaripur","Narendrapur","Narsena","Nehchauli","Nikhob","Nirsukha","Nittyanandpur Nagli","Nizampur Bager","Nizampur Khadar","Pali","Pali Anandgarhi","Palipartapur","Parawana Mahmudpur","Pempur","Pilkhani","Pirpur","Pota Kabulpur","Pyana Kalan","Pyana Khurd","Raghunathpur","Rahmatpur Augna","Rampur Pitampur","Ranapur","Rasulpur","Ratanpur","Rausla","Ravani Katiri Bangar","Ravani Katiri Khadar","Sabdalpur","Sahanpur","Sahera","Saidpur","Salabad Dhamaira","Saujna Rani","Sega Jagatpur","Seorampur","Shadipur Banboi","Shafi Nagar","Shakarpur","Shekhupura","Sikri","Sinhali Jhaya","Siyana","Sojna Jhaya","Sulaila","Surajpur Tikri","Takrarpur Ladpor","Tehgora","Thalinayatpur","Thana Gajraula","Thauna","Tibra","Timarpur","Umarpur","Verafirojpur","Yunispur","Abdullapur Hulasan","Ahmad Baj","Ahmadgarh","Ajijabad","Akbarpur Bas Kaneni","Allipur","Allipura Mubarikpur","Amarpur","Anaouna","Anchar Kalan","Ancharu Khurd","Asawari","Ashrefpur Abdullapur","Asrauli","Aurangabad Chandok","Azampur Dariapur","Bad","Badarkha Sirbas","Badrampur","Bailonth","Bamanpur","Ban","Banaul","Barasau","Barauda","Barauli","Barkatpur","Barkhara Hasangarhi","Beram Nagar","Bhaipur","Bhalolpur","Bhansroli Nasirpur","Bhataula","Bhonpur","Bohich","Chakla","Chitsaun","Dargahpur Basauti","Derveshpur","Dhalna","Dhaurau","Dhooturi","Domla Hasangarh","Faizallapur Ajnara","Faridpur Haveli","Fatahabad","Fatehgarh","Fazilpur","Ganga Garh","Gangabaj","Ghungravali Banvaripur","Golabas","Halpura","Hatampur","Hauganpur","Hazaratpur","Hinnaut","Hurthala","Jagdishpur Aurangabad","Jainawai","Jakhauta","Jalalpur","Jalalpur Karira","Jalalpur Katora","Jalaluddinpur Ginauri","Jalphi","Jamalpur","Janipur Kalan","Janipur Khurd","Jatpura","Jeerajpur","Kadon","Kadrabad","Kailawali","Kaisawan","Kamauna","Kaneni Badrampur","Karaina","Karauda","Karira","Kastaba Dhadd","Kasumi","Keratpur","Khailia Kalyanpur","Khairpur","Khakuda","Khandar","Khandwama","Khassia","Kiryawali","Kondupur","Kutubpur","Kuwarpur","Lalgarhi","Lalner","Lohra","Ludhpura","Madanpur Mubarakpur","Mahmudpur","Mahuwa Khara","Mamau","Mandawali","Maudi","Meerapur","Mohammadpur Ginauri","Morauni","Mukeempur","Mukhara","Mustfabad Daduwa","Nagalia Lachhamanpur","Nagla Dalpatpur","Nagla Lutf Alipur","Nagla Naw","Nagla Sarangpur","Nagla Urf Fattapur","Narau","Nawada","Noorpur Nagalia","Padha","Paharpur Haveli","Paharpur Surjawali","Pahasu Dehat","Pandrawal","Pitampur","Poothri Khurd","Poroli","Ragsonth","Rahmapur","Rajpura","Rajupura","Rampur Manpur","Ranau Raham Alipur","Ranayach Narendrapur","Rangpur","Raniwala","Rasulgarhi","Rasulpur","Rasulpur Nagla Bichat","Risalu","Riwara","Runsi","Sahar","Sahatpur Khairi","Saidh Garhi","Salabad","Salbahanpur","Salempur","Samanpur","Samaspur","Sarawa","Sarbhanna","Sargaon","Shikarpur","Shikarpur Rural","Siddhpur","Sidgarhi","Soi","Sujapur Pootha","Sultanpur Khader","Sultanpur Mirgarhi","Surajpur Nisfi","Surjawali","Surkharu","Syarli","Tayabpur","Teyor Bujurag","Teyori","Tunda Khera","Turkipura Khas","Urdmi","Urf Dusari","Utrawali","Yakubpur"];

        function navigate(path) {
            window.location.href = path;
        }

        // Capitalize first letter of each word
        function capitalizeFirstLetter(input) {
            const words = input.value.split(' ');
            input.value = words.map(word => {
                if (word.length === 0) return '';
                return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
            }).join(' ');
        }

        // Village dropdown functions
        function showVillageDropdown() {
            filterVillages();
            document.getElementById('villageDropdown').classList.remove('hidden');
        }

        function hideVillageDropdown() {
            setTimeout(() => {
                document.getElementById('villageDropdown').classList.add('hidden');
                villageHighlightIndex = -1;
            }, 200);
        }

        function filterVillages() {
            villageHighlightIndex = -1;
            const searchTerm = document.getElementById('village').value.toLowerCase();
            const filtered = villages.filter(v => v.toLowerCase().includes(searchTerm));
            const displayVillages = filtered.slice(0, 30);

            const dropdown = document.getElementById('villageDropdown');
            if (displayVillages.length === 0) {
                dropdown.innerHTML = '<div class="village-item" style="color: #999;">No villages found</div>';
            } else {
                dropdown.innerHTML = displayVillages.map(v =>
                    `<div class="village-item" onclick="selectVillage('${v}')">${v}</div>`
                ).join('');
            }
        }

        function selectVillage(village) {
            document.getElementById('village').value = village;
            document.getElementById('villageDropdown').classList.add('hidden');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const villageInput = document.getElementById('village');
            const villageDropdown = document.getElementById('villageDropdown');
            if (villageInput && villageDropdown && !villageInput.contains(e.target) && !villageDropdown.contains(e.target)) {
                villageDropdown.classList.add('hidden');
            }
        });

        // Keyboard navigation for village dropdown
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('village').addEventListener('keydown', function(e) {
                const dropdown = document.getElementById('villageDropdown');
                const items = dropdown.querySelectorAll('.village-item');

                if (dropdown.classList.contains('hidden') || items.length === 0) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    villageHighlightIndex = Math.min(villageHighlightIndex + 1, items.length - 1);
                    items.forEach((item, i) => item.classList.toggle('highlighted', i === villageHighlightIndex));
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    villageHighlightIndex = Math.max(villageHighlightIndex - 1, 0);
                    items.forEach((item, i) => item.classList.toggle('highlighted', i === villageHighlightIndex));
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (villageHighlightIndex >= 0 && villageHighlightIndex < items.length) {
                        items[villageHighlightIndex].click();
                    }
                } else if (e.key === 'Escape') {
                    dropdown.classList.add('hidden');
                }
            });

            document.getElementById('village').addEventListener('blur', hideVillageDropdown);
        });

        // Toggle driver number field based on checkbox
        function toggleDriverField() {
            const checkbox = document.getElementById('driverSameAsCustomer');
            const container = document.getElementById('driverNoContainer');
            const driverInput = document.getElementById('driverNo');

            if (checkbox.checked) {
                container.classList.add('hidden');
                driverInput.value = '';
            } else {
                container.classList.remove('hidden');
            }
        }

        // Customer search results cache
        let customerSearchResults = [];
        let customerHighlightIndex = -1;

        // Local fuzzy search customers (uses pre-fetched data)
        function searchCustomers() {
            const searchTerm = document.getElementById('mobile').value.trim();
            const dropdown = document.getElementById('customerDropdown');
            const statusEl = document.getElementById('customerStatus');

            // Need at least 2 chars to search
            if (searchTerm.length < 2) {
                dropdown.classList.add('hidden');
                statusEl.classList.add('hidden');
                return;
            }

            // Filter customers locally
            const filtered = allCustomers.filter(c => fuzzyMatchCustomer(searchTerm, c));
            customerSearchResults = filtered.slice(0, 50); // Limit to 50 results
            customerHighlightIndex = -1;

            if (customerSearchResults.length > 0) {
                dropdown.innerHTML = customerSearchResults.map((c, idx) => {
                    let displayText = `<span class="font-semibold">${c.name}</span>`;
                    if (c.so) displayText += ` <span class="text-gray-500">S/O ${c.so}</span>`;
                    displayText += ` - <span class="text-blue-600">${c.phone}</span>`;
                    if (c.village) displayText += ` <span class="text-green-600">(${c.village})</span>`;
                    return `<div class="village-item" onclick="selectCustomer(${idx})">${displayText}</div>`;
                }).join('');
                dropdown.classList.remove('hidden');
                statusEl.classList.add('hidden');
            } else {
                dropdown.classList.add('hidden');
                if (searchTerm.length >= 3) {
                    statusEl.textContent = i18n.t('new_customer', 'New customer - enter details');
                    statusEl.className = 'text-xs mt-1 text-blue-600';
                    statusEl.classList.remove('hidden');
                }
            }
        }

        // Show customer dropdown
        function showCustomerDropdown() {
            const searchTerm = document.getElementById('mobile').value.trim();
            if (searchTerm.length >= 2) {
                searchCustomers(); // Re-filter and show
            }
        }

        // Select customer from dropdown
        function selectCustomer(idx) {
            const customer = customerSearchResults[idx];
            if (customer) {
                document.getElementById('mobile').value = customer.phone || '';
                document.getElementById('customerName').value = customer.name || '';
                document.getElementById('soField').value = customer.so || '';
                document.getElementById('village').value = customer.village || '';

                const statusEl = document.getElementById('customerStatus');
                statusEl.textContent = i18n.t('customer_found', 'Customer found! Details auto-filled.');
                statusEl.className = 'text-xs mt-1 text-green-600 font-semibold';
                statusEl.classList.remove('hidden');
            }
            document.getElementById('customerDropdown').classList.add('hidden');
        }

        // Hide customer dropdown on blur
        document.addEventListener('DOMContentLoaded', function() {
            const mobileInput = document.getElementById('mobile');
            mobileInput.addEventListener('blur', function() {
                setTimeout(() => {
                    document.getElementById('customerDropdown').classList.add('hidden');
                }, 200);
            });

            // Keyboard navigation for customer dropdown
            mobileInput.addEventListener('keydown', function(e) {
                const dropdown = document.getElementById('customerDropdown');
                const items = dropdown.querySelectorAll('.village-item');

                if (dropdown.classList.contains('hidden') || items.length === 0) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    customerHighlightIndex = Math.min(customerHighlightIndex + 1, items.length - 1);
                    items.forEach((item, i) => item.classList.toggle('highlighted', i === customerHighlightIndex));
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    customerHighlightIndex = Math.max(customerHighlightIndex - 1, 0);
                    items.forEach((item, i) => item.classList.toggle('highlighted', i === customerHighlightIndex));
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (customerHighlightIndex >= 0 && customerHighlightIndex < items.length) {
                        selectCustomer(customerHighlightIndex);
                    }
                } else if (e.key === 'Escape') {
                    dropdown.classList.add('hidden');
                }
            });
        });

        // Close success modal
        function closeSuccessModal() {
            document.getElementById('successModal').classList.add('hidden');
        }

        // Show success modal with token number
        function showSuccessModal(tokenNumber) {
            document.getElementById('tokenNumberDisplay').textContent = tokenNumber;
            // Apply token color to the token number display
            const tokenColorEl = document.getElementById('tokenColorDisplay');
            const tokenNumEl = document.getElementById('tokenNumberDisplay');
            tokenNumEl.style.backgroundColor = tokenColorEl.style.backgroundColor;
            tokenNumEl.style.color = tokenColorEl.style.color;
            document.getElementById('successModal').classList.remove('hidden');
        }

        // Token colors mapping
        const tokenColors = {
            'RED': { name: 'RED', nameHi: 'लाल', bg: '#EF4444', text: '#FFFFFF' },
            'BLUE': { name: 'BLUE', nameHi: 'नीला', bg: '#3B82F6', text: '#FFFFFF' },
            'GREEN': { name: 'GREEN', nameHi: 'हरा', bg: '#22C55E', text: '#FFFFFF' },
            'YELLOW': { name: 'YELLOW', nameHi: 'पीला', bg: '#EAB308', text: '#000000' },
            'ORANGE': { name: 'ORANGE', nameHi: 'नारंगी', bg: '#F97316', text: '#FFFFFF' },
            'PINK': { name: 'PINK', nameHi: 'गुलाबी', bg: '#EC4899', text: '#FFFFFF' },
            'WHITE': { name: 'WHITE', nameHi: 'सफेद', bg: '#FFFFFF', text: '#000000' },
            'PURPLE': { name: 'PURPLE', nameHi: 'बैंगनी', bg: '#9333EA', text: '#FFFFFF' },
        };

        // Fetch token color from token-color API
        async function displayTokenColor() {
            const displayEl = document.getElementById('tokenColorDisplay');
            const bannerEl = document.getElementById('tokenColorBanner');
            const lang = localStorage.getItem('lang') || 'en';

            try {
                const res = await fetch('/api/token-color/today', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    const data = await res.json();
                    const colorKey = (data.color || 'RED').toUpperCase();
                    const color = tokenColors[colorKey] || tokenColors['RED'];

                    const colorName = lang === 'hi' ? color.nameHi : color.name;
                    displayEl.textContent = colorName;
                    displayEl.style.backgroundColor = color.bg;
                    displayEl.style.color = color.text;
                    bannerEl.style.backgroundColor = color.bg + '22';
                } else {
                    // Fallback to RED if API fails
                    displayEl.textContent = lang === 'hi' ? 'लाल' : 'RED';
                    displayEl.style.backgroundColor = '#EF4444';
                    displayEl.style.color = '#FFFFFF';
                }
            } catch (error) {
                console.error('Error fetching token color:', error);
                displayEl.textContent = lang === 'hi' ? 'लाल' : 'RED';
                displayEl.style.backgroundColor = '#EF4444';
                displayEl.style.color = '#FFFFFF';
            }
        }

        // Calculate totals from 4 inputs each
        function updateTotals() {
            const seed1 = parseInt(document.getElementById('seed1').value) || 0;
            const seed2 = parseInt(document.getElementById('seed2').value) || 0;
            const seed3 = parseInt(document.getElementById('seed3').value) || 0;
            const seed4 = parseInt(document.getElementById('seed4').value) || 0;
            const seedTotal = seed1 + seed2 + seed3 + seed4;

            const sell1 = parseInt(document.getElementById('sell1').value) || 0;
            const sell2 = parseInt(document.getElementById('sell2').value) || 0;
            const sell3 = parseInt(document.getElementById('sell3').value) || 0;
            const sell4 = parseInt(document.getElementById('sell4').value) || 0;
            const sellTotal = sell1 + sell2 + sell3 + sell4;

            document.getElementById('seedTotal').textContent = `= ${seedTotal}`;
            document.getElementById('sellTotal').textContent = `= ${sellTotal}`;

            return { seedTotal, sellTotal, seed1, seed2, seed3, seed4, sell1, sell2, sell3, sell4 };
        }

        // Submit entry
        async function submitEntry(e) {
            e.preventDefault();

            const totals = updateTotals();
            const seedQty = totals.seedTotal;
            const sellQty = totals.sellTotal;

            if (seedQty <= 0 && sellQty <= 0) {
                alert(i18n.t('at_least_one_qty_error', 'At least one quantity (seed or sell) must be greater than 0'));
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split animate-spin"></i> Registering...';

            const mobile = document.getElementById('mobile').value.trim();
            const driverSame = document.getElementById('driverSameAsCustomer').checked;
            const driverNo = driverSame ? '' : document.getElementById('driverNo').value.trim();

            const data = {
                customer_name: document.getElementById('customerName').value.trim(),
                so: document.getElementById('soField').value.trim(),
                village: document.getElementById('village').value.trim(),
                mobile: mobile,
                driver_no: driverNo,
                seed_quantity: seedQty,
                sell_quantity: sellQty,
                seed_qty_1: totals.seed1,
                seed_qty_2: totals.seed2,
                seed_qty_3: totals.seed3,
                seed_qty_4: totals.seed4,
                sell_qty_1: totals.sell1,
                sell_qty_2: totals.sell2,
                sell_qty_3: totals.sell3,
                sell_qty_4: totals.sell4,
                remarks: document.getElementById('remarks').value.trim()
            };

            try {
                const res = await fetch('/api/guard/entries', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (!res.ok) {
                    const error = await res.text();
                    throw new Error(error);
                }

                const result = await res.json();

                // Show success modal with token number
                showSuccessModal(result.token_number);

                // Reset form
                document.getElementById('registerForm').reset();
                // Clear all 8 quantity inputs
                ['seed1', 'seed2', 'seed3', 'seed4', 'sell1', 'sell2', 'sell3', 'sell4'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                updateTotals();
                document.getElementById('driverSameAsCustomer').checked = true;
                document.getElementById('driverNoContainer').classList.add('hidden');
                document.getElementById('customerStatus').classList.add('hidden');

                // Reload entries list
                loadEntries();

            } catch (error) {
                alert(i18n.t('error', 'Error') + ': ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> <span data-i18n="register_vehicle">Register Vehicle</span>';
            }
        }

        // Load today's entries
        async function loadEntries() {
            try {
                const res = await fetch('/api/guard/entries', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Failed to load entries');

                const entries = await res.json();
                const listEl = document.getElementById('entriesList');
                const countEl = document.getElementById('entryCount');

                countEl.textContent = entries.length;

                if (entries.length === 0) {
                    listEl.innerHTML = `<p class="text-gray-500 text-center py-4" data-i18n="no_entries_today">No entries registered today</p>`;
                    return;
                }

                const lang = localStorage.getItem('lang') || 'en';

                listEl.innerHTML = entries.map(entry => {
                    const time = new Date(entry.arrival_time).toLocaleTimeString(lang === 'hi' ? 'hi-IN' : 'en-IN', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    const statusClass = entry.status === 'pending' ? 'status-pending' : 'status-processed';
                    const statusText = entry.status === 'pending'
                        ? (lang === 'hi' ? 'लंबित' : 'Pending')
                        : (lang === 'hi' ? 'प्रोसेस्ड' : 'Processed');

                    // Build quantity display - show individual quantities separately
                    let qtyParts = [];

                    // Get individual seed quantities
                    const seedQtys = [entry.seed_qty_1 || 0, entry.seed_qty_2 || 0, entry.seed_qty_3 || 0, entry.seed_qty_4 || 0].filter(q => q > 0);
                    if (seedQtys.length > 0) {
                        seedQtys.forEach(qty => {
                            qtyParts.push(`<span class="bg-green-100 px-2 py-1 border border-black">Seed${qty}</span>`);
                        });
                    } else if (entry.seed_quantity > 0) {
                        // Fallback for old entries
                        qtyParts.push(`<span class="bg-green-100 px-2 py-1 border border-black">Seed${entry.seed_quantity}</span>`);
                    }

                    // Get individual sell quantities
                    const sellQtys = [entry.sell_qty_1 || 0, entry.sell_qty_2 || 0, entry.sell_qty_3 || 0, entry.sell_qty_4 || 0].filter(q => q > 0);
                    if (sellQtys.length > 0) {
                        sellQtys.forEach(qty => {
                            qtyParts.push(`<span class="bg-red-100 px-2 py-1 border border-black">Sell${qty}</span>`);
                        });
                    } else if (entry.sell_quantity > 0) {
                        // Fallback for old entries
                        qtyParts.push(`<span class="bg-red-100 px-2 py-1 border border-black">Sell${entry.sell_quantity}</span>`);
                    }

                    const qtyDisplay = qtyParts.length > 0 ? qtyParts.join(' ') : '-';

                    const soDisplay = entry.so ? ` S/O ${entry.so}` : '';

                    // Delete button only for admin
                    const deleteBtn = isAdmin ? `
                        <button onclick="deleteEntry(${entry.id})" class="text-red-600 hover:bg-red-100 px-2 py-1 border border-red-400" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    ` : '';

                    return `
                        <div class="entry-row flex flex-wrap items-center gap-2 md:gap-4">
                            <span class="font-mono text-lg bg-yellow-200 px-3 py-1 border-2 border-black font-bold">#${entry.token_number}</span>
                            <span class="font-mono text-sm bg-gray-100 px-2 py-1 border border-black">${time}</span>
                            <span class="font-bold flex-1">${entry.customer_name}${soDisplay}</span>
                            <span class="text-sm text-gray-600">${entry.village}</span>
                            <div class="flex gap-1 text-sm">${qtyDisplay}</div>
                            <span class="text-xs px-2 py-1 border border-black ${statusClass}">${statusText}</span>
                            ${deleteBtn}
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading entries:', error);
                document.getElementById('entriesList').innerHTML = `
                    <p class="text-red-500 text-center py-4">Error loading entries</p>
                `;
            }
        }

        // Delete entry (admin only)
        async function deleteEntry(id) {
            const lang = localStorage.getItem('lang') || 'en';
            const confirmMsg = lang === 'hi' ? 'क्या आप इस एंट्री को हटाना चाहते हैं?' : 'Are you sure you want to delete this entry?';

            if (!confirm(confirmMsg)) return;

            try {
                const res = await fetch(`/api/guard/entries/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    const error = await res.text();
                    throw new Error(error);
                }

                // Reload entries
                loadEntries();
            } catch (error) {
                alert(i18n.t('error', 'Error') + ': ' + error.message);
            }
        }

        // Initialize
        (function() {
            const lang = localStorage.getItem('lang') || 'en';
            document.getElementById('langSelector').value = lang;
        })();

        // Entries auto-refresh timer
        let entriesRefreshInterval = null;
        let entriesTimerInterval = null;
        let entriesTimerCount = 5;

        function startEntriesTimer() {
            entriesTimerCount = 5;
            updateEntriesTimerDisplay();
            if (entriesTimerInterval) clearInterval(entriesTimerInterval);
            entriesTimerInterval = setInterval(() => {
                entriesTimerCount--;
                if (entriesTimerCount <= 0) {
                    entriesTimerCount = 5;
                }
                updateEntriesTimerDisplay();
            }, 1000);
        }

        function updateEntriesTimerDisplay() {
            const timerEl = document.getElementById('entriesRefreshTimer');
            if (timerEl) {
                timerEl.textContent = entriesTimerCount + 's';
            }
        }

        function resetEntriesTimer() {
            entriesTimerCount = 5;
            updateEntriesTimerDisplay();
        }

        window.addEventListener('load', () => {
            displayTokenColor();
            loadEntries();

            // Start 5-second auto-refresh
            startEntriesTimer();
            entriesRefreshInterval = setInterval(loadEntries, 5000);
        });
    </script>
</body>
</html>
