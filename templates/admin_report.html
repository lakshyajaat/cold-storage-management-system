<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Reports - Cold Storage</title>
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link href="/static/css/arbitrary.css" rel="stylesheet">
    <link href="/static/css/bootstrap-icons.min.css" rel="stylesheet">
    <link href="/static/css/fonts.css" rel="stylesheet">
    <link href="/static/css/dark-mode.css" rel="stylesheet">
    <style>
        * {
            font-family: 'Space Grotesk', sans-serif;
        }
        .neu-border {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            transition: all 0.2s ease;
        }
        .neu-border:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #000;
        }
        .neu-button {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .neu-button:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #000;
        }
        .stat-card {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            padding: 1.5rem;
            background: white;
        }
        .active-date {
            background: #000 !important;
            color: white !important;
        }
        .employee-row:nth-child(even) {
            background: #f9fafb;
        }
    </style>
    <script src="/static/js/theme.js"></script>
</head>
<body class="bg-[#E8F5E9] min-h-screen p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 md:mb-8 neu-border bg-white p-4 md:p-6 gap-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold flex items-center gap-3">
                    <i class="bi bi-file-earmark-bar-graph text-blue-600"></i>
                    Admin Reports
                </h1>
                <p class="text-gray-600 mt-2 text-sm md:text-base">Daily progress analytics and operational reports</p>
            </div>
            <div class="flex gap-2 items-center w-full md:w-auto justify-end">
                <button onclick="theme.toggle()" class="neu-button bg-gray-200" title="Toggle Dark Mode">
                    <i class="bi bi-moon-fill theme-icon-moon"></i>
                    <i class="bi bi-sun-fill theme-icon-sun hidden"></i>
                </button>
                <button onclick="updateAnalytics()" class="neu-button bg-blue-500 text-white">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
                <button onclick="window.location.href='/admin/dashboard'" class="neu-button bg-gray-200">
                    <i class="bi bi-arrow-left"></i> Back
                </button>
            </div>
        </header>

        <!-- Date Range Selector -->
        <div class="neu-border bg-white p-4 mb-6">
            <div class="flex flex-wrap gap-3 items-center">
                <span class="font-semibold text-gray-700"><i class="bi bi-calendar3"></i> Date Range:</span>
                <button onclick="setDateRange('today')" class="date-btn neu-button bg-green-100 text-sm py-2 px-3" id="btnToday">Today</button>
                <button onclick="setDateRange('yesterday')" class="date-btn neu-button bg-yellow-100 text-sm py-2 px-3" id="btnYesterday">Yesterday</button>
                <button onclick="setDateRange('7')" class="date-btn neu-button bg-blue-100 text-sm py-2 px-3" id="btn7">Last 7 Days</button>
                <button onclick="setDateRange('30')" class="date-btn neu-button bg-purple-100 text-sm py-2 px-3 active-date" id="btn30">Last 30 Days</button>
                <button onclick="setDateRange('0')" class="date-btn neu-button bg-gray-100 text-sm py-2 px-3" id="btn0">All Time</button>
                <span class="text-gray-400 mx-2">|</span>
                <span class="text-sm text-gray-600">Custom:</span>
                <input type="date" id="startDate" class="neu-border p-2 text-sm" onchange="clearQuickButtons()">
                <span class="text-gray-500">to</span>
                <input type="date" id="endDate" class="neu-border p-2 text-sm" onchange="clearQuickButtons()">
                <button onclick="applyCustomRange()" class="neu-button bg-orange-400 text-white text-sm py-2 px-4">
                    <i class="bi bi-check-lg"></i> Apply
                </button>
            </div>
        </div>

        <!-- Summary Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 mb-8">
            <div class="stat-card bg-green-100">
                <p class="text-xs text-gray-600">Total Entries</p>
                <p class="text-2xl font-bold text-green-600" id="statEntries">0</p>
            </div>
            <div class="stat-card bg-blue-100">
                <p class="text-xs text-gray-600">Room Entries</p>
                <p class="text-2xl font-bold text-blue-600" id="statRoomEntries">0</p>
            </div>
            <div class="stat-card bg-teal-100">
                <p class="text-xs text-gray-600">Total Qty</p>
                <p class="text-2xl font-bold text-teal-600" id="statQuantity">0</p>
            </div>
            <div class="stat-card bg-cyan-100">
                <p class="text-xs text-gray-600">Today's Qty</p>
                <p class="text-2xl font-bold text-cyan-600" id="statTodayQty">0</p>
            </div>
            <div class="stat-card bg-purple-100">
                <p class="text-xs text-gray-600">Gate Passes</p>
                <p class="text-2xl font-bold text-purple-600" id="statGatePasses">0</p>
            </div>
            <div class="stat-card bg-yellow-100">
                <p class="text-xs text-gray-600">Total Payments</p>
                <p class="text-2xl font-bold text-yellow-600" id="statPayments">â‚¹0</p>
            </div>
            <div class="stat-card bg-pink-100">
                <p class="text-xs text-gray-600">Qty Changes</p>
                <p class="text-2xl font-bold text-pink-600" id="statQtyChanges">0</p>
            </div>
            <div class="stat-card bg-indigo-100">
                <p class="text-xs text-gray-600">Total Edits</p>
                <p class="text-2xl font-bold text-indigo-600" id="statEdits">0</p>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Operations Chart -->
            <div class="neu-border p-6 bg-white">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <i class="bi bi-activity text-blue-600"></i> Daily Operations
                </h3>
                <canvas id="operationsChart" height="280"></canvas>
            </div>

            <!-- Financial Chart -->
            <div class="neu-border p-6 bg-white">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <i class="bi bi-cash-coin text-green-600"></i> Daily Payments
                </h3>
                <canvas id="financialChart" height="280"></canvas>
            </div>
        </div>

        <!-- Edits Chart - Full Width -->
        <div class="neu-border p-6 bg-white mb-8">
            <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                <i class="bi bi-pencil-square text-purple-600"></i> Daily Edits & Quantity Changes
            </h3>
            <canvas id="editsChart" height="150"></canvas>
        </div>

        <!-- Summary Table -->
        <div class="neu-border p-6 bg-white">
            <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                <i class="bi bi-table text-gray-700"></i> Daily Summary Table
            </h3>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="border-b-2 border-black bg-gray-100">
                            <th class="p-3 text-left">Date</th>
                            <th class="p-3 text-center">Entries</th>
                            <th class="p-3 text-center">Expected Qty</th>
                            <th class="p-3 text-center">Not Stored</th>
                            <th class="p-3 text-center">Room Entries</th>
                            <th class="p-3 text-center">Qty</th>
                            <th class="p-3 text-center">Gate Passes</th>
                            <th class="p-3 text-center">Payments (â‚¹)</th>
                            <th class="p-3 text-center">Qty Changed</th>
                            <th class="p-3 text-center">Total Edits</th>
                        </tr>
                    </thead>
                    <tbody id="analyticsSummaryBody">
                        <tr>
                            <td colspan="10" class="text-center p-4 text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                    <tfoot id="analyticsSummaryFooter" class="border-t-2 border-black bg-gray-100 font-bold">
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Employee Analytics Section -->
        <div class="mt-8">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-people-fill text-indigo-600"></i> Employee Analytics
            </h2>

            <!-- Employee Activity Chart -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="neu-border p-6 bg-white">
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                        <i class="bi bi-bar-chart-fill text-indigo-600"></i> Top Employees by Activity
                    </h3>
                    <canvas id="employeeChart" height="280"></canvas>
                </div>

                <!-- Employee Summary Cards -->
                <div class="neu-border p-6 bg-white">
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                        <i class="bi bi-award-fill text-yellow-600"></i> Top Performers
                    </h3>
                    <div class="space-y-3" id="topPerformers">
                        <p class="text-gray-500 text-center p-4">Loading...</p>
                    </div>
                </div>
            </div>

            <!-- Employee Performance Table -->
            <div class="neu-border p-6 bg-white">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <i class="bi bi-table text-indigo-700"></i> Employee Performance Breakdown
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="border-b-2 border-black bg-indigo-100">
                                <th class="p-3 text-left">Employee</th>
                                <th class="p-3 text-center">Entries</th>
                                <th class="p-3 text-center">Room Entries</th>
                                <th class="p-3 text-center">GP Issued</th>
                                <th class="p-3 text-center">GP Approved</th>
                                <th class="p-3 text-center">Payments (â‚¹)</th>
                                <th class="p-3 text-center">Edits</th>
                                <th class="p-3 text-center">Admin Acts</th>
                                <th class="p-3 text-center">Total</th>
                            </tr>
                        </thead>
                        <tbody id="employeeTableBody">
                            <tr>
                                <td colspan="9" class="text-center p-4 text-gray-500">Loading...</td>
                            </tr>
                        </tbody>
                        <tfoot id="employeeTableFooter" class="border-t-2 border-black bg-indigo-100 font-bold">
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart.js -->
    <script src="/static/js/prefetch.js?v=2"></script>
    <script src="/static/js/chart.umd.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        let allEntries = [];
        let allRoomEntries = [];
        let allPayments = [];
        let allGatePasses = [];
        let allEditLogs = [];
        let allAdminLogs = [];
        let allUsers = [];
        let usersMap = {};

        let operationsChart = null;
        let financialChart = null;
        let editsChart = null;
        let employeeChart = null;

        // Current date filter settings
        let currentDateMode = '30'; // 'today', 'yesterday', '7', '30', '0', 'custom'
        let customStartDate = null;
        let customEndDate = null;

        // Load data on page load
        window.addEventListener('load', loadAllData);

        async function loadAllData() {
            try {
                const [entriesRes, roomEntriesRes, paymentsRes, gatePassesRes, editLogsRes, adminLogsRes, usersRes] = await Promise.all([
                    fetch('/api/entries', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('/api/room-entries', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('/api/rent-payments', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('/api/gate-passes', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('/api/edit-logs', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('/api/admin-action-logs', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('/api/users', { headers: { 'Authorization': `Bearer ${token}` } })
                ]);

                allEntries = await entriesRes.json() || [];
                allRoomEntries = await roomEntriesRes.json() || [];
                allPayments = await paymentsRes.json() || [];
                allGatePasses = await gatePassesRes.json() || [];
                allEditLogs = await editLogsRes.json() || [];
                allAdminLogs = await adminLogsRes.json() || [];
                allUsers = await usersRes.json() || [];

                // Build users map for quick lookup
                allUsers.forEach(user => {
                    usersMap[user.id] = user.name || user.email || `User ${user.id}`;
                });

                updateAnalytics();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Date Range Functions
        function setDateRange(range) {
            currentDateMode = range;
            customStartDate = null;
            customEndDate = null;
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';

            // Update button styles
            document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active-date'));
            const btnId = range === 'today' ? 'btnToday' : range === 'yesterday' ? 'btnYesterday' : `btn${range}`;
            const btn = document.getElementById(btnId);
            if (btn) btn.classList.add('active-date');

            updateAnalytics();
        }

        function applyCustomRange() {
            const startInput = document.getElementById('startDate').value;
            const endInput = document.getElementById('endDate').value;

            if (!startInput || !endInput) {
                alert('Please select both start and end dates');
                return;
            }

            if (startInput > endInput) {
                alert('Start date must be before end date');
                return;
            }

            currentDateMode = 'custom';
            customStartDate = startInput;
            customEndDate = endInput;

            // Clear quick button highlights
            document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active-date'));

            updateAnalytics();
        }

        function clearQuickButtons() {
            document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active-date'));
        }

        // Get date range based on current settings
        function getDateRange() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            let startDate, endDate;

            if (currentDateMode === 'custom' && customStartDate && customEndDate) {
                return { start: customStartDate, end: customEndDate };
            }

            endDate = getLocalDateStr(today.toISOString());

            switch (currentDateMode) {
                case 'today':
                    startDate = endDate;
                    break;
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    startDate = getLocalDateStr(yesterday.toISOString());
                    endDate = startDate;
                    break;
                case '0': // All time
                    startDate = '1970-01-01';
                    break;
                default: // Days count (7, 30, etc.)
                    const days = parseInt(currentDateMode) || 30;
                    const start = new Date(today);
                    start.setDate(start.getDate() - days);
                    startDate = getLocalDateStr(start.toISOString());
            }

            return { start: startDate, end: endDate };
        }

        // Helper to get local date string (YYYY-MM-DD) without timezone issues
        function getLocalDateStr(dateStr) {
            const d = new Date(dateStr);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Calculate daily statistics from data arrays using date range
        function calculateDailyStats() {
            const stats = {};
            const { start, end } = getDateRange();

            function ensureDate(dateStr) {
                if (!stats[dateStr]) {
                    stats[dateStr] = {
                        entries: 0,
                        expectedQty: 0,
                        notStored: 0,
                        roomEntries: 0,
                        quantity: 0,
                        gatePasses: 0,
                        payments: 0,
                        qtyChanges: 0,
                        totalEdits: 0
                    };
                }
            }

            function isInRange(dateStr) {
                return dateStr >= start && dateStr <= end;
            }

            // Get entry IDs that have room entries (items actually stored)
            const storedEntryIds = new Set(allRoomEntries.map(r => r.entry_id));

            // Aggregate Entries
            allEntries.forEach(entry => {
                if (entry.created_at) {
                    const dateStr = getLocalDateStr(entry.created_at);
                    if (isInRange(dateStr)) {
                        ensureDate(dateStr);
                        stats[dateStr].entries++;
                        // Only count expected qty if entry has room entries (stored in inventory)
                        if (storedEntryIds.has(entry.id)) {
                            stats[dateStr].expectedQty += entry.expected_quantity || 0;
                        } else {
                            // Entry not stored in inventory
                            stats[dateStr].notStored += entry.expected_quantity || 0;
                        }
                    }
                }
            });

            // Aggregate Room Entries
            allRoomEntries.forEach(room => {
                if (room.created_at) {
                    const dateStr = getLocalDateStr(room.created_at);
                    if (isInRange(dateStr)) {
                        ensureDate(dateStr);
                        stats[dateStr].roomEntries++;
                        stats[dateStr].quantity += room.quantity || 0;
                    }
                }
            });

            // Aggregate Gate Passes
            allGatePasses.forEach(gp => {
                if (gp.issued_at) {
                    const dateStr = getLocalDateStr(gp.issued_at);
                    if (isInRange(dateStr)) {
                        ensureDate(dateStr);
                        stats[dateStr].gatePasses++;
                    }
                }
            });

            // Aggregate Payments
            allPayments.forEach(payment => {
                if (payment.payment_date) {
                    const dateStr = getLocalDateStr(payment.payment_date);
                    if (isInRange(dateStr)) {
                        ensureDate(dateStr);
                        stats[dateStr].payments += payment.amount_paid || 0;
                    }
                }
            });

            // Aggregate Edit Logs
            allEditLogs.forEach(log => {
                if (log.edited_at) {
                    const dateStr = getLocalDateStr(log.edited_at);
                    if (isInRange(dateStr)) {
                        ensureDate(dateStr);
                        stats[dateStr].totalEdits++;
                        if (log.old_quantity !== undefined && log.new_quantity !== undefined &&
                            log.old_quantity !== log.new_quantity) {
                            stats[dateStr].qtyChanges++;
                        }
                    }
                }
            });

            return stats;
        }

        // Calculate employee statistics
        function calculateEmployeeStats() {
            const stats = {};
            const { start, end } = getDateRange();

            function isInRange(dateStr) {
                return dateStr >= start && dateStr <= end;
            }

            function ensureEmployee(userId) {
                if (!stats[userId]) {
                    stats[userId] = {
                        name: usersMap[userId] || `User ${userId}`,
                        entries: 0,
                        roomEntries: 0,
                        gatePassesIssued: 0,
                        gatePassesApproved: 0,
                        paymentsCount: 0,
                        paymentsAmount: 0,
                        edits: 0,
                        adminActions: 0,
                        total: 0
                    };
                }
            }

            // Count entries created by each user
            allEntries.forEach(entry => {
                if (entry.created_at && entry.created_by_user_id) {
                    const dateStr = getLocalDateStr(entry.created_at);
                    if (isInRange(dateStr)) {
                        ensureEmployee(entry.created_by_user_id);
                        stats[entry.created_by_user_id].entries++;
                        stats[entry.created_by_user_id].total++;
                    }
                }
            });

            // Count room entries
            allRoomEntries.forEach(room => {
                if (room.created_at && room.created_by_user_id) {
                    const dateStr = getLocalDateStr(room.created_at);
                    if (isInRange(dateStr)) {
                        ensureEmployee(room.created_by_user_id);
                        stats[room.created_by_user_id].roomEntries++;
                        stats[room.created_by_user_id].total++;
                    }
                }
            });

            // Count gate passes issued and approved
            allGatePasses.forEach(gp => {
                if (gp.issued_at) {
                    const dateStr = getLocalDateStr(gp.issued_at);
                    if (isInRange(dateStr)) {
                        if (gp.issued_by_user_id) {
                            ensureEmployee(gp.issued_by_user_id);
                            stats[gp.issued_by_user_id].gatePassesIssued++;
                            stats[gp.issued_by_user_id].total++;
                        }
                    }
                }
                if (gp.approved_at && gp.approved_by_user_id) {
                    const dateStr = getLocalDateStr(gp.approved_at);
                    if (isInRange(dateStr)) {
                        ensureEmployee(gp.approved_by_user_id);
                        stats[gp.approved_by_user_id].gatePassesApproved++;
                        stats[gp.approved_by_user_id].total++;
                    }
                }
            });

            // Count payments collected
            allPayments.forEach(payment => {
                if (payment.payment_date && payment.processed_by_user_id) {
                    const dateStr = getLocalDateStr(payment.payment_date);
                    if (isInRange(dateStr)) {
                        ensureEmployee(payment.processed_by_user_id);
                        stats[payment.processed_by_user_id].paymentsCount++;
                        stats[payment.processed_by_user_id].paymentsAmount += payment.amount_paid || 0;
                        stats[payment.processed_by_user_id].total++;
                    }
                }
            });

            // Count edits
            allEditLogs.forEach(log => {
                if (log.edited_at && log.edited_by_user_id) {
                    const dateStr = getLocalDateStr(log.edited_at);
                    if (isInRange(dateStr)) {
                        ensureEmployee(log.edited_by_user_id);
                        stats[log.edited_by_user_id].edits++;
                        stats[log.edited_by_user_id].total++;
                    }
                }
            });

            // Count admin actions
            allAdminLogs.forEach(log => {
                if (log.created_at && log.admin_user_id) {
                    const dateStr = getLocalDateStr(log.created_at);
                    if (isInRange(dateStr)) {
                        ensureEmployee(log.admin_user_id);
                        stats[log.admin_user_id].adminActions++;
                        stats[log.admin_user_id].total++;
                    }
                }
            });

            return stats;
        }

        // Update summary stats at top
        function updateSummaryStats(stats) {
            let totals = { entries: 0, roomEntries: 0, quantity: 0, gatePasses: 0, payments: 0, qtyChanges: 0, totalEdits: 0 };
            Object.values(stats).forEach(d => {
                totals.entries += d.entries;
                totals.roomEntries += d.roomEntries;
                totals.quantity += d.quantity;
                totals.gatePasses += d.gatePasses;
                totals.payments += d.payments;
                totals.qtyChanges += d.qtyChanges;
                totals.totalEdits += d.totalEdits;
            });

            // Get today's quantity (using IST timezone)
            const today = new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Kolkata' });
            const todayStats = stats[today] || { quantity: 0 };

            document.getElementById('statEntries').textContent = totals.entries;
            document.getElementById('statRoomEntries').textContent = totals.roomEntries;
            document.getElementById('statQuantity').textContent = totals.quantity.toLocaleString('en-IN');
            document.getElementById('statTodayQty').textContent = todayStats.quantity.toLocaleString('en-IN');
            document.getElementById('statGatePasses').textContent = totals.gatePasses;
            document.getElementById('statPayments').textContent = 'â‚¹' + totals.payments.toLocaleString('en-IN');
            document.getElementById('statQtyChanges').textContent = totals.qtyChanges;
            document.getElementById('statEdits').textContent = totals.totalEdits;
        }

        // Render Operations Chart (Line Chart)
        function renderOperationsChart(stats) {
            const ctx = document.getElementById('operationsChart').getContext('2d');
            const labels = Object.keys(stats).sort();
            const formattedLabels = labels.map(d => {
                const date = new Date(d);
                return date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short' });
            });

            const data = {
                labels: formattedLabels,
                datasets: [
                    {
                        label: 'Entries',
                        data: labels.map(d => stats[d].entries),
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'Room Entries',
                        data: labels.map(d => stats[d].roomEntries),
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'Gate Passes',
                        data: labels.map(d => stats[d].gatePasses),
                        borderColor: '#8B5CF6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.3,
                        fill: true
                    }
                ]
            };

            if (operationsChart) operationsChart.destroy();

            operationsChart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        }

        // Render Financial Chart (Bar Chart)
        function renderFinancialChart(stats) {
            const ctx = document.getElementById('financialChart').getContext('2d');
            const labels = Object.keys(stats).sort();
            const formattedLabels = labels.map(d => {
                const date = new Date(d);
                return date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short' });
            });

            const data = {
                labels: formattedLabels,
                datasets: [{
                    label: 'Payments (â‚¹)',
                    data: labels.map(d => stats[d].payments),
                    backgroundColor: '#10B981',
                    borderColor: '#047857',
                    borderWidth: 2
                }]
            };

            if (financialChart) financialChart.destroy();

            financialChart = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: ctx => 'â‚¹' + ctx.raw.toLocaleString('en-IN')
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: v => 'â‚¹' + v.toLocaleString('en-IN') }
                        }
                    }
                }
            });
        }

        // Render Edits Chart (Bar Chart)
        function renderEditsChart(stats) {
            const ctx = document.getElementById('editsChart').getContext('2d');
            const labels = Object.keys(stats).sort();
            const formattedLabels = labels.map(d => {
                const date = new Date(d);
                return date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short' });
            });

            const data = {
                labels: formattedLabels,
                datasets: [
                    {
                        label: 'Quantity Changes',
                        data: labels.map(d => stats[d].qtyChanges),
                        backgroundColor: '#EC4899',
                        borderColor: '#BE185D',
                        borderWidth: 2
                    },
                    {
                        label: 'Total Edits',
                        data: labels.map(d => stats[d].totalEdits),
                        backgroundColor: '#8B5CF6',
                        borderColor: '#6D28D9',
                        borderWidth: 2
                    }
                ]
            };

            if (editsChart) editsChart.destroy();

            editsChart = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        }

        // Render Summary Table
        function renderSummaryTable(stats) {
            const tbody = document.getElementById('analyticsSummaryBody');
            const tfoot = document.getElementById('analyticsSummaryFooter');
            const sortedDates = Object.keys(stats).sort((a, b) => new Date(b) - new Date(a));

            let totals = { entries: 0, expectedQty: 0, notStored: 0, roomEntries: 0, quantity: 0, gatePasses: 0, payments: 0, qtyChanges: 0, totalEdits: 0 };

            sortedDates.forEach(date => {
                totals.entries += stats[date].entries;
                totals.expectedQty += stats[date].expectedQty || 0;
                totals.notStored += stats[date].notStored || 0;
                totals.roomEntries += stats[date].roomEntries;
                totals.quantity += stats[date].quantity;
                totals.gatePasses += stats[date].gatePasses;
                totals.payments += stats[date].payments;
                totals.qtyChanges += stats[date].qtyChanges;
                totals.totalEdits += stats[date].totalEdits;
            });

            tbody.innerHTML = sortedDates.map(date => {
                const d = stats[date];
                const formattedDate = new Date(date).toLocaleDateString('en-IN', {
                    weekday: 'short', day: '2-digit', month: 'short', year: 'numeric'
                });
                const isToday = date === getLocalDateStr(new Date().toISOString());
                const rowClass = isToday ? 'bg-yellow-100 font-semibold' : 'hover:bg-gray-50';

                return `
                    <tr class="border-b border-gray-200 ${rowClass}">
                        <td class="p-3 text-left">${formattedDate}${isToday ? ' <span class="text-xs bg-yellow-500 text-white px-1 rounded">TODAY</span>' : ''}</td>
                        <td class="p-3 text-center"><span class="text-green-600 font-bold">${d.entries}</span></td>
                        <td class="p-3 text-center"><span class="text-orange-600 font-bold">${d.expectedQty || 0}</span></td>
                        <td class="p-3 text-center"><span class="text-red-600 font-bold">${d.notStored || 0}</span></td>
                        <td class="p-3 text-center"><span class="text-blue-600 font-bold">${d.roomEntries}</span></td>
                        <td class="p-3 text-center"><span class="text-teal-600 font-bold">${d.quantity}</span></td>
                        <td class="p-3 text-center"><span class="text-purple-600 font-bold">${d.gatePasses}</span></td>
                        <td class="p-3 text-center"><span class="text-green-700 font-bold">â‚¹${d.payments.toLocaleString('en-IN')}</span></td>
                        <td class="p-3 text-center"><span class="text-pink-600 font-bold">${d.qtyChanges}</span></td>
                        <td class="p-3 text-center"><span class="text-purple-700 font-bold">${d.totalEdits}</span></td>
                    </tr>
                `;
            }).join('');

            tfoot.innerHTML = `
                <tr>
                    <td class="p-3 text-left">TOTAL (${sortedDates.length} days)</td>
                    <td class="p-3 text-center text-green-600">${totals.entries}</td>
                    <td class="p-3 text-center text-orange-600">${totals.expectedQty.toLocaleString('en-IN')}</td>
                    <td class="p-3 text-center text-red-600">${totals.notStored.toLocaleString('en-IN')}</td>
                    <td class="p-3 text-center text-blue-600">${totals.roomEntries}</td>
                    <td class="p-3 text-center text-teal-600">${totals.quantity.toLocaleString('en-IN')}</td>
                    <td class="p-3 text-center text-purple-600">${totals.gatePasses}</td>
                    <td class="p-3 text-center text-green-700">â‚¹${totals.payments.toLocaleString('en-IN')}</td>
                    <td class="p-3 text-center text-pink-600">${totals.qtyChanges}</td>
                    <td class="p-3 text-center text-purple-700">${totals.totalEdits}</td>
                </tr>
            `;
        }

        // Render Employee Chart (Bar Chart)
        function renderEmployeeChart(employeeStats) {
            const ctx = document.getElementById('employeeChart').getContext('2d');

            // Sort employees by total actions and take top 10
            const sortedEmployees = Object.values(employeeStats)
                .sort((a, b) => b.total - a.total)
                .slice(0, 10);

            if (sortedEmployees.length === 0) {
                if (employeeChart) employeeChart.destroy();
                ctx.font = '16px Space Grotesk';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#9CA3AF';
                ctx.fillText('No employee data for selected period', ctx.canvas.width / 2, 140);
                return;
            }

            const data = {
                labels: sortedEmployees.map(e => e.name.split(' ')[0]), // First name only
                datasets: [
                    {
                        label: 'Entries',
                        data: sortedEmployees.map(e => e.entries),
                        backgroundColor: '#10B981'
                    },
                    {
                        label: 'Room Entries',
                        data: sortedEmployees.map(e => e.roomEntries),
                        backgroundColor: '#3B82F6'
                    },
                    {
                        label: 'Gate Passes',
                        data: sortedEmployees.map(e => e.gatePassesIssued + e.gatePassesApproved),
                        backgroundColor: '#8B5CF6'
                    },
                    {
                        label: 'Payments (â‚¹k)',
                        data: sortedEmployees.map(e => Math.round(e.paymentsAmount / 1000)),
                        backgroundColor: '#F59E0B'
                    },
                    {
                        label: 'Edits',
                        data: sortedEmployees.map(e => e.edits),
                        backgroundColor: '#EC4899'
                    },
                    {
                        label: 'Admin Actions',
                        data: sortedEmployees.map(e => e.adminActions),
                        backgroundColor: '#EF4444'
                    }
                ]
            };

            if (employeeChart) employeeChart.destroy();

            employeeChart = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, beginAtZero: true }
                    }
                }
            });
        }

        // Render Top Performers Section
        function renderTopPerformers(employeeStats) {
            const container = document.getElementById('topPerformers');

            const sortedEmployees = Object.values(employeeStats)
                .sort((a, b) => b.total - a.total)
                .slice(0, 5);

            if (sortedEmployees.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center p-4">No activity in selected period</p>';
                return;
            }

            const medals = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£'];
            const colors = ['bg-yellow-100', 'bg-gray-100', 'bg-orange-100', 'bg-blue-50', 'bg-green-50'];

            container.innerHTML = sortedEmployees.map((emp, idx) => `
                <div class="flex items-center justify-between p-3 ${colors[idx]} rounded border-2 border-black">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">${medals[idx]}</span>
                        <div>
                            <p class="font-bold">${emp.name}</p>
                            <p class="text-xs text-gray-600">
                                ${emp.entries} entries Â· ${emp.roomEntries} rooms Â· ${emp.gatePassesIssued + emp.gatePassesApproved} GP
                            </p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-2xl font-bold text-indigo-600">${emp.total}</p>
                        <p class="text-xs text-gray-500">actions</p>
                    </div>
                </div>
            `).join('');
        }

        // Render Employee Table
        function renderEmployeeTable(employeeStats) {
            const tbody = document.getElementById('employeeTableBody');
            const tfoot = document.getElementById('employeeTableFooter');

            const sortedEmployees = Object.values(employeeStats)
                .sort((a, b) => b.total - a.total);

            if (sortedEmployees.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center p-4 text-gray-500">No employee activity in selected period</td></tr>';
                tfoot.innerHTML = '';
                return;
            }

            let totals = { entries: 0, roomEntries: 0, gatePassesIssued: 0, gatePassesApproved: 0, paymentsAmount: 0, edits: 0, adminActions: 0, total: 0 };
            sortedEmployees.forEach(e => {
                totals.entries += e.entries;
                totals.roomEntries += e.roomEntries;
                totals.gatePassesIssued += e.gatePassesIssued;
                totals.gatePassesApproved += e.gatePassesApproved;
                totals.paymentsAmount += e.paymentsAmount;
                totals.edits += e.edits;
                totals.adminActions += e.adminActions;
                totals.total += e.total;
            });

            tbody.innerHTML = sortedEmployees.map((emp, idx) => `
                <tr class="border-b border-gray-200 employee-row hover:bg-indigo-50">
                    <td class="p-3 text-left">
                        <span class="font-semibold">${emp.name}</span>
                        ${idx < 3 ? '<span class="ml-2 text-xs bg-yellow-400 text-black px-1 rounded">TOP</span>' : ''}
                    </td>
                    <td class="p-3 text-center"><span class="text-green-600 font-bold">${emp.entries}</span></td>
                    <td class="p-3 text-center"><span class="text-blue-600 font-bold">${emp.roomEntries}</span></td>
                    <td class="p-3 text-center"><span class="text-purple-600 font-bold">${emp.gatePassesIssued}</span></td>
                    <td class="p-3 text-center"><span class="text-purple-800 font-bold">${emp.gatePassesApproved}</span></td>
                    <td class="p-3 text-center"><span class="text-yellow-600 font-bold">â‚¹${emp.paymentsAmount.toLocaleString('en-IN')}</span></td>
                    <td class="p-3 text-center"><span class="text-pink-600 font-bold">${emp.edits}</span></td>
                    <td class="p-3 text-center"><span class="text-red-600 font-bold">${emp.adminActions}</span></td>
                    <td class="p-3 text-center"><span class="text-indigo-700 font-bold text-lg">${emp.total}</span></td>
                </tr>
            `).join('');

            tfoot.innerHTML = `
                <tr>
                    <td class="p-3 text-left">TOTAL (${sortedEmployees.length} employees)</td>
                    <td class="p-3 text-center text-green-600">${totals.entries}</td>
                    <td class="p-3 text-center text-blue-600">${totals.roomEntries}</td>
                    <td class="p-3 text-center text-purple-600">${totals.gatePassesIssued}</td>
                    <td class="p-3 text-center text-purple-800">${totals.gatePassesApproved}</td>
                    <td class="p-3 text-center text-yellow-600">â‚¹${totals.paymentsAmount.toLocaleString('en-IN')}</td>
                    <td class="p-3 text-center text-pink-600">${totals.edits}</td>
                    <td class="p-3 text-center text-red-600">${totals.adminActions}</td>
                    <td class="p-3 text-center text-indigo-700">${totals.total}</td>
                </tr>
            `;
        }

        // Main update function
        function updateAnalytics() {
            const stats = calculateDailyStats();
            const employeeStats = calculateEmployeeStats();

            updateSummaryStats(stats);
            renderOperationsChart(stats);
            renderFinancialChart(stats);
            renderEditsChart(stats);
            renderSummaryTable(stats);

            // Employee Analytics
            renderEmployeeChart(employeeStats);
            renderTopPerformers(employeeStats);
            renderEmployeeTable(employeeStats);
        }
    </script>
</body>
</html>
