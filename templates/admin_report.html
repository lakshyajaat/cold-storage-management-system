<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Reports & Logs - Cold Storage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Space Grotesk', sans-serif;
        }
        .neu-border {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            transition: all 0.2s ease;
        }
        .neu-border:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #000;
        }
        .neu-button {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .neu-button:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #000;
        }
        .stat-card {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            padding: 1.5rem;
            background: white;
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            border: 3px solid #000;
            background: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .tab-button.active {
            background: #3B82F6;
            color: white;
            transform: translateY(3px);
            box-shadow: none;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body class="bg-[#FFF9E6] min-h-screen p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8 neu-border bg-white p-6">
            <div>
                <h1 class="text-3xl font-bold flex items-center gap-3">
                    <i class="bi bi-graph-up-arrow text-purple-600"></i>
                    Admin Reports & System Logs
                </h1>
                <p class="text-gray-600 mt-2">Comprehensive system statistics and employee activity tracking</p>
            </div>
            <div class="flex gap-4">
                <button onclick="refreshAllData()" class="neu-button bg-blue-500 text-white">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                <button onclick="window.location.href='/admin/dashboard'" class="neu-button bg-gray-200">
                    <i class="bi bi-arrow-left"></i> Back
                </button>
            </div>
        </header>

        <!-- System Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stat-card bg-green-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Total Entries</p>
                        <p class="text-3xl font-bold text-green-600" id="totalEntries">0</p>
                    </div>
                    <i class="bi bi-box-seam text-4xl text-green-600"></i>
                </div>
            </div>

            <div class="stat-card bg-blue-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Room Assignments</p>
                        <p class="text-3xl font-bold text-blue-600" id="totalRoomEntries">0</p>
                    </div>
                    <i class="bi bi-door-open text-4xl text-blue-600"></i>
                </div>
            </div>

            <div class="stat-card bg-yellow-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Total Payments</p>
                        <p class="text-3xl font-bold text-yellow-600" id="totalPayments">₹0</p>
                    </div>
                    <i class="bi bi-cash-coin text-4xl text-yellow-600"></i>
                </div>
            </div>

            <div class="stat-card bg-purple-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Active Users</p>
                        <p class="text-3xl font-bold text-purple-600" id="totalUsers">0</p>
                    </div>
                    <i class="bi bi-people text-4xl text-purple-600"></i>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-2 mb-6 flex-wrap">
            <button class="tab-button active" onclick="switchTab('activity')">
                <i class="bi bi-activity"></i> Employee Activity
            </button>
            <button class="tab-button" onclick="switchTab('loginlogs')">
                <i class="bi bi-clock-history"></i> Login/Logout Logs
            </button>
            <button class="tab-button" onclick="switchTab('editlogs')">
                <i class="bi bi-pencil-square"></i> Edit Logs
            </button>
            <button class="tab-button" onclick="switchTab('adminactions')">
                <i class="bi bi-shield-check"></i> Admin Actions
            </button>
            <button class="tab-button" onclick="switchTab('entries')">
                <i class="bi bi-box"></i> Entry Logs
            </button>
            <button class="tab-button" onclick="switchTab('rooms')">
                <i class="bi bi-door-closed"></i> Room Assignment Logs
            </button>
            <button class="tab-button" onclick="switchTab('payments')">
                <i class="bi bi-cash"></i> Payment Logs
            </button>
            <button class="tab-button" onclick="switchTab('users')">
                <i class="bi bi-person-badge"></i> User Management
            </button>
        </div>

        <!-- Employee Activity Tab -->
        <div id="activity-tab" class="tab-content active neu-border bg-white p-6">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-person-workspace"></i>
                Employee Activity Summary
            </h2>
            <p class="text-sm text-gray-600 mb-4">Overview of all employee actions in the system</p>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="border-b-2 border-black">
                            <th class="p-3 text-left">Employee</th>
                            <th class="p-3 text-left">ID</th>
                            <th class="p-3 text-left">Role</th>
                            <th class="p-3 text-left">Entries Created</th>
                            <th class="p-3 text-left">Rooms Assigned</th>
                            <th class="p-3 text-left">Payments Processed</th>
                            <th class="p-3 text-left">Last Active</th>
                        </tr>
                    </thead>
                    <tbody id="activityTableBody">
                        <tr>
                            <td colspan="7" class="text-center p-4 text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Login/Logout Logs Tab -->
        <div id="loginlogs-tab" class="tab-content neu-border bg-white p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                    <i class="bi bi-clock-history"></i>
                    Login/Logout Activity Logs
                </h2>
                <input type="text" id="loginLogSearch" placeholder="Search login logs..." class="neu-border p-2" onkeyup="filterLoginLogs()">
            </div>
            <p class="text-sm text-gray-600 mb-4">Track all user login and logout sessions</p>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="border-b-2 border-black">
                            <th class="p-2 text-left">User</th>
                            <th class="p-2 text-left">Email</th>
                            <th class="p-2 text-left">Role</th>
                            <th class="p-2 text-left">Login Time</th>
                            <th class="p-2 text-left">Logout Time</th>
                            <th class="p-2 text-left">Duration</th>
                            <th class="p-2 text-left">IP Address</th>
                            <th class="p-2 text-left">User Agent</th>
                        </tr>
                    </thead>
                    <tbody id="loginLogsBody">
                        <tr>
                            <td colspan="8" class="text-center p-4 text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Room Entry Edit Logs Tab -->
        <div id="editlogs-tab" class="tab-content neu-border bg-white p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                    <i class="bi bi-pencil-square"></i>
                    Room Entry Edit History
                </h2>
                <input type="text" id="editLogSearch" placeholder="Search edit logs..." class="neu-border p-2" onkeyup="filterEditLogs()">
            </div>
            <p class="text-sm text-gray-600 mb-4">Track all changes made to room entries with who edited what and when</p>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="border-b-2 border-black">
                            <th class="p-2 text-left">Truck No</th>
                            <th class="p-2 text-left">Edited By</th>
                            <th class="p-2 text-left">Employee ID</th>
                            <th class="p-2 text-left">Field Changed</th>
                            <th class="p-2 text-left">Old Value</th>
                            <th class="p-2 text-left">New Value</th>
                            <th class="p-2 text-left">Edited At</th>
                        </tr>
                    </thead>
                    <tbody id="editLogsBody">
                        <tr>
                            <td colspan="7" class="text-center p-4 text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Admin Actions Tab -->
        <div id="adminactions-tab" class="tab-content neu-border bg-white p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                    <i class="bi bi-shield-check"></i>
                    Admin Actions Log
                </h2>
                <input type="text" id="adminActionSearch" placeholder="Search admin actions..." class="neu-border p-2" onkeyup="filterAdminActions()">
            </div>
            <p class="text-sm text-gray-600 mb-4">Track all administrative actions: user management, permission changes, system settings</p>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="border-b-2 border-black">
                            <th class="p-2 text-left">Admin</th>
                            <th class="p-2 text-left">Action Type</th>
                            <th class="p-2 text-left">Target</th>
                            <th class="p-2 text-left">Description</th>
                            <th class="p-2 text-left">IP Address</th>
                            <th class="p-2 text-left">Timestamp</th>
                        </tr>
                    </thead>
                    <tbody id="adminActionsBody">
                        <tr>
                            <td colspan="6" class="text-center p-4 text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Entry Logs Tab -->
        <div id="entries-tab" class="tab-content neu-border bg-white p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                    <i class="bi bi-clipboard-data"></i>
                    Entry Creation Logs
                </h2>
                <input type="text" id="entrySearch" placeholder="Search entries..." class="neu-border p-2" onkeyup="filterEntries()">
            </div>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="border-b-2 border-black">
                            <th class="p-2 text-left">Truck No</th>
                            <th class="p-2 text-left">Customer</th>
                            <th class="p-2 text-left">Village</th>
                            <th class="p-2 text-left">Qty</th>
                            <th class="p-2 text-left">Created By</th>
                            <th class="p-2 text-left">Employee ID</th>
                            <th class="p-2 text-left">Created At</th>
                        </tr>
                    </thead>
                    <tbody id="entriesLogBody">
                        <tr>
                            <td colspan="7" class="text-center p-4 text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Room Assignment Logs Tab -->
        <div id="rooms-tab" class="tab-content neu-border bg-white p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                    <i class="bi bi-door-open-fill"></i>
                    Room Assignment Logs
                </h2>
                <input type="text" id="roomSearch" placeholder="Search rooms..." class="neu-border p-2" onkeyup="filterRooms()">
            </div>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="border-b-2 border-black">
                            <th class="p-2 text-left">Truck No</th>
                            <th class="p-2 text-left">Room</th>
                            <th class="p-2 text-left">Floor</th>
                            <th class="p-2 text-left">Gatar</th>
                            <th class="p-2 text-left">Qty</th>
                            <th class="p-2 text-left">Assigned By</th>
                            <th class="p-2 text-left">Employee ID</th>
                            <th class="p-2 text-left">Assigned At</th>
                        </tr>
                    </thead>
                    <tbody id="roomsLogBody">
                        <tr>
                            <td colspan="8" class="text-center p-4 text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Payment Logs Tab -->
        <div id="payments-tab" class="tab-content neu-border bg-white p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                    <i class="bi bi-wallet2"></i>
                    Payment Processing Logs
                </h2>
                <input type="text" id="paymentSearch" placeholder="Search payments..." class="neu-border p-2" onkeyup="filterPayments()">
            </div>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="border-b-2 border-black">
                            <th class="p-2 text-left">Receipt #</th>
                            <th class="p-2 text-left">Customer</th>
                            <th class="p-2 text-left">Phone</th>
                            <th class="p-2 text-left">Amount Paid</th>
                            <th class="p-2 text-left">Balance</th>
                            <th class="p-2 text-left">Processed By</th>
                            <th class="p-2 text-left">Employee ID</th>
                            <th class="p-2 text-left">Payment Date</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsLogBody">
                        <tr>
                            <td colspan="8" class="text-center p-4 text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- User Management Tab -->
        <div id="users-tab" class="tab-content neu-border bg-white p-6">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-people-fill"></i>
                User Management & Permissions
            </h2>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="border-b-2 border-black">
                            <th class="p-3 text-left">Name</th>
                            <th class="p-3 text-left">Email</th>
                            <th class="p-3 text-left">Role</th>
                            <th class="p-3 text-left">Accountant Access</th>
                            <th class="p-3 text-left">Status</th>
                            <th class="p-3 text-left">Created At</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="6" class="text-center p-4 text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        let allEntries = [];
        let allRoomEntries = [];
        let allPayments = [];
        let allUsers = [];
        let allLoginLogs = [];
        let allEditLogs = [];
        let allAdminActions = [];

        // Capitalize first letter function
        function capitalizeText(text) {
            if (!text || text.length === 0) return text;
            return text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();
        }

        // Check admin access
        (function() {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                window.location.href = '/login';
                return;
            }

            const user = JSON.parse(userStr);
            if (user.role !== 'admin') {
                alert('Access Denied: Admin access required');
                window.location.href = '/dashboard';
                return;
            }
        })();

        // Load all data on page load
        window.addEventListener('load', function() {
            loadAllData();
        });

        async function loadAllData() {
            await Promise.all([
                loadUsers(),
                loadEntries(),
                loadRoomEntries(),
                loadPayments(),
                loadLoginLogs(),
                loadEditLogs(),
                loadAdminActions()
            ]);

            updateStatistics();
            displayEmployeeActivity();
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load users');

                allUsers = await response.json();
                displayUsers();
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        async function loadEntries() {
            try {
                const response = await fetch('/api/entries', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load entries');

                allEntries = await response.json();
                displayEntries();
            } catch (error) {
                console.error('Error loading entries:', error);
            }
        }

        async function loadRoomEntries() {
            try {
                const response = await fetch('/api/room-entries', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load room entries');

                allRoomEntries = await response.json();
                displayRoomEntries();
            } catch (error) {
                console.error('Error loading room entries:', error);
            }
        }

        async function loadPayments() {
            try {
                const response = await fetch('/api/rent-payments', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load payments');

                allPayments = await response.json();
                displayPayments();
            } catch (error) {
                console.error('Error loading payments:', error);
            }
        }

        async function loadLoginLogs() {
            try {
                const response = await fetch('/api/login-logs', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load login logs');

                allLoginLogs = await response.json();
                displayLoginLogs();
            } catch (error) {
                console.error('Error loading login logs:', error);
            }
        }

        async function loadEditLogs() {
            try {
                const response = await fetch('/api/edit-logs', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load edit logs');

                allEditLogs = await response.json();
                displayEditLogs();
            } catch (error) {
                console.error('Error loading edit logs:', error);
            }
        }

        async function loadAdminActions() {
            try {
                const response = await fetch('/api/admin-action-logs', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load admin actions');

                allAdminActions = await response.json();
                displayAdminActions();
            } catch (error) {
                console.error('Error loading admin actions:', error);
            }
        }

        function updateStatistics() {
            document.getElementById('totalEntries').textContent = allEntries.length;
            document.getElementById('totalRoomEntries').textContent = allRoomEntries.length;

            const totalPaid = allPayments.reduce((sum, p) => sum + p.amount_paid, 0);
            document.getElementById('totalPayments').textContent = '₹' + totalPaid.toLocaleString('en-IN');

            const activeUsers = allUsers.filter(u => u.is_active).length;
            document.getElementById('totalUsers').textContent = activeUsers;
        }

        function displayEmployeeActivity() {
            const tbody = document.getElementById('activityTableBody');

            if (allUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-gray-500">No users found</td></tr>';
                return;
            }

            const activityData = allUsers.map(user => {
                const entriesCreated = allEntries.filter(e => e.created_by_user_id === user.id).length;
                const roomsAssigned = allRoomEntries.filter(r => r.created_by_user_id === user.id).length;
                const paymentsProcessed = allPayments.filter(p => p.processed_by_user_id === user.id).length;

                // Find most recent activity
                const lastEntry = allEntries.filter(e => e.created_by_user_id === user.id).sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];
                const lastRoom = allRoomEntries.filter(r => r.created_by_user_id === user.id).sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];
                const lastPayment = allPayments.filter(p => p.processed_by_user_id === user.id).sort((a, b) => new Date(b.payment_date) - new Date(a.payment_date))[0];

                const dates = [lastEntry?.created_at, lastRoom?.created_at, lastPayment?.payment_date].filter(Boolean);
                const mostRecent = dates.length > 0 ? new Date(Math.max(...dates.map(d => new Date(d)))) : null;

                return {
                    user,
                    entriesCreated,
                    roomsAssigned,
                    paymentsProcessed,
                    lastActive: mostRecent
                };
            });

            tbody.innerHTML = activityData.map(data => {
                const lastActiveStr = data.lastActive ?
                    data.lastActive.toLocaleString('en-IN', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : 'Never';

                return `
                    <tr class="border-b border-gray-200 hover:bg-yellow-50">
                        <td class="p-3 font-semibold">${capitalizeText(data.user.name)}</td>
                        <td class="p-3">#${data.user.id}</td>
                        <td class="p-3">
                            <span class="px-2 py-1 rounded text-white ${data.user.role === 'admin' ? 'bg-red-500' : data.user.role === 'accountant' ? 'bg-green-500' : 'bg-blue-500'}">
                                ${data.user.role.toUpperCase()}
                            </span>
                        </td>
                        <td class="p-3 text-center"><span class="text-lg font-bold text-green-600">${data.entriesCreated}</span></td>
                        <td class="p-3 text-center"><span class="text-lg font-bold text-blue-600">${data.roomsAssigned}</span></td>
                        <td class="p-3 text-center"><span class="text-lg font-bold text-yellow-600">${data.paymentsProcessed}</span></td>
                        <td class="p-3 text-sm">${lastActiveStr}</td>
                    </tr>
                `;
            }).join('');
        }

        function displayEntries() {
            const tbody = document.getElementById('entriesLogBody');

            if (allEntries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-gray-500">No entries found</td></tr>';
                return;
            }

            // Get user names for display
            const userMap = {};
            allUsers.forEach(u => userMap[u.id] = capitalizeText(u.name));

            tbody.innerHTML = allEntries.map(entry => {
                const createdDate = new Date(entry.created_at).toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const truckColor = getTruckColor(entry.truck_number);
                const createdBy = userMap[entry.created_by_user_id] || 'Unknown';

                return `
                    <tr class="border-b border-gray-200 hover:bg-blue-50">
                        <td class="p-2 font-bold ${truckColor}">${entry.truck_number}</td>
                        <td class="p-2">${capitalizeText(entry.name)}</td>
                        <td class="p-2">${capitalizeText(entry.village)}</td>
                        <td class="p-2">${entry.expected_quantity}</td>
                        <td class="p-2 font-semibold">${createdBy}</td>
                        <td class="p-2">#${entry.created_by_user_id}</td>
                        <td class="p-2 text-sm">${createdDate}</td>
                    </tr>
                `;
            }).join('');
        }

        function displayRoomEntries() {
            const tbody = document.getElementById('roomsLogBody');

            if (allRoomEntries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-gray-500">No room entries found</td></tr>';
                return;
            }

            const userMap = {};
            allUsers.forEach(u => userMap[u.id] = capitalizeText(u.name));

            tbody.innerHTML = allRoomEntries.map(room => {
                const createdDate = new Date(room.created_at).toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const truckColor = getTruckColor(room.truck_number);
                const assignedBy = userMap[room.created_by_user_id] || 'Unknown';

                return `
                    <tr class="border-b border-gray-200 hover:bg-purple-50">
                        <td class="p-2 font-bold ${truckColor}">${room.truck_number}</td>
                        <td class="p-2">${room.room_no}</td>
                        <td class="p-2">${room.floor}</td>
                        <td class="p-2">${room.gate_no}</td>
                        <td class="p-2">${room.quantity}</td>
                        <td class="p-2 font-semibold">${assignedBy}</td>
                        <td class="p-2">#${room.created_by_user_id}</td>
                        <td class="p-2 text-sm">${createdDate}</td>
                    </tr>
                `;
            }).join('');
        }

        function displayPayments() {
            const tbody = document.getElementById('paymentsLogBody');

            if (allPayments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-gray-500">No payments found</td></tr>';
                return;
            }

            const userMap = {};
            allUsers.forEach(u => userMap[u.id] = capitalizeText(u.name));

            tbody.innerHTML = allPayments.map(payment => {
                const paymentDate = new Date(payment.payment_date).toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const processedBy = userMap[payment.processed_by_user_id] || 'Unknown';
                const balanceClass = payment.balance < 0 ? 'text-red-600 font-bold' : 'text-green-600 font-bold';

                return `
                    <tr class="border-b border-gray-200 hover:bg-green-50">
                        <td class="p-2 font-bold">#${payment.receipt_number}</td>
                        <td class="p-2">${capitalizeText(payment.customer_name)}</td>
                        <td class="p-2">${payment.customer_phone}</td>
                        <td class="p-2">₹${payment.amount_paid.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                        <td class="p-2 ${balanceClass}">₹${payment.balance.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                        <td class="p-2 font-semibold">${processedBy}</td>
                        <td class="p-2">#${payment.processed_by_user_id}</td>
                        <td class="p-2 text-sm">${paymentDate}</td>
                    </tr>
                `;
            }).join('');
        }

        function displayUsers() {
            const tbody = document.getElementById('usersTableBody');

            if (allUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-gray-500">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = allUsers.map(user => {
                const createdDate = new Date(user.created_at).toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });

                return `
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="p-3 font-semibold">${capitalizeText(user.name)}</td>
                        <td class="p-3">${user.email}</td>
                        <td class="p-3">
                            <span class="px-2 py-1 rounded text-white ${user.role === 'admin' ? 'bg-red-500' : user.role === 'accountant' ? 'bg-green-500' : 'bg-blue-500'}">
                                ${user.role.toUpperCase()}
                            </span>
                        </td>
                        <td class="p-3 text-center">
                            ${user.has_accountant_access ? '<span class="px-2 py-1 bg-green-500 text-white rounded text-xs">YES</span>' : '<span class="px-2 py-1 bg-gray-300 rounded text-xs">NO</span>'}
                        </td>
                        <td class="p-3">
                            ${user.is_active ? '<span class="px-2 py-1 bg-green-500 text-white rounded text-xs">ACTIVE</span>' : '<span class="px-2 py-1 bg-red-500 text-white rounded text-xs">PAUSED</span>'}
                        </td>
                        <td class="p-3 text-sm">${createdDate}</td>
                    </tr>
                `;
            }).join('');
        }

        function displayLoginLogs() {
            const tbody = document.getElementById('loginLogsBody');

            if (allLoginLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-gray-500">No login logs found</td></tr>';
                return;
            }

            tbody.innerHTML = allLoginLogs.map(log => {
                const loginTime = new Date(log.login_time).toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                let logoutTime = 'Still Active';
                let duration = '-';

                if (log.logout_time) {
                    const logoutDate = new Date(log.logout_time);
                    logoutTime = logoutDate.toLocaleString('en-IN', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });

                    // Calculate duration
                    const diff = logoutDate - new Date(log.login_time);
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    duration = `${hours}h ${minutes}m`;
                }

                const statusClass = log.logout_time ? 'bg-gray-50' : 'bg-green-50';

                return `
                    <tr class="border-b border-gray-200 hover:bg-yellow-50 ${statusClass}">
                        <td class="p-2 font-semibold">${capitalizeText(log.user_name)}</td>
                        <td class="p-2 text-sm">${log.email}</td>
                        <td class="p-2">
                            <span class="px-2 py-1 rounded text-white text-xs ${log.role === 'admin' ? 'bg-red-500' : log.role === 'accountant' ? 'bg-green-500' : 'bg-blue-500'}">
                                ${log.role.toUpperCase()}
                            </span>
                        </td>
                        <td class="p-2 text-sm">${loginTime}</td>
                        <td class="p-2 text-sm ${log.logout_time ? '' : 'text-green-600 font-bold'}">${logoutTime}</td>
                        <td class="p-2 font-semibold">${duration}</td>
                        <td class="p-2 text-xs">${log.ip_address || 'N/A'}</td>
                        <td class="p-2 text-xs" title="${log.user_agent || 'N/A'}">${(log.user_agent || 'N/A').substring(0, 30)}...</td>
                    </tr>
                `;
            }).join('');
        }

        function displayEditLogs() {
            const tbody = document.getElementById('editLogsBody');

            if (allEditLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-gray-500">No edit logs found</td></tr>';
                return;
            }

            // Flatten edit logs to show each field change as a separate row
            const flattenedLogs = [];
            allEditLogs.forEach(log => {
                const editedAt = new Date(log.edited_at).toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                if (log.old_room_no !== undefined || log.new_room_no !== undefined) {
                    flattenedLogs.push({
                        truck_number: log.truck_number,
                        editor_name: log.editor_name,
                        edited_by_user_id: log.edited_by_user_id,
                        field: 'Room No',
                        old_value: log.old_room_no || '-',
                        new_value: log.new_room_no || '-',
                        edited_at: editedAt
                    });
                }

                if (log.old_floor !== undefined || log.new_floor !== undefined) {
                    flattenedLogs.push({
                        truck_number: log.truck_number,
                        editor_name: log.editor_name,
                        edited_by_user_id: log.edited_by_user_id,
                        field: 'Floor',
                        old_value: log.old_floor || '-',
                        new_value: log.new_floor || '-',
                        edited_at: editedAt
                    });
                }

                if (log.old_gate_no !== undefined || log.new_gate_no !== undefined) {
                    flattenedLogs.push({
                        truck_number: log.truck_number,
                        editor_name: log.editor_name,
                        edited_by_user_id: log.edited_by_user_id,
                        field: 'Gate No',
                        old_value: log.old_gate_no || '-',
                        new_value: log.new_gate_no || '-',
                        edited_at: editedAt
                    });
                }

                if (log.old_quantity !== undefined || log.new_quantity !== undefined) {
                    flattenedLogs.push({
                        truck_number: log.truck_number,
                        editor_name: log.editor_name,
                        edited_by_user_id: log.edited_by_user_id,
                        field: 'Quantity',
                        old_value: log.old_quantity || '-',
                        new_value: log.new_quantity || '-',
                        edited_at: editedAt
                    });
                }

                if (log.old_remark !== undefined || log.new_remark !== undefined) {
                    flattenedLogs.push({
                        truck_number: log.truck_number,
                        editor_name: log.editor_name,
                        edited_by_user_id: log.edited_by_user_id,
                        field: 'Remark',
                        old_value: log.old_remark || '-',
                        new_value: log.new_remark || '-',
                        edited_at: editedAt
                    });
                }
            });

            tbody.innerHTML = flattenedLogs.map(log => {
                const truckColor = getTruckColor(log.truck_number);

                return `
                    <tr class="border-b border-gray-200 hover:bg-purple-50">
                        <td class="p-2 font-bold ${truckColor}">${log.truck_number}</td>
                        <td class="p-2 font-semibold">${capitalizeText(log.editor_name)}</td>
                        <td class="p-2">#${log.edited_by_user_id}</td>
                        <td class="p-2"><span class="px-2 py-1 bg-blue-100 rounded text-xs font-bold">${log.field}</span></td>
                        <td class="p-2 text-red-600 line-through">${log.old_value}</td>
                        <td class="p-2 text-green-600 font-semibold">${log.new_value}</td>
                        <td class="p-2 text-sm">${log.edited_at}</td>
                    </tr>
                `;
            }).join('');
        }

        function displayAdminActions() {
            const tbody = document.getElementById('adminActionsBody');

            if (allAdminActions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-gray-500">No admin actions found</td></tr>';
                return;
            }

            tbody.innerHTML = allAdminActions.map(action => {
                const createdAt = new Date(action.created_at).toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                // Color code action types
                let actionColor = 'bg-blue-500';
                if (action.action_type === 'CREATE') actionColor = 'bg-green-500';
                else if (action.action_type === 'DELETE') actionColor = 'bg-red-500';
                else if (action.action_type === 'UPDATE') actionColor = 'bg-yellow-500';
                else if (action.action_type === 'TOGGLE_STATUS') actionColor = 'bg-purple-500';

                return `
                    <tr class="border-b border-gray-200 hover:bg-blue-50">
                        <td class="p-2 font-semibold">${capitalizeText(action.admin_name)}</td>
                        <td class="p-2">
                            <span class="px-2 py-1 rounded text-white text-xs ${actionColor}">
                                ${action.action_type}
                            </span>
                        </td>
                        <td class="p-2 text-xs uppercase">${action.target_type}${action.target_id ? ' #' + action.target_id : ''}</td>
                        <td class="p-2 text-sm">${action.description}</td>
                        <td class="p-2 text-xs">${action.ip_address || 'N/A'}</td>
                        <td class="p-2 text-sm">${createdAt}</td>
                    </tr>
                `;
            }).join('');
        }

        function getTruckColor(truckNumber) {
            const numMatch = truckNumber.match(/^(\d+)/);
            if (numMatch) {
                const num = parseInt(numMatch[1]);
                return num <= 1500 ? 'text-green-600' : 'text-orange-600';
            }
            return 'text-gray-700';
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Activate button
            event.target.classList.add('active');
        }

        function filterEntries() {
            const search = document.getElementById('entrySearch').value.toLowerCase();
            const rows = document.querySelectorAll('#entriesLogBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function filterRooms() {
            const search = document.getElementById('roomSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#roomsLogBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function filterPayments() {
            const search = document.getElementById('paymentSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#paymentsLogBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function filterLoginLogs() {
            const search = document.getElementById('loginLogSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#loginLogsBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function filterEditLogs() {
            const search = document.getElementById('editLogSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#editLogsBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function filterAdminActions() {
            const search = document.getElementById('adminActionSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#adminActionsBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function refreshAllData() {
            loadAllData();
        }
    </script>
</body>
</html>
