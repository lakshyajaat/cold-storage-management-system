<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallery - Activity Log</title>
    <link rel="stylesheet" href="/static/css/bootstrap-icons.min.css">
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link href="/static/css/arbitrary.css" rel="stylesheet">
    <link href="/static/css/fonts.css" rel="stylesheet">
    <link href="/static/css/dark-mode.css" rel="stylesheet">
    <style>
        * { font-family: 'Space Grotesk', sans-serif; }
        .neu-border {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            transition: all 0.2s ease;
        }
        .neu-border:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #000;
        }
        .neu-input {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            padding: 0.75rem;
            font-size: 1rem;
        }
        .neu-input:focus {
            outline: none;
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #000;
        }
        .neu-button {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .neu-button:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #000;
        }
        .neu-button:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 #000;
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            border: 3px solid #000;
            background: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .tab-button.active {
            background: #3B82F6;
            color: white;
            transform: translateY(3px);
            box-shadow: none;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -31px;
            top: 0;
            width: 3px;
            height: 100%;
            background: #e5e7eb;
        }
        .timeline-item:last-child::before {
            display: none;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spin-animation {
            animation: spin 1s linear infinite;
        }
        .hidden { display: none; }
    </style>
    <script src="/static/js/theme.js"></script>
</head>
<body class="bg-[#FFF9E6] min-h-screen p-6">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6 neu-border bg-white p-4">
            <div class="flex items-center gap-4">
                <a href="/g/" class="neu-button bg-gray-200 py-2 px-4">
                    <i class="bi bi-arrow-left"></i>
                </a>
                <div>
                    <div class="flex items-center gap-2">
                        <i class="bi bi-clock-history text-4xl text-blue-600"></i>
                        <div>
                            <h1 class="text-2xl font-bold">Activity Log</h1>
                            <p class="text-gray-600">Track all inventory activities</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="exportCSV()" class="neu-button bg-green-500 text-white">
                    <i class="bi bi-download"></i> Export
                </button>
                <button onclick="logout()" class="neu-button bg-red-500 text-white">
                    <i class="bi bi-box-arrow-right"></i> Exit
                </button>
            </div>
        </header>

        <!-- Stats Bar -->
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="neu-border bg-white p-4 text-center">
                <div class="text-gray-600 text-sm">Total Events</div>
                <div class="text-2xl font-bold" id="totalEvents">0</div>
            </div>
            <div class="neu-border bg-green-100 p-4 text-center">
                <div class="text-gray-600 text-sm">Stock In</div>
                <div class="text-2xl font-bold text-green-600" id="inEvents">0</div>
            </div>
            <div class="neu-border bg-red-100 p-4 text-center">
                <div class="text-gray-600 text-sm">Stock Out</div>
                <div class="text-2xl font-bold text-red-600" id="outEvents">0</div>
            </div>
            <div class="neu-border bg-blue-100 p-4 text-center">
                <div class="text-gray-600 text-sm">Items Affected</div>
                <div class="text-2xl font-bold text-blue-600" id="itemsAffected">0</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-2 mb-4">
            <button class="tab-button active" onclick="setTypeFilter('all')">
                <i class="bi bi-list"></i> All
            </button>
            <button class="tab-button" onclick="setTypeFilter('in')">
                <i class="bi bi-arrow-down-circle text-green-600"></i> Stock In
            </button>
            <button class="tab-button" onclick="setTypeFilter('out')">
                <i class="bi bi-arrow-up-circle text-red-600"></i> Stock Out
            </button>
        </div>

        <!-- Filters -->
        <div class="neu-border bg-white p-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-1">Date From</label>
                    <input type="date" id="dateFrom" class="neu-input w-full" onchange="applyFilters()">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">Date To</label>
                    <input type="date" id="dateTo" class="neu-input w-full" onchange="applyFilters()">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">Floor</label>
                    <select id="floorFilter" class="neu-input w-full" onchange="applyFilters()">
                        <option value="all">All Floors</option>
                        <option value="0">F0 - Ground</option>
                        <option value="1">F1 - First</option>
                        <option value="2">F2 - Second</option>
                        <option value="3">F3 - Third</option>
                        <option value="4">F4 - Top</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">Item</label>
                    <select id="itemFilter" class="neu-input w-full" onchange="applyFilters()">
                        <option value="all">All Items</option>
                    </select>
                </div>
                <div class="flex items-end gap-2">
                    <button onclick="clearFilters()" class="neu-button bg-gray-200 py-2 px-4">
                        <i class="bi bi-x-circle"></i> Clear
                    </button>
                    <button onclick="loadData()" class="neu-button bg-blue-500 text-white py-2 px-4">
                        <i class="bi bi-arrow-clockwise" id="refreshIcon"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- View Toggle -->
        <div class="flex justify-between items-center mb-4">
            <span class="text-sm text-gray-600 bg-green-50 px-2 py-1 border-2 border-black">
                <i class="bi bi-arrow-clockwise"></i> Auto-refresh: 10s
            </span>
            <div class="flex gap-2">
                <button onclick="setView('timeline')" class="neu-button bg-blue-500 text-white py-2 px-4" id="timelineBtn">
                    <i class="bi bi-clock-history"></i> Timeline
                </button>
                <button onclick="setView('table')" class="neu-button bg-white py-2 px-4" id="tableBtn">
                    <i class="bi bi-table"></i> Table
                </button>
            </div>
        </div>

        <!-- Timeline View -->
        <div id="timelineView" class="neu-border bg-white p-6">
            <div class="relative pl-8" id="timelineContainer">
                <div class="text-center text-gray-500 py-8">Loading...</div>
            </div>
        </div>

        <!-- Table View -->
        <div id="tableView" class="neu-border bg-white hidden">
            <div class="overflow-auto" style="max-height: 600px;">
                <table class="w-full">
                    <thead class="sticky top-0 bg-white">
                        <tr class="border-b-2 border-black">
                            <th class="p-3 text-left font-bold">Date & Time</th>
                            <th class="p-3 text-left font-bold">Item</th>
                            <th class="p-3 text-left font-bold">Floor</th>
                            <th class="p-3 text-left font-bold">Type</th>
                            <th class="p-3 text-left font-bold">Qty</th>
                            <th class="p-3 text-left font-bold">Price</th>
                            <th class="p-3 text-left font-bold">Total</th>
                            <th class="p-3 text-left font-bold">Reason</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Load More -->
        <div class="text-center mt-4">
            <button onclick="loadMore()" id="loadMoreBtn" class="neu-button bg-gray-200 hidden">
                <i class="bi bi-arrow-down-circle"></i> Load More (<span id="remainingCount">0</span> remaining)
            </button>
        </div>
    </div>

    <script>
        const token = sessionStorage.getItem('gt');
        const dh = sessionStorage.getItem('gdh');
        if (!token || !dh) window.location.href = '/events';

        let allTxns = [];
        let filteredTxns = [];
        let items = [];
        let currentView = 'timeline';
        let currentTypeFilter = 'all';
        let displayCount = 50;
        let refreshInterval = null;

        async function api(path) {
            const res = await fetch('/g/api' + path, {
                headers: { 'X-Token': token, 'X-DH': dh }
            });
            if (res.status === 401) { logout(); return null; }
            return res.ok ? res.json() : null;
        }

        async function loadData() {
            const refreshIcon = document.getElementById('refreshIcon');
            if (refreshIcon) refreshIcon.classList.add('spin-animation');

            try {
                const [txns, itemData] = await Promise.all([
                    api('/txns?limit=2000'),
                    api('/items')
                ]);

                if (txns) {
                    allTxns = txns || [];
                    applyFilters();
                }

                if (itemData) {
                    items = itemData || [];
                    const select = document.getElementById('itemFilter');
                    select.innerHTML = '<option value="all">All Items</option>' +
                        items.map(i => `<option value="${i.id}">${i.name} (F${i.floor})</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading data:', error);
            } finally {
                if (refreshIcon) {
                    setTimeout(() => refreshIcon.classList.remove('spin-animation'), 500);
                }
            }
        }

        function updateStats() {
            document.getElementById('totalEvents').textContent = filteredTxns.length;
            document.getElementById('inEvents').textContent = filteredTxns.filter(t => t.type === 'in').length;
            document.getElementById('outEvents').textContent = filteredTxns.filter(t => t.type === 'out').length;
            document.getElementById('itemsAffected').textContent = new Set(filteredTxns.map(t => t.item_id)).size;
        }

        function setTypeFilter(type) {
            currentTypeFilter = type;

            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.tab-button').classList.add('active');

            applyFilters();
        }

        function applyFilters() {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const floorFilter = document.getElementById('floorFilter').value;
            const itemFilter = document.getElementById('itemFilter').value;

            filteredTxns = allTxns.filter(t => {
                const date = new Date(t.created_at);
                const item = items.find(i => i.id === t.item_id);

                if (dateFrom && date < new Date(dateFrom)) return false;
                if (dateTo && date > new Date(dateTo + 'T23:59:59')) return false;
                if (currentTypeFilter !== 'all' && t.type !== currentTypeFilter) return false;
                if (floorFilter !== 'all' && item && item.floor !== parseInt(floorFilter)) return false;
                if (itemFilter !== 'all' && t.item_id !== parseInt(itemFilter)) return false;

                return true;
            });

            displayCount = 50;
            updateStats();
            render();
        }

        function clearFilters() {
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('floorFilter').value = 'all';
            document.getElementById('itemFilter').value = 'all';
            currentTypeFilter = 'all';

            // Reset tabs
            document.querySelectorAll('.tab-button').forEach((btn, idx) => {
                btn.classList.toggle('active', idx === 0);
            });

            filteredTxns = [...allTxns];
            displayCount = 50;
            updateStats();
            render();
        }

        function setView(view) {
            currentView = view;
            document.getElementById('timelineView').classList.toggle('hidden', view !== 'timeline');
            document.getElementById('tableView').classList.toggle('hidden', view !== 'table');
            document.getElementById('timelineBtn').classList.toggle('bg-blue-500', view === 'timeline');
            document.getElementById('timelineBtn').classList.toggle('text-white', view === 'timeline');
            document.getElementById('timelineBtn').classList.toggle('bg-white', view !== 'timeline');
            document.getElementById('tableBtn').classList.toggle('bg-blue-500', view === 'table');
            document.getElementById('tableBtn').classList.toggle('text-white', view === 'table');
            document.getElementById('tableBtn').classList.toggle('bg-white', view !== 'table');
        }

        function render() {
            const toShow = filteredTxns.slice(0, displayCount);
            const floorColors = { 0: 'bg-blue-100', 1: 'bg-green-100', 2: 'bg-yellow-100', 3: 'bg-orange-100', 4: 'bg-purple-100' };

            // Timeline view
            const timeline = document.getElementById('timelineContainer');
            if (toShow.length === 0) {
                timeline.innerHTML = '<div class="text-center text-gray-500 py-8">No activities found</div>';
            } else {
                let currentDate = '';
                timeline.innerHTML = toShow.map(t => {
                    const date = new Date(t.created_at);
                    const dateStr = date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
                    const timeStr = date.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
                    const item = items.find(i => i.id === t.item_id);
                    const floor = item ? item.floor : 0;
                    let dateHeader = '';

                    if (dateStr !== currentDate) {
                        currentDate = dateStr;
                        dateHeader = `<div class="font-bold text-lg mb-4 mt-6 -ml-8 bg-gray-100 p-2 border-l-4 border-blue-500">${dateStr}</div>`;
                    }

                    return `
                        ${dateHeader}
                        <div class="timeline-item relative mb-4 pl-4">
                            <div class="absolute -left-6 w-4 h-4 rounded-full ${t.type === 'in' ? 'bg-green-500' : 'bg-red-500'}"></div>
                            <div class="${t.type === 'in' ? 'bg-green-50' : 'bg-red-50'} p-4 rounded-lg border-2 ${t.type === 'in' ? 'border-green-200' : 'border-red-200'}">
                                <div class="flex justify-between items-start">
                                    <div class="flex items-center gap-2">
                                        <span class="font-bold text-lg">${t.item_name || 'Unknown'}</span>
                                        <span class="${floorColors[floor]} px-2 py-0.5 rounded text-xs font-bold">F${floor}</span>
                                        <span class="px-2 py-1 rounded text-sm text-white ${t.type === 'in' ? 'bg-green-500' : 'bg-red-500'}">
                                            ${t.type === 'in' ? 'IN' : 'OUT'}
                                        </span>
                                    </div>
                                    <span class="text-gray-500 text-sm">${timeStr}</span>
                                </div>
                                <div class="mt-2 grid grid-cols-3 gap-4 text-sm">
                                    <div>
                                        <span class="text-gray-500">Quantity:</span>
                                        <span class="font-bold ml-1">${t.qty}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-500">Unit Price:</span>
                                        <span class="font-bold ml-1">Rs. ${(t.unit_price || 0).toFixed(0)}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-500">Total:</span>
                                        <span class="font-bold ml-1 ${t.type === 'in' ? 'text-green-600' : 'text-red-600'}">Rs. ${(t.total || 0).toFixed(0)}</span>
                                    </div>
                                </div>
                                ${t.reason ? `<div class="mt-2 text-gray-600 text-sm"><i class="bi bi-chat-dots"></i> ${t.reason}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Table view
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = toShow.length > 0 ?
                toShow.map(t => {
                    const date = new Date(t.created_at);
                    const item = items.find(i => i.id === t.item_id);
                    const floor = item ? item.floor : 0;

                    return `
                        <tr class="border-b hover:bg-gray-50 ${t.type === 'in' ? 'bg-green-50' : 'bg-red-50'}">
                            <td class="p-3">
                                <div>${date.toLocaleDateString('en-IN')}</div>
                                <div class="text-sm text-gray-500">${date.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' })}</div>
                            </td>
                            <td class="p-3 font-semibold">${t.item_name || '-'}</td>
                            <td class="p-3"><span class="${floorColors[floor]} px-2 py-0.5 rounded font-bold text-xs">F${floor}</span></td>
                            <td class="p-3">
                                <span class="px-2 py-1 rounded text-sm text-white ${t.type === 'in' ? 'bg-green-500' : 'bg-red-500'}">
                                    ${t.type.toUpperCase()}
                                </span>
                            </td>
                            <td class="p-3 font-bold">${t.qty}</td>
                            <td class="p-3">Rs. ${(t.unit_price || 0).toFixed(0)}</td>
                            <td class="p-3 font-bold ${t.type === 'in' ? 'text-green-600' : 'text-red-600'}">Rs. ${(t.total || 0).toFixed(0)}</td>
                            <td class="p-3 text-gray-600">${t.reason || '-'}</td>
                        </tr>
                    `;
                }).join('') :
                '<tr><td colspan="8" class="p-4 text-center text-gray-500">No activities found</td></tr>';

            // Show/hide load more
            const remaining = filteredTxns.length - displayCount;
            document.getElementById('remainingCount').textContent = Math.max(0, remaining);
            document.getElementById('loadMoreBtn').classList.toggle('hidden', displayCount >= filteredTxns.length);
        }

        function loadMore() {
            displayCount += 50;
            render();
        }

        function exportCSV() {
            if (filteredTxns.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = ['Date', 'Time', 'Item', 'Floor', 'Type', 'Qty', 'Unit Price', 'Total', 'Reason'];
            const rows = filteredTxns.map(t => {
                const date = new Date(t.created_at);
                const item = items.find(i => i.id === t.item_id);
                return [
                    date.toLocaleDateString('en-IN'),
                    date.toLocaleTimeString('en-IN'),
                    t.item_name || '-',
                    'F' + (item ? item.floor : 0),
                    t.type.toUpperCase(),
                    t.qty,
                    t.unit_price || 0,
                    t.total || 0,
                    t.reason || ''
                ];
            });

            const csv = [headers.join(','), ...rows.map(r => r.map(v => `"${v}"`).join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gallery_activity_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function startAutoRefresh() {
            refreshInterval = setInterval(loadData, 10000);
        }

        window.addEventListener('beforeunload', () => {
            if (refreshInterval) clearInterval(refreshInterval);
        });

        function logout() {
            fetch('/g/api/logout', { method: 'POST', headers: { 'X-Token': token, 'X-DH': dh } }).finally(() => {
                sessionStorage.removeItem('gt');
                sessionStorage.removeItem('gdh');
                window.location.href = '/events';
            });
        }

        // Initialize
        setView('timeline');
        loadData();
        startAutoRefresh();
    </script>
</body>
</html>
