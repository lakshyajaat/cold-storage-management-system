<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Item Search - Cold Storage</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .neu-brutal {
            background: white;
            border: 3px solid black;
            box-shadow: 5px 5px 0px black;
        }
        .neu-brutal:hover {
            transform: translate(-2px, -2px);
            box-shadow: 7px 7px 0px black;
        }
        .neu-brutal-input {
            border: 2px solid black;
            padding: 8px;
            background: #fff;
        }
        .neu-brutal-button {
            background: #75c2c2;
            border: 3px solid black;
            box-shadow: 3px 3px 0px black;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .neu-brutal-button:hover {
            transform: translate(-2px, -2px);
            box-shadow: 5px 5px 0px black;
        }
        .neu-brutal-button:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px black;
        }
        .active-tab {
            background: #1ccbd1;
            transform: translateY(3px);
            box-shadow: none;
        }
    </style>
</head>
<body class="bg-[#faf4ed] p-4 min-h-screen">
    <div class="max-w-7xl mx-auto neu-brutal p-6 bg-white">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">
                <i class="bi bi-search"></i> Item Search & Filter
            </h1>
            <button class="neu-brutal-button px-4 py-2" onclick="goBack()">
                <i class="bi bi-arrow-left"></i> Back
            </button>
        </div>

        <!-- Find Entry Section -->
        <div class="neu-brutal p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">
                <i class="bi bi-funnel"></i> Search Filters
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <input type="text" id="filterTruck" placeholder="Thock Number" class="neu-brutal-input">
                <input type="text" id="filterName" placeholder="Customer Name" class="neu-brutal-input">
                <input type="text" id="filterVillage" placeholder="Village" class="neu-brutal-input">
                <input type="text" id="filterPhone" placeholder="Phone Number" class="neu-brutal-input">
                <input type="text" id="filterRoom" placeholder="Room Number" class="neu-brutal-input">
                <input type="text" id="filterFloor" placeholder="Floor Number" class="neu-brutal-input">
                <input type="date" id="filterDateFrom" placeholder="Date From" class="neu-brutal-input">
                <input type="date" id="filterDateTo" placeholder="Date To" class="neu-brutal-input">
            </div>
            <div class="flex gap-4">
                <button class="neu-brutal-button px-6 py-2" onclick="applyFilter()">
                    <i class="bi bi-check-circle"></i> Apply Filter
                </button>
                <button class="neu-brutal-button px-6 py-2" onclick="clearFilter()">
                    <i class="bi bi-x-circle"></i> Clear Filter
                </button>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="text-center p-8">
            <i class="bi bi-hourglass-split text-4xl"></i>
            <p class="mt-4">Loading data...</p>
        </div>

        <!-- All Entries Section -->
        <div id="entriesSection" class="neu-brutal p-6" style="display: none;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">
                    <i class="bi bi-list-ul"></i> All Entries (<span id="totalCount">0</span>)
                </h2>
                <div class="flex gap-4">
                    <div class="neu-brutal-button px-4 py-2">
                        <select id="perPage" class="bg-transparent border-none" onchange="updatePerPage()">
                            <option value="10">10 per page</option>
                            <option value="25">25 per page</option>
                            <option value="50">50 per page</option>
                            <option value="100">100 per page</option>
                            <option value="0">All</option>
                        </select>
                    </div>
                    <button class="neu-brutal-button px-6 py-2" onclick="exportToExcel()">
                        <i class="bi bi-file-earmark-excel"></i> Export to Excel
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="border-b-2 border-black">
                            <th class="p-2 text-left">Truck No</th>
                            <th class="p-2 text-left">Customer</th>
                            <th class="p-2 text-left">Phone</th>
                            <th class="p-2 text-left">Village</th>
                            <th class="p-2 text-left">Room</th>
                            <th class="p-2 text-left">Floor</th>
                            <th class="p-2 text-left">Gatar No</th>
                            <th class="p-2 text-left">Qty</th>
                            <th class="p-2 text-left">Remark</th>
                            <th class="p-2 text-left">Date</th>
                            <th class="p-2 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="entriesTableBody">
                        <!-- Table data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Capitalize first letter of text
        function capitalizeText(text) {
            if (!text || text.length === 0) return text;
            return text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();
        }

        const token = localStorage.getItem('token');
        let allEntries = [];
        let allRoomEntries = [];
        let combinedData = [];
        let filteredData = [];
        let perPage = 10;

        window.addEventListener('load', loadAllData);

        async function loadAllData() {
            try {
                // Check authentication
                if (!token) {
                    window.location.href = '/login';
                    return;
                }

                // Fetch all entries
                const entriesResponse = await fetch('/api/entries', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!entriesResponse.ok) {
                    if (entriesResponse.status === 401 || entriesResponse.status === 403) {
                        window.location.href = '/login';
                        return;
                    }
                    throw new Error(`Failed to load entries: ${await entriesResponse.text()}`);
                }

                allEntries = await entriesResponse.json();

                // Fetch all room entries
                const roomEntriesResponse = await fetch('/api/room-entries', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!roomEntriesResponse.ok) {
                    if (roomEntriesResponse.status === 401 || roomEntriesResponse.status === 403) {
                        window.location.href = '/login';
                        return;
                    }
                    throw new Error(`Failed to load room entries: ${await roomEntriesResponse.text()}`);
                }

                allRoomEntries = await roomEntriesResponse.json();

                // Combine data
                combinedData = allRoomEntries.map(roomEntry => {
                    const entry = allEntries.find(e => e.id === roomEntry.entry_id);
                    return {
                        truckNumber: roomEntry.truck_number,
                        name: entry?.name || '-',
                        phone: entry?.phone || '-',
                        village: entry?.village || '-',
                        room: roomEntry.room_no,
                        floor: roomEntry.floor,
                        gateNo: roomEntry.gate_no,
                        quantity: roomEntry.quantity,
                        remark: roomEntry.remark || '-',
                        date: new Date(roomEntry.created_at).toLocaleString('en-IN', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }),
                        rawDate: roomEntry.created_at,
                        entryId: entry?.id,
                        roomEntryId: roomEntry.id
                    };
                });

                filteredData = [...combinedData];

                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('entriesSection').style.display = 'block';

                populateTable();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingIndicator').innerHTML = `
                    <div class="neu-border bg-red-50 p-8">
                        <i class="bi bi-exclamation-triangle text-6xl text-red-500"></i>
                        <p class="mt-4 text-red-600 font-bold text-lg">Error loading data</p>
                        <p class="mt-2 text-red-500 text-sm">${error.message}</p>
                        <button onclick="window.location.href='/login'" class="mt-4 bg-red-500 text-white px-6 py-3 neu-border hover:bg-red-600">
                            <i class="bi bi-box-arrow-in-right"></i> Login Again
                        </button>
                    </div>
                `;
            }
        }

        function populateTable() {
            const tbody = document.getElementById('entriesTableBody');
            tbody.innerHTML = '';

            // Apply pagination
            const dataToShow = perPage === 0 ? filteredData : filteredData.slice(0, perPage);

            if (dataToShow.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="p-4 text-center text-gray-500">No entries found</td>
                    </tr>
                `;
                document.getElementById('totalCount').textContent = '0';
                return;
            }

            dataToShow.forEach(entry => {
                const row = document.createElement('tr');
                row.className = 'border-b border-black hover:bg-yellow-50';

                // Color code truck number based on pattern
                const truckColor = getTruckColor(entry.truckNumber);

                row.innerHTML = `
                    <td class="p-2 font-bold ${truckColor}">${entry.truckNumber}</td>
                    <td class="p-2">${capitalizeText(entry.name)}</td>
                    <td class="p-2">${entry.phone}</td>
                    <td class="p-2">${capitalizeText(entry.village)}</td>
                    <td class="p-2">${entry.room}</td>
                    <td class="p-2">${entry.floor}</td>
                    <td class="p-2">${entry.gateNo}</td>
                    <td class="p-2">${entry.quantity}</td>
                    <td class="p-2">${capitalizeText(entry.remark)}</td>
                    <td class="p-2 text-sm">${entry.date}</td>
                    <td class="p-2">
                        <div class="flex gap-2">
                            <button onclick="editLocation(${entry.roomEntryId})" class="neu-brutal-button px-3 py-1 text-xs bg-blue-400">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('totalCount').textContent = filteredData.length;
        }

        function getTruckColor(truckNumber) {
            // Extract the numeric part from truck number (e.g., "0001/100" -> 0001, "1605/200" -> 1605)
            const numMatch = truckNumber.match(/^(\d+)/);
            if (numMatch) {
                const num = parseInt(numMatch[1]);
                // SEED: 1-1500 (green), SELL: 1501-3000 (orange)
                return num <= 1500 ? 'text-green-600' : 'text-orange-600';
            }
            return 'text-gray-700'; // Default color
        }

        // Fuzzy search function - allows typos and partial matches
        function fuzzyMatch(searchTerm, targetText) {
            if (!searchTerm) return true;
            if (!targetText) return false;

            searchTerm = searchTerm.toLowerCase();
            targetText = targetText.toLowerCase();

            // If exact substring match, return true immediately
            if (targetText.includes(searchTerm)) return true;

            // Fuzzy matching: check if all characters appear in order
            let searchIndex = 0;
            for (let i = 0; i < targetText.length && searchIndex < searchTerm.length; i++) {
                if (targetText[i] === searchTerm[searchIndex]) {
                    searchIndex++;
                }
            }

            return searchIndex === searchTerm.length;
        }

        function applyFilter() {
            const truckFilter = document.getElementById('filterTruck').value;
            const nameFilter = document.getElementById('filterName').value;
            const villageFilter = document.getElementById('filterVillage').value;
            const phoneFilter = document.getElementById('filterPhone').value;
            const roomFilter = document.getElementById('filterRoom').value;
            const floorFilter = document.getElementById('filterFloor').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;

            filteredData = combinedData.filter(entry => {
                let matches = true;

                if (!fuzzyMatch(truckFilter, entry.truckNumber)) {
                    matches = false;
                }
                if (!fuzzyMatch(nameFilter, entry.name)) {
                    matches = false;
                }
                if (!fuzzyMatch(villageFilter, entry.village)) {
                    matches = false;
                }
                if (!fuzzyMatch(phoneFilter, entry.phone)) {
                    matches = false;
                }
                if (!fuzzyMatch(roomFilter, entry.room)) {
                    matches = false;
                }
                if (!fuzzyMatch(floorFilter, entry.floor)) {
                    matches = false;
                }

                // Date filtering
                if (dateFrom || dateTo) {
                    const entryDate = new Date(entry.rawDate);
                    if (dateFrom) {
                        const fromDate = new Date(dateFrom);
                        if (entryDate < fromDate) {
                            matches = false;
                        }
                    }
                    if (dateTo) {
                        const toDate = new Date(dateTo);
                        toDate.setHours(23, 59, 59, 999); // End of day
                        if (entryDate > toDate) {
                            matches = false;
                        }
                    }
                }

                return matches;
            });

            populateTable();
        }

        function clearFilter() {
            document.getElementById('filterTruck').value = '';
            document.getElementById('filterName').value = '';
            document.getElementById('filterVillage').value = '';
            document.getElementById('filterPhone').value = '';
            document.getElementById('filterRoom').value = '';
            document.getElementById('filterFloor').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';

            filteredData = [...combinedData];
            populateTable();
        }

        function updatePerPage() {
            perPage = parseInt(document.getElementById('perPage').value);
            populateTable();
        }

        function exportToExcel() {
            if (filteredData.length === 0) {
                alert('No data to export');
                return;
            }

            // Prepare data for export
            const exportData = filteredData.map(entry => ({
                'Truck Number': entry.truckNumber,
                'Customer Name': entry.name,
                'Phone': entry.phone,
                'Village': entry.village,
                'Room': entry.room,
                'Floor': entry.floor,
                'Gatar Number': entry.gateNo,
                'Quantity': entry.quantity,
                'Remark': entry.remark,
                'Date': entry.date
            }));

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);

            // Set column widths
            ws['!cols'] = [
                {wch: 15}, {wch: 20}, {wch: 15}, {wch: 15},
                {wch: 10}, {wch: 10}, {wch: 15}, {wch: 10},
                {wch: 20}, {wch: 20}
            ];

            XLSX.utils.book_append_sheet(wb, ws, "Entries");

            const filename = `cold_storage_entries_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        function editLocation(roomEntryId) {
            // Redirect to edit page
            window.location.href = `/room-entry-edit?id=${roomEntryId}`;
        }


        function goBack() {
            window.history.back();
        }

        // Auto-refresh data every 30 seconds
        setInterval(() => {
            console.log('Auto-refreshing data...');
            loadAllData();
        }, 30000);
    </script>
</body>
</html>
