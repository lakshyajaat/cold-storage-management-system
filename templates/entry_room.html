<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n-page-title="page_title_entry">Entry Room - Cold Storage</title>
    <link rel="stylesheet" href="/static/css/bootstrap-icons.min.css">
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link href="/static/css/arbitrary.css" rel="stylesheet">
    <link href="/static/css/fonts.css" rel="stylesheet">
    <link href="/static/css/dark-mode.css" rel="stylesheet">

    <style>
        * {
            font-family: 'Space Grotesk', sans-serif;
        }
        .neu-border {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            transition: all 0.2s ease;
        }
        .neu-border:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #000;
        }
        .neu-input {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            padding: 0.75rem;
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        .neu-input:focus {
            outline: none;
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #000;
        }
        .neu-button {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .neu-button:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #000;
        }
        .neu-button:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 #000;
        }
        .hidden { display: none; }
        .cursor-pointer { cursor: pointer; }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spin-animation {
            animation: spin 1s linear infinite;
        }
        .village-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 4px;
        }
        .village-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .village-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 2px solid #eee;
            transition: background 0.2s;
        }
        .village-item:hover {
            background: #f0f0f0;
            font-weight: 600;
        }
        .village-item:last-child {
            border-bottom: none;
        }
        .village-item.highlighted {
            background: #fbbf24;
            font-weight: 600;
        }
        .lang-selector {
            border: 2px solid #000;
            box-shadow: 2px 2px 0px #000;
        }
        .variety-chip.selected {
            background-color: #10b981;
            color: white;
            border-color: #059669;
        }
        .variety-chip.selected:hover {
            background-color: #059669;
        }
    </style>
    <script src="/static/js/theme.js"></script>
</head>
<body class="bg-[#FFF9E6] min-h-screen p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 md:mb-8 neu-border bg-white p-4 md:p-6 gap-4">
            <div>
                <div class="flex items-center gap-3">
                    <i class="bi bi-box-arrow-in-right text-3xl md:text-4xl text-orange-600"></i>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold" data-i18n="entry_room_title">Entry Room</h1>
                        <p class="text-gray-600 text-sm md:text-base" data-i18n="register_new_entry">Register new entry</p>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 items-center w-full md:w-auto justify-end">
                <!-- Language Selector -->
                <select id="langSelector" onchange="i18n.setLanguage(this.value)"
                        class="lang-selector bg-white px-3 py-2 text-sm font-medium cursor-pointer">
                    <option value="en">EN</option>
                    <option value="hi">हिं</option>
                </select>
                <!-- Theme Toggle -->
                <button onclick="theme.toggle()" class="neu-border bg-gray-200 px-3 py-2" title="Toggle Dark Mode">
                    <i class="bi bi-moon-fill theme-icon-moon"></i>
                    <i class="bi bi-sun-fill theme-icon-sun hidden"></i>
                </button>
                <button onclick="goBack()" class="neu-button bg-gray-200">
                    <i class="bi bi-arrow-left"></i> <span data-i18n="back">Back</span>
                </button>
            </div>
        </header>

        <!-- Pending Guard Entries Section -->
        <div id="guardEntriesSection" class="neu-border bg-yellow-50 p-4 mb-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <i class="bi bi-truck text-orange-600"></i>
                    <span data-i18n="pending_guard_entries">Pending Guard Entries</span>
                    <span id="guardEntryCount" class="text-sm bg-red-500 text-white px-2 py-1 rounded">0</span>
                </h3>
                <div class="flex items-center gap-2">
                    <span id="guardRefreshTimer" class="text-xs bg-blue-100 px-2 py-1 border border-black font-mono">5s</span>
                    <button onclick="loadGuardEntries(); resetGuardTimer();" class="text-sm bg-gray-200 px-3 py-1 border-2 border-black">
                        <i class="bi bi-arrow-clockwise"></i> <span data-i18n="refresh">Refresh</span>
                    </button>
                </div>
            </div>
            <div id="guardEntriesList" class="max-h-64 overflow-y-auto space-y-2">
                <!-- Guard entries will be populated here -->
            </div>
        </div>

        <!-- Main Content Grid: Form (Left) + Recent Room Entries (Right) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 mb-8">
            <!-- User Details & Entry Form (Left) -->
            <div id="entryForm" class="neu-border bg-white p-6">
                <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                    <i class="bi bi-person-check"></i>
                    <span data-i18n="user_details_entry">User Details & Entry</span>
                </h2>

                <div class="grid grid-cols-1 gap-4 mb-6">
                    <div class="relative">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <span data-i18n="phone">Phone</span> * <span class="text-sm text-gray-500">(<span data-i18n="phone_must_10_digits">Must be 10 digits</span>)</span>
                        </label>
                        <input
                            type="tel"
                            id="userPhone"
                            required
                            class="w-full neu-input"
                            data-i18n-placeholder="phone_placeholder"
                            placeholder="Search or enter 10-digit phone number"
                            maxlength="10"
                            minlength="10"
                            pattern="[0-9]{10}"
                            autocomplete="off"
                            onfocus="showPhoneDropdown()"
                            oninput="filterPhones()"
                        >
                        <div id="phoneDropdown" class="village-dropdown hidden">
                            <div id="phoneList" class="village-list"></div>
                        </div>
                        <div id="searchStatus" class="hidden mt-2 p-2 border-2">
                            <p class="text-sm font-semibold"></p>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <span data-i18n="name">Name</span> *
                        </label>
                        <input
                            type="text"
                            id="userName"
                            required
                            class="w-full neu-input"
                            data-i18n-placeholder="name_placeholder"
                            placeholder="Enter name"
                            oninput="capitalizeFirstLetter(this)"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <span data-i18n="so_label">S/O</span> <span class="text-sm text-gray-500">(<span data-i18n="so_description">Son Of / Father's Name</span>)</span>
                        </label>
                        <input
                            type="text"
                            id="userSO"
                            class="w-full neu-input"
                            data-i18n-placeholder="so_placeholder"
                            placeholder="Enter father's name (optional)"
                            oninput="capitalizeFirstLetter(this)"
                        >
                    </div>
                    <div class="relative">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <span data-i18n="village">Village</span> *
                        </label>
                        <div class="relative">
                            <input
                                type="text"
                                id="userVillage"
                                required
                                class="w-full neu-input"
                                data-i18n-placeholder="village_placeholder"
                                placeholder="Search or select village"
                                autocomplete="off"
                                onfocus="showVillageDropdown()"
                                oninput="capitalizeFirstLetter(this); filterVillages()"
                            >
                            <div id="villageDropdown" class="village-dropdown hidden">
                                <div id="villageList" class="village-list"></div>
                            </div>
                        </div>
                    </div>
                </div>

            <form id="entrySubmitForm" onsubmit="submitEntry(event)">
                <input type="hidden" id="userId" />

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <span data-i18n="select_category">Select Category</span> *
                    </label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <label class="neu-border p-3 bg-green-50 cursor-pointer hover:bg-green-100 transition-colors">
                            <input
                                type="radio"
                                name="thockCategory"
                                value="seed"
                                required
                                class="mr-2"
                                onchange="updateCategoryInfo()"
                            >
                            <div>
                                <span class="text-lg font-bold text-green-700" data-i18n="seed">SEED</span>
                                <p id="seedCount" class="text-xs text-gray-600 mt-1 hidden" data-i18n="loading">Loading...</p>
                            </div>
                        </label>
                        <label class="neu-border p-3 bg-orange-50 cursor-pointer hover:bg-orange-100 transition-colors">
                            <input
                                type="radio"
                                name="thockCategory"
                                value="sell"
                                required
                                class="mr-2"
                                onchange="updateCategoryInfo()"
                            >
                            <div>
                                <span class="text-lg font-bold text-orange-700" data-i18n="sell">SELL</span>
                                <p id="sellCount" class="text-xs text-gray-600 mt-1 hidden" data-i18n="loading">Loading...</p>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <span data-i18n="expected_quantity_label">Expected Quantity</span> *
                    </label>
                    <input
                        type="number"
                        id="expectedQuantity"
                        required
                        min="1"
                        max="1500"
                        class="w-full neu-input"
                        data-i18n-placeholder="expected_qty_placeholder"
                        placeholder="Enter expected quantity (1-1500)"
                        oninput="updateTruckPreview()"
                    >
                </div>

                <!-- Variety Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <span data-i18n="variety_label">Variety</span> <span class="text-sm text-gray-500">(<span data-i18n="select_multiple">Select multiple</span>)</span>
                    </label>
                    <div id="varietyChips" class="flex flex-wrap gap-2">
                        <button type="button" onclick="toggleVariety(this, 'Chipsona 1')" class="variety-chip px-3 py-1 text-sm font-medium rounded-full border-2 border-gray-300 bg-gray-50 hover:bg-gray-100 transition-colors">
                            Chipsona 1
                        </button>
                        <button type="button" onclick="toggleVariety(this, 'Chipsona 3')" class="variety-chip px-3 py-1 text-sm font-medium rounded-full border-2 border-gray-300 bg-gray-50 hover:bg-gray-100 transition-colors">
                            Chipsona 3
                        </button>
                        <button type="button" onclick="toggleVariety(this, '3797')" class="variety-chip px-3 py-1 text-sm font-medium rounded-full border-2 border-gray-300 bg-gray-50 hover:bg-gray-100 transition-colors">
                            3797
                        </button>
                        <button type="button" onclick="toggleVariety(this, 'S4')" class="variety-chip px-3 py-1 text-sm font-medium rounded-full border-2 border-gray-300 bg-gray-50 hover:bg-gray-100 transition-colors">
                            S4
                        </button>
                        <button type="button" onclick="toggleVariety(this, 'Sangam')" class="variety-chip px-3 py-1 text-sm font-medium rounded-full border-2 border-gray-300 bg-gray-50 hover:bg-gray-100 transition-colors">
                            Sangam
                        </button>
                        <button type="button" onclick="toggleVariety(this, 'Khayat')" class="variety-chip px-3 py-1 text-sm font-medium rounded-full border-2 border-gray-300 bg-gray-50 hover:bg-gray-100 transition-colors">
                            Khayat
                        </button>
                        <button type="button" onclick="toggleVariety(this, 'Neel Kanth')" class="variety-chip px-3 py-1 text-sm font-medium rounded-full border-2 border-gray-300 bg-gray-50 hover:bg-gray-100 transition-colors">
                            Neel Kanth
                        </button>
                        <button type="button" onclick="toggleVariety(this, 'Fry Sona')" class="variety-chip px-3 py-1 text-sm font-medium rounded-full border-2 border-gray-300 bg-gray-50 hover:bg-gray-100 transition-colors">
                            Fry Sona
                        </button>
                        <button type="button" onclick="toggleVariety(this, 'Surya')" class="variety-chip px-3 py-1 text-sm font-medium rounded-full border-2 border-gray-300 bg-gray-50 hover:bg-gray-100 transition-colors">
                            Surya
                        </button>
                        <button type="button" onclick="toggleVariety(this, 'L.R.')" class="variety-chip px-3 py-1 text-sm font-medium rounded-full border-2 border-gray-300 bg-gray-50 hover:bg-gray-100 transition-colors">
                            L.R.
                        </button>
                        <button type="button" onclick="toggleVariety(this, 'Pakhraaj')" class="variety-chip px-3 py-1 text-sm font-medium rounded-full border-2 border-gray-300 bg-gray-50 hover:bg-gray-100 transition-colors">
                            Pakhraaj
                        </button>
                        <button type="button" onclick="toggleCustomVariety()" class="variety-chip px-3 py-1 text-sm font-medium rounded-full border-2 border-dashed border-gray-400 bg-white hover:bg-gray-50 transition-colors">
                            <i class="bi bi-plus"></i> Custom
                        </button>
                    </div>
                    <!-- Custom variety input (hidden by default) -->
                    <div id="customVarietyInput" class="hidden mt-2">
                        <input
                            type="text"
                            id="customVarietyText"
                            class="w-full neu-input text-sm"
                            placeholder="Enter custom variety name"
                            onkeypress="addCustomVariety(event)"
                        >
                        <p class="text-xs text-gray-500 mt-1">Press Enter to add</p>
                    </div>
                    <!-- Selected varieties display -->
                    <input type="hidden" id="selectedVarieties" value="">
                    <p id="selectedVarietiesDisplay" class="text-sm text-gray-600 mt-2 hidden">
                        <span data-i18n="selected">Selected</span>: <span id="varietyList"></span>
                    </p>
                </div>

                <div id="truckPreview" class="mb-4 p-3 bg-blue-50 neu-border hidden">
                    <p class="text-sm text-gray-600 mb-1">
                        <i class="bi bi-truck"></i>
                        <span data-i18n="truck_preview">Truck number preview</span>:
                    </p>
                    <p class="text-2xl font-bold text-blue-700" id="previewThockNumber">-</p>
                </div>

                <div class="flex gap-3">
                    <button type="submit" id="submitEntryBtn" class="neu-button bg-green-500 text-white flex-1">
                        <i class="bi bi-check-circle"></i> <span data-i18n="submit">Submit</span>
                    </button>
                    <button type="button" onclick="resetForm()" class="neu-button bg-gray-300">
                        <i class="bi bi-x-circle"></i> <span data-i18n="reset">Reset</span>
                    </button>
                </div>
            </form>
            </div>

            <!-- Recent Room Entries (Right) -->
            <div class="neu-border bg-white p-4 md:p-6">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                    <h2 class="text-xl md:text-2xl font-bold flex items-center gap-2">
                        <i class="bi bi-door-open text-blue-600"></i>
                        <span data-i18n="recent_room_entries">Recent Room Entries</span>
                    </h2>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-600 bg-green-50 px-2 py-1 neu-border flex items-center gap-1">
                            <i class="bi bi-arrow-clockwise" id="refreshIcon"></i> <span data-i18n="auto_refresh_5s">Auto-refresh (5s)</span>
                        </span>
                        <span class="text-xs text-gray-600 bg-blue-50 px-2 py-1 neu-border">
                            <i class="bi bi-hand-index"></i> <span data-i18n="click_to_print">Click to print</span>
                        </span>
                    </div>
                </div>
                <div id="recentRoomEntries" class="overflow-auto" style="max-height: 700px;">
                    <table class="w-full text-sm">
                        <thead class="sticky top-0 bg-white">
                            <tr class="border-b-2 border-black">
                                <th class="text-left p-2 font-bold" data-i18n="thock_number">Truck No</th>
                                <th class="text-left p-2 font-bold" data-i18n="room">Room</th>
                                <th class="text-left p-2 font-bold" data-i18n="floor">Floor</th>
                                <th class="text-left p-2 font-bold" data-i18n="gatar">Gatar</th>
                                <th class="text-left p-2 font-bold" data-i18n="qty">Qty</th>
                                <th class="text-left p-2 font-bold" data-i18n="date">Date</th>
                                <th class="text-left p-2 font-bold" data-i18n="action">Action</th>
                            </tr>
                        </thead>
                        <tbody id="roomEntriesTableBody">
                            <tr>
                                <td colspan="7" class="text-center p-4 text-gray-500" data-i18n="loading_room_entries">Loading room entries...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Success Message -->
        <div id="successMessage" class="hidden mt-6 neu-border bg-green-100 p-8">
            <h3 class="text-2xl font-bold text-green-700 mb-4 flex items-center gap-2">
                <i class="bi bi-check-circle-fill"></i>
                <span data-i18n="entry_created_success">Entry Created Successfully!</span>
            </h3>
            <div class="p-6 bg-white neu-border mb-4">
                <p class="text-lg text-gray-700 mb-2"><span data-i18n="auto_generated_truck">Auto-Generated Truck Number</span>:</p>
                <p class="text-4xl font-bold text-green-700" id="assignedTruck"></p>
            </div>
            <button onclick="resetForm()" class="neu-button bg-green-500 text-white w-full">
                <i class="bi bi-plus-circle"></i> <span data-i18n="create_another_entry">Create Another Entry</span>
            </button>
        </div>

        <!-- Recent Main Entries (Bottom) -->
        <div class="neu-border bg-white p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <i class="bi bi-clock-history"></i>
                    <span data-i18n="recent_main_entries">Recent Main Entries</span>
                </h2>
            </div>
            <div id="recentEntries" class="overflow-auto border border-gray-200 rounded" style="max-height: 500px;">
                <table class="w-full text-sm">
                    <thead class="sticky top-0 bg-white">
                        <tr class="border-b-2 border-black">
                            <th class="text-left p-2 font-bold" data-i18n="truck">Truck</th>
                            <th class="text-left p-2 font-bold" data-i18n="name">Name</th>
                            <th class="text-left p-2 font-bold" data-i18n="phone">Phone</th>
                            <th class="text-left p-2 font-bold" data-i18n="village">Village</th>
                            <th class="text-left p-2 font-bold" data-i18n="qty">Qty</th>
                            <th class="text-left p-2 font-bold" data-i18n="category">Category</th>
                            <th class="text-left p-2 font-bold" data-i18n="created">Created</th>
                            <th class="text-right p-2 font-bold" data-i18n="actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="entriesTableBody">
                        <tr>
                            <td colspan="8" class="text-center p-4 text-gray-500" data-i18n="loading">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Edit Entry Modal -->
    <div id="editEntryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="display: none;">
        <div class="bg-white neu-border p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <i class="bi bi-pencil-square text-blue-600"></i>
                    <span data-i18n="edit_entry">Edit Entry</span>
                </h2>
                <button onclick="closeEditEntryModal()" class="text-2xl text-gray-500 hover:text-black">&times;</button>
            </div>
            <form id="editEntryForm" onsubmit="saveEditedEntry(event)">
                <input type="hidden" id="editEntryId">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold mb-1" data-i18n="name">Name</label>
                        <input type="text" id="editEntryName" required class="w-full neu-input" placeholder="Name">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1" data-i18n="phone">Phone</label>
                        <input type="tel" id="editEntryPhone" required maxlength="10" minlength="10" pattern="[0-9]{10}" class="w-full neu-input" placeholder="10-digit phone">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1" data-i18n="village">Village</label>
                        <input type="text" id="editEntryVillage" class="w-full neu-input" placeholder="Village">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1" data-i18n="so_label">S/O</label>
                        <input type="text" id="editEntrySO" class="w-full neu-input" placeholder="Father's name">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1" data-i18n="expected_qty">Expected Quantity</label>
                        <input type="number" id="editEntryQty" required min="1" class="w-full neu-input" placeholder="Quantity">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1" data-i18n="category">Category</label>
                        <select id="editEntryCategory" required class="w-full neu-input">
                            <option value="seed">SEED (1-1500)</option>
                            <option value="sell">SELL (1501+)</option>
                        </select>
                <!-- Theme Toggle -->
                <button onclick="theme.toggle()" class="neu-border bg-gray-200 px-3 py-2" title="Toggle Dark Mode">
                    <i class="bi bi-moon-fill theme-icon-moon"></i>
                    <i class="bi bi-sun-fill theme-icon-sun hidden"></i>
                </button>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1" data-i18n="variety">Variety</label>
                        <input type="text" id="editEntryRemark" class="w-full neu-input" placeholder="Variety (comma-separated)">
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 neu-button bg-green-500 text-white">
                        <i class="bi bi-check-circle"></i> <span data-i18n="save">Save</span>
                    </button>
                    <button type="button" onclick="closeEditEntryModal()" class="flex-1 neu-button bg-gray-300">
                        <i class="bi bi-x-circle"></i> <span data-i18n="cancel">Cancel</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- i18n Script -->
    <script src="/static/js/prefetch.js"></script>
    <script src="/static/js/i18n.js"></script>
    <script>
        const token = localStorage.getItem('token');
        let currentUser = null;

        // Check operation mode on page load and redirect if needed
        async function checkOperationMode() {
            try {
                const response = await fetch('/api/settings/operation_mode', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const setting = await response.json();
                    if (setting.setting_value === 'unloading') {
                        // Redirect to gate pass entry page in unloading mode
                        window.location.href = '/gate-pass-entry';
                        return false;
                    }
                }
            } catch (error) {
                console.error('Error checking operation mode:', error);
            }
            return true;
        }

        // Auto-search timeout
        let searchTimeout = null;
        let entriesLimit = 10; // Default to show 10 entries

        // Category counts
        let seedCount = 0;
        let sellCount = 0;

        // Phone list from database - will be populated on load
        let customerPhones = [];

        // Village list for searchable dropdown
        const villages = ["Jahangirabad","Anupshahr","Achalpur","Ahamad Nagar Urf Touli","Ahar Bangar","Ahar Khadar","Akbarpur Urf Bachchikhera Bang","Alampur Urf Torai Bangar","Amarpur","Amba","Ametha","Aniwas","Anjni","Badarkha","Badshahpur Pauta","Bagsara","Bamanpur","Banawaripur","Barhpura","Begampur Urf Jairampur","Bhailai","Bhaipur","Bhiroli","Bhopur","Bibiyana","Bichaula","Bidhipur","Birauli","Borha","Chacharai","Charaura","Chhaturiya","Dabka","Daraura","Daravar","Davkora","Devakaranpur Urf Bajhera","Dugrau","Dungara Jogi","Enchora","Faridpur Bariyan","Fatahpur","Gahana Govardhanpur","Gangabas Pahara","Garhara","Godhana","Harchandpur","Hasanpur Bangar","Hisavati","Hoshiyarpur Urf Adhiyar","Jafrabad Urf Gangabas Bangar","Jahangirabad Rural","Jairampur Kudena","Jalilpur","Jamrau","Jasar","Jatpura","Jatvai","Jugasana Kalan","Jugasana Khurd","Karanpur Kalan","Karanpur Urf Nurpur","Karonji","Katiyavali","Khadana","Khalaur","Khalikabad/Dungrajat","Khalikpur","Khanpura","Khaunada","Khijarabad","Khushalgarh","Kishanpur Urf Kishan Khera","Kubari","Lachchhampur","Lachhoi","Madagavan","Madhogarh","Malakpur","Man Karora","Mau","Mauharsa","Maujpur","Mohammadpur Bangar","Mohammadpur Khadar","Mubarikpur","Mubarikpur Bangar","Muradnagar","Nagala Nalu","Navabpur Urf Dharampur","Navi Nagar","Pachdevra","Pagauna","Paharpur","Parali","Patrampur","Pipehara","Pootha","Rajapur","Rajaur","Rajner Urf Sorla","Rajpur","Raura","Rohallapur/Kharva","Ronda","Roopvas","Rooth Bangar","Rootha","Sahibad Urf Kakarai","Salamatpur","Salgavan","Sankhani","Shahjahanpur","Shekupur Raura","Sherpur Bangar","Shikoi","Shyampuri","Shyaurampur Jinai","Sihlinagar","Siraura Bangar","Soharkhan","Sunai","Sunana","Suratgarh Urf Lodhai","Telia Nagla","Titota Urf Birgaon","Ugevan","Abhaypur","Akapur Riyana","Alampur Nagla","Alavas Baturi","Amargarh","Amarthal Urf Unchagaon","Aurangabad Tahapur Bager","Aurangabad Tahapur Khader","B B Nagar","Badshahpur Gadia","Badshahpur Talab","Bahainpur","Baharmpur Urf Pali","Bahedi Khera","Bainipur","Balipur","Bamanpur Talluka","Bansuri","Barauli Basdevpur","Barhana","Barkatpur","Basi Bangar","Basi Khadar","Bathada Vajidpur","Bhadaura","Bhadoi Asarfpur","Bhagawantpur","Bhainsaura","Bhamrauli","Bhansa Khur","Bharkau","Bharra","Bhatpura","Bhaupur","Bhirawti","Bhurawala","Bigraon","Biharipur","Bihata","Chandpur Poothi","Chandyana","Chasi","Chatehra","Chhanaura","Chhatamwala","Chigrawati","Chitsona Alipur","Darauli","Darveshpur","Daulatpur Kalan","Dehra","Dhakauli","Dhakka","Dhakrauli","Dhalna","Dhaniyawali","Dulkhara","Eklaidi","Emamabad","Farida Bager","Farida Khadar","Fatehpur","Fatehpur Gujar","Fulaira","Gasupur","Ghansoorpur","Ghunghraoli","Ginaura Nagli","Giraura","Gulab Nagar","Guraoli","Hajipur","Harwanpur Urf Bhagawanpur","Hasanpur Ujarra","Hingbara","Ilna","Imalia","Ishanpur","Jadaul","Jadauli","Jalalpur","Jaria Alampur","Jawasa","Kachraut","Kalyanpur","Kamalpur","Kanauna","Kapsaipur","Karaitha","Karauthi","Karethha","Kariyari","Kaura Shamshadbad","Kesorpur Sathla","Khad Mohan Nagar","Khandoi","Khanpur Guntu","Khanpur Majra","Kharkali","Kharpur","Khijarpur","Kisola","Kriyawali","Kuchesar","Kurena","Ladana","Lalgarhi","Launga","Madangarh","Madona Jafrabad","Maduhasan Garhi Bager","Maduhasan Garhi Khadar","Mahav","Mahiuddinpur Bukalana","Mahuddinpur","Makri","Mangalpur","Mania Tikri","Manpur","Mathura Nagal","Maua Khera","Mavai","Mirzapur Nagli","Modh Allipur Urf Nima Patty Al","Mohamadpurbarwala","Mullani","Nagaur","Nagla Madaripur","Narendrapur","Narsena","Nehchauli","Nikhob","Nirsukha","Nittyanandpur Nagli","Nizampur Bager","Nizampur Khadar","Pali","Pali Anandgarhi","Palipartapur","Parawana Mahmudpur","Pempur","Pilkhani","Pirpur","Pota Kabulpur","Pyana Kalan","Pyana Khurd","Raghunathpur","Rahmatpur Augna","Rampur Pitampur","Ranapur","Rasulpur","Ratanpur","Rausla","Ravani Katiri Bangar","Ravani Katiri Khadar","Sabdalpur","Sahanpur","Sahera","Saidpur","Salabad Dhamaira","Saujna Rani","Sega Jagatpur","Seorampur","Shadipur Banboi","Shafi Nagar","Shakarpur","Shekhupura","Sikri","Sinhali Jhaya","Siyana","Sojna Jhaya","Sulaila","Surajpur Tikri","Takrarpur Ladpor","Tehgora","Thalinayatpur","Thana Gajraula","Thauna","Tibra","Timarpur","Umarpur","Verafirojpur","Yunispur","Abdullapur Hulasan","Ahmad Baj","Ahmadgarh","Ajijabad","Akbarpur Bas Kaneni","Allipur","Allipura Mubarikpur","Amarpur","Anaouna","Anchar Kalan","Ancharu Khurd","Asawari","Ashrefpur Abdullapur","Asrauli","Aurangabad Chandok","Azampur Dariapur","Bad","Badarkha Sirbas","Badrampur","Bailonth","Bamanpur","Ban","Banaul","Barasau","Barauda","Barauli","Barkatpur","Barkhara Hasangarhi","Beram Nagar","Bhaipur","Bhalolpur","Bhansroli Nasirpur","Bhataula","Bhonpur","Bohich","Chakla","Chitsaun","Dargahpur Basauti","Derveshpur","Dhalna","Dhaurau","Dhooturi","Domla Hasangarh","Faizallapur Ajnara","Faridpur Haveli","Fatahabad","Fatehgarh","Fazilpur","Ganga Garh","Gangabaj","Ghungravali Banvaripur","Golabas","Halpura","Hatampur","Hauganpur","Hazaratpur","Hinnaut","Hurthala","Jagdishpur Aurangabad","Jainawai","Jakhauta","Jalalpur","Jalalpur Karira","Jalalpur Katora","Jalaluddinpur Ginauri","Jalphi","Jamalpur","Janipur Kalan","Janipur Khurd","Jatpura","Jeerajpur","Kadon","Kadrabad","Kailawali","Kaisawan","Kamauna","Kaneni Badrampur","Karaina","Karauda","Karira","Kastaba Dhadd","Kasumi","Keratpur","Khailia Kalyanpur","Khairpur","Khakuda","Khandar","Khandwama","Khassia","Kiryawali","Kondupur","Kutubpur","Kuwarpur","Lalgarhi","Lalner","Lohra","Ludhpura","Madanpur Mubarakpur","Mahmudpur","Mahuwa Khara","Mamau","Mandawali","Maudi","Meerapur","Mohammadpur Ginauri","Morauni","Mukeempur","Mukhara","Mustfabad Daduwa","Nagalia Lachhamanpur","Nagla Dalpatpur","Nagla Lutf Alipur","Nagla Naw","Nagla Sarangpur","Nagla Urf Fattapur","Narau","Nawada","Noorpur Nagalia","Padha","Paharpur Haveli","Paharpur Surjawali","Pahasu Dehat","Pandrawal","Pitampur","Poothri Khurd","Poroli","Ragsonth","Rahmapur","Rajpura","Rajupura","Rampur Manpur","Ranau Raham Alipur","Ranayach Narendrapur","Rangpur","Raniwala","Rasulgarhi","Rasulpur","Rasulpur Nagla Bichat","Risalu","Riwara","Runsi","Sahar","Sahatpur Khairi","Saidh Garhi","Salabad","Salbahanpur","Salempur","Samanpur","Samaspur","Sarawa","Sarbhanna","Sargaon","Shikarpur","Shikarpur Rural","Siddhpur","Sidgarhi","Soi","Sujapur Pootha","Sultanpur Khader","Sultanpur Mirgarhi","Surajpur Nisfi","Surjawali","Surkharu","Syarli","Tayabpur","Teyor Bujurag","Teyori","Tunda Khera","Turkipura Khas","Urdmi","Urf Dusari","Utrawali","Yakubpur"];

        // Selected varieties array for multi-select
        let selectedVarieties = [];

        // Toggle variety selection
        function toggleVariety(button, variety) {
            const index = selectedVarieties.indexOf(variety);
            if (index > -1) {
                // Remove from selection
                selectedVarieties.splice(index, 1);
                button.classList.remove('selected');
            } else {
                // Add to selection
                selectedVarieties.push(variety);
                button.classList.add('selected');
            }
            updateVarietyDisplay();
        }

        // Toggle custom variety input visibility
        function toggleCustomVariety() {
            const customInput = document.getElementById('customVarietyInput');
            customInput.classList.toggle('hidden');
            if (!customInput.classList.contains('hidden')) {
                document.getElementById('customVarietyText').focus();
            }
        }

        // Add custom variety on Enter key
        function addCustomVariety(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = document.getElementById('customVarietyText');
                const variety = input.value.trim();
                if (variety && !selectedVarieties.includes(variety)) {
                    selectedVarieties.push(variety);

                    // Add a new chip for the custom variety
                    const chipsContainer = document.getElementById('varietyChips');
                    const customButton = chipsContainer.querySelector('button:last-child');
                    const newChip = document.createElement('button');
                    newChip.type = 'button';
                    newChip.className = 'variety-chip selected px-3 py-1 text-sm font-medium rounded-full border-2 border-gray-300 bg-gray-50 hover:bg-gray-100 transition-colors';
                    newChip.textContent = variety;
                    newChip.onclick = function() { toggleVariety(this, variety); };
                    chipsContainer.insertBefore(newChip, customButton);

                    updateVarietyDisplay();
                }
                input.value = '';
                document.getElementById('customVarietyInput').classList.add('hidden');
            }
        }

        // Update the variety display text
        function updateVarietyDisplay() {
            const display = document.getElementById('selectedVarietiesDisplay');
            const list = document.getElementById('varietyList');
            const hiddenInput = document.getElementById('selectedVarieties');

            if (selectedVarieties.length > 0) {
                display.classList.remove('hidden');
                list.textContent = selectedVarieties.join(', ');
                hiddenInput.value = selectedVarieties.join(', ');
            } else {
                display.classList.add('hidden');
                list.textContent = '';
                hiddenInput.value = '';
            }
        }

        // Clear variety selection (called by resetForm)
        function clearVarietySelection() {
            selectedVarieties = [];
            document.querySelectorAll('.variety-chip.selected').forEach(chip => {
                chip.classList.remove('selected');
            });
            // Remove any dynamically added custom chips
            const customChips = document.querySelectorAll('.variety-chip');
            const defaultVarieties = ['Chipsona 1', 'Chipsona 3', '3797', 'S4', 'Sangam', 'Khayat', 'Neel Kanth', 'Fry Sona', 'Surya', 'L.R.', 'Pakhraaj'];
            customChips.forEach(chip => {
                const text = chip.textContent.trim();
                if (!defaultVarieties.includes(text) && !text.includes('Custom')) {
                    chip.remove();
                }
            });
            updateVarietyDisplay();
            document.getElementById('customVarietyInput').classList.add('hidden');
            document.getElementById('customVarietyText').value = '';
        }

        // Capitalize first letter of input field
        function capitalizeFirstLetter(input) {
            const value = input.value;
            if (value.length > 0) {
                input.value = value.charAt(0).toUpperCase() + value.slice(1);
            }
        }

        // Capitalize first letter of text content
        function capitalizeText(text) {
            if (!text || text.length === 0) return text;
            return text.charAt(0).toUpperCase() + text.slice(1);
        }

        // Capitalize all text outputs in tables and display elements
        function capitalizeOutputs() {
            // Capitalize table cells (except headers and specific columns like phone, truck number)
            document.querySelectorAll('tbody td').forEach(cell => {
                const text = cell.textContent.trim();
                // Skip if it's a number, phone, truck number, or empty
                if (text && !/^\d+$/.test(text) && !/^[\d\/-]+$/.test(text) && text !== '-') {
                    cell.textContent = capitalizeText(text);
                }
            });
        }

        // Fuzzy match function for village search
        function fuzzyMatchVillage(searchTerm, targetText) {
            if (!searchTerm) return true;
            if (!targetText) return false;

            searchTerm = searchTerm.toLowerCase();
            targetText = targetText.toLowerCase();

            // Exact substring match first (fast path)
            if (targetText.includes(searchTerm)) return true;

            // Fuzzy matching: all characters must appear in order
            let searchIndex = 0;
            for (let i = 0; i < targetText.length && searchIndex < searchTerm.length; i++) {
                if (targetText[i] === searchTerm[searchIndex]) {
                    searchIndex++;
                }
            }

            return searchIndex === searchTerm.length;
        }

        // Show village dropdown
        function showVillageDropdown() {
            filterVillages();
            document.getElementById('villageDropdown').classList.remove('hidden');
        }

        // Hide village dropdown
        function hideVillageDropdown() {
            setTimeout(() => {
                document.getElementById('villageDropdown').classList.add('hidden');
            }, 200);
        }

        // Filter and display villages
        function filterVillages() {
            villageHighlightIndex = -1; // Reset highlight on filter
            const searchTerm = document.getElementById('userVillage').value;
            const filtered = villages.filter(village => fuzzyMatchVillage(searchTerm, village));

            // Limit to 50 results for performance
            const displayVillages = filtered.slice(0, 50);

            const villageList = document.getElementById('villageList');
            villageList.innerHTML = displayVillages.map(village =>
                `<div class="village-item" onclick="selectVillage('${village}')">${village}</div>`
            ).join('');

            if (displayVillages.length === 0) {
                villageList.innerHTML = `<div class="village-item" style="color: #999;">${i18n.t('no_villages_found', 'No villages found')}</div>`;
            }
        }

        // Select a village
        function selectVillage(village) {
            document.getElementById('userVillage').value = village;
            document.getElementById('villageDropdown').classList.add('hidden');
        }

        // Fuzzy match function for phone search
        function fuzzyMatchPhone(searchTerm, phoneData) {
            if (!searchTerm) return true;
            searchTerm = searchTerm.toLowerCase();

            const phone = phoneData.phone.toLowerCase();
            const name = (phoneData.name || '').toLowerCase();
            const village = (phoneData.village || '').toLowerCase();

            // Check if search term matches phone, name, or village
            if (phone.includes(searchTerm)) return true;
            if (name.includes(searchTerm)) return true;
            if (village.includes(searchTerm)) return true;

            // Fuzzy matching on name
            let searchIndex = 0;
            for (let i = 0; i < name.length && searchIndex < searchTerm.length; i++) {
                if (name[i] === searchTerm[searchIndex]) {
                    searchIndex++;
                }
            }
            return searchIndex === searchTerm.length;
        }

        // Load customer phones from database
        async function loadCustomerPhones() {
            try {
                const response = await fetch('/api/customers', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    // Token might be expired - redirect to login
                    if (response.status === 401) {
                        console.error('Token expired - redirecting to login');
                        alert(i18n.t('session_expired', 'Session expired. Please login again.'));
                        window.location.href = '/login';
                        return;
                    }
                    console.error('Failed to load customers:', response.status);
                    return;
                }

                const customers = await response.json() || [];

                // Map customer data to phone autocomplete format
                customerPhones = customers.map(customer => ({
                    phone: customer.phone || '',
                    name: customer.name || '',
                    village: customer.village || '',
                    so: customer.so || '' // Now customers have S/O field!
                }));

                console.log(`Loaded ${customerPhones.length} customers for autocomplete`);
            } catch (error) {
                console.error('Error loading customer phones:', error);
                customerPhones = []; // Set to empty array on error
            }
        }

        // Show phone dropdown
        function showPhoneDropdown() {
            filterPhones();
            document.getElementById('phoneDropdown').classList.remove('hidden');
        }

        // Filter and display phones
        function filterPhones() {
            phoneHighlightIndex = -1; // Reset highlight on filter
            const searchTerm = document.getElementById('userPhone').value;
            const filtered = customerPhones.filter(phoneData => fuzzyMatchPhone(searchTerm, phoneData));

            // Limit to 50 results for performance
            const displayPhones = filtered.slice(0, 50);

            const phoneList = document.getElementById('phoneList');
            phoneList.innerHTML = displayPhones.map(phoneData => {
                const displayText = `${phoneData.phone} - ${phoneData.name}${phoneData.village ? ' (' + phoneData.village + ')' : ''}`;
                return `<div class="village-item" onclick='selectPhone(${JSON.stringify(phoneData)})'>${displayText}</div>`;
            }).join('');

            if (displayPhones.length === 0 && searchTerm.length >= 3) {
                phoneList.innerHTML = `<div class="village-item" style="color: #999;">${i18n.t('no_matching_customers', 'No matching customers found')}</div>`;
            } else if (searchTerm.length === 0) {
                phoneList.innerHTML = `<div class="village-item" style="color: #999;">${i18n.t('start_typing_search', 'Start typing to search...')}</div>`;
            }
        }

        // Select a phone and auto-fill customer data
        function selectPhone(phoneData) {
            document.getElementById('userPhone').value = phoneData.phone;
            document.getElementById('userName').value = phoneData.name;
            document.getElementById('userVillage').value = phoneData.village;
            document.getElementById('userSO').value = phoneData.so || '';

            // Capitalize first letter of auto-filled fields
            capitalizeFirstLetter(document.getElementById('userName'));
            capitalizeFirstLetter(document.getElementById('userSO'));
            capitalizeFirstLetter(document.getElementById('userVillage'));

            document.getElementById('phoneDropdown').classList.add('hidden');
            showSearchStatus(i18n.t('customer_found', 'Customer found! Details auto-filled.'), 'success');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            const villageInput = document.getElementById('userVillage');
            const villageDropdown = document.getElementById('villageDropdown');
            if (villageInput && villageDropdown && !villageInput.contains(e.target) && !villageDropdown.contains(e.target)) {
                villageDropdown.classList.add('hidden');
            }

            const phoneInput = document.getElementById('userPhone');
            const phoneDropdown = document.getElementById('phoneDropdown');
            if (phoneInput && phoneDropdown && !phoneInput.contains(e.target) && !phoneDropdown.contains(e.target)) {
                phoneDropdown.classList.add('hidden');
            }
        });

        // Keyboard navigation for dropdowns
        let villageHighlightIndex = -1;
        let phoneHighlightIndex = -1;

        // Update highlighted item in a list
        function updateHighlight(listId, index) {
            const list = document.getElementById(listId);
            const items = list.querySelectorAll('.village-item');
            items.forEach((item, i) => {
                if (i === index) {
                    item.classList.add('highlighted');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('highlighted');
                }
            });
        }

        // Village input keyboard handler
        document.getElementById('userVillage').addEventListener('keydown', function(e) {
            const dropdown = document.getElementById('villageDropdown');
            const list = document.getElementById('villageList');
            const items = list.querySelectorAll('.village-item');

            if (dropdown.classList.contains('hidden') || items.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                villageHighlightIndex = Math.min(villageHighlightIndex + 1, items.length - 1);
                updateHighlight('villageList', villageHighlightIndex);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                villageHighlightIndex = Math.max(villageHighlightIndex - 1, 0);
                updateHighlight('villageList', villageHighlightIndex);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (villageHighlightIndex >= 0 && villageHighlightIndex < items.length) {
                    items[villageHighlightIndex].click();
                }
            } else if (e.key === 'Escape') {
                dropdown.classList.add('hidden');
                villageHighlightIndex = -1;
            }
        });

        // Phone input keyboard handler
        document.getElementById('userPhone').addEventListener('keydown', function(e) {
            const dropdown = document.getElementById('phoneDropdown');
            const list = document.getElementById('phoneList');
            const items = list.querySelectorAll('.village-item');

            if (dropdown.classList.contains('hidden') || items.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                phoneHighlightIndex = Math.min(phoneHighlightIndex + 1, items.length - 1);
                updateHighlight('phoneList', phoneHighlightIndex);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                phoneHighlightIndex = Math.max(phoneHighlightIndex - 1, 0);
                updateHighlight('phoneList', phoneHighlightIndex);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (phoneHighlightIndex >= 0 && phoneHighlightIndex < items.length) {
                    items[phoneHighlightIndex].click();
                }
            } else if (e.key === 'Escape') {
                dropdown.classList.add('hidden');
                phoneHighlightIndex = -1;
            }
        });

        // Auto-refresh intervals
        let roomEntriesRefreshInterval = null;
        let entriesRefreshInterval = null;
        let guardEntriesRefreshInterval = null;
        let guardTimerInterval = null;
        let guardTimerCount = 5;
        let selectedGuardEntry = null;

        // Guard entries countdown timer
        function startGuardTimer() {
            guardTimerCount = 5;
            updateGuardTimerDisplay();
            if (guardTimerInterval) clearInterval(guardTimerInterval);
            guardTimerInterval = setInterval(() => {
                guardTimerCount--;
                if (guardTimerCount <= 0) {
                    guardTimerCount = 5;
                }
                updateGuardTimerDisplay();
            }, 1000);
        }

        function updateGuardTimerDisplay() {
            const timerEl = document.getElementById('guardRefreshTimer');
            if (timerEl) {
                timerEl.textContent = guardTimerCount + 's';
            }
        }

        function resetGuardTimer() {
            guardTimerCount = 5;
            updateGuardTimerDisplay();
        }

        // Format individual quantities for display (e.g., "10, 15, 20" instead of just "45")
        // Falls back to showing total if no individual quantities stored (old entries)
        function formatIndividualQty(qty1, qty2, qty3, qty4, total) {
            const parts = [qty1, qty2, qty3, qty4].filter(q => q > 0);
            if (parts.length > 0) {
                return parts.join(', ');
            }
            // Fallback to total for old entries without individual quantities
            return total > 0 ? total.toString() : '0';
        }

        // Guard Entries Functions
        async function loadGuardEntries() {
            try {
                const res = await fetch('/api/guard/entries/pending', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    console.log('Guard entries not available');
                    return;
                }

                const entries = await res.json();
                const section = document.getElementById('guardEntriesSection');
                const list = document.getElementById('guardEntriesList');
                const countEl = document.getElementById('guardEntryCount');

                countEl.textContent = entries.length;

                if (entries.length === 0) {
                    section.classList.add('hidden');
                    return;
                }

                section.classList.remove('hidden');

                const lang = localStorage.getItem('lang') || 'en';

                list.innerHTML = entries.map(entry => {
                    const time = new Date(entry.arrival_time).toLocaleTimeString(lang === 'hi' ? 'hi-IN' : 'en-IN', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    // S/O display
                    const soDisplay = entry.so ? ` S/O ${entry.so}` : '';

                    // Token number
                    const tokenDisplay = entry.token_number ? `<span class="font-mono text-lg bg-yellow-200 px-2 py-1 border-2 border-black font-bold">#${entry.token_number}</span>` : '';

                    // Build separate buttons for each individual quantity
                    let actionButtons = [];

                    // Get individual seed quantities
                    const seedQtys = [entry.seed_qty_1 || 0, entry.seed_qty_2 || 0, entry.seed_qty_3 || 0, entry.seed_qty_4 || 0].filter(q => q > 0);
                    const sellQtys = [entry.sell_qty_1 || 0, entry.sell_qty_2 || 0, entry.sell_qty_3 || 0, entry.sell_qty_4 || 0].filter(q => q > 0);

                    // Seed section - show each quantity as separate button
                    if (entry.seed_quantity > 0 && !entry.seed_processed) {
                        // If we have individual quantities, show each as separate button
                        if (seedQtys.length > 0) {
                            seedQtys.forEach(qty => {
                                actionButtons.push(`
                                    <button class="text-sm bg-green-200 px-2 py-1 border-2 border-black hover:bg-green-300"
                                            onclick="event.stopPropagation(); selectGuardEntry(${entry.id}, '${entry.customer_name}', '${entry.so || ''}', '${entry.village}', '${entry.mobile}', 'seed', ${qty}, 0)">
                                        Seed${qty}
                                    </button>
                                `);
                            });
                        } else {
                            // Fallback for old entries - show total
                            actionButtons.push(`
                                <button class="text-sm bg-green-200 px-2 py-1 border-2 border-black hover:bg-green-300"
                                        onclick="event.stopPropagation(); selectGuardEntry(${entry.id}, '${entry.customer_name}', '${entry.so || ''}', '${entry.village}', '${entry.mobile}', 'seed', ${entry.seed_quantity}, 0)">
                                    Seed${entry.seed_quantity}
                                </button>
                            `);
                        }
                        // Mark all seed done button
                        actionButtons.push(`
                            <button class="text-xs bg-green-500 text-white px-2 py-1 border border-black hover:bg-green-600"
                                    onclick="event.stopPropagation(); markPortionDone(${entry.id}, 'seed')" title="Mark All Seed Done">
                                ✓
                            </button>
                        `);
                    } else if (entry.seed_quantity > 0 && entry.seed_processed) {
                        // Show processed seed quantities
                        if (seedQtys.length > 0) {
                            seedQtys.forEach(qty => {
                                actionButtons.push(`<span class="text-xs bg-green-500 text-white px-2 py-1 border border-black">Seed${qty}✓</span>`);
                            });
                        } else {
                            actionButtons.push(`<span class="text-xs bg-green-500 text-white px-2 py-1 border border-black">Seed${entry.seed_quantity}✓</span>`);
                        }
                    }

                    // Sell section - show each quantity as separate button (RED color)
                    if (entry.sell_quantity > 0 && !entry.sell_processed) {
                        // If we have individual quantities, show each as separate button
                        if (sellQtys.length > 0) {
                            sellQtys.forEach(qty => {
                                actionButtons.push(`
                                    <button class="text-sm bg-red-200 px-2 py-1 border-2 border-black hover:bg-red-300"
                                            onclick="event.stopPropagation(); selectGuardEntry(${entry.id}, '${entry.customer_name}', '${entry.so || ''}', '${entry.village}', '${entry.mobile}', 'sell', 0, ${qty})">
                                        Sell${qty}
                                    </button>
                                `);
                            });
                        } else {
                            // Fallback for old entries - show total
                            actionButtons.push(`
                                <button class="text-sm bg-red-200 px-2 py-1 border-2 border-black hover:bg-red-300"
                                        onclick="event.stopPropagation(); selectGuardEntry(${entry.id}, '${entry.customer_name}', '${entry.so || ''}', '${entry.village}', '${entry.mobile}', 'sell', 0, ${entry.sell_quantity})">
                                    Sell${entry.sell_quantity}
                                </button>
                            `);
                        }
                        // Mark all sell done button
                        actionButtons.push(`
                            <button class="text-xs bg-red-500 text-white px-2 py-1 border border-black hover:bg-red-600"
                                    onclick="event.stopPropagation(); markPortionDone(${entry.id}, 'sell')" title="Mark All Sell Done">
                                ✓
                            </button>
                        `);
                    } else if (entry.sell_quantity > 0 && entry.sell_processed) {
                        // Show processed sell quantities
                        if (sellQtys.length > 0) {
                            sellQtys.forEach(qty => {
                                actionButtons.push(`<span class="text-xs bg-red-500 text-white px-2 py-1 border border-black">Sell${qty}✓</span>`);
                            });
                        } else {
                            actionButtons.push(`<span class="text-xs bg-red-500 text-white px-2 py-1 border border-black">Sell${entry.sell_quantity}✓</span>`);
                        }
                    }

                    return `
                        <div class="flex flex-wrap items-center gap-2 p-3 bg-white border-2 border-black">
                            ${tokenDisplay}
                            <span class="font-mono text-sm bg-orange-100 px-2 py-1 border border-black">${time}</span>
                            <span class="font-bold">${entry.customer_name}${soDisplay}</span>
                            <span class="text-sm text-gray-600">${entry.village}</span>
                            <span class="text-sm">${entry.mobile}</span>
                            <span class="text-xs text-gray-500">${lang === 'hi' ? 'गार्ड' : 'Guard'}: ${entry.created_by_user_name || 'Unknown'}</span>
                            <div class="ml-auto flex gap-2">${actionButtons.join('')}</div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading guard entries:', error);
            }
        }

        let selectedGuardPortion = null; // 'seed' or 'sell'

        function selectGuardEntry(id, name, so, village, mobile, category, seedQty, sellQty) {
            selectedGuardEntry = id;
            selectedGuardPortion = category; // 'seed' or 'sell'

            // Fill the form with guard entry data
            document.getElementById('userPhone').value = mobile;
            document.getElementById('userName').value = name;
            document.getElementById('userVillage').value = village;

            // Fill S/O if available
            const soField = document.getElementById('userSO');
            if (soField) soField.value = so || '';

            // Set category based on portion being processed
            if (category === 'seed') {
                document.querySelector('input[name="thockCategory"][value="seed"]').checked = true;
            } else if (category === 'sell') {
                document.querySelector('input[name="thockCategory"][value="sell"]').checked = true;
            }

            // Pre-fill quantity based on which portion is selected
            const qty = category === 'seed' ? seedQty : sellQty;
            if (qty > 0) {
                document.getElementById('expectedQuantity').value = qty;
            }

            // Update category info
            updateCategoryInfo();

            // Focus on quantity field
            document.getElementById('expectedQuantity').focus();

            // Highlight that we're processing a guard entry
            const formSection = document.getElementById('entryForm');
            formSection.style.backgroundColor = '#FEF3C7';
            const portionLabel = category === 'seed' ? 'SEED' : 'SELL';
            const portionColor = category === 'seed' ? 'bg-green-200' : 'bg-red-200';
            formSection.querySelector('h2').innerHTML = `
                <i class="bi bi-truck text-orange-600"></i>
                <span data-i18n="processing_guard_entry">Processing Guard Entry</span>
                <span class="text-sm bg-yellow-200 px-2 py-1 border-2 border-black ml-2 font-bold">#${id}</span>
                <span class="text-sm ${portionColor} px-2 py-1 border border-black ml-1">${portionLabel}</span>
            `;
        }

        // Mark a portion (seed/sell) as done manually
        async function markPortionDone(entryId, portion) {
            const lang = localStorage.getItem('lang') || 'en';
            const confirmMsg = lang === 'hi'
                ? `क्या आप ${portion === 'seed' ? 'बीज' : 'बिक्री'} को पूर्ण के रूप में चिह्नित करना चाहते हैं?`
                : `Mark ${portion.toUpperCase()} as done?`;

            if (!confirm(confirmMsg)) return;

            try {
                const res = await fetch(`/api/guard/entries/${entryId}/process/${portion}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    const error = await res.text();
                    throw new Error(error);
                }

                // Reload guard entries
                loadGuardEntries();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function markGuardEntryProcessed() {
            // Don't auto-mark, let user do it manually with ✓ button
            if (!selectedGuardEntry) return;

            // Just clear the selection, don't mark as processed
            selectedGuardEntry = null;
            selectedGuardPortion = null;

            // Reset form styling
            const formSection = document.getElementById('entryForm');
            formSection.style.backgroundColor = 'white';
            formSection.querySelector('h2').innerHTML = `
                <i class="bi bi-person-check"></i>
                <span data-i18n="user_details_entry">User Details & Entry</span>
            `;

            // Reload guard entries
            loadGuardEntries();
        }

        // Track last refresh time for delta updates
        let lastRefreshTime = null;

        // Optimized single API call to load all entry room data
        async function loadEntryRoomData() {
            try {
                const response = await fetch('/api/entry-room/summary', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        alert(i18n.t('session_expired', 'Session expired. Please login again.'));
                        window.location.href = '/login';
                        return;
                    }
                    throw new Error('Failed to load entry room data');
                }

                const data = await response.json();

                // Display all data from single response
                displayRecentEntries(data.entries || []);
                displayRoomEntries(data.room_entries || []);
                displayGuardEntriesFromData(data.guard_entries || []);

                // Setup customer autocomplete
                customerPhones = (data.customer_phones || []).map(c => ({
                    phone: c.phone || '',
                    name: c.name || '',
                    village: c.village || '',
                    so: c.so || ''
                }));
                console.log(`Loaded ${customerPhones.length} customers for autocomplete`);

                // Track refresh time for delta updates
                lastRefreshTime = data.generated_at || new Date().toISOString();

            } catch (error) {
                console.error('Error loading entry room data:', error);
            }
        }

        // Delta refresh - only fetch new entries since last refresh
        async function refreshEntryRoomDelta() {
            if (!lastRefreshTime) {
                // First load - do full refresh
                await loadEntryRoomData();
                return;
            }

            // Show loading animation
            const refreshIcon = document.getElementById('refreshIcon');
            if (refreshIcon) {
                refreshIcon.classList.add('spin-animation');
            }

            try {
                const response = await fetch(`/api/entry-room/since?t=${encodeURIComponent(lastRefreshTime)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('Failed to load delta');
                }

                const data = await response.json();

                // Prepend new entries if any
                if (data.entries && data.entries.length > 0) {
                    prependNewEntries(data.entries);
                }
                if (data.room_entries && data.room_entries.length > 0) {
                    prependNewRoomEntries(data.room_entries);
                }
                // Guard entries always show full pending list
                if (data.guard_entries) {
                    displayGuardEntriesFromData(data.guard_entries);
                }

                // Update last refresh time
                lastRefreshTime = data.timestamp || new Date().toISOString();

            } catch (error) {
                console.error('Error loading delta:', error);
            } finally {
                if (refreshIcon) {
                    setTimeout(() => {
                        refreshIcon.classList.remove('spin-animation');
                    }, 500);
                }
            }
        }

        // Prepend new entries to the table (avoid full re-render)
        function prependNewEntries(newEntries) {
            const tbody = document.getElementById('entriesTableBody');
            if (!tbody || newEntries.length === 0) return;

            // Check if "No entries" message is displayed
            const noDataRow = tbody.querySelector('td[colspan="8"]');
            if (noDataRow) {
                tbody.innerHTML = '';
            }

            const fragment = document.createDocumentFragment();
            newEntries.forEach(entry => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-50';
                const truckColor = getTruckColor(entry.thock_number);
                const categoryColor = entry.thock_category === 'seed' ? 'text-green-700 bg-green-100' : 'text-orange-700 bg-orange-100';
                const date = new Date(entry.created_at);
                const formattedDate = date.toLocaleString('en-IN', {
                    day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
                });
                row.innerHTML = `
                    <td class="p-2 font-bold ${truckColor}">${entry.thock_number}</td>
                    <td class="p-2">${capitalizeText(entry.name)}</td>
                    <td class="p-2">${entry.phone}</td>
                    <td class="p-2">${capitalizeText(entry.village) || '-'}</td>
                    <td class="p-2">${entry.expected_quantity}</td>
                    <td class="p-2"><span class="px-2 py-1 rounded text-xs font-bold ${categoryColor}">${entry.thock_category.toUpperCase()}</span></td>
                    <td class="p-2 text-xs">${formattedDate}</td>
                    <td class="p-2 text-right">
                        <button onclick="openEditEntryModal(${entry.id})" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </td>
                `;
                fragment.appendChild(row);
            });
            tbody.insertBefore(fragment, tbody.firstChild);
        }

        // Prepend new room entries to the table
        function prependNewRoomEntries(newEntries) {
            const tbody = document.getElementById('roomEntriesTableBody');
            if (!tbody || newEntries.length === 0) return;

            // Check if "No entries" message is displayed
            const noDataRow = tbody.querySelector('td[colspan="7"]');
            if (noDataRow) {
                tbody.innerHTML = '';
            }

            const fragment = document.createDocumentFragment();
            newEntries.forEach(entry => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-blue-50 cursor-pointer transition-colors';
                row.onclick = () => printReceipt(entry.entry_id, entry.id);
                row.title = 'Click to print receipt';
                const truckColor = getTruckColor(entry.thock_number);
                const date = new Date(entry.created_at);
                const formattedDate = date.toLocaleString('en-IN', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const breakdownDisplay = entry.quantity_breakdown ? `<span class="text-xs text-gray-500 block">(${entry.quantity_breakdown})</span>` : '';
                row.innerHTML = `
                    <td class="p-2 font-bold ${truckColor}">${entry.thock_number}</td>
                    <td class="p-2">${entry.room_no}</td>
                    <td class="p-2">${entry.floor}</td>
                    <td class="p-2">${entry.gate_no}</td>
                    <td class="p-2 font-bold">${entry.quantity} ${breakdownDisplay}</td>
                    <td class="p-2 text-xs">${formattedDate}</td>
                    <td class="p-2" onclick="event.stopPropagation()">
                        <div class="flex gap-1">
                            <button onclick="printReceipt(${entry.entry_id}, ${entry.id})" class="neu-button bg-blue-500 text-white text-xs px-2 py-1" title="Print Receipt">
                                <i class="bi bi-printer"></i>
                            </button>
                        </div>
                    </td>
                `;
                fragment.appendChild(row);
            });
            tbody.insertBefore(fragment, tbody.firstChild);
        }

        // Display guard entries from summary data (shared between full load and delta)
        function displayGuardEntriesFromData(entries) {
            const section = document.getElementById('guardEntriesSection');
            const list = document.getElementById('guardEntriesList');
            const countEl = document.getElementById('guardEntryCount');

            countEl.textContent = entries.length;

            if (entries.length === 0) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');
            const lang = localStorage.getItem('lang') || 'en';

            list.innerHTML = entries.map(entry => {
                const time = new Date(entry.arrival_time).toLocaleTimeString(lang === 'hi' ? 'hi-IN' : 'en-IN', {
                    hour: '2-digit', minute: '2-digit'
                });
                const soDisplay = entry.so ? ` S/O ${entry.so}` : '';
                const tokenDisplay = entry.token_number ? `<span class="font-mono text-lg bg-yellow-200 px-2 py-1 border-2 border-black font-bold">#${entry.token_number}</span>` : '';
                let actionButtons = [];
                const seedQtys = [entry.seed_qty_1 || 0, entry.seed_qty_2 || 0, entry.seed_qty_3 || 0, entry.seed_qty_4 || 0].filter(q => q > 0);
                const sellQtys = [entry.sell_qty_1 || 0, entry.sell_qty_2 || 0, entry.sell_qty_3 || 0, entry.sell_qty_4 || 0].filter(q => q > 0);

                if (entry.seed_quantity > 0 && !entry.seed_processed) {
                    if (seedQtys.length > 0) {
                        seedQtys.forEach(qty => {
                            actionButtons.push(`<button class="text-sm bg-green-200 px-2 py-1 border-2 border-black hover:bg-green-300" onclick="event.stopPropagation(); selectGuardEntry(${entry.id}, '${entry.customer_name}', '${entry.so || ''}', '${entry.village}', '${entry.mobile}', 'seed', ${qty}, 0)">Seed${qty}</button>`);
                        });
                    } else {
                        actionButtons.push(`<button class="text-sm bg-green-200 px-2 py-1 border-2 border-black hover:bg-green-300" onclick="event.stopPropagation(); selectGuardEntry(${entry.id}, '${entry.customer_name}', '${entry.so || ''}', '${entry.village}', '${entry.mobile}', 'seed', ${entry.seed_quantity}, 0)">Seed${entry.seed_quantity}</button>`);
                    }
                    actionButtons.push(`<button class="text-xs bg-green-500 text-white px-2 py-1 border border-black hover:bg-green-600" onclick="event.stopPropagation(); markPortionDone(${entry.id}, 'seed')" title="Mark All Seed Done">✓</button>`);
                } else if (entry.seed_quantity > 0 && entry.seed_processed) {
                    if (seedQtys.length > 0) {
                        seedQtys.forEach(qty => { actionButtons.push(`<span class="text-xs bg-green-500 text-white px-2 py-1 border border-black">Seed${qty}✓</span>`); });
                    } else {
                        actionButtons.push(`<span class="text-xs bg-green-500 text-white px-2 py-1 border border-black">Seed${entry.seed_quantity}✓</span>`);
                    }
                }
                if (entry.sell_quantity > 0 && !entry.sell_processed) {
                    if (sellQtys.length > 0) {
                        sellQtys.forEach(qty => {
                            actionButtons.push(`<button class="text-sm bg-red-200 px-2 py-1 border-2 border-black hover:bg-red-300" onclick="event.stopPropagation(); selectGuardEntry(${entry.id}, '${entry.customer_name}', '${entry.so || ''}', '${entry.village}', '${entry.mobile}', 'sell', 0, ${qty})">Sell${qty}</button>`);
                        });
                    } else {
                        actionButtons.push(`<button class="text-sm bg-red-200 px-2 py-1 border-2 border-black hover:bg-red-300" onclick="event.stopPropagation(); selectGuardEntry(${entry.id}, '${entry.customer_name}', '${entry.so || ''}', '${entry.village}', '${entry.mobile}', 'sell', 0, ${entry.sell_quantity})">Sell${entry.sell_quantity}</button>`);
                    }
                    actionButtons.push(`<button class="text-xs bg-red-500 text-white px-2 py-1 border border-black hover:bg-red-600" onclick="event.stopPropagation(); markPortionDone(${entry.id}, 'sell')" title="Mark All Sell Done">✓</button>`);
                } else if (entry.sell_quantity > 0 && entry.sell_processed) {
                    if (sellQtys.length > 0) {
                        sellQtys.forEach(qty => { actionButtons.push(`<span class="text-xs bg-red-500 text-white px-2 py-1 border border-black">Sell${qty}✓</span>`); });
                    } else {
                        actionButtons.push(`<span class="text-xs bg-red-500 text-white px-2 py-1 border border-black">Sell${entry.sell_quantity}✓</span>`);
                    }
                }
                return `<div class="flex items-center justify-between p-2 bg-yellow-50 neu-border mb-2 hover:bg-yellow-100 cursor-pointer" onclick="selectGuardEntryCard(${entry.id}, '${entry.customer_name}', '${entry.so || ''}', '${entry.village}', '${entry.mobile}')">
                    <div class="flex-1">
                        <div class="flex items-center gap-2">${tokenDisplay}<span class="font-bold">${entry.customer_name}${soDisplay}</span><span class="text-xs text-gray-500">${entry.village}</span></div>
                        <div class="text-xs text-gray-500">${entry.mobile} • ${time}</div>
                    </div>
                    <div class="flex gap-1 flex-wrap">${actionButtons.join('')}</div>
                </div>`;
            }).join('');
        }

        // Load recent entries on page load
        window.addEventListener('load', async function() {
            // Check operation mode first - redirect if in unloading mode
            const shouldContinue = await checkOperationMode();
            if (!shouldContinue) return;

            // Single optimized API call for all data
            await loadEntryRoomData();

            // Start auto-refresh using delta updates (every 5 seconds)
            startAutoRefresh();

            // Start guard entries countdown timer
            startGuardTimer();
        });

        async function updateCategoryInfo() {
            const categoryRadio = document.querySelector('input[name="thockCategory"]:checked');
            if (!categoryRadio) return;

            const category = categoryRadio.value;

            // Hide all count displays first
            document.getElementById('seedCount').classList.add('hidden');
            document.getElementById('sellCount').classList.add('hidden');

            try {
                // Fetch count for selected category
                const response = await fetch(`/api/entries/count?category=${category}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch count');
                }

                const data = await response.json();

                // Store count in global variable
                if (category === 'seed') {
                    seedCount = data.count;
                    document.getElementById('seedCount').textContent = `Current: ${data.count} | Next number: ${data.next}`;
                    document.getElementById('seedCount').classList.remove('hidden');
                } else if (category === 'sell') {
                    sellCount = data.count;
                    document.getElementById('sellCount').textContent = `Current: ${data.count} | Next number: ${data.next}`;
                    document.getElementById('sellCount').classList.remove('hidden');
                }

                // Update truck preview
                updateTruckPreview();
            } catch (error) {
                console.error('Error fetching category count:', error);
            }
        }

        function updateTruckPreview() {
            const categoryRadio = document.querySelector('input[name="thockCategory"]:checked');
            const quantity = parseInt(document.getElementById('expectedQuantity').value);

            if (!categoryRadio || !quantity || quantity < 1) {
                document.getElementById('truckPreview').classList.add('hidden');
                return;
            }

            const category = categoryRadio.value;
            let nextNumber;
            let thockNumber;

            if (category === 'seed') {
                nextNumber = seedCount + 1;
                thockNumber = String(nextNumber).padStart(3, '0') + '/' + quantity;
            } else if (category === 'sell') {
                nextNumber = 1501 + sellCount;
                thockNumber = nextNumber + '/' + quantity;
            }

            document.getElementById('previewThockNumber').textContent = thockNumber;
            document.getElementById('truckPreview').classList.remove('hidden');
        }

        function changeEntriesLimit() {
            const select = document.getElementById('entriesLimit');
            entriesLimit = parseInt(select.value);
            loadRecentEntries();
        }

        async function loadRecentEntries() {
            try {
                const response = await fetch('/api/entries', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('Failed to load entries');
                }

                const entries = await response.json();

                // Show entries based on selected limit (0 means all)
                const entriesToShow = entriesLimit === 0 ? entries : entries.slice(0, entriesLimit);
                displayRecentEntries(entriesToShow);
            } catch (error) {
                console.error('Error loading entries:', error);
                document.getElementById('entriesTableBody').innerHTML =
                    `<tr><td colspan="8" class="text-center p-4 text-red-500">${i18n.t('failed_load_entries', 'Failed to load entries')}</td></tr>`;
            }
        }

        function displayRecentEntries(entries) {
            const tbody = document.getElementById('entriesTableBody');

            if (entries.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center p-4 text-gray-500">${i18n.t('no_entries_yet', 'No entries yet')}</td></tr>`;
                return;
            }

            // Show only last 15 entries
            const recentEntries = entries.slice(0, 15);

            tbody.innerHTML = recentEntries.map(entry => {
                const truckColor = getTruckColor(entry.thock_number);
                const categoryColor = entry.thock_category === 'seed' ? 'text-green-700 bg-green-100' : 'text-orange-700 bg-orange-100';

                const date = new Date(entry.created_at);
                const formattedDate = date.toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                return `
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="p-2 font-bold ${truckColor}">${entry.thock_number}</td>
                        <td class="p-2">${capitalizeText(entry.name)}</td>
                        <td class="p-2">${entry.phone}</td>
                        <td class="p-2">${capitalizeText(entry.village) || '-'}</td>
                        <td class="p-2">${entry.expected_quantity}</td>
                        <td class="p-2"><span class="px-2 py-1 rounded text-xs font-bold ${categoryColor}">${entry.thock_category.toUpperCase()}</span></td>
                        <td class="p-2 text-xs">${formattedDate}</td>
                        <td class="p-2 text-right">
                            <button onclick="openEditEntryModal(${entry.id})" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Edit Entry Modal Functions
        async function openEditEntryModal(entryId) {
            try {
                const response = await fetch(`/api/entries/${entryId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Failed to load entry');
                const entry = await response.json();

                document.getElementById('editEntryId').value = entry.id;
                document.getElementById('editEntryName').value = entry.name || '';
                document.getElementById('editEntryPhone').value = entry.phone || '';
                document.getElementById('editEntryVillage').value = entry.village || '';
                document.getElementById('editEntrySO').value = entry.so || '';
                document.getElementById('editEntryQty').value = entry.expected_quantity || 1;
                document.getElementById('editEntryCategory').value = entry.thock_category || 'seed';
                document.getElementById('editEntryRemark').value = entry.remark || '';

                document.getElementById('editEntryModal').style.display = 'flex';
            } catch (error) {
                console.error('Error loading entry:', error);
                alert('Failed to load entry details');
            }
        }

        function closeEditEntryModal() {
            document.getElementById('editEntryModal').style.display = 'none';
            document.getElementById('editEntryForm').reset();
        }

        async function saveEditedEntry(event) {
            event.preventDefault();

            const entryId = document.getElementById('editEntryId').value;
            const data = {
                name: document.getElementById('editEntryName').value,
                phone: document.getElementById('editEntryPhone').value,
                village: document.getElementById('editEntryVillage').value,
                so: document.getElementById('editEntrySO').value,
                expected_quantity: parseInt(document.getElementById('editEntryQty').value),
                thock_category: document.getElementById('editEntryCategory').value,
                remark: document.getElementById('editEntryRemark').value
            };

            try {
                const response = await fetch(`/api/entries/${entryId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                const updatedEntry = await response.json();
                closeEditEntryModal();
                loadRecentEntries();
                alert(i18n.t('entry_updated_thock', 'Entry updated! New Thock No: ') + updatedEntry.thock_number);
            } catch (error) {
                console.error('Error updating entry:', error);
                alert('Error: ' + error.message);
            }
        }

        function clearCustomerFields() {
            document.getElementById('userName').value = '';
            document.getElementById('userVillage').value = '';
            document.getElementById('userSO').value = '';
            document.getElementById('userId').value = '';
            currentUser = null;
        }

        function showSearchStatus(message, type) {
            const statusEl = document.getElementById('searchStatus');
            const statusText = statusEl.querySelector('p');

            statusText.textContent = message;
            statusEl.classList.remove('hidden', 'bg-green-100', 'border-green-600', 'text-green-700', 'bg-blue-100', 'border-blue-600', 'text-blue-700');

            if (type === 'success') {
                statusEl.classList.add('bg-green-100', 'border-green-600');
                statusText.className = 'text-sm font-semibold text-green-700';
            } else if (type === 'info') {
                statusEl.classList.add('bg-blue-100', 'border-blue-600');
                statusText.className = 'text-sm font-semibold text-blue-700';
            }
        }

        function hideSearchStatus() {
            const statusEl = document.getElementById('searchStatus');
            statusEl.classList.add('hidden');
        }

        function displayUserDetails(user) {
            document.getElementById('userName').value = user.name || '';
            document.getElementById('userVillage').value = user.village || '';
            document.getElementById('userSO').value = user.so || '';
            document.getElementById('userId').value = user.id;

            // Capitalize first letter of auto-filled fields
            capitalizeFirstLetter(document.getElementById('userName'));
            capitalizeFirstLetter(document.getElementById('userSO'));
            capitalizeFirstLetter(document.getElementById('userVillage'));
        }

        let isSubmitting = false; // Debounce flag to prevent double submission

        async function submitEntry(event) {
            event.preventDefault();

            // Prevent double submission
            if (isSubmitting) {
                console.log('Submission already in progress, ignoring');
                return;
            }

            const submitBtn = document.getElementById('submitEntryBtn');
            const originalBtnText = submitBtn.innerHTML;

            const quantity = parseInt(document.getElementById('expectedQuantity').value);

            // Validate quantity
            if (quantity < 1) {
                alert(i18n.t('qty_must_be_1', 'Quantity must be at least 1'));
                return;
            }

            // Get values from input fields
            const name = document.getElementById('userName').value.trim();
            const phone = document.getElementById('userPhone').value.trim();
            const village = document.getElementById('userVillage').value.trim();
            const so = document.getElementById('userSO').value.trim();

            // Validate phone number (must be exactly 10 digits)
            if (phone.length !== 10 || !/^\d{10}$/.test(phone)) {
                alert(i18n.t('phone_must_10', 'Phone number must be exactly 10 digits'));
                return;
            }

            // Validate required fields
            if (!name || !phone || !village) {
                alert(i18n.t('fill_required_fields', 'Please fill in all required fields (Name, Phone, Village)'));
                return;
            }

            // Get selected category from radio buttons
            const categoryRadio = document.querySelector('input[name="thockCategory"]:checked');
            if (!categoryRadio) {
                alert(i18n.t('select_category_error', 'Please select a category (SEED or SELL)'));
                return;
            }
            const category = categoryRadio.value;

            const entryData = {
                customer_id: parseInt(document.getElementById('userId').value) || 0,
                phone: phone,
                name: name,
                village: village,
                so: so,
                expected_quantity: quantity,
                thock_category: category,
                remark: selectedVarieties.join(', ')
            };

            // Disable button and set loading state
            isSubmitting = true;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Submitting...';

            try {
                const response = await fetch('/api/entries', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(entryData)
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                const result = await response.json();
                console.log('Entry created:', result);
                const thockNumber = result.thock_number || 'AUTO-' + result.id;
                console.log('Truck number:', thockNumber);
                showSuccess(thockNumber);

                // Mark guard entry as processed if we were processing one
                markGuardEntryProcessed();
            } catch (error) {
                alert(i18n.t('error_creating_entry', 'Error creating entry') + ': ' + error.message);
                // Re-enable button on error
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                isSubmitting = false;
            }
            // Note: isSubmitting is reset in showSuccess after 5s cooldown
        }

        function showError(message) {
            const errorEl = document.getElementById('searchError');
            errorEl.querySelector('p').textContent = message;
            errorEl.classList.remove('hidden');
        }

        function showSuccess(thockNumber) {
            console.log('showSuccess called with:', thockNumber);
            const truckEl = document.getElementById('assignedTruck');
            const successEl = document.getElementById('successMessage');
            const submitBtn = document.getElementById('submitEntryBtn');

            if (truckEl) {
                truckEl.textContent = thockNumber;
                console.log('Truck number set to element');
            }

            if (successEl) {
                successEl.classList.remove('hidden');
                console.log('Success message shown');
                // Scroll to success message
                successEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // 5 second cooldown before allowing next submission
            if (submitBtn) {
                let countdown = 5;
                submitBtn.disabled = true;
                submitBtn.innerHTML = `<i class="bi bi-hourglass-split"></i> Wait ${countdown}s...`;

                const cooldownInterval = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        submitBtn.innerHTML = `<i class="bi bi-hourglass-split"></i> Wait ${countdown}s...`;
                    } else {
                        clearInterval(cooldownInterval);
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> <span data-i18n="submit">Submit</span>';
                        isSubmitting = false;
                    }
                }, 1000);
            }

            // Reload recent entries and room entries to show the new entry
            loadRecentEntries();
            loadRoomEntries();
        }

        function resetForm() {
            document.getElementById('userName').value = '';
            document.getElementById('userVillage').value = '';
            document.getElementById('userPhone').value = '';
            document.getElementById('userSO').value = '';
            document.getElementById('entrySubmitForm').reset();
            document.getElementById('successMessage').classList.add('hidden');
            document.getElementById('truckPreview').classList.add('hidden');
            hideSearchStatus();

            // Hide count displays
            document.getElementById('seedCount').classList.add('hidden');
            document.getElementById('sellCount').classList.add('hidden');

            // Uncheck all radio buttons
            const radios = document.querySelectorAll('input[name="thockCategory"]');
            radios.forEach(radio => radio.checked = false);

            // Clear variety selection
            clearVarietySelection();

            currentUser = null;

            // Refresh the lists
            loadRecentEntries();
            loadRoomEntries();
        }

        function goBack() {
            window.history.back();
        }

        async function loadRoomEntries() {
            // Show loading animation
            const refreshIcon = document.getElementById('refreshIcon');
            if (refreshIcon) {
                refreshIcon.classList.add('spin-animation');
            }

            try {
                const response = await fetch('/api/room-entries', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('Failed to load room entries');
                }

                const roomEntries = await response.json();
                displayRoomEntries(roomEntries || []);
            } catch (error) {
                console.error('Error loading room entries:', error);
                document.getElementById('roomEntriesTableBody').innerHTML =
                    `<tr><td colspan="7" class="text-center p-4 text-red-500">${i18n.t('failed_load_room_entries', 'Failed to load room entries')}</td></tr>`;
            } finally {
                // Stop loading animation after a short delay
                if (refreshIcon) {
                    setTimeout(() => {
                        refreshIcon.classList.remove('spin-animation');
                    }, 500);
                }
            }
        }

        function displayRoomEntries(roomEntries) {
            const tbody = document.getElementById('roomEntriesTableBody');

            if (roomEntries.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-gray-500">${i18n.t('no_room_entries_yet', 'No room entries yet')}</td></tr>`;
                return;
            }

            tbody.innerHTML = roomEntries.map(entry => {
                const date = new Date(entry.created_at);
                const formattedDate = date.toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                const truckColor = getTruckColor(entry.thock_number);

                const breakdownDisplay = entry.quantity_breakdown ? `<span class="text-xs text-gray-500 block">(${entry.quantity_breakdown})</span>` : '';

                return `
                    <tr class="border-b border-gray-200 hover:bg-blue-50 cursor-pointer transition-colors"
                        onclick="printReceipt(${entry.entry_id}, ${entry.id})"
                        title="Click to print receipt">
                        <td class="p-2 font-bold ${truckColor}">${entry.thock_number}</td>
                        <td class="p-2">${entry.room_no}</td>
                        <td class="p-2">${entry.floor}</td>
                        <td class="p-2">${entry.gate_no}</td>
                        <td class="p-2 font-bold">${entry.quantity} ${breakdownDisplay}</td>
                        <td class="p-2 text-xs">${formattedDate}</td>
                        <td class="p-2" onclick="event.stopPropagation()">
                            <div class="flex gap-1">
                                <button onclick="printReceipt(${entry.entry_id}, ${entry.id})" class="neu-button bg-blue-500 text-white text-xs px-2 py-1" title="Print Receipt">
                                    <i class="bi bi-printer"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function goToInvoice(entryId, roomEntryId) {
            window.location.href = `/loading-invoice?entry_id=${entryId}&room_entry_id=${roomEntryId}`;
        }

        // Decode JWT to get employee details
        function getEmployeeFromToken() {
            if (!token) return null;

            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));

                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error('Error decoding token:', error);
                return null;
            }
        }

        async function printReceipt(entryId, roomEntryId) {
            try {
                // Fetch entry details
                const entryResponse = await fetch(`/api/entries/${entryId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const entry = await entryResponse.json();

                // Fetch room entry details
                const roomEntryResponse = await fetch(`/api/room-entries/${roomEntryId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const roomEntry = await roomEntryResponse.json();

                // Fetch rent rate from system settings
                let ratePerUnit = 10; // Default fallback
                try {
                    const settingsResponse = await fetch('/api/settings/rent_per_item', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (settingsResponse.ok) {
                        const setting = await settingsResponse.json();
                        ratePerUnit = parseFloat(setting.setting_value) || 10;
                    }
                } catch (error) {
                    console.warn('Failed to fetch rent rate, using default:', error);
                }

                // Get employee details from token
                const employee = getEmployeeFromToken();

                // Calculate rent
                const grandTotal = roomEntry.quantity * ratePerUnit;

                // Format dates
                const entryDate = new Date(entry.created_at).toLocaleString('en-IN');
                const roomEntryDate = new Date(roomEntry.created_at).toLocaleString('en-IN');
                const printDate = new Date().toLocaleDateString('en-IN', { day: '2-digit', month: '2-digit', year: 'numeric' });

                // Generate random weight between 55-57 kg (whole numbers)
                const randomWeight = Math.floor(Math.random() * (58 - 55) + 55);

                // Determine category from truck number (SEED: 1-1500, SELL: 1501-3000)
                const truckNum = parseInt(roomEntry.thock_number.split('/')[0]);
                const category = truckNum <= 1500 ? 'बीज' : 'मोटा';

                // Create receipt HTML (2 copies side by side) - Hindi Format
                const receiptHTML = `
                    <div class="receipt">
                        <div class="header">
                            <h1>गुरु कृपा कोल्ड स्टोर</h1>
                            <p>Guru Kripa Cold Store</p>
                            <p>कोल्ड स्टोर लाइसेंस/गोदाम | Cold Store License/Warehouse</p>
                            <p style="font-weight: bold; margin-top: 2px;">Mobile: 7505837172</p>
                        </div>

                        <div class="truck-banner">
                            ${roomEntry.thock_number}
                        </div>

                        <div class="info-section">
                            <div class="info-row">
                                <span class="label">ग्राहक का नाम | Customer:</span>
                                <span class="value">${capitalizeText(entry.name)}${entry.so ? ' S/O ' + capitalizeText(entry.so) : ''}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">फोन | Phone:</span>
                                <span class="value">${entry.phone}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">ग्राम व पता | Village:</span>
                                <span class="value">${capitalizeText(entry.village) || 'N/A'}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">दिनांक | Date:</span>
                                <span class="value">${printDate}</span>
                            </div>
                        </div>

                        <div class="quantity-section">
                            <div class="quantity-label">कुल भरती बोरे | Total Bags</div>
                            <div class="quantity-value">${roomEntry.quantity} बोरे</div>
                        </div>

                        <div class="weight-section">
                            <div class="weight-label">प्राप्त हुआ भार (प्रति बैग):</div>
                            <div class="weight-value">${randomWeight} किग्रा</div>
                        </div>

                        <div class="category-section">
                            <div class="category-label">श्रेणी:</div>
                            <div class="category-value">${category}</div>
                        </div>

                        <div class="terms-section">
                            <div class="terms-title">शर्तें:</div>
                            <div class="terms-text">
                                स्पेशल-1, पुखराज एवं कुफरी मोहन किस्म के आलू के गलने की जिम्मेदारी माल मालिक की होगी। आलू भंडारण की अवधि 15 फरवरी से 15 नवम्बर तक माल की सुरक्षा एवं संरक्षण की जिम्मेदारी शीतगृह स्वामी की होगी। इसके पश्चात बिना किसी सूचना के माल का भंडारण एवं खराब होना, दोनों की पूर्ण जिम्मेदारी माल मालिक की होगी।
                            </div>
                        </div>

                        <div class="signature-section">
                            <div class="signature-box">
                                <div class="signature-line">ग्राहक के हस्ताक्षर<br>Customer Signature</div>
                            </div>
                            <div class="signature-box">
                                <div class="signature-line">प्रबंधक के हस्ताक्षर<br>Manager Signature</div>
                            </div>
                        </div>

                    </div>
                `;

                // Create print window with 2 copies side by side
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Entry Receipt - ${roomEntry.thock_number}</title>
                        <style>
                            @page {
                                size: landscape;
                                margin: 10mm;
                            }
                            * {
                                margin: 0;
                                padding: 0;
                                box-sizing: border-box;
                            }
                            body {
                                font-family: 'Arial', sans-serif;
                                background: white;
                                padding: 10px;
                            }
                            .container {
                                display: flex;
                                gap: 10px;
                                justify-content: center;
                                align-items: flex-start;
                            }
                            .receipt {
                                width: 48%;
                                border: 2px solid #000;
                                padding: 10px;
                                background: white;
                                page-break-inside: avoid;
                            }
                            .header {
                                text-align: center;
                                border-bottom: 2px solid #000;
                                padding-bottom: 6px;
                                margin-bottom: 8px;
                            }
                            .header h1 {
                                font-size: 18px;
                                font-weight: bold;
                            }
                            .header p {
                                font-size: 8px;
                                color: #000;
                                margin-top: 2px;
                            }
                            .info-section {
                                border: 2px solid #000;
                                padding: 8px;
                                margin-bottom: 8px;
                            }
                            .truck-banner {
                                border: 2px solid #000;
                                color: #000;
                                text-align: center;
                                font-size: 20px;
                                font-weight: bold;
                                padding: 8px;
                                margin-bottom: 8px;
                                letter-spacing: 1px;
                                background: white;
                            }
                            .info-row {
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                margin-bottom: 8px;
                                padding: 4px 0;
                            }
                            .info-item {
                                flex: 1;
                                padding: 4px;
                                border: 1px solid #000;
                                background: white;
                            }
                            .label {
                                font-size: 10px;
                                color: #000;
                                font-weight: bold;
                                display: inline-block;
                                min-width: 120px;
                            }
                            .value {
                                font-size: 12px;
                                color: #000;
                                font-weight: bold;
                                display: inline-block;
                            }
                            .location-section {
                                border: 1px solid #000;
                                padding: 6px;
                                margin: 8px 0;
                                background: white;
                            }
                            .section-title {
                                font-size: 9px;
                                font-weight: bold;
                                margin-bottom: 4px;
                                text-align: center;
                                background: white;
                                color: #000;
                                padding: 3px;
                                border-bottom: 1px solid #000;
                            }
                            .location-grid {
                                display: grid;
                                grid-template-columns: repeat(3, 1fr);
                                gap: 4px;
                                text-align: center;
                                font-size: 9px;
                            }
                            .quantity-section {
                                border: 2px solid #000;
                                color: #000;
                                text-align: center;
                                padding: 8px;
                                margin: 8px 0;
                                background: white;
                            }
                            .quantity-label {
                                font-size: 8px;
                                margin-bottom: 3px;
                                font-weight: bold;
                                color: #000;
                            }
                            .quantity-value {
                                font-size: 20px;
                                font-weight: bold;
                                color: #000;
                            }
                            .weight-section {
                                border: 2px solid #000;
                                padding: 8px;
                                margin: 8px 0;
                                background: white;
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                            }
                            .weight-label {
                                font-size: 10px;
                                font-weight: bold;
                                color: #000;
                            }
                            .weight-value {
                                font-size: 14px;
                                font-weight: bold;
                                color: #000;
                            }
                            .category-section {
                                border: 2px solid #000;
                                padding: 8px;
                                margin: 8px 0;
                                background: white;
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                            }
                            .category-label {
                                font-size: 10px;
                                font-weight: bold;
                                color: #000;
                            }
                            .category-value {
                                font-size: 14px;
                                font-weight: bold;
                                color: #000;
                            }
                            .pricing-section {
                                border: 1px solid #000;
                                padding: 6px;
                                margin: 8px 0;
                                background: white;
                            }
                            .pricing-title {
                                font-size: 9px;
                                font-weight: bold;
                                text-align: center;
                                background: white;
                                color: #000;
                                padding: 3px;
                                margin-bottom: 5px;
                                border-bottom: 1px solid #000;
                            }
                            .pricing-row {
                                display: flex;
                                justify-content: space-between;
                                padding: 3px 5px;
                                border-bottom: 1px dashed #ccc;
                                font-size: 9px;
                            }
                            .pricing-total {
                                display: flex;
                                justify-content: space-between;
                                padding: 5px;
                                margin-top: 5px;
                                background: white;
                                border: 1px solid #000;
                                font-size: 11px;
                                font-weight: bold;
                            }
                            .pricing-total span:last-child {
                                color: #000;
                                font-size: 12px;
                            }
                            .employee-section {
                                border-top: 1px solid #000;
                                padding-top: 6px;
                                margin-top: 8px;
                                font-size: 8px;
                                text-align: center;
                            }
                            .employee-section div {
                                margin: 2px 0;
                            }
                            .timestamp {
                                font-size: 7px;
                                color: #666;
                                margin-top: 4px;
                                font-style: italic;
                            }
                            .footer {
                                margin-top: 8px;
                                padding-top: 6px;
                                border-top: 1px dashed #999;
                                text-align: center;
                                font-size: 7px;
                                color: #666;
                            }
                            .remark {
                                background: white;
                                border: 1px solid #000;
                                padding: 3px;
                                margin-bottom: 5px;
                                font-size: 7px;
                                color: #000;
                            }
                            .terms-section {
                                border: 2px solid #000;
                                padding: 6px;
                                margin: 8px 0;
                                background: white;
                            }
                            .terms-title {
                                font-size: 11px;
                                font-weight: bold;
                                text-align: center;
                                background: #000;
                                color: white;
                                padding: 4px;
                                margin-bottom: 6px;
                            }
                            .terms-list {
                                font-size: 11px;
                                line-height: 1.5;
                                margin-left: 12px;
                                padding: 0;
                            }
                            .terms-list li {
                                margin-bottom: 3px;
                            }
                            .terms-text {
                                font-size: 11px;
                                line-height: 1.6;
                                padding: 8px;
                                text-align: justify;
                                color: #000;
                            }
                            .signature-section {
                                display: flex;
                                justify-content: space-between;
                                margin-top: 15px;
                                padding-top: 8px;
                                border-top: 2px solid #000;
                            }
                            .signature-box {
                                flex: 1;
                                text-align: center;
                            }
                            .signature-line {
                                border-top: 2px solid #000;
                                margin-top: 30px;
                                padding-top: 4px;
                                font-size: 8px;
                                font-weight: bold;
                            }
                            .print-button {
                                background: #4CAF50;
                                color: white;
                                padding: 15px 40px;
                                border: none;
                                border-radius: 5px;
                                font-size: 18px;
                                cursor: pointer;
                                margin: 20px auto;
                                display: block;
                                font-weight: bold;
                            }
                            .print-button:hover {
                                background: #45a049;
                            }
                            @media print {
                                .print-button { display: none; }
                                body { padding: 0; }
                                .container { gap: 10px; }
                            }
                        </style>
                        <script src="/static/js/theme.js"></script>
</head>
                    <body>
                        <div class="container">
                            ${receiptHTML}
                            ${receiptHTML}
                        </div>

                        <button class="print-button" onclick="window.print()">
                            🖨️ Print 2 Receipts
                        </button>
                    </body>
                    </html>
                `);

                printWindow.document.close();
                printWindow.focus();

            } catch (error) {
                console.error('Error printing receipt:', error);
                alert(i18n.t('error_printing_receipt', 'Error printing receipt') + ': ' + error.message);
            }
        }

        function getTruckColor(thockNumber) {
            const numMatch = thockNumber.match(/^(\d+)/);
            if (numMatch) {
                const num = parseInt(numMatch[1]);
                return num <= 1500 ? 'text-green-600' : 'text-orange-600';
            }
            return 'text-gray-700';
        }

        // Auto-refresh functions - using delta updates for efficiency
        function startAutoRefresh() {
            // Single 5-second interval using delta refresh (only fetches new entries)
            roomEntriesRefreshInterval = setInterval(() => {
                refreshEntryRoomDelta();
            }, 5000);
        }

        function stopAutoRefresh() {
            if (roomEntriesRefreshInterval) {
                clearInterval(roomEntriesRefreshInterval);
            }
            if (entriesRefreshInterval) {
                clearInterval(entriesRefreshInterval);
            }
        }

        // Stop auto-refresh when leaving the page
        window.addEventListener('beforeunload', stopAutoRefresh);
    </script>

</body>
</html>
