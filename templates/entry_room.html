<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entry Room - Cold Storage</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">

    <style>
        * {
            font-family: 'Space Grotesk', sans-serif;
        }
        .neu-border {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            transition: all 0.2s ease;
        }
        .neu-border:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #000;
        }
        .neu-input {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            padding: 0.75rem;
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        .neu-input:focus {
            outline: none;
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #000;
        }
        .neu-button {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .neu-button:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #000;
        }
        .neu-button:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 #000;
        }
        .hidden { display: none; }
        .cursor-pointer { cursor: pointer; }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spin-animation {
            animation: spin 1s linear infinite;
        }
        .village-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 4px;
        }
        .village-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .village-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 2px solid #eee;
            transition: background 0.2s;
        }
        .village-item:hover {
            background: #f0f0f0;
            font-weight: 600;
        }
        .village-item:last-child {
            border-bottom: none;
        }
        .village-item.highlighted {
            background: #fbbf24;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-[#FFF9E6] min-h-screen p-8">
    <div class="max-w-7xl mx-auto">
        <header class="flex justify-between items-center mb-8 neu-border bg-white p-6">
            <div>
                <div class="flex items-center gap-3">
                    <i class="bi bi-box-arrow-in-right text-4xl text-orange-600"></i>
                    <div>
                        <h1 class="text-3xl font-bold">Entry Room</h1>
                        <p class="text-gray-600">Register new entry</p>
                    </div>
                </div>
            </div>
            <button onclick="goBack()" class="neu-button bg-gray-200">
                <i class="bi bi-arrow-left"></i> Back
            </button>
        </header>

        <!-- Main Content Grid: Form (Left) + Recent Room Entries (Right) -->
        <div class="grid grid-cols-2 gap-8 mb-8">
            <!-- User Details & Entry Form (Left) -->
            <div id="entryForm" class="neu-border bg-white p-6">
                <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                    <i class="bi bi-person-check"></i>
                    User Details & Entry
                </h2>

                <div class="grid grid-cols-1 gap-4 mb-6">
                    <div class="relative">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Phone * <span class="text-sm text-gray-500">(Must be 10 digits)</span>
                        </label>
                        <input
                            type="tel"
                            id="userPhone"
                            required
                            class="w-full neu-input"
                            placeholder="Search or enter 10-digit phone number"
                            maxlength="10"
                            minlength="10"
                            pattern="[0-9]{10}"
                            autocomplete="off"
                            onfocus="showPhoneDropdown()"
                            oninput="filterPhones()"
                        >
                        <div id="phoneDropdown" class="village-dropdown hidden">
                            <div id="phoneList" class="village-list"></div>
                        </div>
                        <div id="searchStatus" class="hidden mt-2 p-2 border-2">
                            <p class="text-sm font-semibold"></p>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Name *
                        </label>
                        <input
                            type="text"
                            id="userName"
                            required
                            class="w-full neu-input"
                            placeholder="Enter name"
                            oninput="capitalizeFirstLetter(this)"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            S/O <span class="text-sm text-gray-500">(Son Of / Father's Name)</span>
                        </label>
                        <input
                            type="text"
                            id="userSO"
                            class="w-full neu-input"
                            placeholder="Enter father's name (optional)"
                            oninput="capitalizeFirstLetter(this)"
                        >
                    </div>
                    <div class="relative">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Village *
                        </label>
                        <div class="relative">
                            <input
                                type="text"
                                id="userVillage"
                                required
                                class="w-full neu-input"
                                placeholder="Search or select village"
                                autocomplete="off"
                                onfocus="showVillageDropdown()"
                                oninput="capitalizeFirstLetter(this); filterVillages()"
                            >
                            <div id="villageDropdown" class="village-dropdown hidden">
                                <div id="villageList" class="village-list"></div>
                            </div>
                        </div>
                    </div>
                </div>

            <form id="entrySubmitForm" onsubmit="submitEntry(event)">
                <input type="hidden" id="userId" />

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Select Category *
                    </label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="neu-border p-3 bg-green-50 cursor-pointer hover:bg-green-100 transition-colors">
                            <input
                                type="radio"
                                name="truckCategory"
                                value="seed"
                                required
                                class="mr-2"
                                onchange="updateCategoryInfo()"
                            >
                            <div>
                                <span class="text-lg font-bold text-green-700">SEED</span>
                                <p id="seedCount" class="text-xs text-gray-600 mt-1 hidden">Loading...</p>
                            </div>
                        </label>
                        <label class="neu-border p-3 bg-orange-50 cursor-pointer hover:bg-orange-100 transition-colors">
                            <input
                                type="radio"
                                name="truckCategory"
                                value="sell"
                                required
                                class="mr-2"
                                onchange="updateCategoryInfo()"
                            >
                            <div>
                                <span class="text-lg font-bold text-orange-700">SELL</span>
                                <p id="sellCount" class="text-xs text-gray-600 mt-1 hidden">Loading...</p>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Expected Quantity *
                    </label>
                    <input
                        type="number"
                        id="expectedQuantity"
                        required
                        min="1"
                        max="1500"
                        class="w-full neu-input"
                        placeholder="Enter expected quantity (1-1500)"
                        oninput="updateTruckPreview()"
                    >
                </div>

                <div id="truckPreview" class="mb-4 p-3 bg-blue-50 neu-border hidden">
                    <p class="text-sm text-gray-600 mb-1">
                        <i class="bi bi-truck"></i>
                        Truck number preview:
                    </p>
                    <p class="text-2xl font-bold text-blue-700" id="previewTruckNumber">-</p>
                </div>

                <div class="flex gap-3">
                    <button type="submit" class="neu-button bg-green-500 text-white flex-1">
                        <i class="bi bi-check-circle"></i> Submit
                    </button>
                    <button type="button" onclick="resetForm()" class="neu-button bg-gray-300">
                        <i class="bi bi-x-circle"></i> Reset
                    </button>
                </div>
            </form>
            </div>

            <!-- Recent Room Entries (Right) -->
            <div class="neu-border bg-white p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold flex items-center gap-2">
                        <i class="bi bi-door-open text-blue-600"></i>
                        Recent Room Entries
                    </h2>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-600 bg-green-50 px-2 py-1 neu-border flex items-center gap-1">
                            <i class="bi bi-arrow-clockwise" id="refreshIcon"></i> Auto-refresh (5s)
                        </span>
                        <span class="text-xs text-gray-600 bg-blue-50 px-2 py-1 neu-border">
                            <i class="bi bi-hand-index"></i> Click to print
                        </span>
                    </div>
                </div>
                <div id="recentRoomEntries" class="overflow-auto" style="max-height: 700px;">
                    <table class="w-full text-sm">
                        <thead class="sticky top-0 bg-white">
                            <tr class="border-b-2 border-black">
                                <th class="text-left p-2 font-bold">Truck No</th>
                                <th class="text-left p-2 font-bold">Room</th>
                                <th class="text-left p-2 font-bold">Floor</th>
                                <th class="text-left p-2 font-bold">Gatar</th>
                                <th class="text-left p-2 font-bold">Qty</th>
                                <th class="text-left p-2 font-bold">Date</th>
                                <th class="text-left p-2 font-bold">Action</th>
                            </tr>
                        </thead>
                        <tbody id="roomEntriesTableBody">
                            <tr>
                                <td colspan="7" class="text-center p-4 text-gray-500">Loading room entries...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Success Message -->
        <div id="successMessage" class="hidden mt-6 neu-border bg-green-100 p-8">
            <h3 class="text-2xl font-bold text-green-700 mb-4 flex items-center gap-2">
                <i class="bi bi-check-circle-fill"></i>
                Entry Created Successfully!
            </h3>
            <div class="p-6 bg-white neu-border mb-4">
                <p class="text-lg text-gray-700 mb-2">Auto-Generated Truck Number:</p>
                <p class="text-4xl font-bold text-green-700" id="assignedTruck"></p>
            </div>
            <button onclick="resetForm()" class="neu-button bg-green-500 text-white w-full">
                <i class="bi bi-plus-circle"></i> Create Another Entry
            </button>
        </div>

        <!-- Recent Main Entries (Bottom) -->
        <div class="neu-border bg-white p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <i class="bi bi-clock-history"></i>
                    Recent Main Entries
                </h2>
            </div>
            <div id="recentEntries" class="overflow-auto" style="max-height: 400px;">
                <table class="w-full text-sm">
                    <thead class="sticky top-0 bg-white">
                        <tr class="border-b-2 border-black">
                            <th class="text-left p-2 font-bold">Truck</th>
                            <th class="text-left p-2 font-bold">Name</th>
                            <th class="text-left p-2 font-bold">Phone</th>
                            <th class="text-left p-2 font-bold">Village</th>
                            <th class="text-left p-2 font-bold">Qty</th>
                            <th class="text-left p-2 font-bold">Category</th>
                            <th class="text-left p-2 font-bold">Created</th>
                        </tr>
                    </thead>
                    <tbody id="entriesTableBody">
                        <tr>
                            <td colspan="7" class="text-center p-4 text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        let currentUser = null;

        // Auto-search timeout
        let searchTimeout = null;
        let entriesLimit = 10; // Default to show 10 entries

        // Category counts
        let seedCount = 0;
        let sellCount = 0;

        // Phone list from database - will be populated on load
        let customerPhones = [];

        // Village list for searchable dropdown
        const villages = ["Jahangirabad","Anupshahr","Achalpur","Ahamad Nagar Urf Touli","Ahar Bangar","Ahar Khadar","Akbarpur Urf Bachchikhera Bang","Alampur Urf Torai Bangar","Amarpur","Amba","Ametha","Aniwas","Anjni","Badarkha","Badshahpur Pauta","Bagsara","Bamanpur","Banawaripur","Barhpura","Begampur Urf Jairampur","Bhailai","Bhaipur","Bhiroli","Bhopur","Bibiyana","Bichaula","Bidhipur","Birauli","Borha","Chacharai","Charaura","Chhaturiya","Dabka","Daraura","Daravar","Davkora","Devakaranpur Urf Bajhera","Dugrau","Dungara Jogi","Enchora","Faridpur Bariyan","Fatahpur","Gahana Govardhanpur","Gangabas Pahara","Garhara","Godhana","Harchandpur","Hasanpur Bangar","Hisavati","Hoshiyarpur Urf Adhiyar","Jafrabad Urf Gangabas Bangar","Jahangirabad Rural","Jairampur Kudena","Jalilpur","Jamrau","Jasar","Jatpura","Jatvai","Jugasana Kalan","Jugasana Khurd","Karanpur Kalan","Karanpur Urf Nurpur","Karonji","Katiyavali","Khadana","Khalaur","Khalikabad/Dungrajat","Khalikpur","Khanpura","Khaunada","Khijarabad","Khushalgarh","Kishanpur Urf Kishan Khera","Kubari","Lachchhampur","Lachhoi","Madagavan","Madhogarh","Malakpur","Man Karora","Mau","Mauharsa","Maujpur","Mohammadpur Bangar","Mohammadpur Khadar","Mubarikpur","Mubarikpur Bangar","Muradnagar","Nagala Nalu","Navabpur Urf Dharampur","Navi Nagar","Pachdevra","Pagauna","Paharpur","Parali","Patrampur","Pipehara","Pootha","Rajapur","Rajaur","Rajner Urf Sorla","Rajpur","Raura","Rohallapur/Kharva","Ronda","Roopvas","Rooth Bangar","Rootha","Sahibad Urf Kakarai","Salamatpur","Salgavan","Sankhani","Shahjahanpur","Shekupur Raura","Sherpur Bangar","Shikoi","Shyampuri","Shyaurampur Jinai","Sihlinagar","Siraura Bangar","Soharkhan","Sunai","Sunana","Suratgarh Urf Lodhai","Telia Nagla","Titota Urf Birgaon","Ugevan","Abhaypur","Akapur Riyana","Alampur Nagla","Alavas Baturi","Amargarh","Amarthal Urf Unchagaon","Aurangabad Tahapur Bager","Aurangabad Tahapur Khader","B B Nagar","Badshahpur Gadia","Badshahpur Talab","Bahainpur","Baharmpur Urf Pali","Bahedi Khera","Bainipur","Balipur","Bamanpur Talluka","Bansuri","Barauli Basdevpur","Barhana","Barkatpur","Basi Bangar","Basi Khadar","Bathada Vajidpur","Bhadaura","Bhadoi Asarfpur","Bhagawantpur","Bhainsaura","Bhamrauli","Bhansa Khur","Bharkau","Bharra","Bhatpura","Bhaupur","Bhirawti","Bhurawala","Bigraon","Biharipur","Bihata","Chandpur Poothi","Chandyana","Chasi","Chatehra","Chhanaura","Chhatamwala","Chigrawati","Chitsona Alipur","Darauli","Darveshpur","Daulatpur Kalan","Dehra","Dhakauli","Dhakka","Dhakrauli","Dhalna","Dhaniyawali","Dulkhara","Eklaidi","Emamabad","Farida Bager","Farida Khadar","Fatehpur","Fatehpur Gujar","Fulaira","Gasupur","Ghansoorpur","Ghunghraoli","Ginaura Nagli","Giraura","Gulab Nagar","Guraoli","Hajipur","Harwanpur Urf Bhagawanpur","Hasanpur Ujarra","Hingbara","Ilna","Imalia","Ishanpur","Jadaul","Jadauli","Jalalpur","Jaria Alampur","Jawasa","Kachraut","Kalyanpur","Kamalpur","Kanauna","Kapsaipur","Karaitha","Karauthi","Karethha","Kariyari","Kaura Shamshadbad","Kesorpur Sathla","Khad Mohan Nagar","Khandoi","Khanpur Guntu","Khanpur Majra","Kharkali","Kharpur","Khijarpur","Kisola","Kriyawali","Kuchesar","Kurena","Ladana","Lalgarhi","Launga","Madangarh","Madona Jafrabad","Maduhasan Garhi Bager","Maduhasan Garhi Khadar","Mahav","Mahiuddinpur Bukalana","Mahuddinpur","Makri","Mangalpur","Mania Tikri","Manpur","Mathura Nagal","Maua Khera","Mavai","Mirzapur Nagli","Modh Allipur Urf Nima Patty Al","Mohamadpurbarwala","Mullani","Nagaur","Nagla Madaripur","Narendrapur","Narsena","Nehchauli","Nikhob","Nirsukha","Nittyanandpur Nagli","Nizampur Bager","Nizampur Khadar","Pali","Pali Anandgarhi","Palipartapur","Parawana Mahmudpur","Pempur","Pilkhani","Pirpur","Pota Kabulpur","Pyana Kalan","Pyana Khurd","Raghunathpur","Rahmatpur Augna","Rampur Pitampur","Ranapur","Rasulpur","Ratanpur","Rausla","Ravani Katiri Bangar","Ravani Katiri Khadar","Sabdalpur","Sahanpur","Sahera","Saidpur","Salabad Dhamaira","Saujna Rani","Sega Jagatpur","Seorampur","Shadipur Banboi","Shafi Nagar","Shakarpur","Shekhupura","Sikri","Sinhali Jhaya","Siyana","Sojna Jhaya","Sulaila","Surajpur Tikri","Takrarpur Ladpor","Tehgora","Thalinayatpur","Thana Gajraula","Thauna","Tibra","Timarpur","Umarpur","Verafirojpur","Yunispur","Abdullapur Hulasan","Ahmad Baj","Ahmadgarh","Ajijabad","Akbarpur Bas Kaneni","Allipur","Allipura Mubarikpur","Amarpur","Anaouna","Anchar Kalan","Ancharu Khurd","Asawari","Ashrefpur Abdullapur","Asrauli","Aurangabad Chandok","Azampur Dariapur","Bad","Badarkha Sirbas","Badrampur","Bailonth","Bamanpur","Ban","Banaul","Barasau","Barauda","Barauli","Barkatpur","Barkhara Hasangarhi","Beram Nagar","Bhaipur","Bhalolpur","Bhansroli Nasirpur","Bhataula","Bhonpur","Bohich","Chakla","Chitsaun","Dargahpur Basauti","Derveshpur","Dhalna","Dhaurau","Dhooturi","Domla Hasangarh","Faizallapur Ajnara","Faridpur Haveli","Fatahabad","Fatehgarh","Fazilpur","Ganga Garh","Gangabaj","Ghungravali Banvaripur","Golabas","Halpura","Hatampur","Hauganpur","Hazaratpur","Hinnaut","Hurthala","Jagdishpur Aurangabad","Jainawai","Jakhauta","Jalalpur","Jalalpur Karira","Jalalpur Katora","Jalaluddinpur Ginauri","Jalphi","Jamalpur","Janipur Kalan","Janipur Khurd","Jatpura","Jeerajpur","Kadon","Kadrabad","Kailawali","Kaisawan","Kamauna","Kaneni Badrampur","Karaina","Karauda","Karira","Kastaba Dhadd","Kasumi","Keratpur","Khailia Kalyanpur","Khairpur","Khakuda","Khandar","Khandwama","Khassia","Kiryawali","Kondupur","Kutubpur","Kuwarpur","Lalgarhi","Lalner","Lohra","Ludhpura","Madanpur Mubarakpur","Mahmudpur","Mahuwa Khara","Mamau","Mandawali","Maudi","Meerapur","Mohammadpur Ginauri","Morauni","Mukeempur","Mukhara","Mustfabad Daduwa","Nagalia Lachhamanpur","Nagla Dalpatpur","Nagla Lutf Alipur","Nagla Naw","Nagla Sarangpur","Nagla Urf Fattapur","Narau","Nawada","Noorpur Nagalia","Padha","Paharpur Haveli","Paharpur Surjawali","Pahasu Dehat","Pandrawal","Pitampur","Poothri Khurd","Poroli","Ragsonth","Rahmapur","Rajpura","Rajupura","Rampur Manpur","Ranau Raham Alipur","Ranayach Narendrapur","Rangpur","Raniwala","Rasulgarhi","Rasulpur","Rasulpur Nagla Bichat","Risalu","Riwara","Runsi","Sahar","Sahatpur Khairi","Saidh Garhi","Salabad","Salbahanpur","Salempur","Samanpur","Samaspur","Sarawa","Sarbhanna","Sargaon","Shikarpur","Shikarpur Rural","Siddhpur","Sidgarhi","Soi","Sujapur Pootha","Sultanpur Khader","Sultanpur Mirgarhi","Surajpur Nisfi","Surjawali","Surkharu","Syarli","Tayabpur","Teyor Bujurag","Teyori","Tunda Khera","Turkipura Khas","Urdmi","Urf Dusari","Utrawali","Yakubpur"];

        // Capitalize first letter of input field
        function capitalizeFirstLetter(input) {
            const value = input.value;
            if (value.length > 0) {
                input.value = value.charAt(0).toUpperCase() + value.slice(1);
            }
        }

        // Capitalize first letter of text content
        function capitalizeText(text) {
            if (!text || text.length === 0) return text;
            return text.charAt(0).toUpperCase() + text.slice(1);
        }

        // Capitalize all text outputs in tables and display elements
        function capitalizeOutputs() {
            // Capitalize table cells (except headers and specific columns like phone, truck number)
            document.querySelectorAll('tbody td').forEach(cell => {
                const text = cell.textContent.trim();
                // Skip if it's a number, phone, truck number, or empty
                if (text && !/^\d+$/.test(text) && !/^[\d\/-]+$/.test(text) && text !== '-') {
                    cell.textContent = capitalizeText(text);
                }
            });
        }

        // Fuzzy match function for village search
        function fuzzyMatchVillage(searchTerm, targetText) {
            if (!searchTerm) return true;
            if (!targetText) return false;

            searchTerm = searchTerm.toLowerCase();
            targetText = targetText.toLowerCase();

            // Exact substring match first (fast path)
            if (targetText.includes(searchTerm)) return true;

            // Fuzzy matching: all characters must appear in order
            let searchIndex = 0;
            for (let i = 0; i < targetText.length && searchIndex < searchTerm.length; i++) {
                if (targetText[i] === searchTerm[searchIndex]) {
                    searchIndex++;
                }
            }

            return searchIndex === searchTerm.length;
        }

        // Show village dropdown
        function showVillageDropdown() {
            filterVillages();
            document.getElementById('villageDropdown').classList.remove('hidden');
        }

        // Hide village dropdown
        function hideVillageDropdown() {
            setTimeout(() => {
                document.getElementById('villageDropdown').classList.add('hidden');
            }, 200);
        }

        // Filter and display villages
        function filterVillages() {
            const searchTerm = document.getElementById('userVillage').value;
            const filtered = villages.filter(village => fuzzyMatchVillage(searchTerm, village));

            // Limit to 50 results for performance
            const displayVillages = filtered.slice(0, 50);

            const villageList = document.getElementById('villageList');
            villageList.innerHTML = displayVillages.map(village =>
                `<div class="village-item" onclick="selectVillage('${village}')">${village}</div>`
            ).join('');

            if (displayVillages.length === 0) {
                villageList.innerHTML = '<div class="village-item" style="color: #999;">No villages found</div>';
            }
        }

        // Select a village
        function selectVillage(village) {
            document.getElementById('userVillage').value = village;
            document.getElementById('villageDropdown').classList.add('hidden');
        }

        // Fuzzy match function for phone search
        function fuzzyMatchPhone(searchTerm, phoneData) {
            if (!searchTerm) return true;
            searchTerm = searchTerm.toLowerCase();

            const phone = phoneData.phone.toLowerCase();
            const name = (phoneData.name || '').toLowerCase();
            const village = (phoneData.village || '').toLowerCase();

            // Check if search term matches phone, name, or village
            if (phone.includes(searchTerm)) return true;
            if (name.includes(searchTerm)) return true;
            if (village.includes(searchTerm)) return true;

            // Fuzzy matching on name
            let searchIndex = 0;
            for (let i = 0; i < name.length && searchIndex < searchTerm.length; i++) {
                if (name[i] === searchTerm[searchIndex]) {
                    searchIndex++;
                }
            }
            return searchIndex === searchTerm.length;
        }

        // Load customer phones from database
        async function loadCustomerPhones() {
            try {
                const response = await fetch('/api/entries', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) return;

                const entries = await response.json();

                // Extract unique customer data
                const phoneMap = new Map();
                entries.forEach(entry => {
                    if (entry.phone && !phoneMap.has(entry.phone)) {
                        phoneMap.set(entry.phone, {
                            phone: entry.phone,
                            name: entry.name || '',
                            village: entry.village || '',
                            so: entry.so || ''
                        });
                    }
                });

                customerPhones = Array.from(phoneMap.values());
            } catch (error) {
                console.error('Error loading customer phones:', error);
            }
        }

        // Show phone dropdown
        function showPhoneDropdown() {
            filterPhones();
            document.getElementById('phoneDropdown').classList.remove('hidden');
        }

        // Filter and display phones
        function filterPhones() {
            const searchTerm = document.getElementById('userPhone').value;
            const filtered = customerPhones.filter(phoneData => fuzzyMatchPhone(searchTerm, phoneData));

            // Limit to 50 results for performance
            const displayPhones = filtered.slice(0, 50);

            const phoneList = document.getElementById('phoneList');
            phoneList.innerHTML = displayPhones.map(phoneData => {
                const displayText = `${phoneData.phone} - ${phoneData.name}${phoneData.village ? ' (' + phoneData.village + ')' : ''}`;
                return `<div class="village-item" onclick='selectPhone(${JSON.stringify(phoneData)})'>${displayText}</div>`;
            }).join('');

            if (displayPhones.length === 0 && searchTerm.length >= 3) {
                phoneList.innerHTML = '<div class="village-item" style="color: #999;">No matching customers found</div>';
            } else if (searchTerm.length === 0) {
                phoneList.innerHTML = '<div class="village-item" style="color: #999;">Start typing to search...</div>';
            }
        }

        // Select a phone and auto-fill customer data
        function selectPhone(phoneData) {
            document.getElementById('userPhone').value = phoneData.phone;
            document.getElementById('userName').value = phoneData.name;
            document.getElementById('userVillage').value = phoneData.village;
            document.getElementById('userSO').value = phoneData.so || '';

            // Capitalize first letter of auto-filled fields
            capitalizeFirstLetter(document.getElementById('userName'));
            capitalizeFirstLetter(document.getElementById('userSO'));
            capitalizeFirstLetter(document.getElementById('userVillage'));

            document.getElementById('phoneDropdown').classList.add('hidden');
            showSearchStatus('Customer found! Details auto-filled.', 'success');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            const villageInput = document.getElementById('userVillage');
            const villageDropdown = document.getElementById('villageDropdown');
            if (villageInput && villageDropdown && !villageInput.contains(e.target) && !villageDropdown.contains(e.target)) {
                villageDropdown.classList.add('hidden');
            }

            const phoneInput = document.getElementById('userPhone');
            const phoneDropdown = document.getElementById('phoneDropdown');
            if (phoneInput && phoneDropdown && !phoneInput.contains(e.target) && !phoneDropdown.contains(e.target)) {
                phoneDropdown.classList.add('hidden');
            }
        });

        // Auto-refresh intervals
        let roomEntriesRefreshInterval = null;
        let entriesRefreshInterval = null;

        // Load recent entries on page load
        window.addEventListener('load', function() {
            loadRecentEntries();
            loadRoomEntries();
            loadCustomerPhones(); // Load customer phones for dropdown

            // Start auto-refresh for room entries (every 5 seconds)
            startAutoRefresh();
        });

        async function updateCategoryInfo() {
            const categoryRadio = document.querySelector('input[name="truckCategory"]:checked');
            if (!categoryRadio) return;

            const category = categoryRadio.value;

            // Hide all count displays first
            document.getElementById('seedCount').classList.add('hidden');
            document.getElementById('sellCount').classList.add('hidden');

            try {
                // Fetch count for selected category
                const response = await fetch(`/api/entries/count?category=${category}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch count');
                }

                const data = await response.json();

                // Store count in global variable
                if (category === 'seed') {
                    seedCount = data.count;
                    document.getElementById('seedCount').textContent = `Current: ${data.count} | Next number: ${data.next}`;
                    document.getElementById('seedCount').classList.remove('hidden');
                } else if (category === 'sell') {
                    sellCount = data.count;
                    document.getElementById('sellCount').textContent = `Current: ${data.count} | Next number: ${data.next}`;
                    document.getElementById('sellCount').classList.remove('hidden');
                }

                // Update truck preview
                updateTruckPreview();
            } catch (error) {
                console.error('Error fetching category count:', error);
            }
        }

        function updateTruckPreview() {
            const categoryRadio = document.querySelector('input[name="truckCategory"]:checked');
            const quantity = parseInt(document.getElementById('expectedQuantity').value);

            if (!categoryRadio || !quantity || quantity < 1) {
                document.getElementById('truckPreview').classList.add('hidden');
                return;
            }

            const category = categoryRadio.value;
            let nextNumber;
            let truckNumber;

            if (category === 'seed') {
                nextNumber = seedCount + 1;
                truckNumber = String(nextNumber).padStart(3, '0') + '/' + quantity;
            } else if (category === 'sell') {
                nextNumber = 1501 + sellCount;
                truckNumber = nextNumber + '/' + quantity;
            }

            document.getElementById('previewTruckNumber').textContent = truckNumber;
            document.getElementById('truckPreview').classList.remove('hidden');
        }

        function changeEntriesLimit() {
            const select = document.getElementById('entriesLimit');
            entriesLimit = parseInt(select.value);
            loadRecentEntries();
        }

        async function loadRecentEntries() {
            try {
                const response = await fetch('/api/entries', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('Failed to load entries');
                }

                const entries = await response.json();

                // Show entries based on selected limit (0 means all)
                const entriesToShow = entriesLimit === 0 ? entries : entries.slice(0, entriesLimit);
                displayRecentEntries(entriesToShow);
            } catch (error) {
                console.error('Error loading entries:', error);
                document.getElementById('entriesTableBody').innerHTML =
                    '<tr><td colspan="7" class="text-center p-4 text-red-500">Failed to load entries</td></tr>';
            }
        }

        function displayRecentEntries(entries) {
            const tbody = document.getElementById('entriesTableBody');

            if (entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-gray-500">No entries yet</td></tr>';
                return;
            }

            // Show only last 15 entries
            const recentEntries = entries.slice(0, 15);

            tbody.innerHTML = recentEntries.map(entry => {
                const truckColor = getTruckColor(entry.truck_number);
                const categoryColor = entry.truck_category === 'seed' ? 'text-green-700 bg-green-100' : 'text-orange-700 bg-orange-100';

                const date = new Date(entry.created_at);
                const formattedDate = date.toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                return `
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="p-2 font-bold ${truckColor}">${entry.truck_number}</td>
                        <td class="p-2">${capitalizeText(entry.name)}</td>
                        <td class="p-2">${entry.phone}</td>
                        <td class="p-2">${capitalizeText(entry.village) || '-'}</td>
                        <td class="p-2">${entry.expected_quantity}</td>
                        <td class="p-2"><span class="px-2 py-1 rounded text-xs font-bold ${categoryColor}">${entry.truck_category.toUpperCase()}</span></td>
                        <td class="p-2 text-xs">${formattedDate}</td>
                    </tr>
                `;
            }).join('');
        }


        function clearCustomerFields() {
            document.getElementById('userName').value = '';
            document.getElementById('userVillage').value = '';
            document.getElementById('userSO').value = '';
            document.getElementById('userId').value = '';
            currentUser = null;
        }

        function showSearchStatus(message, type) {
            const statusEl = document.getElementById('searchStatus');
            const statusText = statusEl.querySelector('p');

            statusText.textContent = message;
            statusEl.classList.remove('hidden', 'bg-green-100', 'border-green-600', 'text-green-700', 'bg-blue-100', 'border-blue-600', 'text-blue-700');

            if (type === 'success') {
                statusEl.classList.add('bg-green-100', 'border-green-600');
                statusText.className = 'text-sm font-semibold text-green-700';
            } else if (type === 'info') {
                statusEl.classList.add('bg-blue-100', 'border-blue-600');
                statusText.className = 'text-sm font-semibold text-blue-700';
            }
        }

        function hideSearchStatus() {
            const statusEl = document.getElementById('searchStatus');
            statusEl.classList.add('hidden');
        }

        function displayUserDetails(user) {
            document.getElementById('userName').value = user.name || '';
            document.getElementById('userVillage').value = user.village || '';
            document.getElementById('userSO').value = user.so || '';
            document.getElementById('userId').value = user.id;

            // Capitalize first letter of auto-filled fields
            capitalizeFirstLetter(document.getElementById('userName'));
            capitalizeFirstLetter(document.getElementById('userSO'));
            capitalizeFirstLetter(document.getElementById('userVillage'));
        }

        async function submitEntry(event) {
            event.preventDefault();

            const quantity = parseInt(document.getElementById('expectedQuantity').value);

            // Validate quantity
            if (quantity < 1) {
                alert('Quantity must be at least 1');
                return;
            }

            // Get values from input fields
            const name = document.getElementById('userName').value.trim();
            const phone = document.getElementById('userPhone').value.trim();
            const village = document.getElementById('userVillage').value.trim();
            const so = document.getElementById('userSO').value.trim();

            // Validate phone number (must be exactly 10 digits)
            if (phone.length !== 10 || !/^\d{10}$/.test(phone)) {
                alert('Phone number must be exactly 10 digits');
                return;
            }

            // Validate required fields
            if (!name || !phone || !village) {
                alert('Please fill in all required fields (Name, Phone, Village)');
                return;
            }

            // Get selected category from radio buttons
            const categoryRadio = document.querySelector('input[name="truckCategory"]:checked');
            if (!categoryRadio) {
                alert('Please select a category (SEED or SELL)');
                return;
            }
            const category = categoryRadio.value;

            const entryData = {
                customer_id: parseInt(document.getElementById('userId').value) || 0,
                phone: phone,
                name: name,
                village: village,
                so: so,
                expected_quantity: quantity,
                truck_category: category
            };

            try {
                const response = await fetch('/api/entries', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(entryData)
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                const result = await response.json();
                console.log('Entry created:', result);
                const truckNumber = result.truck_number || 'AUTO-' + result.id;
                console.log('Truck number:', truckNumber);
                showSuccess(truckNumber);
            } catch (error) {
                alert('Error creating entry: ' + error.message);
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('searchError');
            errorEl.querySelector('p').textContent = message;
            errorEl.classList.remove('hidden');
        }

        function showSuccess(truckNumber) {
            console.log('showSuccess called with:', truckNumber);
            const truckEl = document.getElementById('assignedTruck');
            const successEl = document.getElementById('successMessage');

            if (truckEl) {
                truckEl.textContent = truckNumber;
                console.log('Truck number set to element');
            }

            if (successEl) {
                successEl.classList.remove('hidden');
                console.log('Success message shown');
                // Scroll to success message
                successEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // Reload recent entries and room entries to show the new entry
            loadRecentEntries();
            loadRoomEntries();
        }

        function resetForm() {
            document.getElementById('userName').value = '';
            document.getElementById('userVillage').value = '';
            document.getElementById('userPhone').value = '';
            document.getElementById('userSO').value = '';
            document.getElementById('entrySubmitForm').reset();
            document.getElementById('successMessage').classList.add('hidden');
            document.getElementById('truckPreview').classList.add('hidden');
            hideSearchStatus();

            // Hide count displays
            document.getElementById('seedCount').classList.add('hidden');
            document.getElementById('sellCount').classList.add('hidden');

            // Uncheck all radio buttons
            const radios = document.querySelectorAll('input[name="truckCategory"]');
            radios.forEach(radio => radio.checked = false);

            currentUser = null;

            // Refresh the lists
            loadRecentEntries();
            loadRoomEntries();
        }

        function goBack() {
            window.history.back();
        }

        async function loadRoomEntries() {
            // Show loading animation
            const refreshIcon = document.getElementById('refreshIcon');
            if (refreshIcon) {
                refreshIcon.classList.add('spin-animation');
            }

            try {
                const response = await fetch('/api/room-entries', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('Failed to load room entries');
                }

                const roomEntries = await response.json();
                displayRoomEntries(roomEntries || []);
            } catch (error) {
                console.error('Error loading room entries:', error);
                document.getElementById('roomEntriesTableBody').innerHTML =
                    '<tr><td colspan="7" class="text-center p-4 text-red-500">Failed to load room entries</td></tr>';
            } finally {
                // Stop loading animation after a short delay
                if (refreshIcon) {
                    setTimeout(() => {
                        refreshIcon.classList.remove('spin-animation');
                    }, 500);
                }
            }
        }

        function displayRoomEntries(roomEntries) {
            const tbody = document.getElementById('roomEntriesTableBody');

            if (roomEntries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-gray-500">No room entries yet</td></tr>';
                return;
            }

            tbody.innerHTML = roomEntries.map(entry => {
                const date = new Date(entry.created_at);
                const formattedDate = date.toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                const truckColor = getTruckColor(entry.truck_number);

                return `
                    <tr class="border-b border-gray-200 hover:bg-blue-50 cursor-pointer transition-colors"
                        onclick="printReceipt(${entry.entry_id}, ${entry.id})"
                        title="Click to print receipt">
                        <td class="p-2 font-bold ${truckColor}">${entry.truck_number}</td>
                        <td class="p-2">${entry.room_no}</td>
                        <td class="p-2">${entry.floor}</td>
                        <td class="p-2">${entry.gate_no}</td>
                        <td class="p-2 font-bold">${entry.quantity}</td>
                        <td class="p-2 text-xs">${formattedDate}</td>
                        <td class="p-2" onclick="event.stopPropagation()">
                            <div class="flex gap-1">
                                <button onclick="printReceipt(${entry.entry_id}, ${entry.id})" class="neu-button bg-blue-500 text-white text-xs px-2 py-1" title="Print Receipt">
                                    <i class="bi bi-printer"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function goToInvoice(entryId, roomEntryId) {
            window.location.href = `/loading-invoice?entry_id=${entryId}&room_entry_id=${roomEntryId}`;
        }

        // Decode JWT to get employee details
        function getEmployeeFromToken() {
            if (!token) return null;

            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));

                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error('Error decoding token:', error);
                return null;
            }
        }

        async function printReceipt(entryId, roomEntryId) {
            try {
                // Fetch entry details
                const entryResponse = await fetch(`/api/entries/${entryId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const entry = await entryResponse.json();

                // Fetch room entry details
                const roomEntryResponse = await fetch(`/api/room-entries/${roomEntryId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const roomEntry = await roomEntryResponse.json();

                // Fetch rent rate from system settings
                let ratePerUnit = 10; // Default fallback
                try {
                    const settingsResponse = await fetch('/api/settings/rent_per_item', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (settingsResponse.ok) {
                        const setting = await settingsResponse.json();
                        ratePerUnit = parseFloat(setting.setting_value) || 10;
                    }
                } catch (error) {
                    console.warn('Failed to fetch rent rate, using default:', error);
                }

                // Get employee details from token
                const employee = getEmployeeFromToken();

                // Calculate rent
                const grandTotal = roomEntry.quantity * ratePerUnit;

                // Format dates
                const entryDate = new Date(entry.created_at).toLocaleString('en-IN');
                const roomEntryDate = new Date(roomEntry.created_at).toLocaleString('en-IN');
                const printDate = new Date().toLocaleDateString('en-IN', { day: '2-digit', month: '2-digit', year: 'numeric' });

                // Generate random weight between 55-57 kg (whole numbers)
                const randomWeight = Math.floor(Math.random() * (58 - 55) + 55);

                // Determine category from truck number (SEED: 1-1500, SELL: 1501-3000)
                const truckNum = parseInt(roomEntry.truck_number.split('/')[0]);
                const category = truckNum <= 1500 ? '' : '';

                // Create receipt HTML (2 copies side by side) - Hindi Format
                const receiptHTML = `
                    <div class="receipt">
                        <div class="header">
                            <h1>   </h1>
                            <p>Gud Kripa Cold Store</p>
                            <p>  / | Cold Store License/Warehouse</p>
                            <p style="font-weight: bold; margin-top: 2px;">Mobile: 7505837172</p>
                        </div>

                        <div class="truck-banner">
                            ${roomEntry.truck_number}
                        </div>

                        <div class="info-section">
                            <div class="info-row">
                                <span class="label">   | Customer:</span>
                                <span class="value">${capitalizeText(entry.name)}</span>
                            </div>
                            <div class="info-row">
                                <span class="label"> | Phone:</span>
                                <span class="value">${entry.phone}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">   | Village:</span>
                                <span class="value">${capitalizeText(entry.village) || 'N/A'}</span>
                            </div>
                            <div class="info-row">
                                <span class="label"> | Date:</span>
                                <span class="value">${printDate}</span>
                            </div>
                        </div>

                        <div class="quantity-section">
                            <div class="quantity-label">   | Total Bags</div>
                            <div class="quantity-value">${roomEntry.quantity} </div>
                        </div>

                        <div class="weight-section">
                            <div class="weight-label">   ( ):</div>
                            <div class="weight-value">${randomWeight} </div>
                        </div>

                        <div class="category-section">
                            <div class="category-label">:</div>
                            <div class="category-value">${category}</div>
                        </div>

                        <div class="terms-section">
                            <div class="terms-title">:</div>
                            <div class="terms-text">
                                -1,                    15   15                         ,        
                            </div>
                        </div>

                        <div class="signature-section">
                            <div class="signature-box">
                                <div class="signature-line">  <br>Customer Signature</div>
                            </div>
                            <div class="signature-box">
                                <div class="signature-line">  <br>Manager Signature</div>
                            </div>
                        </div>

                        ${roomEntry.remark ? '<div class="remark"> | Note: ' + roomEntry.remark + '</div>' : ''}
                    </div>
                `;

                // Create print window with 2 copies side by side
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Entry Receipt - ${roomEntry.truck_number}</title>
                        <style>
                            @page {
                                size: landscape;
                                margin: 10mm;
                            }
                            * {
                                margin: 0;
                                padding: 0;
                                box-sizing: border-box;
                            }
                            body {
                                font-family: 'Arial', sans-serif;
                                background: white;
                                padding: 10px;
                            }
                            .container {
                                display: flex;
                                gap: 10px;
                                justify-content: center;
                                align-items: flex-start;
                            }
                            .receipt {
                                width: 48%;
                                border: 2px solid #000;
                                padding: 10px;
                                background: white;
                                page-break-inside: avoid;
                            }
                            .header {
                                text-align: center;
                                border-bottom: 2px solid #000;
                                padding-bottom: 6px;
                                margin-bottom: 8px;
                            }
                            .header h1 {
                                font-size: 18px;
                                font-weight: bold;
                            }
                            .header p {
                                font-size: 8px;
                                color: #000;
                                margin-top: 2px;
                            }
                            .info-section {
                                border: 2px solid #000;
                                padding: 8px;
                                margin-bottom: 8px;
                            }
                            .truck-banner {
                                border: 2px solid #000;
                                color: #000;
                                text-align: center;
                                font-size: 20px;
                                font-weight: bold;
                                padding: 8px;
                                margin-bottom: 8px;
                                letter-spacing: 1px;
                                background: white;
                            }
                            .info-row {
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                margin-bottom: 8px;
                                padding: 4px 0;
                            }
                            .info-item {
                                flex: 1;
                                padding: 4px;
                                border: 1px solid #000;
                                background: white;
                            }
                            .label {
                                font-size: 10px;
                                color: #000;
                                font-weight: bold;
                                display: inline-block;
                                min-width: 120px;
                            }
                            .value {
                                font-size: 12px;
                                color: #000;
                                font-weight: bold;
                                display: inline-block;
                            }
                            .location-section {
                                border: 1px solid #000;
                                padding: 6px;
                                margin: 8px 0;
                                background: white;
                            }
                            .section-title {
                                font-size: 9px;
                                font-weight: bold;
                                margin-bottom: 4px;
                                text-align: center;
                                background: white;
                                color: #000;
                                padding: 3px;
                                border-bottom: 1px solid #000;
                            }
                            .location-grid {
                                display: grid;
                                grid-template-columns: repeat(3, 1fr);
                                gap: 4px;
                                text-align: center;
                                font-size: 9px;
                            }
                            .quantity-section {
                                border: 2px solid #000;
                                color: #000;
                                text-align: center;
                                padding: 8px;
                                margin: 8px 0;
                                background: white;
                            }
                            .quantity-label {
                                font-size: 8px;
                                margin-bottom: 3px;
                                font-weight: bold;
                                color: #000;
                            }
                            .quantity-value {
                                font-size: 20px;
                                font-weight: bold;
                                color: #000;
                            }
                            .weight-section {
                                border: 2px solid #000;
                                padding: 8px;
                                margin: 8px 0;
                                background: white;
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                            }
                            .weight-label {
                                font-size: 10px;
                                font-weight: bold;
                                color: #000;
                            }
                            .weight-value {
                                font-size: 14px;
                                font-weight: bold;
                                color: #000;
                            }
                            .category-section {
                                border: 2px solid #000;
                                padding: 8px;
                                margin: 8px 0;
                                background: white;
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                            }
                            .category-label {
                                font-size: 10px;
                                font-weight: bold;
                                color: #000;
                            }
                            .category-value {
                                font-size: 14px;
                                font-weight: bold;
                                color: #000;
                            }
                            .pricing-section {
                                border: 1px solid #000;
                                padding: 6px;
                                margin: 8px 0;
                                background: white;
                            }
                            .pricing-title {
                                font-size: 9px;
                                font-weight: bold;
                                text-align: center;
                                background: white;
                                color: #000;
                                padding: 3px;
                                margin-bottom: 5px;
                                border-bottom: 1px solid #000;
                            }
                            .pricing-row {
                                display: flex;
                                justify-content: space-between;
                                padding: 3px 5px;
                                border-bottom: 1px dashed #ccc;
                                font-size: 9px;
                            }
                            .pricing-total {
                                display: flex;
                                justify-content: space-between;
                                padding: 5px;
                                margin-top: 5px;
                                background: white;
                                border: 1px solid #000;
                                font-size: 11px;
                                font-weight: bold;
                            }
                            .pricing-total span:last-child {
                                color: #000;
                                font-size: 12px;
                            }
                            .employee-section {
                                border-top: 1px solid #000;
                                padding-top: 6px;
                                margin-top: 8px;
                                font-size: 8px;
                                text-align: center;
                            }
                            .employee-section div {
                                margin: 2px 0;
                            }
                            .timestamp {
                                font-size: 7px;
                                color: #666;
                                margin-top: 4px;
                                font-style: italic;
                            }
                            .footer {
                                margin-top: 8px;
                                padding-top: 6px;
                                border-top: 1px dashed #999;
                                text-align: center;
                                font-size: 7px;
                                color: #666;
                            }
                            .remark {
                                background: white;
                                border: 1px solid #000;
                                padding: 3px;
                                margin-bottom: 5px;
                                font-size: 7px;
                                color: #000;
                            }
                            .terms-section {
                                border: 2px solid #000;
                                padding: 6px;
                                margin: 8px 0;
                                background: white;
                            }
                            .terms-title {
                                font-size: 11px;
                                font-weight: bold;
                                text-align: center;
                                background: #000;
                                color: white;
                                padding: 4px;
                                margin-bottom: 6px;
                            }
                            .terms-list {
                                font-size: 11px;
                                line-height: 1.5;
                                margin-left: 12px;
                                padding: 0;
                            }
                            .terms-list li {
                                margin-bottom: 3px;
                            }
                            .terms-text {
                                font-size: 11px;
                                line-height: 1.6;
                                padding: 8px;
                                text-align: justify;
                                color: #000;
                            }
                            .signature-section {
                                display: flex;
                                justify-content: space-between;
                                margin-top: 15px;
                                padding-top: 8px;
                                border-top: 2px solid #000;
                            }
                            .signature-box {
                                flex: 1;
                                text-align: center;
                            }
                            .signature-line {
                                border-top: 2px solid #000;
                                margin-top: 30px;
                                padding-top: 4px;
                                font-size: 8px;
                                font-weight: bold;
                            }
                            .print-button {
                                background: #4CAF50;
                                color: white;
                                padding: 15px 40px;
                                border: none;
                                border-radius: 5px;
                                font-size: 18px;
                                cursor: pointer;
                                margin: 20px auto;
                                display: block;
                                font-weight: bold;
                            }
                            .print-button:hover {
                                background: #45a049;
                            }
                            @media print {
                                .print-button { display: none; }
                                body { padding: 0; }
                                .container { gap: 10px; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            ${receiptHTML}
                            ${receiptHTML}
                        </div>

                        <button class="print-button" onclick="window.print()">
                             Print 2 Receipts
                        </button>
                    </body>
                    </html>
                `);

                printWindow.document.close();
                printWindow.focus();

            } catch (error) {
                console.error('Error printing receipt:', error);
                alert('Error printing receipt: ' + error.message);
            }
        }

        function getTruckColor(truckNumber) {
            const numMatch = truckNumber.match(/^(\d+)/);
            if (numMatch) {
                const num = parseInt(numMatch[1]);
                return num <= 1500 ? 'text-green-600' : 'text-orange-600';
            }
            return 'text-gray-700';
        }

        // Auto-refresh functions
        function startAutoRefresh() {
            // Refresh room entries every 5 seconds
            roomEntriesRefreshInterval = setInterval(() => {
                loadRoomEntries();
            }, 5000);

            // Refresh main entries every 10 seconds
            entriesRefreshInterval = setInterval(() => {
                loadRecentEntries();
            }, 10000);
        }

        function stopAutoRefresh() {
            if (roomEntriesRefreshInterval) {
                clearInterval(roomEntriesRefreshInterval);
            }
            if (entriesRefreshInterval) {
                clearInterval(entriesRefreshInterval);
            }
        }

        // Stop auto-refresh when leaving the page
        window.addEventListener('beforeunload', stopAutoRefresh);
    </script>

</body>
</html>
