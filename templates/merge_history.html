<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png?v=2">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merge & Transfer History - Cold Storage</title>
    <link rel="stylesheet" href="/static/css/bootstrap-icons.min.css">
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link href="/static/css/arbitrary.css" rel="stylesheet">
    <link href="/static/css/fonts.css" rel="stylesheet">
    <link href="/static/css/dark-mode.css" rel="stylesheet">
    <link href="/static/css/responsive.css" rel="stylesheet">
    <link href="/static/css/inventory-theme.css" rel="stylesheet">

    <style>
        * { font-family: 'Space Grotesk', sans-serif; }
        .neu-border {
            border: 1px solid var(--border-color, #e0e6ed);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-radius: 16px;
            transition: all 0.2s ease;
        }
        .neu-border:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        .neu-button {
            border: 1px solid var(--border-color, #e0e6ed);
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
            border-radius: 10px;
            padding: 0.5rem 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .neu-button:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        .history-card {
            border: 1px solid var(--border-color, #e0e6ed);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-radius: 12px;
            margin-bottom: 1rem;
            background: white;
        }
        .merged { border-color: #9333ea; box-shadow: 0 4px 15px rgba(147, 51, 234, 0.15); }
        .transferred { border-color: #3b82f6; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.15); }
        @media (max-width: 1023px) and (orientation: portrait) {
            body { font-size: 0.875rem; }
            .neu-border, .history-card {
                border-width: 1px;
                box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            }
            .neu-button {
                padding: 0.375rem 0.625rem;
                font-size: 0.75rem;
                border-width: 1px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
        }
    </style>
    <script src="/static/js/theme.js"></script>
</head>
<body class="bg-[#f8fafb] min-h-screen p-2 sm:p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 md:mb-8 neu-border bg-white p-3 md:p-6 gap-3 md:gap-4">
            <div>
                <div class="flex items-center gap-2 md:gap-3">
                    <i class="bi bi-clock-history text-2xl md:text-4xl text-purple-600"></i>
                    <div>
                        <h1 class="text-xl md:text-3xl font-bold">Merge & Transfer History</h1>
                        <p class="text-gray-600 text-xs md:text-base hidden sm:block">View and undo customer merges and thock transfers</p>
                    </div>
                </div>
            </div>
            <div class="flex flex-wrap gap-2">
                <button onclick="theme.toggle()" class="neu-button bg-gray-200 px-2 md:px-3 py-2" title="Toggle Dark Mode">
                    <i class="bi bi-moon-fill theme-icon-moon"></i>
                    <i class="bi bi-sun-fill theme-icon-sun hidden"></i>
                </button>
                <button onclick="window.history.back()" class="neu-button bg-gray-200 px-3 md:px-4 py-2">
                    <i class="bi bi-arrow-left"></i> <span class="hidden sm:inline">Back</span>
                </button>
            </div>
        </header>

        <!-- Summary Cards -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="neu-border bg-gradient-to-br from-purple-400 to-purple-600 text-white p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90">Merged Customers</p>
                        <p class="text-3xl font-bold" id="mergedCount">0</p>
                    </div>
                    <i class="bi bi-people text-4xl opacity-50"></i>
                </div>
            </div>
            <div class="neu-border bg-gradient-to-br from-blue-400 to-blue-600 text-white p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90">Transferred Thocks</p>
                        <p class="text-3xl font-bold" id="transferredCount">0</p>
                    </div>
                    <i class="bi bi-arrow-left-right text-4xl opacity-50"></i>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-2 mb-4">
            <button id="mergeLogsTab" onclick="showTab('mergeLogs')" class="neu-button bg-purple-500 text-white">
                <i class="bi bi-journal-text"></i> Merge Logs
            </button>
            <button id="mergedTab" onclick="showTab('merged')" class="neu-button bg-gray-300">
                <i class="bi bi-people"></i> Merged Customers
            </button>
            <button id="transferredTab" onclick="showTab('transferred')" class="neu-button bg-gray-300">
                <i class="bi bi-arrow-left-right"></i> Transferred Thocks
            </button>
        </div>

        <!-- Merge Logs Section (Detailed) -->
        <div id="mergeLogsSection">
            <div id="mergeLogsContainer">
                <div class="text-center py-12">
                    <i class="bi bi-hourglass-split text-6xl text-gray-400"></i>
                    <p class="text-gray-600 mt-4">Loading merge logs...</p>
                </div>
            </div>
        </div>

        <!-- Merged Customers Section -->
        <div id="mergedSection" class="hidden">
            <div id="mergedContainer">
                <div class="text-center py-12">
                    <i class="bi bi-hourglass-split text-6xl text-gray-400"></i>
                    <p class="text-gray-600 mt-4">Loading merge history...</p>
                </div>
            </div>
        </div>

        <!-- Transferred Thocks Section -->
        <div id="transferredSection" class="hidden">
            <div id="transferredContainer">
                <div class="text-center py-12">
                    <i class="bi bi-hourglass-split text-6xl text-gray-400"></i>
                    <p class="text-gray-600 mt-4">Loading transfer history...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        let historyData = null;

        function capitalizeText(text) {
            if (!text || text.length === 0) return text;
            return text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();
        }

        // Check admin access
        (function() {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                window.location.href = '/login';
                return;
            }
            const user = JSON.parse(userStr);
            if (user.role !== 'admin') {
                alert('Access Denied: Admin access required');
                window.location.href = '/dashboard';
                return;
            }
        })();

        function showTab(tab) {
            // Hide all sections
            document.getElementById('mergeLogsSection').classList.add('hidden');
            document.getElementById('mergedSection').classList.add('hidden');
            document.getElementById('transferredSection').classList.add('hidden');

            // Reset all tabs
            document.getElementById('mergeLogsTab').classList.remove('bg-purple-500', 'bg-blue-500', 'text-white');
            document.getElementById('mergeLogsTab').classList.add('bg-gray-300');
            document.getElementById('mergedTab').classList.remove('bg-purple-500', 'bg-blue-500', 'text-white');
            document.getElementById('mergedTab').classList.add('bg-gray-300');
            document.getElementById('transferredTab').classList.remove('bg-purple-500', 'bg-blue-500', 'text-white');
            document.getElementById('transferredTab').classList.add('bg-gray-300');

            // Show selected section
            if (tab === 'mergeLogs') {
                document.getElementById('mergeLogsSection').classList.remove('hidden');
                document.getElementById('mergeLogsTab').classList.remove('bg-gray-300');
                document.getElementById('mergeLogsTab').classList.add('bg-purple-500', 'text-white');
            } else if (tab === 'merged') {
                document.getElementById('mergedSection').classList.remove('hidden');
                document.getElementById('mergedTab').classList.remove('bg-gray-300');
                document.getElementById('mergedTab').classList.add('bg-purple-500', 'text-white');
            } else {
                document.getElementById('transferredSection').classList.remove('hidden');
                document.getElementById('transferredTab').classList.remove('bg-gray-300');
                document.getElementById('transferredTab').classList.add('bg-blue-500', 'text-white');
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch('/api/merge-history', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }
                    throw new Error(await response.text());
                }

                historyData = await response.json();

                // Update counts
                document.getElementById('mergedCount').textContent = historyData.merge_logs?.length || historyData.merged_customers?.length || 0;
                document.getElementById('transferredCount').textContent = historyData.transferred_entries?.length || 0;

                // Render merge logs (detailed)
                renderMergeLogs(historyData.merge_logs || []);

                // Render merged customers
                renderMergedCustomers(historyData.merged_customers || []);

                // Render transferred entries
                renderTransferredEntries(historyData.transferred_entries || []);

            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('mergedContainer').innerHTML = `
                    <div class="neu-border bg-red-50 p-8 text-center">
                        <i class="bi bi-exclamation-triangle text-4xl text-red-500"></i>
                        <p class="text-red-600 mt-4">Error loading history: ${error.message}</p>
                    </div>
                `;
            }
        }

        function renderMergeLogs(logs) {
            const container = document.getElementById('mergeLogsContainer');

            if (!logs || logs.length === 0) {
                container.innerHTML = `
                    <div class="neu-border bg-white p-8 text-center">
                        <i class="bi bi-info-circle text-4xl text-blue-500"></i>
                        <p class="text-gray-600 mt-4">No merge logs found. Detailed logs will appear here after new merges.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = logs.map(log => {
                const date = new Date(log.created_at).toLocaleString('en-IN', {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });

                // Build entries list
                let entriesHtml = '';
                if (log.merge_details?.entries && log.merge_details.entries.length > 0) {
                    entriesHtml = `
                        <div class="mt-3 p-3 bg-yellow-50 border border-yellow-300 rounded-lg">
                            <p class="font-bold text-sm mb-2"><i class="bi bi-box-seam"></i> Thocks Transferred (${log.merge_details.entries.length}):</p>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                ${log.merge_details.entries.map(e => `
                                    <div class="bg-white p-2 border text-sm">
                                        <strong>${e.thock_number}</strong><br>
                                        <span class="text-gray-500">${e.expected_quantity} bags | ${e.thock_category}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                // Build payments list
                let paymentsHtml = '';
                if (log.merge_details?.payments && log.merge_details.payments.length > 0) {
                    const totalPayments = log.merge_details.payments.reduce((sum, p) => sum + p.amount, 0);
                    paymentsHtml = `
                        <div class="mt-3 p-3 bg-green-50 border border-green-300 rounded-lg">
                            <p class="font-bold text-sm mb-2"><i class="bi bi-cash"></i> Payments Transferred (${log.merge_details.payments.length}) - Total: ₹${totalPayments.toLocaleString()}:</p>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                ${log.merge_details.payments.map(p => `
                                    <div class="bg-white p-2 border text-sm">
                                        <strong>₹${p.amount.toLocaleString()}</strong><br>
                                        <span class="text-gray-500">${p.receipt_number || 'No receipt'} | ${p.payment_date}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                return `
                    <div class="history-card merged p-4 mb-4">
                        <div class="flex justify-between items-start flex-wrap gap-2">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2 flex-wrap">
                                    <span class="bg-purple-500 text-white px-2 py-1 text-xs font-bold">MERGE</span>
                                    <span class="text-gray-500 text-sm">${date}</span>
                                    <span class="text-gray-500 text-sm">by ${capitalizeText(log.performed_by_name)}</span>
                                </div>

                                <div class="grid md:grid-cols-2 gap-4">
                                    <!-- Source Customer -->
                                    <div class="p-3 bg-red-50 border border-red-300 rounded-lg">
                                        <p class="text-xs text-red-600 font-bold mb-1">SOURCE (MERGED)</p>
                                        <h3 class="text-lg font-bold">${capitalizeText(log.source_customer_name || '')}</h3>
                                        <p class="text-gray-600 text-sm">
                                            <i class="bi bi-telephone"></i> ${log.source_customer_phone || ''}
                                            ${log.source_customer_so ? ` | S/O: ${capitalizeText(log.source_customer_so)}` : ''}
                                            ${log.source_customer_village ? ` | ${capitalizeText(log.source_customer_village)}` : ''}
                                        </p>
                                    </div>

                                    <!-- Target Customer -->
                                    <div class="p-3 bg-green-50 border border-green-300 rounded-lg">
                                        <p class="text-xs text-green-600 font-bold mb-1">TARGET (KEPT)</p>
                                        <h3 class="text-lg font-bold">${capitalizeText(log.target_customer_name || '')}</h3>
                                        <p class="text-gray-600 text-sm">
                                            <i class="bi bi-telephone"></i> ${log.target_customer_phone || ''}
                                            ${log.target_customer_so ? ` | S/O: ${capitalizeText(log.target_customer_so)}` : ''}
                                            ${log.target_customer_village ? ` | ${capitalizeText(log.target_customer_village)}` : ''}
                                        </p>
                                    </div>
                                </div>

                                <div class="mt-3 flex gap-4 text-sm">
                                    <span class="bg-purple-100 px-2 py-1"><strong>${log.entries_moved || 0}</strong> Thocks</span>
                                    <span class="bg-green-100 px-2 py-1"><strong>${log.payments_moved || 0}</strong> Payments</span>
                                </div>

                                ${entriesHtml}
                                ${paymentsHtml}
                            </div>

                            <button onclick="undoMerge(${log.source_customer_id})" class="neu-button bg-yellow-500 text-white">
                                <i class="bi bi-arrow-counterclockwise"></i> Undo
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderMergedCustomers(customers) {
            const container = document.getElementById('mergedContainer');

            if (customers.length === 0) {
                container.innerHTML = `
                    <div class="neu-border bg-white p-8 text-center">
                        <i class="bi bi-check-circle text-4xl text-green-500"></i>
                        <p class="text-gray-600 mt-4">No merged customers found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = customers.map(c => `
                <div class="history-card merged p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-purple-500 text-white px-2 py-1 text-xs font-bold">MERGED</span>
                                <span class="text-gray-500 text-sm">${c.merged_at}</span>
                            </div>
                            <h3 class="text-xl font-bold">${capitalizeText(c.name)}</h3>
                            <p class="text-gray-600">
                                <i class="bi bi-telephone"></i> ${c.phone}
                                ${c.so ? ` | S/O: ${capitalizeText(c.so)}` : ''}
                                | ${capitalizeText(c.village)}
                            </p>
                            ${c.target_customer ? `
                                <div class="mt-2 p-2 bg-green-50 border border-green-300 rounded-lg">
                                    <p class="text-sm text-green-700">
                                        <i class="bi bi-arrow-right"></i> Merged into:
                                        <strong>${capitalizeText(c.target_customer.name)}</strong> (${c.target_customer.phone})
                                    </p>
                                </div>
                            ` : ''}
                        </div>
                        <button onclick="undoMerge(${c.id})" class="neu-button bg-yellow-500 text-white">
                            <i class="bi bi-arrow-counterclockwise"></i> Undo
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderTransferredEntries(entries) {
            const container = document.getElementById('transferredContainer');

            if (entries.length === 0) {
                container.innerHTML = `
                    <div class="neu-border bg-white p-8 text-center">
                        <i class="bi bi-check-circle text-4xl text-green-500"></i>
                        <p class="text-gray-600 mt-4">No transferred thocks found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = entries.map(e => `
                <div class="history-card transferred p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-blue-500 text-white px-2 py-1 text-xs font-bold">TRANSFERRED</span>
                                <span class="text-gray-500 text-sm">${e.transferred_at}</span>
                            </div>
                            <h3 class="text-xl font-bold">Thock #${e.thock_number}</h3>
                            <p class="text-gray-600">
                                Original: ${capitalizeText(e.name)} (${e.phone}) | ${capitalizeText(e.village)}
                            </p>
                            ${e.current_customer ? `
                                <div class="mt-2 p-2 bg-blue-50 border border-blue-300 rounded-lg">
                                    <p class="text-sm text-blue-700">
                                        <i class="bi bi-arrow-right"></i> Now belongs to:
                                        <strong>${capitalizeText(e.current_customer.name)}</strong> (${e.current_customer.phone})
                                    </p>
                                </div>
                            ` : ''}
                        </div>
                        <button onclick="undoTransfer(${e.id}, '${e.name.replace(/'/g, "\\'")}', '${e.phone}', '${e.village.replace(/'/g, "\\'")}', '${(e.so || '').replace(/'/g, "\\'")}')"
                                class="neu-button bg-yellow-500 text-white"
                                title="Note: You need to manually select the original customer">
                            <i class="bi bi-arrow-counterclockwise"></i> Undo
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function undoMerge(customerId) {
            console.log('Undo merge called with customerId:', customerId);

            if (!customerId) {
                alert('Error: Customer ID is missing. Please use the "Merged Customers" tab to undo.');
                return;
            }

            if (!confirm('Are you sure you want to undo this merge? The customer will be restored to active status.\n\nCustomer ID: ' + customerId)) {
                return;
            }

            try {
                const response = await fetch('/api/merge-history/undo-merge', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ customer_id: parseInt(customerId) })
                });

                const text = await response.text();
                console.log('Undo response:', response.status, text);

                if (!response.ok) {
                    throw new Error(text);
                }

                alert('Merge undone successfully!');
                loadHistory(); // Refresh
            } catch (error) {
                alert('Error undoing merge: ' + error.message);
            }
        }

        async function undoTransfer(entryId, originalName, originalPhone, originalVillage, originalSO) {
            // For undo transfer, we need to know the original customer
            // The entry was transferred TO a new customer, so we need to find the original
            const originalCustomerId = prompt('Enter the original customer ID to restore this thock to:');
            if (!originalCustomerId) return;

            if (!confirm(`Are you sure you want to undo this transfer and restore it to customer ID ${originalCustomerId}?`)) {
                return;
            }

            try {
                const response = await fetch('/api/merge-history/undo-transfer', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        entry_id: entryId,
                        original_customer_id: parseInt(originalCustomerId),
                        name: originalName,
                        phone: originalPhone,
                        village: originalVillage,
                        so: originalSO
                    })
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                alert('Transfer undone successfully!');
                loadHistory(); // Refresh
            } catch (error) {
                alert('Error undoing transfer: ' + error.message);
            }
        }

        // Load on page load
        window.addEventListener('load', loadHistory);
    </script>
</body>
</html>
