<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png?v=2">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merge & Transfer History - Cold Storage</title>
    <link rel="stylesheet" href="/static/css/bootstrap-icons.min.css">
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link href="/static/css/arbitrary.css" rel="stylesheet">
    <link href="/static/css/fonts.css" rel="stylesheet">
    <link href="/static/css/dark-mode.css" rel="stylesheet">
    <link href="/static/css/responsive.css" rel="stylesheet">

    <style>
        * { font-family: 'Space Grotesk', sans-serif; }
        .neu-border {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            transition: all 0.2s ease;
        }
        .neu-border:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #000;
        }
        .neu-button {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            padding: 0.5rem 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .neu-button:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #000;
        }
        .history-card {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            margin-bottom: 1rem;
            background: white;
        }
        .merged { border-color: #9333ea; box-shadow: 4px 4px 0 #9333ea; }
        .transferred { border-color: #3b82f6; box-shadow: 4px 4px 0 #3b82f6; }
        @media (max-width: 1023px) and (orientation: portrait) {
            body { font-size: 0.875rem; }
            .neu-border, .history-card {
                border-width: 2px;
                box-shadow: 2px 2px 0 #000;
            }
            .neu-button {
                padding: 0.375rem 0.625rem;
                font-size: 0.75rem;
                border-width: 2px;
                box-shadow: 2px 2px 0 #000;
            }
        }
    </style>
    <script src="/static/js/theme.js"></script>
</head>
<body class="bg-[#FFF9E6] min-h-screen p-2 sm:p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 md:mb-8 neu-border bg-white p-3 md:p-6 gap-3 md:gap-4">
            <div>
                <div class="flex items-center gap-2 md:gap-3">
                    <i class="bi bi-clock-history text-2xl md:text-4xl text-purple-600"></i>
                    <div>
                        <h1 class="text-xl md:text-3xl font-bold">Merge & Transfer History</h1>
                        <p class="text-gray-600 text-xs md:text-base hidden sm:block">View and undo customer merges and thock transfers</p>
                    </div>
                </div>
            </div>
            <div class="flex flex-wrap gap-2">
                <button onclick="theme.toggle()" class="neu-button bg-gray-200 px-2 md:px-3 py-2" title="Toggle Dark Mode">
                    <i class="bi bi-moon-fill theme-icon-moon"></i>
                    <i class="bi bi-sun-fill theme-icon-sun hidden"></i>
                </button>
                <button onclick="window.history.back()" class="neu-button bg-gray-200 px-3 md:px-4 py-2">
                    <i class="bi bi-arrow-left"></i> <span class="hidden sm:inline">Back</span>
                </button>
            </div>
        </header>

        <!-- Summary Cards -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="neu-border bg-gradient-to-br from-purple-400 to-purple-600 text-white p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90">Merged Customers</p>
                        <p class="text-3xl font-bold" id="mergedCount">0</p>
                    </div>
                    <i class="bi bi-people text-4xl opacity-50"></i>
                </div>
            </div>
            <div class="neu-border bg-gradient-to-br from-blue-400 to-blue-600 text-white p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90">Transferred Thocks</p>
                        <p class="text-3xl font-bold" id="transferredCount">0</p>
                    </div>
                    <i class="bi bi-arrow-left-right text-4xl opacity-50"></i>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-2 mb-4">
            <button id="mergedTab" onclick="showTab('merged')" class="neu-button bg-purple-500 text-white">
                <i class="bi bi-people"></i> Merged Customers
            </button>
            <button id="transferredTab" onclick="showTab('transferred')" class="neu-button bg-gray-300">
                <i class="bi bi-arrow-left-right"></i> Transferred Thocks
            </button>
        </div>

        <!-- Merged Customers Section -->
        <div id="mergedSection">
            <div id="mergedContainer">
                <div class="text-center py-12">
                    <i class="bi bi-hourglass-split text-6xl text-gray-400"></i>
                    <p class="text-gray-600 mt-4">Loading merge history...</p>
                </div>
            </div>
        </div>

        <!-- Transferred Thocks Section -->
        <div id="transferredSection" class="hidden">
            <div id="transferredContainer">
                <div class="text-center py-12">
                    <i class="bi bi-hourglass-split text-6xl text-gray-400"></i>
                    <p class="text-gray-600 mt-4">Loading transfer history...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        let historyData = null;

        function capitalizeText(text) {
            if (!text || text.length === 0) return text;
            return text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();
        }

        // Check admin access
        (function() {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                window.location.href = '/login';
                return;
            }
            const user = JSON.parse(userStr);
            if (user.role !== 'admin') {
                alert('Access Denied: Admin access required');
                window.location.href = '/dashboard';
                return;
            }
        })();

        function showTab(tab) {
            if (tab === 'merged') {
                document.getElementById('mergedSection').classList.remove('hidden');
                document.getElementById('transferredSection').classList.add('hidden');
                document.getElementById('mergedTab').classList.remove('bg-gray-300');
                document.getElementById('mergedTab').classList.add('bg-purple-500', 'text-white');
                document.getElementById('transferredTab').classList.remove('bg-blue-500', 'text-white');
                document.getElementById('transferredTab').classList.add('bg-gray-300');
            } else {
                document.getElementById('mergedSection').classList.add('hidden');
                document.getElementById('transferredSection').classList.remove('hidden');
                document.getElementById('transferredTab').classList.remove('bg-gray-300');
                document.getElementById('transferredTab').classList.add('bg-blue-500', 'text-white');
                document.getElementById('mergedTab').classList.remove('bg-purple-500', 'text-white');
                document.getElementById('mergedTab').classList.add('bg-gray-300');
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch('/api/merge-history', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }
                    throw new Error(await response.text());
                }

                historyData = await response.json();

                // Update counts
                document.getElementById('mergedCount').textContent = historyData.merged_customers?.length || 0;
                document.getElementById('transferredCount').textContent = historyData.transferred_entries?.length || 0;

                // Render merged customers
                renderMergedCustomers(historyData.merged_customers || []);

                // Render transferred entries
                renderTransferredEntries(historyData.transferred_entries || []);

            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('mergedContainer').innerHTML = `
                    <div class="neu-border bg-red-50 p-8 text-center">
                        <i class="bi bi-exclamation-triangle text-4xl text-red-500"></i>
                        <p class="text-red-600 mt-4">Error loading history: ${error.message}</p>
                    </div>
                `;
            }
        }

        function renderMergedCustomers(customers) {
            const container = document.getElementById('mergedContainer');

            if (customers.length === 0) {
                container.innerHTML = `
                    <div class="neu-border bg-white p-8 text-center">
                        <i class="bi bi-check-circle text-4xl text-green-500"></i>
                        <p class="text-gray-600 mt-4">No merged customers found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = customers.map(c => `
                <div class="history-card merged p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-purple-500 text-white px-2 py-1 text-xs font-bold">MERGED</span>
                                <span class="text-gray-500 text-sm">${c.merged_at}</span>
                            </div>
                            <h3 class="text-xl font-bold">${capitalizeText(c.name)}</h3>
                            <p class="text-gray-600">
                                <i class="bi bi-telephone"></i> ${c.phone}
                                ${c.so ? ` | S/O: ${capitalizeText(c.so)}` : ''}
                                | ${capitalizeText(c.village)}
                            </p>
                            ${c.target_customer ? `
                                <div class="mt-2 p-2 bg-green-50 border-2 border-green-300">
                                    <p class="text-sm text-green-700">
                                        <i class="bi bi-arrow-right"></i> Merged into:
                                        <strong>${capitalizeText(c.target_customer.name)}</strong> (${c.target_customer.phone})
                                    </p>
                                </div>
                            ` : ''}
                        </div>
                        <button onclick="undoMerge(${c.id})" class="neu-button bg-yellow-500 text-white">
                            <i class="bi bi-arrow-counterclockwise"></i> Undo
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderTransferredEntries(entries) {
            const container = document.getElementById('transferredContainer');

            if (entries.length === 0) {
                container.innerHTML = `
                    <div class="neu-border bg-white p-8 text-center">
                        <i class="bi bi-check-circle text-4xl text-green-500"></i>
                        <p class="text-gray-600 mt-4">No transferred thocks found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = entries.map(e => `
                <div class="history-card transferred p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-blue-500 text-white px-2 py-1 text-xs font-bold">TRANSFERRED</span>
                                <span class="text-gray-500 text-sm">${e.transferred_at}</span>
                            </div>
                            <h3 class="text-xl font-bold">Thock #${e.thock_number}</h3>
                            <p class="text-gray-600">
                                Original: ${capitalizeText(e.name)} (${e.phone}) | ${capitalizeText(e.village)}
                            </p>
                            ${e.current_customer ? `
                                <div class="mt-2 p-2 bg-blue-50 border-2 border-blue-300">
                                    <p class="text-sm text-blue-700">
                                        <i class="bi bi-arrow-right"></i> Now belongs to:
                                        <strong>${capitalizeText(e.current_customer.name)}</strong> (${e.current_customer.phone})
                                    </p>
                                </div>
                            ` : ''}
                        </div>
                        <button onclick="undoTransfer(${e.id}, '${e.name.replace(/'/g, "\\'")}', '${e.phone}', '${e.village.replace(/'/g, "\\'")}', '${(e.so || '').replace(/'/g, "\\'")}')"
                                class="neu-button bg-yellow-500 text-white"
                                title="Note: You need to manually select the original customer">
                            <i class="bi bi-arrow-counterclockwise"></i> Undo
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function undoMerge(customerId) {
            if (!confirm('Are you sure you want to undo this merge? The customer will be restored to active status.')) {
                return;
            }

            try {
                const response = await fetch('/api/merge-history/undo-merge', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ customer_id: customerId })
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                alert('Merge undone successfully!');
                loadHistory(); // Refresh
            } catch (error) {
                alert('Error undoing merge: ' + error.message);
            }
        }

        async function undoTransfer(entryId, originalName, originalPhone, originalVillage, originalSO) {
            // For undo transfer, we need to know the original customer
            // The entry was transferred TO a new customer, so we need to find the original
            const originalCustomerId = prompt('Enter the original customer ID to restore this thock to:');
            if (!originalCustomerId) return;

            if (!confirm(`Are you sure you want to undo this transfer and restore it to customer ID ${originalCustomerId}?`)) {
                return;
            }

            try {
                const response = await fetch('/api/merge-history/undo-transfer', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        entry_id: entryId,
                        original_customer_id: parseInt(originalCustomerId),
                        name: originalName,
                        phone: originalPhone,
                        village: originalVillage,
                        so: originalSO
                    })
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                alert('Transfer undone successfully!');
                loadHistory(); // Refresh
            } catch (error) {
                alert('Error undoing transfer: ' + error.message);
            }
        }

        // Load on page load
        window.addEventListener('load', loadHistory);
    </script>
</body>
</html>
