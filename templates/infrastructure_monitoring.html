<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infrastructure Monitoring - Cold Storage</title>
    <link rel="stylesheet" href="/static/css/bootstrap-icons.min.css">
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link href="/static/css/arbitrary.css" rel="stylesheet">
    <link href="/static/css/fonts.css" rel="stylesheet">
    <style>
        * { font-family: 'Space Grotesk', sans-serif; }
        .status-healthy { background: #10b981; }
        .status-warning { background: #f59e0b; }
        .status-critical { background: #ef4444; }
        .status-unknown { background: #6b7280; }
        .neu-border {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
        }
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="neu-border bg-white p-4 md:p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-2xl md:text-4xl font-bold flex items-center gap-3">
                        <i class="bi bi-hdd-network"></i>
                        Infrastructure Monitoring
                    </h1>
                    <p class="text-gray-600 text-sm md:text-base">Cold Storage HA Cluster Status & Failover Control</p>
                </div>
                <div class="text-left md:text-right w-full md:w-auto">
                    <div class="text-sm text-gray-600">Last Update</div>
                    <div id="lastUpdate" class="text-lg font-bold">--:--:--</div>
                    <button onclick="refreshAll()" class="mt-2 neu-border bg-blue-500 text-white px-4 py-2 text-sm">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Overall System Status -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="neu-border bg-white p-4">
                <div class="text-sm text-gray-600 mb-2">K3s Cluster</div>
                <div id="k3sStatus" class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full status-unknown pulse"></div>
                    <span class="font-bold">Checking...</span>
                </div>
            </div>
            <div class="neu-border bg-white p-4">
                <div class="text-sm text-gray-600 mb-2">PostgreSQL HA</div>
                <div id="pgStatus" class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full status-unknown pulse"></div>
                    <span class="font-bold">Checking...</span>
                </div>
            </div>
            <div class="neu-border bg-white p-4">
                <div class="text-sm text-gray-600 mb-2">VIP (192.168.15.200)</div>
                <div id="vipStatus" class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full status-unknown pulse"></div>
                    <span class="font-bold">Checking...</span>
                </div>
            </div>
            <div class="neu-border bg-white p-4">
                <div class="text-sm text-gray-600 mb-2">Backup Server</div>
                <div id="backupStatus" class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full status-unknown pulse"></div>
                    <span class="font-bold">Checking...</span>
                </div>
            </div>
        </div>

        <!-- PostgreSQL Cluster Detail -->
        <div class="neu-border bg-white p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">
                <i class="bi bi-database"></i> PostgreSQL Cluster
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="font-bold mb-2">Primary Node</h3>
                    <div id="primaryNode" class="text-sm"></div>
                </div>
                <div>
                    <h3 class="font-bold mb-2">Replica Nodes</h3>
                    <div id="replicaNodes" class="text-sm"></div>
                </div>
            </div>
            <div class="mt-4">
                <h3 class="font-bold mb-2">Connection String</h3>
                <code class="bg-gray-100 p-2 block text-sm">postgresql://postgres:***@192.168.15.200:5432/cold_db</code>
            </div>
        </div>

        <!-- PostgreSQL Database Pods -->
        <div class="neu-border bg-white p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                <h2 class="text-xl md:text-2xl font-bold">
                    <i class="bi bi-database-gear"></i> PostgreSQL Database Pods
                </h2>
                <div class="flex flex-wrap gap-2">
                    <button onclick="checkRecoveryStatus()" class="neu-border bg-blue-100 text-blue-800 px-3 py-2 text-sm">
                        <i class="bi bi-info-circle"></i> Check Status
                    </button>
                    <button onclick="recoverStuckPods(true)" class="neu-border bg-yellow-100 text-yellow-800 px-3 py-2 text-sm">
                        <i class="bi bi-search"></i> Detect Stuck
                    </button>
                    <button onclick="recoverStuckPods(false)" class="neu-border bg-red-100 text-red-800 px-3 py-2 text-sm">
                        <i class="bi bi-arrow-repeat"></i> Recover Stuck
                    </button>
                </div>
            </div>
            <div id="recoveryAlert" class="hidden neu-border bg-yellow-50 p-3 mb-4 text-sm">
                <div class="flex items-center gap-2">
                    <i class="bi bi-exclamation-triangle text-yellow-600"></i>
                    <span id="recoveryAlertText"></span>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-gray-100 border-b-2 border-black">
                            <th class="px-4 py-2 text-left font-bold">Pod Name</th>
                            <th class="px-4 py-2 text-left font-bold">Role</th>
                            <th class="px-4 py-2 text-left font-bold">Status</th>
                            <th class="px-4 py-2 text-left font-bold">Node</th>
                            <th class="px-4 py-2 text-left font-bold">DB Size</th>
                            <th class="px-4 py-2 text-left font-bold">Connections</th>
                            <th class="px-4 py-2 text-left font-bold">Repl. Lag</th>
                            <th class="px-4 py-2 text-left font-bold">Cache Hit</th>
                        </tr>
                    </thead>
                    <tbody id="pgPodsList">
                        <tr>
                            <td colspan="8" class="text-center py-4 text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- K3s Node Metrics Graphs -->
        <div class="neu-border bg-white p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">
                <i class="bi bi-graph-up"></i> K3s Node Metrics
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="neu-border bg-gray-50 p-4">
                    <h3 class="font-bold mb-3 text-center text-gray-700">
                        <i class="bi bi-cpu text-blue-500"></i> CPU Usage (%)
                    </h3>
                    <div style="height: 280px;">
                        <canvas id="nodeCpuChart"></canvas>
                    </div>
                </div>
                <div class="neu-border bg-gray-50 p-4">
                    <h3 class="font-bold mb-3 text-center text-gray-700">
                        <i class="bi bi-memory text-green-500"></i> Memory Usage (%)
                    </h3>
                    <div style="height: 280px;">
                        <canvas id="nodeMemoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- PostgreSQL Metrics Graphs -->
        <div class="neu-border bg-white p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">
                <i class="bi bi-bar-chart-line"></i> PostgreSQL Metrics
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="neu-border bg-gray-50 p-4">
                    <h3 class="font-bold mb-3 text-center text-gray-700">
                        <i class="bi bi-plug text-purple-500"></i> Connections
                    </h3>
                    <div style="height: 250px;">
                        <canvas id="pgConnectionsChart"></canvas>
                    </div>
                </div>
                <div class="neu-border bg-gray-50 p-4">
                    <h3 class="font-bold mb-3 text-center text-gray-700">
                        <i class="bi bi-lightning text-yellow-500"></i> Cache Hit Ratio (%)
                    </h3>
                    <div style="height: 250px;">
                        <canvas id="pgCacheHitChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                <div class="neu-border bg-gray-50 p-4">
                    <h3 class="font-bold mb-3 text-center text-gray-700">
                        <i class="bi bi-hdd text-red-500"></i> DB Size (MB)
                    </h3>
                    <div style="height: 250px;">
                        <canvas id="pgDbSizeChart"></canvas>
                    </div>
                </div>
                <div class="neu-border bg-gray-50 p-4">
                    <h3 class="font-bold mb-3 text-center text-gray-700">
                        <i class="bi bi-arrow-repeat text-orange-500"></i> Replication Lag
                    </h3>
                    <div style="height: 250px;">
                        <canvas id="pgReplLagChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Backend Pods Status -->
        <div class="neu-border bg-white p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">
                <i class="bi bi-server"></i> Backend Pods
            </h2>
            <div id="backendPods" class="space-y-2"></div>
        </div>

        <!-- Backup Server Health & Capacity (192.168.15.195) -->
        <div class="neu-border bg-white p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">
                <i class="bi bi-server"></i> Backup Server Health (192.168.15.195)
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div class="neu-border bg-blue-50 p-4">
                    <div class="text-sm text-gray-600 mb-1">CPU Usage</div>
                    <div id="cpuUsage" class="text-2xl font-bold">--</div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                        <div id="cpuBar" class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                <div class="neu-border bg-green-50 p-4">
                    <div class="text-sm text-gray-600 mb-1">Memory Usage</div>
                    <div id="memUsage" class="text-2xl font-bold">--</div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                        <div id="memBar" class="bg-green-500 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                <div class="neu-border bg-purple-50 p-4">
                    <div class="text-sm text-gray-600 mb-1">Root Disk</div>
                    <div id="rootDisk" class="text-2xl font-bold">--</div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                        <div id="rootBar" class="bg-purple-500 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                <div class="neu-border bg-yellow-50 p-4">
                    <div class="text-sm text-gray-600 mb-1">27TB NAS</div>
                    <div id="nasDisk" class="text-2xl font-bold">--</div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                        <div id="nasBar" class="bg-yellow-500 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Storage Details -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="neu-border bg-gray-50 p-3">
                    <div class="font-bold mb-2">Local Backup Storage</div>
                    <div class="text-sm space-y-1">
                        <div class="flex justify-between">
                            <span>Total:</span>
                            <span id="localTotal" class="font-mono">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Used:</span>
                            <span id="localUsed" class="font-mono">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Free:</span>
                            <span id="localFree" class="font-mono text-green-600">--</span>
                        </div>
                    </div>
                </div>
                <div class="neu-border bg-gray-50 p-3">
                    <div class="font-bold mb-2">NAS Backup Storage</div>
                    <div class="text-sm space-y-1">
                        <div class="flex justify-between">
                            <span>Total:</span>
                            <span id="nasTotal" class="font-mono">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Used:</span>
                            <span id="nasUsed" class="font-mono">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Free:</span>
                            <span id="nasFree" class="font-mono text-green-600">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Backup Status & Controls -->
        <div class="neu-border bg-white p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">
                <i class="bi bi-archive"></i> Backup Status & Controls
            </h2>

            <!-- Current Status -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="neu-border bg-gray-50 p-3">
                    <div class="text-sm text-gray-600">Last Local Backup</div>
                    <div id="lastBackup" class="text-lg font-bold">--</div>
                </div>
                <div class="neu-border bg-gray-50 p-3">
                    <div class="text-sm text-gray-600">Last NAS Archive</div>
                    <div id="lastNasBackup" class="text-lg font-bold">--</div>
                </div>
                <div class="neu-border bg-gray-50 p-3">
                    <div class="text-sm text-gray-600">Total Backups</div>
                    <div id="totalBackups" class="text-lg font-bold">--</div>
                </div>
                <div class="neu-border bg-gray-50 p-3">
                    <div class="text-sm text-gray-600">Replica Status</div>
                    <div id="replicaStatus" class="text-lg font-bold">--</div>
                </div>
            </div>

            <!-- NAS Archive Monitoring -->
            <div class="neu-border bg-blue-50 p-4 mb-4">
                <h3 class="font-bold mb-3">
                    <i class="bi bi-hdd-network"></i> 27TB NAS Archive (/mnt/192.168.15.52/mine)
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <div class="text-sm text-gray-600">Archive Size</div>
                        <div id="nasArchiveSize" class="text-xl font-bold">--</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600">Total Snapshots</div>
                        <div id="nasSnapshots" class="text-xl font-bold">--</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600">Oldest Snapshot</div>
                        <div id="nasOldest" class="text-xl font-bold">--</div>
                    </div>
                </div>
            </div>

            <!-- Backup Controls -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Manual Backup -->
                <div class="neu-border bg-green-50 p-4">
                    <h3 class="font-bold mb-2">
                        <i class="bi bi-play-circle"></i> Manual Backup
                    </h3>
                    <p class="text-sm text-gray-600 mb-3">Trigger immediate backup to 27TB NAS</p>
                    <button onclick="triggerManualBackup()" class="neu-border bg-green-500 text-white px-6 py-3 w-full">
                        <i class="bi bi-cloud-upload"></i> Backup Now to NAS
                    </button>
                    <div id="backupProgress" class="mt-2 text-sm text-center hidden">
                        <i class="bi bi-hourglass-split"></i> Backing up...
                    </div>
                </div>

                <!-- Auto Backup Timer -->
                <div class="neu-border bg-purple-50 p-4">
                    <h3 class="font-bold mb-2">
                        <i class="bi bi-clock-history"></i> Auto Backup Schedule
                    </h3>
                    <p class="text-sm text-gray-600 mb-3">Set automatic backup frequency to NAS</p>
                    <select id="backupFrequency" onchange="updateBackupSchedule()" class="neu-border w-full px-4 py-3 bg-white">
                        <option value="disabled">Disabled</option>
                        <option value="15min">Every 15 Minutes</option>
                        <option value="30min">Every 30 Minutes</option>
                        <option value="1hour" selected>Every Hour (Default)</option>
                        <option value="3hours">Every 3 Hours</option>
                        <option value="6hours">Every 6 Hours</option>
                        <option value="12hours">Every 12 Hours</option>
                        <option value="daily">Daily at Midnight</option>
                    </select>
                    <div id="scheduleStatus" class="mt-2 text-sm text-center text-gray-600">
                        Current: Every Hour
                    </div>
                </div>
            </div>
        </div>

        <!-- Manual Failover Controls -->
        <div class="neu-border bg-red-100 p-6">
            <h2 class="text-2xl font-bold mb-4 text-red-700">
                <i class="bi bi-exclamation-triangle"></i> Manual Failover Controls
            </h2>
            <p class="mb-4 text-sm">Use these controls only when the HA cluster is not responding</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="neu-border bg-white p-4">
                    <h3 class="font-bold mb-2">Start Standby Backend</h3>
                    <p class="text-sm text-gray-600 mb-3">Activates backup server on 192.168.15.195</p>
                    <button onclick="startStandbyBackend()" class="neu-border bg-orange-500 text-white px-4 py-2 w-full">
                        <i class="bi bi-play-circle"></i> Activate Standby
                    </button>
                </div>

                <div class="neu-border bg-white p-4">
                    <h3 class="font-bold mb-2">Restore from Backup</h3>
                    <p class="text-sm text-gray-600 mb-3">Restore database from latest backup</p>
                    <button onclick="restoreFromBackup()" class="neu-border bg-red-600 text-white px-4 py-2 w-full">
                        <i class="bi bi-arrow-counterclockwise"></i> Restore Database
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/chart.umd.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        if (!token) {
            console.error('No auth token found in localStorage');
            alert('Session expired. Please log in again.');
            window.location.href = '/login';
        }
        console.log('Token found, length:', token ? token.length : 0);

        // Chart instances
        let nodeCpuChart = null;
        let nodeMemoryChart = null;
        let pgConnectionsChart = null;
        let pgCacheHitChart = null;
        let pgDbSizeChart = null;
        let pgReplLagChart = null;

        // Chart colors
        const chartColors = [
            'rgba(59, 130, 246, 0.8)',   // blue
            'rgba(16, 185, 129, 0.8)',   // green
            'rgba(245, 158, 11, 0.8)',   // yellow
            'rgba(139, 92, 246, 0.8)',   // purple
            'rgba(239, 68, 68, 0.8)',    // red
        ];

        // Initialize charts
        function initCharts() {
            // Optimized chart colors - gradient-like
            const nodeColors = ['#3b82f6', '#10b981', '#8b5cf6', '#f59e0b', '#ef4444', '#06b6d4'];
            const pgColors = ['#6366f1', '#22c55e', '#f97316', '#ec4899'];

            // Common options for all charts
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 500 },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 13 },
                        padding: 12,
                        cornerRadius: 8
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { font: { size: 11, weight: '600' } }
                    },
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: { font: { size: 11 } }
                    }
                }
            };

            // Node CPU Chart
            nodeCpuChart = new Chart(document.getElementById('nodeCpuChart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CPU %',
                        data: [],
                        backgroundColor: nodeColors,
                        borderColor: nodeColors.map(c => c),
                        borderWidth: 2,
                        borderRadius: 6,
                        barThickness: 40
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: { ...commonOptions.scales.y, max: 100, ticks: { callback: v => v + '%' } }
                    },
                    plugins: {
                        ...commonOptions.plugins,
                        tooltip: {
                            ...commonOptions.plugins.tooltip,
                            callbacks: { label: ctx => `CPU: ${ctx.raw.toFixed(1)}%` }
                        }
                    }
                }
            });

            // Node Memory Chart
            nodeMemoryChart = new Chart(document.getElementById('nodeMemoryChart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Memory %',
                        data: [],
                        backgroundColor: nodeColors.map(c => c.replace(')', ', 0.8)').replace('rgb', 'rgba').replace('#', '')),
                        borderColor: nodeColors,
                        borderWidth: 2,
                        borderRadius: 6,
                        barThickness: 40
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: { ...commonOptions.scales.y, max: 100, ticks: { callback: v => v + '%' } }
                    },
                    plugins: {
                        ...commonOptions.plugins,
                        tooltip: {
                            ...commonOptions.plugins.tooltip,
                            callbacks: { label: ctx => `Memory: ${ctx.raw.toFixed(1)}%` }
                        }
                    }
                }
            });

            // PostgreSQL Connections Chart
            pgConnectionsChart = new Chart(document.getElementById('pgConnectionsChart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Connections',
                        data: [],
                        backgroundColor: pgColors,
                        borderRadius: 6,
                        barThickness: 35
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        tooltip: {
                            ...commonOptions.plugins.tooltip,
                            callbacks: { label: ctx => `Connections: ${ctx.raw}` }
                        }
                    }
                }
            });

            // PostgreSQL Cache Hit Chart
            pgCacheHitChart = new Chart(document.getElementById('pgCacheHitChart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Cache Hit %',
                        data: [],
                        backgroundColor: ['#22c55e', '#22c55e', '#22c55e', '#22c55e'],
                        borderRadius: 6,
                        barThickness: 35
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: { ...commonOptions.scales.y, min: 90, max: 100, ticks: { callback: v => v + '%' } }
                    },
                    plugins: {
                        ...commonOptions.plugins,
                        tooltip: {
                            ...commonOptions.plugins.tooltip,
                            callbacks: { label: ctx => `Cache Hit: ${ctx.raw.toFixed(1)}%` }
                        }
                    }
                }
            });

            // PostgreSQL DB Size Chart
            pgDbSizeChart = new Chart(document.getElementById('pgDbSizeChart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Size (MB)',
                        data: [],
                        backgroundColor: ['#8b5cf6', '#a78bfa', '#c4b5fd', '#ddd6fe'],
                        borderRadius: 6,
                        barThickness: 35
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        tooltip: {
                            ...commonOptions.plugins.tooltip,
                            callbacks: { label: ctx => `Size: ${ctx.raw.toFixed(2)} MB` }
                        }
                    }
                }
            });

            // PostgreSQL Replication Lag Chart
            pgReplLagChart = new Chart(document.getElementById('pgReplLagChart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Lag',
                        data: [],
                        backgroundColor: ctx => {
                            const value = ctx.raw || 0;
                            if (value === 0) return '#22c55e';
                            if (value < 1024) return '#f59e0b';
                            return '#ef4444';
                        },
                        borderRadius: 6,
                        barThickness: 35
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        tooltip: {
                            ...commonOptions.plugins.tooltip,
                            callbacks: {
                                label: ctx => {
                                    const bytes = ctx.raw;
                                    if (bytes === 0) return 'Lag: 0 (In Sync)';
                                    if (bytes < 1024) return `Lag: ${bytes} B`;
                                    if (bytes < 1024 * 1024) return `Lag: ${(bytes/1024).toFixed(1)} KB`;
                                    return `Lag: ${(bytes/1024/1024).toFixed(1)} MB`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update K3s Node Charts
        async function updateNodeCharts() {
            const nodeColors = ['#3b82f6', '#10b981', '#8b5cf6', '#f59e0b', '#ef4444', '#06b6d4'];
            try {
                const response = await fetch('/api/monitoring/nodes', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.nodes && data.nodes.length > 0) {
                    // Sort: k3s nodes first, then backup server
                    const sortedNodes = data.nodes.sort((a, b) => {
                        if (a.node_name.startsWith('k3s-') && !b.node_name.startsWith('k3s-')) return -1;
                        if (!a.node_name.startsWith('k3s-') && b.node_name.startsWith('k3s-')) return 1;
                        return a.node_name.localeCompare(b.node_name);
                    });

                    const labels = sortedNodes.map(n => n.node_name.replace('k3s-', '').replace('backup-server', 'backup'));
                    const cpuData = sortedNodes.map(n => n.cpu_percent || 0);
                    const memData = sortedNodes.map(n => n.memory_percent || 0);

                    // Color based on value for CPU
                    const cpuColors = cpuData.map(v => {
                        if (v < 50) return '#22c55e';  // green
                        if (v < 75) return '#f59e0b';  // yellow
                        return '#ef4444';              // red
                    });

                    // Color based on value for Memory
                    const memColors = memData.map(v => {
                        if (v < 60) return '#3b82f6';  // blue
                        if (v < 80) return '#f59e0b';  // yellow
                        return '#ef4444';              // red
                    });

                    nodeCpuChart.data.labels = labels;
                    nodeCpuChart.data.datasets[0].data = cpuData;
                    nodeCpuChart.data.datasets[0].backgroundColor = cpuColors;
                    nodeCpuChart.update('none');  // No animation for smoother updates

                    nodeMemoryChart.data.labels = labels;
                    nodeMemoryChart.data.datasets[0].data = memData;
                    nodeMemoryChart.data.datasets[0].backgroundColor = memColors;
                    nodeMemoryChart.update('none');
                }
            } catch (error) {
                console.error('Failed to update node charts:', error);
            }
        }

        // Update PostgreSQL Charts from pods data
        function updatePgCharts(pods) {
            if (!pods || pods.length === 0) return;

            const pgColors = ['#6366f1', '#22c55e', '#f97316', '#ec4899', '#8b5cf6'];
            const labels = pods.map(p => {
                if (p.name.includes('streaming-replica')) return 'ext-195';
                return p.name.replace('cold-postgres-', 'pg-');
            });

            // Connections - color by role
            const connData = pods.map(p => parseInt(p.connections) || 0);
            const connColors = pods.map(p => {
                if (p.role === 'Primary') return '#3b82f6';      // blue for primary
                if (p.role === 'Metrics DB') return '#8b5cf6';   // purple for metrics
                return '#22c55e';                                 // green for replicas
            });
            pgConnectionsChart.data.labels = labels;
            pgConnectionsChart.data.datasets[0].data = connData;
            pgConnectionsChart.data.datasets[0].backgroundColor = connColors;
            pgConnectionsChart.update('none');

            // Cache Hit - color by performance
            const cacheData = pods.map(p => parseFloat(p.cache_hit) || 0);
            const cacheColors = cacheData.map(v => {
                if (v >= 99) return '#22c55e';   // green - excellent
                if (v >= 95) return '#84cc16';   // lime - good
                if (v >= 90) return '#f59e0b';   // yellow - warning
                return '#ef4444';                 // red - bad
            });
            pgCacheHitChart.data.labels = labels;
            pgCacheHitChart.data.datasets[0].data = cacheData;
            pgCacheHitChart.data.datasets[0].backgroundColor = cacheColors;
            pgCacheHitChart.update('none');

            // DB Size (convert to MB) - gradient purple
            const sizeData = pods.map(p => {
                const size = p.disk_used || '0';
                if (size.includes('MB')) return parseFloat(size);
                if (size.includes('kB')) return parseFloat(size) / 1024;
                if (size.includes('GB')) return parseFloat(size) * 1024;
                return parseFloat(size) / (1024 * 1024) || 0;
            });
            const sizeColors = ['#8b5cf6', '#a78bfa', '#c4b5fd', '#ddd6fe', '#ede9fe'];
            pgDbSizeChart.data.labels = labels;
            pgDbSizeChart.data.datasets[0].data = sizeData;
            pgDbSizeChart.data.datasets[0].backgroundColor = labels.map((_, i) => sizeColors[i % sizeColors.length]);
            pgDbSizeChart.update('none');

            // Replication Lag - color by lag severity
            const lagData = pods.map(p => {
                if (p.role === 'Primary' || p.repl_lag === 'N/A') return 0;
                const lag = p.repl_lag || '0';
                if (lag.includes('KB')) return parseFloat(lag) * 1024;
                if (lag.includes('MB')) return parseFloat(lag) * 1024 * 1024;
                if (lag.includes('B')) return parseFloat(lag);
                return parseFloat(lag) || 0;
            });
            const lagColors = lagData.map(v => {
                if (v === 0) return '#22c55e';       // green - in sync
                if (v < 1024) return '#84cc16';      // lime - minimal lag
                if (v < 10240) return '#f59e0b';    // yellow - some lag
                return '#ef4444';                    // red - significant lag
            });
            pgReplLagChart.data.labels = labels;
            pgReplLagChart.data.datasets[0].data = lagData;
            pgReplLagChart.data.datasets[0].backgroundColor = lagColors;
            pgReplLagChart.update('none');
        }

        // Initialize charts on page load
        initCharts();

        async function checkK3sCluster() {
            try {
                const response = await fetch('/api/infrastructure/k3s-status', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                updateStatus('k3sStatus', data.healthy ? 'healthy' : 'critical', data.message);
            } catch (error) {
                updateStatus('k3sStatus', 'critical', 'Unable to reach cluster');
            }
        }

        async function checkPostgreSQL() {
            try {
                const response = await fetch('/api/infrastructure/postgresql-status', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                updateStatus('pgStatus', data.healthy ? 'healthy' : 'critical', data.message);
                document.getElementById('primaryNode').textContent = data.primary || 'Unknown';
                document.getElementById('replicaNodes').textContent = data.replicas ? data.replicas.join(', ') : 'None';
            } catch (error) {
                updateStatus('pgStatus', 'critical', 'Connection failed');
            }
        }

        async function checkVIP() {
            try {
                const response = await fetch('/api/infrastructure/vip-status', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                updateStatus('vipStatus', data.healthy ? 'healthy' : 'warning', data.message);
            } catch (error) {
                updateStatus('vipStatus', 'critical', 'VIP unreachable');
            }
        }

        async function checkBackupServer() {
            try {
                const response = await fetch('/api/infrastructure/backup-status', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                console.log('Backup server data:', data);
                updateStatus('backupStatus', data.healthy ? 'healthy' : 'warning', 'Online');

                // Backup info
                document.getElementById('lastBackup').textContent = data.last_backup || 'Never';
                document.getElementById('totalBackups').textContent = data.total_backups || '0';
                // backupSize element removed from UI
                document.getElementById('replicaStatus').textContent = data.replica_running ? '✅ Running' : '⚠️ Stopped';

                // NAS Archive monitoring
                document.getElementById('lastNasBackup').textContent = data.nas_last_backup || 'Never';
                document.getElementById('nasArchiveSize').textContent = data.nas_archive_size || '0 MB';
                document.getElementById('nasSnapshots').textContent = data.nas_snapshots || '0';
                document.getElementById('nasOldest').textContent = data.nas_oldest || 'N/A';

                // Load current backup schedule
                if (data.backup_schedule) {
                    document.getElementById('backupFrequency').value = data.backup_schedule;
                    const scheduleText = document.getElementById('backupFrequency').selectedOptions[0].text;
                    document.getElementById('scheduleStatus').textContent = 'Current: ' + scheduleText;
                }

                // CPU & Memory
                const cpuPercent = data.cpu_percent || 0;
                const memPercent = data.memory_percent || 0;
                document.getElementById('cpuUsage').textContent = cpuPercent.toFixed(1) + '%';
                document.getElementById('cpuBar').style.width = cpuPercent + '%';
                document.getElementById('cpuBar').className = 'h-2 rounded-full ' + (cpuPercent > 80 ? 'bg-red-500' : cpuPercent > 60 ? 'bg-yellow-500' : 'bg-blue-500');

                document.getElementById('memUsage').textContent = memPercent.toFixed(1) + '%';
                document.getElementById('memBar').style.width = memPercent + '%';
                document.getElementById('memBar').className = 'h-2 rounded-full ' + (memPercent > 80 ? 'bg-red-500' : memPercent > 60 ? 'bg-yellow-500' : 'bg-green-500');

                // Disk usage
                if (data.disk_root) {
                    document.getElementById('rootDisk').textContent = data.disk_root.percent + '%';
                    document.getElementById('rootBar').style.width = data.disk_root.percent + '%';
                    document.getElementById('rootBar').className = 'h-2 rounded-full ' + (data.disk_root.percent > 80 ? 'bg-red-500' : 'bg-purple-500');
                    document.getElementById('localTotal').textContent = data.disk_root.total;
                    document.getElementById('localUsed').textContent = data.disk_root.used;
                    document.getElementById('localFree').textContent = data.disk_root.free;
                }

                if (data.disk_nas) {
                    document.getElementById('nasDisk').textContent = data.disk_nas.percent + '%';
                    document.getElementById('nasBar').style.width = data.disk_nas.percent + '%';
                    document.getElementById('nasBar').className = 'h-2 rounded-full ' + (data.disk_nas.percent > 80 ? 'bg-red-500' : 'bg-yellow-500');
                    document.getElementById('nasTotal').textContent = data.disk_nas.total;
                    document.getElementById('nasUsed').textContent = data.disk_nas.used;
                    document.getElementById('nasFree').textContent = data.disk_nas.free;
                }
            } catch (error) {
                console.error('Backup server check failed:', error);
                updateStatus('backupStatus', 'warning', 'Error: ' + error.message);
            }
        }

        async function checkBackendPods() {
            try {
                const response = await fetch('/api/infrastructure/backend-pods', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                const container = document.getElementById('backendPods');
                container.innerHTML = data.pods.map(pod => `
                    <div class="flex items-center justify-between p-2 bg-gray-50 neu-border">
                        <span class="font-mono text-sm">${pod.name}</span>
                        <div class="flex items-center gap-2">
                            <span class="text-sm">${pod.ready}</span>
                            <div class="w-3 h-3 rounded-full status-${pod.status === 'Running' ? 'healthy' : 'warning'}"></div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('backendPods').innerHTML = '<div class="text-red-500">Error loading pods</div>';
            }
        }

        async function checkPostgreSQLPods() {
            try {
                const response = await fetch('/api/infrastructure/postgresql-pods', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                const tbody = document.getElementById('pgPodsList');

                if (data.pods && data.pods.length > 0) {
                    tbody.innerHTML = data.pods.map(pod => {
                        const isExternal = pod.is_external || false;
                        const rowClass = isExternal ? 'border-b border-gray-200 hover:bg-purple-50 bg-purple-50' : 'border-b border-gray-200 hover:bg-gray-50';
                        const roleClass = pod.role === 'Primary' ? 'bg-blue-100 text-blue-800' :
                                         pod.role === 'Metrics DB' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800';
                        const cacheHit = pod.cache_hit || 'N/A';
                        const connections = pod.connections || 'N/A';
                        const maxConn = pod.max_conn || 200;
                        const connDisplay = connections !== 'N/A' ? `${connections} / ${maxConn}` : 'N/A';

                        return `
                        <tr class="${rowClass}">
                            <td class="px-4 py-3 font-mono text-xs">${pod.name}</td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 rounded text-xs font-bold ${roleClass}">
                                    ${pod.role}
                                </span>
                            </td>
                            <td class="px-4 py-3">
                                <div class="flex items-center gap-2">
                                    <div class="w-2 h-2 rounded-full ${pod.status === 'Running' ? 'bg-green-500' : 'bg-red-500'}"></div>
                                    <span class="text-xs">${pod.status}</span>
                                </div>
                            </td>
                            <td class="px-4 py-3 text-xs">${pod.node}</td>
                            <td class="px-4 py-3 font-mono text-xs">${pod.disk_used}</td>
                            <td class="px-4 py-3 font-mono text-xs">${connDisplay}</td>
                            <td class="px-4 py-3 font-mono text-xs ${pod.repl_lag !== 'N/A' && pod.repl_lag !== 'N/A' ? 'text-orange-600' : 'text-gray-400'}">${pod.repl_lag}</td>
                            <td class="px-4 py-3 font-mono text-xs ${cacheHit !== 'N/A' ? 'text-green-600' : 'text-gray-400'}">${cacheHit}</td>
                        </tr>
                    `}).join('');

                    // Update PostgreSQL charts with pod data
                    updatePgCharts(data.pods);
                } else {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-gray-500">No pods found</td></tr>';
                }
            } catch (error) {
                document.getElementById('pgPodsList').innerHTML = '<tr><td colspan="8" class="text-center py-4 text-red-500">Error loading PostgreSQL pods</td></tr>';
                console.error('PostgreSQL pods check failed:', error);
            }
        }

        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            const dot = element.querySelector('div');
            const text = element.querySelector('span');

            dot.className = `w-4 h-4 rounded-full status-${status}`;
            text.textContent = message;
        }

        async function triggerManualBackup() {
            if (!confirm('This will trigger an immediate backup to the 27TB NAS. Continue?')) return;

            const progressEl = document.getElementById('backupProgress');
            progressEl.classList.remove('hidden');

            try {
                const response = await fetch('/api/infrastructure/trigger-backup', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                progressEl.classList.add('hidden');
                alert(data.message || 'Backup completed successfully!');

                // Refresh backup status
                checkBackupServer();
            } catch (error) {
                progressEl.classList.add('hidden');
                alert('Failed to trigger backup: ' + error.message);
            }
        }

        async function updateBackupSchedule() {
            const frequency = document.getElementById('backupFrequency').value;
            const scheduleText = document.getElementById('backupFrequency').selectedOptions[0].text;

            if (!confirm(`Set backup schedule to: ${scheduleText}?`)) {
                // Reload current schedule
                checkBackupServer();
                return;
            }

            try {
                const response = await fetch('/api/infrastructure/backup-schedule', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ schedule: frequency })
                });
                const data = await response.json();

                document.getElementById('scheduleStatus').textContent = 'Current: ' + scheduleText;
                alert(data.message || 'Backup schedule updated!');
            } catch (error) {
                alert('Failed to update schedule: ' + error.message);
                checkBackupServer(); // Reload current schedule
            }
        }

        async function startStandbyBackend() {
            if (!confirm('This will start the standby backend server on 192.168.15.195. Continue?')) return;

            try {
                const response = await fetch('/api/infrastructure/start-standby', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                alert(data.message);
            } catch (error) {
                alert('Failed to start standby backend: ' + error.message);
            }
        }

        async function restoreFromBackup() {
            if (!confirm('WARNING: This will restore the database from the latest backup. All current data will be replaced. Continue?')) return;
            if (!confirm('Are you ABSOLUTELY SURE? This cannot be undone!')) return;

            try {
                const response = await fetch('/api/infrastructure/restore-backup', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                alert(data.message);
            } catch (error) {
                alert('Failed to restore from backup: ' + error.message);
            }
        }

        async function checkRecoveryStatus() {
            try {
                const response = await fetch('/api/infrastructure/recovery-status', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                const alertEl = document.getElementById('recoveryAlert');
                const alertText = document.getElementById('recoveryAlertText');

                if (data.cluster_healthy) {
                    alertEl.className = 'neu-border bg-green-50 p-3 mb-4 text-sm';
                    alertText.innerHTML = `<span class="text-green-700"><i class="bi bi-check-circle"></i> Cluster healthy: ${data.message}</span>`;
                } else {
                    alertEl.className = 'neu-border bg-yellow-50 p-3 mb-4 text-sm';
                    alertText.innerHTML = `<span class="text-yellow-700"><i class="bi bi-exclamation-triangle"></i> ${data.message} - Auto-recovery: ${data.auto_recovery_enabled ? 'Enabled' : 'Disabled'}</span>`;
                }
                alertEl.classList.remove('hidden');

                setTimeout(() => alertEl.classList.add('hidden'), 5000);
            } catch (error) {
                alert('Failed to check recovery status: ' + error.message);
            }
        }

        async function recoverStuckPods(dryRun) {
            const alertEl = document.getElementById('recoveryAlert');
            const alertText = document.getElementById('recoveryAlertText');

            try {
                const response = await fetch('/api/infrastructure/recover-stuck-pods', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ dry_run: dryRun })
                });
                const data = await response.json();

                if (dryRun) {
                    // Show detection results
                    if (data.stuck_pods && data.stuck_pods.length > 0) {
                        const stuckList = data.stuck_pods.map(p =>
                            `${p.name} (${p.reason}, ${p.stuck_duration})`
                        ).join(', ');
                        alertEl.className = 'neu-border bg-yellow-50 p-3 mb-4 text-sm';
                        alertText.innerHTML = `<span class="text-yellow-700"><i class="bi bi-exclamation-triangle"></i> Found ${data.stuck_pods.length} stuck pods: ${stuckList}</span>`;
                    } else {
                        alertEl.className = 'neu-border bg-green-50 p-3 mb-4 text-sm';
                        alertText.innerHTML = `<span class="text-green-700"><i class="bi bi-check-circle"></i> No stuck pods detected. ${data.healthy_pods ? data.healthy_pods.length : 0} pods healthy.</span>`;
                    }
                } else {
                    // Show recovery results
                    if (!confirm(`This will attempt to recover stuck pods. Continue?`)) return;

                    if (data.recovered_pods && data.recovered_pods.length > 0) {
                        alertEl.className = 'neu-border bg-green-50 p-3 mb-4 text-sm';
                        alertText.innerHTML = `<span class="text-green-700"><i class="bi bi-check-circle"></i> Recovered: ${data.recovered_pods.join(', ')}. CNPG will recreate them.</span>`;
                    } else if (data.skipped_pods && data.skipped_pods.length > 0) {
                        alertEl.className = 'neu-border bg-yellow-50 p-3 mb-4 text-sm';
                        alertText.innerHTML = `<span class="text-yellow-700"><i class="bi bi-info-circle"></i> Skipped: ${data.skipped_pods.join(', ')}</span>`;
                    } else {
                        alertEl.className = 'neu-border bg-blue-50 p-3 mb-4 text-sm';
                        alertText.innerHTML = `<span class="text-blue-700"><i class="bi bi-info-circle"></i> No stuck pods to recover.</span>`;
                    }

                    // Refresh pod list after recovery
                    setTimeout(() => {
                        checkPostgreSQLPods();
                        checkPostgreSQL();
                    }, 2000);
                }

                alertEl.classList.remove('hidden');
                setTimeout(() => alertEl.classList.add('hidden'), 10000);
            } catch (error) {
                alert('Failed to recover stuck pods: ' + error.message);
            }
        }

        function refreshAll() {
            checkK3sCluster();
            checkPostgreSQL();
            checkPostgreSQLPods();
            checkVIP();
            checkBackupServer();
            checkBackendPods();
            updateNodeCharts();
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // Initial load and auto-refresh every 30 seconds
        refreshAll();
        setInterval(refreshAll, 30000);
    </script>
</body>
</html>
