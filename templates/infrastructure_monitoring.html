<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png?v=2">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infrastructure Monitoring - Cold Storage</title>
    <link rel="stylesheet" href="/static/css/bootstrap-icons.min.css">
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link href="/static/css/arbitrary.css" rel="stylesheet">
    <link href="/static/css/fonts.css" rel="stylesheet">
    <link href="/static/css/dark-mode.css" rel="stylesheet">
    <style>
        * { font-family: 'Space Grotesk', sans-serif; }
        .status-healthy { background: #10b981; }
        .status-warning { background: #f59e0b; }
        .status-critical { background: #ef4444; }
        .status-unknown { background: #6b7280; }
        .neu-border {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
        }
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
    <script src="/static/js/theme.js"></script>
</head>
<body class="bg-gray-100 p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="neu-border bg-white p-4 md:p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-2xl md:text-4xl font-bold flex items-center gap-3">
                        <i class="bi bi-hdd-network"></i>
                        Infrastructure Monitoring
                    </h1>
                    <p class="text-gray-600 text-sm md:text-base">Cold Storage HA Cluster Status & Failover Control</p>
                </div>
                <div class="text-left md:text-right w-full md:w-auto">
                    <div class="text-sm text-gray-600">Last Update</div>
                    <div id="lastUpdate" class="text-lg font-bold">--:--:--</div>
                    <div class="flex gap-2 mt-2">
                        <button onclick="theme.toggle()" class="neu-border bg-gray-200 px-3 py-2 text-sm" title="Toggle Dark Mode">
                            <i class="bi bi-moon-fill theme-icon-moon"></i>
                            <i class="bi bi-sun-fill theme-icon-sun hidden"></i>
                        </button>
                        <button onclick="refreshAll()" class="neu-border bg-blue-500 text-white px-4 py-2 text-sm">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overall System Status -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
            <div class="neu-border bg-white p-4">
                <div class="text-sm text-gray-600 mb-2">K3s Cluster</div>
                <div id="k3sStatus" class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full status-unknown pulse"></div>
                    <span class="font-bold">Checking...</span>
                </div>
            </div>
            <div class="neu-border bg-white p-4">
                <div class="text-sm text-gray-600 mb-2">PostgreSQL HA</div>
                <div id="pgStatus" class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full status-unknown pulse"></div>
                    <span class="font-bold">Checking...</span>
                </div>
            </div>
            <div class="neu-border bg-white p-4">
                <div class="text-sm text-gray-600 mb-2">VIP (192.168.15.200)</div>
                <div id="vipStatus" class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full status-unknown pulse"></div>
                    <span class="font-bold">Checking...</span>
                </div>
            </div>
            <div class="neu-border bg-white p-4">
                <div class="text-sm text-gray-600 mb-2">Backup Server</div>
                <div id="backupStatus" class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full status-unknown pulse"></div>
                    <span class="font-bold">Checking...</span>
                </div>
            </div>
            <div class="neu-border bg-white p-4">
                <div class="text-sm text-gray-600 mb-2">R2 Cloud</div>
                <div id="offsiteStatusHeader" class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full status-unknown pulse"></div>
                    <span class="font-bold">Checking...</span>
                </div>
            </div>
        </div>

        <!-- PostgreSQL Cluster Detail -->
        <div class="neu-border bg-white p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">
                <i class="bi bi-database"></i> PostgreSQL Cluster
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="font-bold mb-2">Primary Node</h3>
                    <div id="primaryNode" class="text-sm"></div>
                </div>
                <div>
                    <h3 class="font-bold mb-2">Replica Nodes</h3>
                    <div id="replicaNodes" class="text-sm"></div>
                </div>
            </div>
            <div class="mt-4">
                <h3 class="font-bold mb-2">Connection String</h3>
                <code class="bg-gray-100 p-2 block text-sm">postgresql://postgres:***@192.168.15.200:5432/cold_db</code>
            </div>
        </div>

        <!-- PostgreSQL Database Pods -->
        <div class="neu-border bg-white p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                <h2 class="text-xl md:text-2xl font-bold">
                    <i class="bi bi-database-gear"></i> PostgreSQL Database Pods
                </h2>
                <div class="flex flex-wrap gap-2">
                    <button onclick="checkRecoveryStatus()" class="neu-border bg-blue-100 text-blue-800 px-3 py-2 text-sm">
                        <i class="bi bi-info-circle"></i> Check Status
                    </button>
                    <button onclick="recoverStuckPods(true)" class="neu-border bg-yellow-100 text-yellow-800 px-3 py-2 text-sm">
                        <i class="bi bi-search"></i> Detect Stuck
                    </button>
                    <button onclick="recoverStuckPods(false)" class="neu-border bg-red-100 text-red-800 px-3 py-2 text-sm">
                        <i class="bi bi-arrow-repeat"></i> Recover Stuck
                    </button>
                </div>
            </div>
            <div id="recoveryAlert" class="hidden neu-border bg-yellow-50 p-3 mb-4 text-sm">
                <div class="flex items-center gap-2">
                    <i class="bi bi-exclamation-triangle text-yellow-600"></i>
                    <span id="recoveryAlertText"></span>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-gray-100 border-b-2 border-black">
                            <th class="px-4 py-2 text-left font-bold">Pod Name</th>
                            <th class="px-4 py-2 text-left font-bold">Role</th>
                            <th class="px-4 py-2 text-left font-bold">Status</th>
                            <th class="px-4 py-2 text-left font-bold">Node</th>
                            <th class="px-4 py-2 text-left font-bold">DB Size</th>
                            <th class="px-4 py-2 text-left font-bold">Connections</th>
                            <th class="px-4 py-2 text-left font-bold">Repl. Lag</th>
                            <th class="px-4 py-2 text-left font-bold">Sync %</th>
                            <th class="px-4 py-2 text-left font-bold">Cache Hit</th>
                        </tr>
                    </thead>
                    <tbody id="pgPodsList">
                        <tr>
                            <td colspan="9" class="text-center py-4 text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- K3s Node Metrics Graphs -->
        <div class="neu-border bg-white p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">
                <i class="bi bi-graph-up"></i> K3s Node Metrics
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="neu-border bg-gray-50 p-4">
                    <h3 class="font-bold mb-3 text-center text-gray-700">
                        <i class="bi bi-cpu text-blue-500"></i> CPU Usage (%)
                    </h3>
                    <div style="height: 280px;">
                        <canvas id="nodeCpuChart"></canvas>
                    </div>
                </div>
                <div class="neu-border bg-gray-50 p-4">
                    <h3 class="font-bold mb-3 text-center text-gray-700">
                        <i class="bi bi-memory text-green-500"></i> Memory Usage (%)
                    </h3>
                    <div style="height: 280px;">
                        <canvas id="nodeMemoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- PostgreSQL Metrics Graphs -->
        <div class="neu-border bg-white p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">
                <i class="bi bi-bar-chart-line"></i> PostgreSQL Metrics
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="neu-border bg-gray-50 p-4">
                    <h3 class="font-bold mb-3 text-center text-gray-700">
                        <i class="bi bi-plug text-purple-500"></i> Connections
                    </h3>
                    <div style="height: 250px;">
                        <canvas id="pgConnectionsChart"></canvas>
                    </div>
                </div>
                <div class="neu-border bg-gray-50 p-4">
                    <h3 class="font-bold mb-3 text-center text-gray-700">
                        <i class="bi bi-lightning text-yellow-500"></i> Cache Hit Ratio (%)
                    </h3>
                    <div style="height: 250px;">
                        <canvas id="pgCacheHitChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                <div class="neu-border bg-gray-50 p-4">
                    <h3 class="font-bold mb-3 text-center text-gray-700">
                        <i class="bi bi-hdd text-red-500"></i> DB Size (MB)
                    </h3>
                    <div style="height: 250px;">
                        <canvas id="pgDbSizeChart"></canvas>
                    </div>
                </div>
                <div class="neu-border bg-gray-50 p-4">
                    <h3 class="font-bold mb-3 text-center text-gray-700">
                        <i class="bi bi-arrow-repeat text-orange-500"></i> Replication Lag
                    </h3>
                    <div style="height: 250px;">
                        <canvas id="pgReplLagChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Backend Pods Status -->
        <div class="neu-border bg-white p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">
                <i class="bi bi-server"></i> Backend Pods
            </h2>
            <div id="backendPods" class="space-y-2"></div>
        </div>

        <!-- One-Click Deployment Section -->
        <div class="neu-border bg-white p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                <h2 class="text-xl md:text-2xl font-bold">
                    <i class="bi bi-rocket-takeoff"></i> One-Click Deployment
                </h2>
                <div class="flex flex-wrap gap-2">
                    <button onclick="loadDeploymentStatus()" class="neu-border bg-blue-100 text-blue-800 px-3 py-2 text-sm">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                    <button onclick="showDeployHistory()" class="neu-border bg-gray-100 text-gray-800 px-3 py-2 text-sm">
                        <i class="bi bi-clock-history"></i> History
                    </button>
                </div>
            </div>

            <!-- Deployment Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <!-- Employee Deployment -->
                <div class="neu-border bg-blue-50 p-4">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-bold text-lg">cold-backend-employee</h3>
                            <p class="text-sm text-gray-600">Employee Portal (Port 8080)</p>
                        </div>
                        <div id="employeeVersionBadge" class="neu-border bg-white px-3 py-1 text-sm font-mono">
                            Loading...
                        </div>
                    </div>
                    <div class="flex gap-2 mt-3">
                        <button onclick="deployNew('employee')" class="neu-border bg-blue-500 text-white px-4 py-2 text-sm flex-1">
                            <i class="bi bi-cloud-upload"></i> Deploy
                        </button>
                        <button onclick="rollback('employee')" class="neu-border bg-gray-500 text-white px-4 py-2 text-sm">
                            <i class="bi bi-arrow-counterclockwise"></i> Rollback
                        </button>
                    </div>
                </div>

                <!-- Customer Deployment -->
                <div class="neu-border bg-green-50 p-4">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-bold text-lg">cold-backend-customer</h3>
                            <p class="text-sm text-gray-600">Customer Portal (Port 8081)</p>
                        </div>
                        <div id="customerVersionBadge" class="neu-border bg-white px-3 py-1 text-sm font-mono">
                            Loading...
                        </div>
                    </div>
                    <div class="flex gap-2 mt-3">
                        <button onclick="deployNew('customer')" class="neu-border bg-green-500 text-white px-4 py-2 text-sm flex-1">
                            <i class="bi bi-cloud-upload"></i> Deploy
                        </button>
                        <button onclick="rollback('customer')" class="neu-border bg-gray-500 text-white px-4 py-2 text-sm">
                            <i class="bi bi-arrow-counterclockwise"></i> Rollback
                        </button>
                    </div>
                </div>
            </div>

            <!-- Deploy Both Button -->
            <div class="neu-border bg-purple-50 p-4">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div>
                        <h3 class="font-bold">Deploy Both Portals</h3>
                        <p class="text-sm text-gray-600">Build once, deploy to employee and customer portals simultaneously</p>
                    </div>
                    <button onclick="deployNew('both')" class="neu-border bg-purple-600 text-white px-6 py-3">
                        <i class="bi bi-rocket-takeoff"></i> Deploy All
                    </button>
                </div>
            </div>
        </div>

        <!-- Deployment Progress Modal -->
        <div id="deployModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="neu-border bg-white p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">
                        <i class="bi bi-gear-wide-connected"></i> Deployment in Progress
                    </h3>
                    <button onclick="closeDeployModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="bi bi-x-lg text-xl"></i>
                    </button>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between text-sm mb-1">
                        <span id="deployStepText">Initializing...</span>
                        <span id="deployProgressText">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4 neu-border">
                        <div id="deployProgressBar" class="bg-blue-600 h-full rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>

                <div id="deployLog" class="bg-gray-900 text-green-400 font-mono text-sm p-4 rounded max-h-64 overflow-y-auto">
                    <div class="text-gray-500">Waiting for deployment to start...</div>
                </div>

                <div id="deployResult" class="hidden mt-4 p-4 rounded">
                    <!-- Success/Error message will appear here -->
                </div>

                <div class="mt-4 flex gap-2 justify-end">
                    <button id="deployCloseBtn" onclick="closeDeployModal()" class="neu-border bg-gray-200 px-4 py-2 text-sm hidden">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <!-- Deploy Version Input Modal -->
        <div id="versionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="neu-border bg-white p-6 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold mb-4">
                    <i class="bi bi-tag"></i> Deploy New Version
                </h3>
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-2">Version Tag</label>
                    <input type="text" id="versionInput" placeholder="v1.5.x (auto-generated if empty)"
                           class="neu-border w-full px-4 py-2 font-mono">
                    <p class="text-xs text-gray-500 mt-1">Leave empty to auto-generate based on timestamp</p>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-2">Deploy Target</label>
                    <select id="deployTargetSelect" class="neu-border w-full px-4 py-2">
                        <option value="both">Both (Employee + Customer)</option>
                        <option value="employee">Employee Portal Only</option>
                        <option value="customer">Customer Portal Only</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="skipBuildCheck" class="w-4 h-4">
                        <span class="text-sm">Skip build (use existing image)</span>
                    </label>
                </div>
                <div class="flex gap-2 justify-end">
                    <button onclick="closeVersionModal()" class="neu-border bg-gray-200 px-4 py-2">Cancel</button>
                    <button onclick="startDeploy()" class="neu-border bg-blue-500 text-white px-4 py-2">
                        <i class="bi bi-rocket-takeoff"></i> Deploy
                    </button>
                </div>
            </div>
        </div>

        <!-- Deployment History Modal -->
        <div id="historyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="neu-border bg-white p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">
                        <i class="bi bi-clock-history"></i> Deployment History
                    </h3>
                    <button onclick="closeHistoryModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="bi bi-x-lg text-xl"></i>
                    </button>
                </div>
                <div id="historyContent" class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-gray-100 border-b-2 border-black">
                                <th class="px-4 py-2 text-left">Version</th>
                                <th class="px-4 py-2 text-left">Status</th>
                                <th class="px-4 py-2 text-left">Deployed By</th>
                                <th class="px-4 py-2 text-left">Started At</th>
                                <th class="px-4 py-2 text-left">Duration</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <tr><td colspan="5" class="text-center py-4">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Backup Server Health & Capacity (192.168.15.195) -->
        <div class="neu-border bg-white p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">
                <i class="bi bi-server"></i> Backup Server Health (192.168.15.195)
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div class="neu-border bg-blue-50 p-4">
                    <div class="text-sm text-gray-600 mb-1">CPU Usage</div>
                    <div id="cpuUsage" class="text-2xl font-bold">--</div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                        <div id="cpuBar" class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                <div class="neu-border bg-green-50 p-4">
                    <div class="text-sm text-gray-600 mb-1">Memory Usage</div>
                    <div id="memUsage" class="text-2xl font-bold">--</div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                        <div id="memBar" class="bg-green-500 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                <div class="neu-border bg-purple-50 p-4">
                    <div class="text-sm text-gray-600 mb-1">Root Disk</div>
                    <div id="rootDisk" class="text-2xl font-bold">--</div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                        <div id="rootBar" class="bg-purple-500 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                <div class="neu-border bg-yellow-50 p-4">
                    <div class="text-sm text-gray-600 mb-1">27TB NAS</div>
                    <div id="nasDisk" class="text-2xl font-bold">--</div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                        <div id="nasBar" class="bg-yellow-500 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Storage Details -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="neu-border bg-gray-50 p-3">
                    <div class="font-bold mb-2">Local Backup Storage</div>
                    <div class="text-sm space-y-1">
                        <div class="flex justify-between">
                            <span>Total:</span>
                            <span id="localTotal" class="font-mono">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Used:</span>
                            <span id="localUsed" class="font-mono">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Free:</span>
                            <span id="localFree" class="font-mono text-green-600">--</span>
                        </div>
                    </div>
                </div>
                <div class="neu-border bg-gray-50 p-3">
                    <div class="font-bold mb-2">NAS Backup Storage</div>
                    <div class="text-sm space-y-1">
                        <div class="flex justify-between">
                            <span>Total:</span>
                            <span id="nasTotal" class="font-mono">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Used:</span>
                            <span id="nasUsed" class="font-mono">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Free:</span>
                            <span id="nasFree" class="font-mono text-green-600">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Backup Status & Controls -->
        <div class="neu-border bg-white p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">
                <i class="bi bi-archive"></i> Backup Status & Controls
            </h2>

            <!-- Current Status -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="neu-border bg-gray-50 p-3">
                    <div class="text-sm text-gray-600">Last Local Backup</div>
                    <div id="lastBackup" class="text-lg font-bold">--</div>
                </div>
                <div class="neu-border bg-gray-50 p-3">
                    <div class="text-sm text-gray-600">Last NAS Archive</div>
                    <div id="lastNasBackup" class="text-lg font-bold">--</div>
                </div>
                <div class="neu-border bg-gray-50 p-3">
                    <div class="text-sm text-gray-600">Total Backups</div>
                    <div id="totalBackups" class="text-lg font-bold">--</div>
                </div>
                <div class="neu-border bg-gray-50 p-3">
                    <div class="text-sm text-gray-600">Replica Status</div>
                    <div id="replicaStatus" class="text-lg font-bold">--</div>
                </div>
            </div>

            <!-- NAS Archive Monitoring -->
            <div class="neu-border bg-blue-50 p-4 mb-4">
                <h3 class="font-bold mb-3">
                    <i class="bi bi-hdd-network"></i> 27TB NAS Archive (/mnt/192.168.15.52/mine)
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <div class="text-sm text-gray-600">Archive Size</div>
                        <div id="nasArchiveSize" class="text-xl font-bold">--</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600">Total Snapshots</div>
                        <div id="nasSnapshots" class="text-xl font-bold">--</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600">Oldest Snapshot</div>
                        <div id="nasOldest" class="text-xl font-bold">--</div>
                    </div>
                </div>
            </div>

            <!-- Cloudflare R2 Cloud Storage -->
            <div class="neu-border bg-orange-50 p-4 mb-4">
                <h3 class="font-bold mb-3">
                    <i class="bi bi-cloud"></i> Cloudflare R2 Cloud Storage (Offsite)
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                    <div>
                        <div class="text-sm text-gray-600">Status</div>
                        <div id="r2Status" class="text-xl font-bold">--</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600">Total Size</div>
                        <div id="r2Size" class="text-xl font-bold">--</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600">Total Backups</div>
                        <div id="r2Backups" class="text-xl font-bold">--</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600">Last Backup</div>
                        <div id="r2LastBackup" class="text-xl font-bold">--</div>
                    </div>
                </div>
                <div class="mt-3 text-xs text-gray-500">
                    <i class="bi bi-info-circle"></i> Bucket: cold-db-backups | Region: auto
                </div>
            </div>

            <!-- Backup Controls -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Manual Backup -->
                <div class="neu-border bg-green-50 p-4">
                    <h3 class="font-bold mb-2">
                        <i class="bi bi-play-circle"></i> Manual Backup
                    </h3>
                    <p class="text-sm text-gray-600 mb-3">Trigger immediate backup to 27TB NAS</p>
                    <button onclick="triggerManualBackup()" class="neu-border bg-green-500 text-white px-6 py-3 w-full">
                        <i class="bi bi-cloud-upload"></i> Backup Now to NAS
                    </button>
                    <div id="backupProgress" class="mt-2 text-sm text-center hidden">
                        <i class="bi bi-hourglass-split"></i> Backing up...
                    </div>
                </div>

                <!-- Download Database -->
                <div class="neu-border bg-blue-50 p-4">
                    <h3 class="font-bold mb-2">
                        <i class="bi bi-download"></i> Download Database
                    </h3>
                    <p class="text-sm text-gray-600 mb-3">Download complete database as SQL file</p>
                    <button onclick="downloadDatabase()" class="neu-border bg-blue-500 text-white px-6 py-3 w-full">
                        <i class="bi bi-file-earmark-arrow-down"></i> Download DB
                    </button>
                    <div id="downloadProgress" class="mt-2 text-sm text-center hidden">
                        <i class="bi bi-hourglass-split"></i> Preparing download...
                    </div>
                </div>

                <!-- Auto Backup Timer -->
                <div class="neu-border bg-purple-50 p-4">
                    <h3 class="font-bold mb-2">
                        <i class="bi bi-clock-history"></i> Auto Backup Schedule
                    </h3>
                    <p class="text-sm text-gray-600 mb-3">Set automatic backup frequency to NAS</p>
                    <select id="backupFrequency" onchange="updateBackupSchedule()" class="neu-border w-full px-4 py-3 bg-white">
                        <option value="disabled">Disabled</option>
                        <option value="15min">Every 15 Minutes</option>
                        <option value="30min">Every 30 Minutes</option>
                        <option value="1hour" selected>Every Hour (Default)</option>
                        <option value="3hours">Every 3 Hours</option>
                        <option value="6hours">Every 6 Hours</option>
                        <option value="12hours">Every 12 Hours</option>
                        <option value="daily">Daily at Midnight</option>
                    </select>
                    <div id="scheduleStatus" class="mt-2 text-sm text-center text-gray-600">
                        Current: Every Hour
                    </div>
                </div>
            </div>
        </div>

        <!-- Manual Failover Controls -->
        <div class="neu-border bg-red-100 p-6">
            <h2 class="text-2xl font-bold mb-4 text-red-700">
                <i class="bi bi-exclamation-triangle"></i> Manual Failover Controls
            </h2>
            <p class="mb-4 text-sm">Use these controls only when the HA cluster is not responding</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="neu-border bg-white p-4">
                    <h3 class="font-bold mb-2">Start Standby Backend</h3>
                    <p class="text-sm text-gray-600 mb-3">Activates backup server on 192.168.15.195</p>
                    <button onclick="startStandbyBackend()" class="neu-border bg-orange-500 text-white px-4 py-2 w-full">
                        <i class="bi bi-play-circle"></i> Activate Standby
                    </button>
                </div>

                <div class="neu-border bg-white p-4">
                    <h3 class="font-bold mb-2">Restore from Backup</h3>
                    <p class="text-sm text-gray-600 mb-3">Restore database from latest backup</p>
                    <button onclick="restoreFromBackup()" class="neu-border bg-red-600 text-white px-4 py-2 w-full">
                        <i class="bi bi-arrow-counterclockwise"></i> Restore Database
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/prefetch.js?v=5"></script>
    <script src="/static/js/chart.umd.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        if (!token) {
            console.error('No auth token found in localStorage');
            alert('Session expired. Please log in again.');
            window.location.href = '/login';
        }
        console.log('Token found, length:', token ? token.length : 0);

        // Chart instances
        let nodeCpuChart = null;
        let nodeMemoryChart = null;
        let pgConnectionsChart = null;
        let pgCacheHitChart = null;
        let pgDbSizeChart = null;
        let pgReplLagChart = null;

        // Chart colors
        const chartColors = [
            'rgba(59, 130, 246, 0.8)',   // blue
            'rgba(16, 185, 129, 0.8)',   // green
            'rgba(245, 158, 11, 0.8)',   // yellow
            'rgba(139, 92, 246, 0.8)',   // purple
            'rgba(239, 68, 68, 0.8)',    // red
        ];

        // Initialize charts
        function initCharts() {
            // Optimized chart colors - gradient-like
            const nodeColors = ['#3b82f6', '#10b981', '#8b5cf6', '#f59e0b', '#ef4444', '#06b6d4'];
            const pgColors = ['#6366f1', '#22c55e', '#f97316', '#ec4899'];

            // Common options for all charts
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 500 },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 13 },
                        padding: 12,
                        cornerRadius: 8
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { font: { size: 11, weight: '600' } }
                    },
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: { font: { size: 11 } }
                    }
                }
            };

            // Node CPU Chart
            nodeCpuChart = new Chart(document.getElementById('nodeCpuChart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CPU %',
                        data: [],
                        backgroundColor: nodeColors,
                        borderColor: nodeColors.map(c => c),
                        borderWidth: 2,
                        borderRadius: 6,
                        barThickness: 40
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: { ...commonOptions.scales.y, max: 100, ticks: { callback: v => v + '%' } }
                    },
                    plugins: {
                        ...commonOptions.plugins,
                        tooltip: {
                            ...commonOptions.plugins.tooltip,
                            callbacks: { label: ctx => `CPU: ${ctx.raw.toFixed(1)}%` }
                        }
                    }
                }
            });

            // Node Memory Chart
            nodeMemoryChart = new Chart(document.getElementById('nodeMemoryChart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Memory %',
                        data: [],
                        backgroundColor: nodeColors.map(c => c.replace(')', ', 0.8)').replace('rgb', 'rgba').replace('#', '')),
                        borderColor: nodeColors,
                        borderWidth: 2,
                        borderRadius: 6,
                        barThickness: 40
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: { ...commonOptions.scales.y, max: 100, ticks: { callback: v => v + '%' } }
                    },
                    plugins: {
                        ...commonOptions.plugins,
                        tooltip: {
                            ...commonOptions.plugins.tooltip,
                            callbacks: { label: ctx => `Memory: ${ctx.raw.toFixed(1)}%` }
                        }
                    }
                }
            });

            // PostgreSQL Connections Chart
            pgConnectionsChart = new Chart(document.getElementById('pgConnectionsChart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Connections',
                        data: [],
                        backgroundColor: pgColors,
                        borderRadius: 6,
                        barThickness: 35
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        tooltip: {
                            ...commonOptions.plugins.tooltip,
                            callbacks: { label: ctx => `Connections: ${ctx.raw}` }
                        }
                    }
                }
            });

            // PostgreSQL Cache Hit Chart
            pgCacheHitChart = new Chart(document.getElementById('pgCacheHitChart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Cache Hit %',
                        data: [],
                        backgroundColor: ['#22c55e', '#22c55e', '#22c55e', '#22c55e'],
                        borderRadius: 6,
                        barThickness: 35
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: { ...commonOptions.scales.y, min: 90, max: 100, ticks: { callback: v => v + '%' } }
                    },
                    plugins: {
                        ...commonOptions.plugins,
                        tooltip: {
                            ...commonOptions.plugins.tooltip,
                            callbacks: { label: ctx => `Cache Hit: ${ctx.raw.toFixed(1)}%` }
                        }
                    }
                }
            });

            // PostgreSQL DB Size Chart
            pgDbSizeChart = new Chart(document.getElementById('pgDbSizeChart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Size (MB)',
                        data: [],
                        backgroundColor: ['#8b5cf6', '#a78bfa', '#c4b5fd', '#ddd6fe'],
                        borderRadius: 6,
                        barThickness: 35
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        tooltip: {
                            ...commonOptions.plugins.tooltip,
                            callbacks: { label: ctx => `Size: ${ctx.raw.toFixed(2)} MB` }
                        }
                    }
                }
            });

            // PostgreSQL Replication Lag Chart
            pgReplLagChart = new Chart(document.getElementById('pgReplLagChart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Lag',
                        data: [],
                        backgroundColor: ctx => {
                            const value = ctx.raw || 0;
                            if (value === 0) return '#22c55e';
                            if (value < 1024) return '#f59e0b';
                            return '#ef4444';
                        },
                        borderRadius: 6,
                        barThickness: 35
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        tooltip: {
                            ...commonOptions.plugins.tooltip,
                            callbacks: {
                                label: ctx => {
                                    const bytes = ctx.raw;
                                    if (bytes === 0) return 'Lag: 0 (In Sync)';
                                    if (bytes < 1024) return `Lag: ${bytes} B`;
                                    if (bytes < 1024 * 1024) return `Lag: ${(bytes/1024).toFixed(1)} KB`;
                                    return `Lag: ${(bytes/1024/1024).toFixed(1)} MB`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update K3s Node Charts
        async function updateNodeCharts() {
            const nodeColors = ['#3b82f6', '#10b981', '#8b5cf6', '#f59e0b', '#ef4444', '#06b6d4'];
            try {
                const response = await fetch('/api/monitoring/nodes', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.nodes && data.nodes.length > 0) {
                    // Sort: k3s nodes first, then backup server
                    const sortedNodes = data.nodes.sort((a, b) => {
                        if (a.node_name.startsWith('k3s-') && !b.node_name.startsWith('k3s-')) return -1;
                        if (!a.node_name.startsWith('k3s-') && b.node_name.startsWith('k3s-')) return 1;
                        return a.node_name.localeCompare(b.node_name);
                    });

                    const labels = sortedNodes.map(n => n.node_name.replace('k3s-', '').replace('backup-server', 'backup'));
                    const cpuData = sortedNodes.map(n => n.cpu_percent || 0);
                    const memData = sortedNodes.map(n => n.memory_percent || 0);

                    // Color based on value for CPU
                    const cpuColors = cpuData.map(v => {
                        if (v < 50) return '#22c55e';  // green
                        if (v < 75) return '#f59e0b';  // yellow
                        return '#ef4444';              // red
                    });

                    // Color based on value for Memory
                    const memColors = memData.map(v => {
                        if (v < 60) return '#3b82f6';  // blue
                        if (v < 80) return '#f59e0b';  // yellow
                        return '#ef4444';              // red
                    });

                    nodeCpuChart.data.labels = labels;
                    nodeCpuChart.data.datasets[0].data = cpuData;
                    nodeCpuChart.data.datasets[0].backgroundColor = cpuColors;
                    nodeCpuChart.update('none');  // No animation for smoother updates

                    nodeMemoryChart.data.labels = labels;
                    nodeMemoryChart.data.datasets[0].data = memData;
                    nodeMemoryChart.data.datasets[0].backgroundColor = memColors;
                    nodeMemoryChart.update('none');
                }
            } catch (error) {
                console.error('Failed to update node charts:', error);
            }
        }

        // Update PostgreSQL Charts from pods data
        function updatePgCharts(pods) {
            if (!pods || pods.length === 0) return;

            const pgColors = ['#6366f1', '#22c55e', '#f97316', '#ec4899', '#8b5cf6'];
            const labels = pods.map(p => {
                if (p.name.includes('streaming-replica')) return 'ext-195';
                return p.name.replace('cold-postgres-', 'pg-');
            });

            // Connections - color by role
            const connData = pods.map(p => parseInt(p.connections) || 0);
            const connColors = pods.map(p => {
                if (p.role === 'Primary') return '#3b82f6';      // blue for primary
                if (p.role === 'Metrics DB') return '#8b5cf6';   // purple for metrics
                return '#22c55e';                                 // green for replicas
            });
            pgConnectionsChart.data.labels = labels;
            pgConnectionsChart.data.datasets[0].data = connData;
            pgConnectionsChart.data.datasets[0].backgroundColor = connColors;
            pgConnectionsChart.update('none');

            // Cache Hit - color by performance
            const cacheData = pods.map(p => parseFloat(p.cache_hit) || 0);
            const cacheColors = cacheData.map(v => {
                if (v >= 99) return '#22c55e';   // green - excellent
                if (v >= 95) return '#84cc16';   // lime - good
                if (v >= 90) return '#f59e0b';   // yellow - warning
                return '#ef4444';                 // red - bad
            });
            pgCacheHitChart.data.labels = labels;
            pgCacheHitChart.data.datasets[0].data = cacheData;
            pgCacheHitChart.data.datasets[0].backgroundColor = cacheColors;
            pgCacheHitChart.update('none');

            // DB Size (convert to MB) - gradient purple
            const sizeData = pods.map(p => {
                const size = p.disk_used || '0';
                if (size.includes('MB')) return parseFloat(size);
                if (size.includes('kB')) return parseFloat(size) / 1024;
                if (size.includes('GB')) return parseFloat(size) * 1024;
                return parseFloat(size) / (1024 * 1024) || 0;
            });
            const sizeColors = ['#8b5cf6', '#a78bfa', '#c4b5fd', '#ddd6fe', '#ede9fe'];
            pgDbSizeChart.data.labels = labels;
            pgDbSizeChart.data.datasets[0].data = sizeData;
            pgDbSizeChart.data.datasets[0].backgroundColor = labels.map((_, i) => sizeColors[i % sizeColors.length]);
            pgDbSizeChart.update('none');

            // Replication Lag - color by lag severity
            const lagData = pods.map(p => {
                if (p.role === 'Primary' || p.repl_lag === 'N/A') return 0;
                const lag = p.repl_lag || '0';
                if (lag.includes('KB')) return parseFloat(lag) * 1024;
                if (lag.includes('MB')) return parseFloat(lag) * 1024 * 1024;
                if (lag.includes('B')) return parseFloat(lag);
                return parseFloat(lag) || 0;
            });
            const lagColors = lagData.map(v => {
                if (v === 0) return '#22c55e';       // green - in sync
                if (v < 1024) return '#84cc16';      // lime - minimal lag
                if (v < 10240) return '#f59e0b';    // yellow - some lag
                return '#ef4444';                    // red - significant lag
            });
            pgReplLagChart.data.labels = labels;
            pgReplLagChart.data.datasets[0].data = lagData;
            pgReplLagChart.data.datasets[0].backgroundColor = lagColors;
            pgReplLagChart.update('none');
        }

        // Initialize charts on page load
        initCharts();

        async function checkK3sCluster() {
            try {
                const response = await fetch('/api/infrastructure/k3s-status', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                updateStatus('k3sStatus', data.healthy ? 'healthy' : 'critical', data.message);
            } catch (error) {
                updateStatus('k3sStatus', 'critical', 'Unable to reach cluster');
            }
        }

        async function checkPostgreSQL() {
            try {
                const response = await fetch('/api/infrastructure/postgresql-status', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                updateStatus('pgStatus', data.healthy ? 'healthy' : 'critical', data.message);
                document.getElementById('primaryNode').textContent = data.primary || 'Unknown';
                document.getElementById('replicaNodes').textContent = data.replicas ? data.replicas.join(', ') : 'None';
            } catch (error) {
                updateStatus('pgStatus', 'critical', 'Connection failed');
            }
        }

        async function checkVIP() {
            try {
                const response = await fetch('/api/infrastructure/vip-status', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                updateStatus('vipStatus', data.healthy ? 'healthy' : 'warning', data.message);
            } catch (error) {
                updateStatus('vipStatus', 'critical', 'VIP unreachable');
            }
        }

        async function checkBackupServer() {
            try {
                const response = await fetch('/api/infrastructure/backup-status', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                console.log('Backup server data:', data);
                updateStatus('backupStatus', data.healthy ? 'healthy' : 'warning', 'Online');

                // Backup info
                document.getElementById('lastBackup').textContent = data.last_backup || 'Never';
                document.getElementById('totalBackups').textContent = data.total_backups || '0';
                // backupSize element removed from UI
                document.getElementById('replicaStatus').textContent = data.replica_running ? ' Running' : ' Stopped';

                // NAS Archive monitoring
                document.getElementById('lastNasBackup').textContent = data.nas_last_backup || 'Never';
                document.getElementById('nasArchiveSize').textContent = data.nas_archive_size || '0 MB';
                document.getElementById('nasSnapshots').textContent = data.nas_snapshots || '0';
                document.getElementById('nasOldest').textContent = data.nas_oldest || 'N/A';

                // Load current backup schedule
                if (data.backup_schedule) {
                    document.getElementById('backupFrequency').value = data.backup_schedule;
                    const scheduleText = document.getElementById('backupFrequency').selectedOptions[0].text;
                    document.getElementById('scheduleStatus').textContent = 'Current: ' + scheduleText;
                }

                // CPU & Memory
                const cpuPercent = data.cpu_percent || 0;
                const memPercent = data.memory_percent || 0;
                document.getElementById('cpuUsage').textContent = cpuPercent.toFixed(1) + '%';
                document.getElementById('cpuBar').style.width = cpuPercent + '%';
                document.getElementById('cpuBar').className = 'h-2 rounded-full ' + (cpuPercent > 80 ? 'bg-red-500' : cpuPercent > 60 ? 'bg-yellow-500' : 'bg-blue-500');

                document.getElementById('memUsage').textContent = memPercent.toFixed(1) + '%';
                document.getElementById('memBar').style.width = memPercent + '%';
                document.getElementById('memBar').className = 'h-2 rounded-full ' + (memPercent > 80 ? 'bg-red-500' : memPercent > 60 ? 'bg-yellow-500' : 'bg-green-500');

                // Disk usage
                if (data.disk_root) {
                    document.getElementById('rootDisk').textContent = data.disk_root.percent + '%';
                    document.getElementById('rootBar').style.width = data.disk_root.percent + '%';
                    document.getElementById('rootBar').className = 'h-2 rounded-full ' + (data.disk_root.percent > 80 ? 'bg-red-500' : 'bg-purple-500');
                    document.getElementById('localTotal').textContent = data.disk_root.total;
                    document.getElementById('localUsed').textContent = data.disk_root.used;
                    document.getElementById('localFree').textContent = data.disk_root.free;
                }

                if (data.disk_nas) {
                    document.getElementById('nasDisk').textContent = data.disk_nas.percent + '%';
                    document.getElementById('nasBar').style.width = data.disk_nas.percent + '%';
                    document.getElementById('nasBar').className = 'h-2 rounded-full ' + (data.disk_nas.percent > 80 ? 'bg-red-500' : 'bg-yellow-500');
                    document.getElementById('nasTotal').textContent = data.disk_nas.total;
                    document.getElementById('nasUsed').textContent = data.disk_nas.used;
                    document.getElementById('nasFree').textContent = data.disk_nas.free;
                }
            } catch (error) {
                console.error('Backup server check failed:', error);
                updateStatus('backupStatus', 'warning', 'Error: ' + error.message);
            }
        }

        async function checkBackendPods() {
            try {
                const response = await fetch('/api/infrastructure/backend-pods', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                const container = document.getElementById('backendPods');
                container.innerHTML = data.pods.map(pod => `
                    <div class="flex items-center justify-between p-2 bg-gray-50 neu-border">
                        <span class="font-mono text-sm">${pod.name}</span>
                        <div class="flex items-center gap-2">
                            <span class="text-sm">${pod.ready}</span>
                            <div class="w-3 h-3 rounded-full status-${pod.status === 'Running' ? 'healthy' : 'warning'}"></div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('backendPods').innerHTML = '<div class="text-red-500">Error loading pods</div>';
            }
        }

        async function checkPostgreSQLPods() {
            try {
                const response = await fetch('/api/infrastructure/postgresql-pods', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                const tbody = document.getElementById('pgPodsList');

                if (data.pods && data.pods.length > 0) {
                    tbody.innerHTML = data.pods.map(pod => {
                        const isExternal = pod.is_external || false;
                        const rowClass = isExternal ? 'border-b border-gray-200 hover:bg-purple-50 bg-purple-50' : 'border-b border-gray-200 hover:bg-gray-50';
                        const roleClass = pod.role === 'Primary' ? 'bg-blue-100 text-blue-800' :
                                         pod.role === 'Metrics DB' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800';
                        const cacheHit = pod.cache_hit || 'N/A';
                        const connections = pod.connections || 'N/A';
                        const maxConn = pod.max_conn || 200;
                        const connDisplay = connections !== 'N/A' ? `${connections} / ${maxConn}` : 'N/A';

                        // Sync percentage display
                        const syncPct = pod.sync_pct;
                        let syncDisplay = 'N/A';
                        let syncClass = 'text-gray-400';
                        if (pod.role === 'Primary') {
                            syncDisplay = 'N/A';
                        } else if (syncPct !== undefined && syncPct >= 0) {
                            syncDisplay = syncPct.toFixed(1) + '%';
                            if (syncPct >= 99.9) syncClass = 'text-green-600';
                            else if (syncPct >= 95) syncClass = 'text-yellow-600';
                            else syncClass = 'text-red-600';
                        }

                        return `
                        <tr class="${rowClass}">
                            <td class="px-4 py-3 font-mono text-xs">${pod.name}</td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 rounded text-xs font-bold ${roleClass}">
                                    ${pod.role}
                                </span>
                            </td>
                            <td class="px-4 py-3">
                                <div class="flex items-center gap-2">
                                    <div class="w-2 h-2 rounded-full ${pod.status === 'Running' ? 'bg-green-500' : 'bg-red-500'}"></div>
                                    <span class="text-xs">${pod.status}</span>
                                </div>
                            </td>
                            <td class="px-4 py-3 text-xs">${pod.node}</td>
                            <td class="px-4 py-3 font-mono text-xs">${pod.disk_used}</td>
                            <td class="px-4 py-3 font-mono text-xs">${connDisplay}</td>
                            <td class="px-4 py-3 font-mono text-xs ${pod.repl_lag !== 'N/A' && pod.repl_lag !== 'N/A' ? 'text-orange-600' : 'text-gray-400'}">${pod.repl_lag}</td>
                            <td class="px-4 py-3 font-mono text-xs ${syncClass}">${syncDisplay}</td>
                            <td class="px-4 py-3 font-mono text-xs ${cacheHit !== 'N/A' ? 'text-green-600' : 'text-gray-400'}">${cacheHit}</td>
                        </tr>
                    `}).join('');

                    // Update PostgreSQL charts with pod data
                    updatePgCharts(data.pods);
                } else {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-gray-500">No pods found</td></tr>';
                }
            } catch (error) {
                document.getElementById('pgPodsList').innerHTML = '<tr><td colspan="9" class="text-center py-4 text-red-500">Error loading PostgreSQL pods</td></tr>';
                console.error('PostgreSQL pods check failed:', error);
            }
        }

        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            const dot = element.querySelector('div');
            const text = element.querySelector('span');

            dot.className = `w-4 h-4 rounded-full status-${status}`;
            text.textContent = message;
        }

        async function triggerManualBackup() {
            if (!confirm('This will trigger an immediate backup to the 27TB NAS. Continue?')) return;

            const progressEl = document.getElementById('backupProgress');
            progressEl.classList.remove('hidden');

            try {
                const response = await fetch('/api/infrastructure/trigger-backup', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                progressEl.classList.add('hidden');
                alert(data.message || 'Backup completed successfully!');

                // Refresh backup status
                checkBackupServer();
            } catch (error) {
                progressEl.classList.add('hidden');
                alert('Failed to trigger backup: ' + error.message);
            }
        }

        async function downloadDatabase() {
            if (!confirm('This will download the entire database as a SQL file. Continue?')) return;

            const progressEl = document.getElementById('downloadProgress');
            progressEl.classList.remove('hidden');

            try {
                const response = await fetch('/api/infrastructure/download-database', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error(await response.text());
                }

                // Get the filename from the Content-Disposition header or generate one
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'cold_db_backup.sql';
                if (contentDisposition) {
                    const match = contentDisposition.match(/filename="(.+)"/);
                    if (match) filename = match[1];
                }

                // Download the file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                progressEl.classList.add('hidden');
            } catch (error) {
                progressEl.classList.add('hidden');
                alert('Failed to download database: ' + error.message);
            }
        }

        async function updateBackupSchedule() {
            const frequency = document.getElementById('backupFrequency').value;
            const scheduleText = document.getElementById('backupFrequency').selectedOptions[0].text;

            if (!confirm(`Set backup schedule to: ${scheduleText}?`)) {
                // Reload current schedule
                checkBackupServer();
                return;
            }

            try {
                const response = await fetch('/api/infrastructure/backup-schedule', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ schedule: frequency })
                });
                const data = await response.json();

                document.getElementById('scheduleStatus').textContent = 'Current: ' + scheduleText;
                alert(data.message || 'Backup schedule updated!');
            } catch (error) {
                alert('Failed to update schedule: ' + error.message);
                checkBackupServer(); // Reload current schedule
            }
        }

        async function startStandbyBackend() {
            if (!confirm('This will start the standby backend server on 192.168.15.195. Continue?')) return;

            try {
                const response = await fetch('/api/infrastructure/start-standby', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                alert(data.message);
            } catch (error) {
                alert('Failed to start standby backend: ' + error.message);
            }
        }

        async function restoreFromBackup() {
            if (!confirm('WARNING: This will restore the database from the latest backup. All current data will be replaced. Continue?')) return;
            if (!confirm('Are you ABSOLUTELY SURE? This cannot be undone!')) return;

            try {
                const response = await fetch('/api/infrastructure/restore-backup', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                alert(data.message);
            } catch (error) {
                alert('Failed to restore from backup: ' + error.message);
            }
        }

        async function checkRecoveryStatus() {
            try {
                const response = await fetch('/api/infrastructure/recovery-status', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                const alertEl = document.getElementById('recoveryAlert');
                const alertText = document.getElementById('recoveryAlertText');

                if (data.cluster_healthy) {
                    alertEl.className = 'neu-border bg-green-50 p-3 mb-4 text-sm';
                    alertText.innerHTML = `<span class="text-green-700"><i class="bi bi-check-circle"></i> Cluster healthy: ${data.message}</span>`;
                } else {
                    alertEl.className = 'neu-border bg-yellow-50 p-3 mb-4 text-sm';
                    alertText.innerHTML = `<span class="text-yellow-700"><i class="bi bi-exclamation-triangle"></i> ${data.message} - Auto-recovery: ${data.auto_recovery_enabled ? 'Enabled' : 'Disabled'}</span>`;
                }
                alertEl.classList.remove('hidden');

                setTimeout(() => alertEl.classList.add('hidden'), 5000);
            } catch (error) {
                alert('Failed to check recovery status: ' + error.message);
            }
        }

        async function recoverStuckPods(dryRun) {
            const alertEl = document.getElementById('recoveryAlert');
            const alertText = document.getElementById('recoveryAlertText');

            try {
                const response = await fetch('/api/infrastructure/recover-stuck-pods', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ dry_run: dryRun })
                });
                const data = await response.json();

                if (dryRun) {
                    // Show detection results
                    if (data.stuck_pods && data.stuck_pods.length > 0) {
                        const stuckList = data.stuck_pods.map(p =>
                            `${p.name} (${p.reason}, ${p.stuck_duration})`
                        ).join(', ');
                        alertEl.className = 'neu-border bg-yellow-50 p-3 mb-4 text-sm';
                        alertText.innerHTML = `<span class="text-yellow-700"><i class="bi bi-exclamation-triangle"></i> Found ${data.stuck_pods.length} stuck pods: ${stuckList}</span>`;
                    } else {
                        alertEl.className = 'neu-border bg-green-50 p-3 mb-4 text-sm';
                        alertText.innerHTML = `<span class="text-green-700"><i class="bi bi-check-circle"></i> No stuck pods detected. ${data.healthy_pods ? data.healthy_pods.length : 0} pods healthy.</span>`;
                    }
                } else {
                    // Show recovery results
                    if (!confirm(`This will attempt to recover stuck pods. Continue?`)) return;

                    if (data.recovered_pods && data.recovered_pods.length > 0) {
                        alertEl.className = 'neu-border bg-green-50 p-3 mb-4 text-sm';
                        alertText.innerHTML = `<span class="text-green-700"><i class="bi bi-check-circle"></i> Recovered: ${data.recovered_pods.join(', ')}. CNPG will recreate them.</span>`;
                    } else if (data.skipped_pods && data.skipped_pods.length > 0) {
                        alertEl.className = 'neu-border bg-yellow-50 p-3 mb-4 text-sm';
                        alertText.innerHTML = `<span class="text-yellow-700"><i class="bi bi-info-circle"></i> Skipped: ${data.skipped_pods.join(', ')}</span>`;
                    } else {
                        alertEl.className = 'neu-border bg-blue-50 p-3 mb-4 text-sm';
                        alertText.innerHTML = `<span class="text-blue-700"><i class="bi bi-info-circle"></i> No stuck pods to recover.</span>`;
                    }

                    // Refresh pod list after recovery
                    setTimeout(() => {
                        checkPostgreSQLPods();
                        checkPostgreSQL();
                    }, 2000);
                }

                alertEl.classList.remove('hidden');
                setTimeout(() => alertEl.classList.add('hidden'), 10000);
            } catch (error) {
                alert('Failed to recover stuck pods: ' + error.message);
            }
        }

        async function checkR2Storage() {
            try {
                const response = await fetch('/api/monitoring/r2-status', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.connected) {
                    document.getElementById('r2Status').innerHTML = '<span class="text-green-600">Connected</span>';
                    document.getElementById('r2Size').textContent = data.total_size || '0 B';
                    document.getElementById('r2Backups').textContent = data.total_backups || '0';
                    document.getElementById('r2LastBackup').textContent = data.last_backup || 'Never';

                    // Update header status
                    updateStatus('offsiteStatusHeader', 'healthy', `${data.total_backups} backups`);
                } else {
                    document.getElementById('r2Status').innerHTML = '<span class="text-red-600">Disconnected</span>';
                    document.getElementById('r2Size').textContent = '--';
                    document.getElementById('r2Backups').textContent = '--';
                    document.getElementById('r2LastBackup').textContent = '--';

                    // Update header status
                    updateStatus('offsiteStatusHeader', 'critical', data.error || 'Connection failed');
                }
            } catch (error) {
                console.error('R2 check failed:', error);
                document.getElementById('r2Status').innerHTML = '<span class="text-red-600">Error</span>';
                updateStatus('offsiteStatusHeader', 'critical', 'Error');
            }
        }

        function refreshAll() {
            checkK3sCluster();
            checkPostgreSQL();
            checkPostgreSQLPods();
            checkVIP();
            checkBackupServer();
            checkBackendPods();
            checkR2Storage();
            updateNodeCharts();
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // Initial load and auto-refresh every 30 seconds
        refreshAll();
        setInterval(refreshAll, 30000);

        // ============================================
        // Deployment Functions
        // ============================================

        let currentDeployTarget = 'both';
        let deploymentConfigId = 1; // Default deployment config ID

        // Load deployment status (current versions)
        async function loadDeploymentStatus() {
            try {
                const response = await fetch('/api/deployments', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.deployments && data.deployments.length > 0) {
                    const config = data.deployments[0];
                    deploymentConfigId = config.id;
                    document.getElementById('employeeVersionBadge').textContent = config.current_version || 'Unknown';
                    document.getElementById('customerVersionBadge').textContent = config.current_version || 'Unknown';
                }
            } catch (error) {
                console.error('Failed to load deployment status:', error);
                document.getElementById('employeeVersionBadge').textContent = 'Error';
                document.getElementById('customerVersionBadge').textContent = 'Error';
            }
        }

        // Show version modal for deployment
        function deployNew(target) {
            currentDeployTarget = target;
            document.getElementById('deployTargetSelect').value = target;
            document.getElementById('versionInput').value = '';
            document.getElementById('skipBuildCheck').checked = false;
            document.getElementById('versionModal').classList.remove('hidden');
        }

        function closeVersionModal() {
            document.getElementById('versionModal').classList.add('hidden');
        }

        function closeDeployModal() {
            document.getElementById('deployModal').classList.add('hidden');
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').classList.add('hidden');
        }

        // Start deployment with SSE streaming
        async function startDeploy() {
            const version = document.getElementById('versionInput').value.trim();
            const target = document.getElementById('deployTargetSelect').value;
            const skipBuild = document.getElementById('skipBuildCheck').checked;

            // Build targets array
            let deployTargets = [];
            if (target === 'both') {
                deployTargets = ['employee', 'customer'];
            } else {
                deployTargets = [target];
            }

            closeVersionModal();

            // Show deployment modal
            document.getElementById('deployModal').classList.remove('hidden');
            document.getElementById('deployLog').innerHTML = '<div class="text-gray-500">Connecting to deployment server...</div>';
            document.getElementById('deployProgressBar').style.width = '0%';
            document.getElementById('deployProgressText').textContent = '0%';
            document.getElementById('deployStepText').textContent = 'Initializing...';
            document.getElementById('deployResult').classList.add('hidden');
            document.getElementById('deployCloseBtn').classList.add('hidden');

            try {
                // Start deployment with SSE
                const response = await fetch(`/api/deployments/${deploymentConfigId}/deploy`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        version: version,
                        skip_build: skipBuild,
                        deploy_targets: deployTargets
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                handleDeployProgress(data);
                            } catch (e) {
                                console.error('Failed to parse SSE data:', e);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Deployment failed:', error);
                showDeployError('Connection failed: ' + error.message);
            }
        }

        function handleDeployProgress(data) {
            const logEl = document.getElementById('deployLog');
            const progressBar = document.getElementById('deployProgressBar');
            const progressText = document.getElementById('deployProgressText');
            const stepText = document.getElementById('deployStepText');

            if (data.type === 'started') {
                logEl.innerHTML = `<div class="text-blue-400">[${new Date().toLocaleTimeString()}] Deployment started (ID: ${data.history_id})</div>`;
            } else if (data.type === 'progress') {
                // Update progress bar
                progressBar.style.width = `${data.progress}%`;
                progressText.textContent = `${data.progress}%`;

                // Update step text
                const stepNames = {
                    'building': 'Building...',
                    'distributing': 'Distributing to nodes...',
                    'updating': 'Updating Kubernetes...',
                    'verifying': 'Verifying health...',
                    'complete': 'Complete!',
                    'failed': 'Failed'
                };
                stepText.textContent = stepNames[data.step] || data.step;

                // Add log entry
                const color = data.error ? 'text-red-400' : 'text-green-400';
                logEl.innerHTML += `<div class="${color}">[${new Date().toLocaleTimeString()}] ${data.message}</div>`;

                if (data.error) {
                    logEl.innerHTML += `<div class="text-red-500">[ERROR] ${data.error}</div>`;
                }

                // Auto-scroll to bottom
                logEl.scrollTop = logEl.scrollHeight;
            } else if (data.type === 'done') {
                showDeploySuccess();
            }
        }

        function showDeploySuccess() {
            const resultEl = document.getElementById('deployResult');
            resultEl.classList.remove('hidden');
            resultEl.className = 'mt-4 p-4 rounded bg-green-100 border-2 border-green-500';
            resultEl.innerHTML = `
                <div class="flex items-center gap-2 text-green-700">
                    <i class="bi bi-check-circle-fill text-2xl"></i>
                    <div>
                        <div class="font-bold">Deployment Successful!</div>
                        <div class="text-sm">All services have been updated.</div>
                    </div>
                </div>
            `;
            document.getElementById('deployCloseBtn').classList.remove('hidden');
            loadDeploymentStatus(); // Refresh version badges
        }

        function showDeployError(message) {
            const resultEl = document.getElementById('deployResult');
            resultEl.classList.remove('hidden');
            resultEl.className = 'mt-4 p-4 rounded bg-red-100 border-2 border-red-500';
            resultEl.innerHTML = `
                <div class="flex items-center gap-2 text-red-700">
                    <i class="bi bi-x-circle-fill text-2xl"></i>
                    <div>
                        <div class="font-bold">Deployment Failed</div>
                        <div class="text-sm">${message}</div>
                    </div>
                </div>
            `;
            document.getElementById('deployCloseBtn').classList.remove('hidden');
        }

        // Rollback function
        async function rollback(target) {
            if (!confirm(`Are you sure you want to rollback the ${target} deployment to the previous version?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/deployments/${deploymentConfigId}/rollback`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ targets: [target] })
                });

                const data = await response.json();

                if (data.success) {
                    alert('Rollback initiated successfully!');
                    loadDeploymentStatus();
                } else {
                    alert('Rollback failed: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Rollback failed: ' + error.message);
            }
        }

        // Show deployment history
        async function showDeployHistory() {
            document.getElementById('historyModal').classList.remove('hidden');
            document.getElementById('historyTableBody').innerHTML = '<tr><td colspan="5" class="text-center py-4">Loading...</td></tr>';

            try {
                const response = await fetch(`/api/deployments/${deploymentConfigId}/history?limit=20`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.history && data.history.length > 0) {
                    document.getElementById('historyTableBody').innerHTML = data.history.map(h => {
                        const statusClass = {
                            'success': 'bg-green-100 text-green-800',
                            'failed': 'bg-red-100 text-red-800',
                            'building': 'bg-blue-100 text-blue-800',
                            'deploying': 'bg-yellow-100 text-yellow-800',
                            'rolled_back': 'bg-orange-100 text-orange-800'
                        }[h.status] || 'bg-gray-100 text-gray-800';

                        const startTime = new Date(h.started_at).toLocaleString();
                        const duration = h.completed_at ?
                            Math.round((new Date(h.completed_at) - new Date(h.started_at)) / 1000) + 's' :
                            'In progress...';

                        return `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="px-4 py-2 font-mono">${h.version}</td>
                                <td class="px-4 py-2">
                                    <span class="px-2 py-1 rounded text-xs font-bold ${statusClass}">${h.status}</span>
                                </td>
                                <td class="px-4 py-2">${h.deployed_by_name || 'System'}</td>
                                <td class="px-4 py-2">${startTime}</td>
                                <td class="px-4 py-2">${duration}</td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    document.getElementById('historyTableBody').innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No deployment history found</td></tr>';
                }
            } catch (error) {
                document.getElementById('historyTableBody').innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">Error: ${error.message}</td></tr>`;
            }
        }

        // Load deployment status on page load
        loadDeploymentStatus();
    </script>
</body>
</html>
