<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n-page-title="page_title_events">Events - Cold Storage Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        * {
            font-family: 'Space Grotesk', sans-serif;
        }
        .neu-border {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            transition: all 0.2s ease;
        }
        .neu-border:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #000;
        }
        .table-header {
            background: #a8e0ff;
        }
        .row-seed {
            background: #dcfce7 !important;
            border-left: 4px solid #22c55e;
        }
        .row-sell {
            background: #fed7aa !important;
            border-left: 4px solid #f97316;
        }
        .row-other {
            background: #f3f4f6 !important;
        }
        .category-seed {
            background: #22c55e;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-weight: 600;
            display: inline-block;
        }
        .category-sell {
            background: #f97316;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-weight: 600;
            display: inline-block;
        }
        .status-main {
            background: #3b82f6;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-weight: 600;
            font-size: 0.75rem;
            display: inline-block;
        }
        .status-room {
            background: #8b5cf6;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-weight: 600;
            font-size: 0.75rem;
            display: inline-block;
        }
        .row-main {
            background: #dbeafe !important;
            border-left: 4px solid #3b82f6;
        }
        .row-room {
            background: #ede9fe !important;
            border-left: 4px solid #8b5cf6;
        }
        .lang-selector {
            border: 2px solid #000;
            box-shadow: 2px 2px 0px #000;
        }
    </style>
</head>
<body class="bg-[#DFCCFB] min-h-screen p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8 neu-border bg-white p-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-4xl font-bold flex items-center gap-3">
                        <i class="bi bi-calendar-event text-purple-600"></i>
                        <span data-i18n="events_activity">Events & Activity</span>
                    </h1>
                    <p class="text-gray-600 mt-2" data-i18n="recent_entries_activity">Recent entries and system activity</p>
                </div>
                <nav class="flex gap-4 items-center">
                    <select id="langSelector" onchange="i18n.setLanguage(this.value)"
                            class="lang-selector bg-white px-3 py-2 text-sm font-medium cursor-pointer">
                        <option value="en">EN</option>
                        <option value="hi">हिं</option>
                    </select>
                    <button class="neu-border bg-[#98EECC] px-6 py-2" onclick="window.location.href='/dashboard'">
                        <i class="bi bi-grid"></i> <span data-i18n="dashboard">Dashboard</span>
                    </button>
                    <button id="viewToggle" class="neu-border bg-[#FFD93D] px-6 py-2" onclick="toggleView()">
                        <i class="bi bi-clock-history"></i> <span id="viewToggleText" data-i18n="show_all_events">Show All Events</span>
                    </button>
                    <button class="neu-border bg-[#4edcff] px-6 py-2" onclick="refreshData()">
                        <i class="bi bi-arrow-clockwise"></i> <span data-i18n="refresh">Refresh</span>
                    </button>
                </nav>
            </div>
            <div class="mt-4 inline-block bg-gradient-to-r from-purple-500 to-blue-500 text-white px-4 py-2 border-2 border-black shadow-[3px_3px_0_#000]">
                <i class="bi bi-person-circle"></i> <span id="userName" data-i18n="loading">Loading...</span>
            </div>
        </header>

        <!-- Entry Status Section -->
        <div class="neu-border bg-white p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4">
                <i class="bi bi-graph-up text-green-600"></i> <span data-i18n="entry_status_overview">Entry Status Overview</span>
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="p-4 bg-green-50 border-2 border-black">
                    <p class="text-sm text-gray-600" data-i18n="total_entries">Total Entries</p>
                    <p id="totalEntries" class="text-3xl font-bold">...</p>
                </div>
                <div class="p-4 bg-blue-50 border-2 border-black">
                    <p class="text-sm text-gray-600" data-i18n="room_entries">Room Entries</p>
                    <p id="totalRoomEntries" class="text-3xl font-bold">...</p>
                </div>
                <div class="p-4 bg-purple-50 border-2 border-black">
                    <p class="text-sm text-gray-600" data-i18n="seed_category">SEED Category</p>
                    <p id="seedEntries" class="text-3xl font-bold">...</p>
                </div>
                <div class="p-4 bg-orange-50 border-2 border-black">
                    <p class="text-sm text-gray-600" data-i18n="sell_category">SELL Category</p>
                    <p id="sellEntries" class="text-3xl font-bold">...</p>
                </div>
            </div>
        </div>

        <!-- Combined Activity Log Section -->
        <div class="neu-border bg-white p-6">
            <h2 class="text-2xl font-bold mb-4">
                <i class="bi bi-activity text-purple-600"></i> <span data-i18n="all_activity_log">All Activity Log</span>
            </h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="table-header">
                        <tr>
                            <th class="p-3 text-left border-2 border-black" data-i18n="truck_number">Truck Number</th>
                            <th class="p-3 text-left border-2 border-black" data-i18n="category">Category</th>
                            <th class="p-3 text-left border-2 border-black" data-i18n="customer_name">Customer Name</th>
                            <th class="p-3 text-left border-2 border-black" data-i18n="phone">Phone</th>
                            <th class="p-3 text-left border-2 border-black" data-i18n="village">Village</th>
                            <th class="p-3 text-left border-2 border-black" data-i18n="room_floor_gate">Room/Floor/Gate</th>
                            <th class="p-3 text-left border-2 border-black" data-i18n="quantity">Quantity</th>
                            <th class="p-3 text-left border-2 border-black" data-i18n="entry_created">Entry Created</th>
                            <th class="p-3 text-left border-2 border-black" data-i18n="room_allocated">Room Allocated</th>
                            <th class="p-3 text-left border-2 border-black" data-i18n="status">Status</th>
                        </tr>
                    </thead>
                    <tbody id="activityLogBody">
                        <tr><td colspan="10" class="text-center p-4" data-i18n="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- i18n Script -->
    <script src="/static/js/i18n.js"></script>

    <script>
        const token = localStorage.getItem('token');
        let showAllEvents = false; // Track view mode: false = recent (10), true = all

        // Capitalize first letter of text
        function capitalizeText(text) {
            if (!text || text.length === 0) return text;
            return text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();
        }

        // Load and display user name
        (function() {
            const userStr = localStorage.getItem('user');
            if (userStr) {
                try {
                    const user = JSON.parse(userStr);
                    document.getElementById('userName').textContent = capitalizeText(user.name) || user.email || 'User';
                } catch (error) {
                    console.error('Error parsing user data:', error);
                    document.getElementById('userName').textContent = 'User';
                }
            } else {
                document.getElementById('userName').textContent = 'User';
            }
        })();

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('en-IN', {
                year: 'numeric',
                month: 'short',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getCategory(truckNumber) {
            if (!truckNumber) return '-';
            const num = parseInt(truckNumber);
            if (num >= 1 && num <= 1500) return 'SEED';
            if (num >= 1501 && num <= 3000) return 'SELL';
            return '-';
        }

        function getCategoryClass(category) {
            if (category === 'SEED') return 'category-seed';
            if (category === 'SELL') return 'category-sell';
            return '';
        }

        function getRowClass(truckNumber) {
            const category = getCategory(truckNumber);
            if (category === 'SEED') return 'row-seed';
            if (category === 'SELL') return 'row-sell';
            return 'row-other';
        }

        async function loadActivityLog() {
            try {
                // Fetch all data including users
                const [entriesRes, roomEntriesRes, usersRes] = await Promise.all([
                    fetch('/api/entries', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('/api/room-entries', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('/api/users', { headers: { 'Authorization': `Bearer ${token}` } })
                ]);

                const entries = await entriesRes.json();
                const roomEntries = await roomEntriesRes.json();
                const users = await usersRes.json();

                // Create user lookup map
                const userMap = {};
                users.forEach(user => {
                    userMap[user.id] = capitalizeText(user.name);
                });

                // Group by truck number
                const truckMap = new Map();

                // Process main entries
                entries.forEach(entry => {
                    const truckNum = entry.truck_number;
                    if (!truckMap.has(truckNum)) {
                        truckMap.set(truckNum, {
                            truck_number: truckNum,
                            customer_name: entry.name,
                            phone: entry.phone,
                            village: entry.village,
                            quantity: entry.expected_quantity || 0,
                            main_entry_time: entry.created_at,
                            main_entry_user: userMap[entry.created_by_user_id] || `User #${entry.created_by_user_id}`,
                            room_entry_time: null,
                            room_entry_user: null,
                            room: null,
                            floor: null,
                            gate: null,
                            room_quantity: null,
                            latest_time: new Date(entry.created_at).getTime()
                        });
                    }
                });

                // Process room entries
                roomEntries.forEach(entry => {
                    const truckNum = entry.truck_number;
                    if (truckMap.has(truckNum)) {
                        const existing = truckMap.get(truckNum);
                        existing.room = entry.room_no;
                        existing.floor = entry.floor;
                        existing.gate = entry.gate_no;
                        existing.room_quantity = entry.quantity;
                        existing.room_entry_time = entry.created_at;
                        existing.room_entry_user = userMap[entry.created_by_user_id] || `User #${entry.created_by_user_id}`;
                        existing.latest_time = Math.max(existing.latest_time, new Date(entry.created_at).getTime());
                    }
                });

                // Convert to array and sort by latest activity
                let activities = Array.from(truckMap.values());
                activities.sort((a, b) => b.latest_time - a.latest_time);

                // Apply view mode filter
                const displayActivities = showAllEvents ? activities : activities.slice(0, 20);

                const tbody = document.getElementById('activityLogBody');
                if (displayActivities.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" class="text-center p-4">' + i18n.t('no_activity_found', 'No activity found') + '</td></tr>';
                    return;
                }

                const expectedLabel = i18n.t('expected_label', 'Expected:');
                const storedLabel = i18n.t('stored_label', 'Stored:');
                const bagsLabel = i18n.t('bags', 'bags');
                const byLabel = i18n.t('by', 'by');
                const roomLabel = i18n.t('room', 'Room');
                const floorLabel = i18n.t('floor', 'Floor');
                const gateLabel = i18n.t('gatar', 'Gate');
                const awaitingStorageText = i18n.t('awaiting_storage', 'Awaiting Storage');
                const completeText = i18n.t('status_complete', 'COMPLETE');
                const pendingStorageText = i18n.t('status_pending_storage', 'PENDING STORAGE');

                tbody.innerHTML = displayActivities.map(activity => {
                    const category = getCategory(activity.truck_number);
                    const categoryClass = getCategoryClass(category);
                    const hasRoom = activity.room !== null;
                    const rowClass = hasRoom ? 'row-room' : 'row-main';
                    const statusClass = hasRoom ? 'status-room' : 'status-main';
                    const statusText = hasRoom ? completeText : pendingStorageText;

                    const roomInfo = hasRoom ?
                        `${roomLabel} ${activity.room} / ${floorLabel} ${activity.floor} / ${gateLabel} ${activity.gate}` :
                        `<span class="text-orange-600 font-semibold">${awaitingStorageText}</span>`;

                    return `
                    <tr class="${rowClass} hover:opacity-80 transition-opacity">
                        <td class="p-3 border-2 border-black font-bold text-lg">${activity.truck_number || '-'}</td>
                        <td class="p-3 border-2 border-black">
                            <span class="${categoryClass}">${category}</span>
                        </td>
                        <td class="p-3 border-2 border-black font-semibold">${capitalizeText(activity.customer_name) || '-'}</td>
                        <td class="p-3 border-2 border-black">${activity.phone || '-'}</td>
                        <td class="p-3 border-2 border-black">${capitalizeText(activity.village) || '-'}</td>
                        <td class="p-3 border-2 border-black text-purple-700 font-semibold">${roomInfo}</td>
                        <td class="p-3 border-2 border-black">
                            <div class="text-sm">${expectedLabel} <span class="font-bold">${activity.quantity}</span></div>
                            ${hasRoom ? `<div class="text-sm text-green-700">${storedLabel} <span class="font-bold">${activity.room_quantity} ${bagsLabel}</span></div>` : ''}
                        </td>
                        <td class="p-3 border-2 border-black text-sm">
                            <div class="font-semibold">${formatDateTime(activity.main_entry_time)}</div>
                            <div class="text-xs text-blue-600">${byLabel} ${activity.main_entry_user}</div>
                        </td>
                        <td class="p-3 border-2 border-black text-sm">
                            ${hasRoom ? `
                                <div class="font-semibold">${formatDateTime(activity.room_entry_time)}</div>
                                <div class="text-xs text-purple-600">${byLabel} ${activity.room_entry_user}</div>
                            ` : '<span class="text-gray-400">-</span>'}
                        </td>
                        <td class="p-3 border-2 border-black">
                            <span class="${statusClass}">${statusText}</span>
                        </td>
                    </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading activity log:', error);
                document.getElementById('activityLogBody').innerHTML =
                    '<tr><td colspan="10" class="text-center p-4 text-red-600">' + i18n.t('error_loading_data', 'Error loading data') + '</td></tr>';
            }
        }

        async function loadEntryStatus() {
            try {
                const [entriesRes, roomEntriesRes] = await Promise.all([
                    fetch('/api/entries', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('/api/room-entries', { headers: { 'Authorization': `Bearer ${token}` } })
                ]);

                const entries = await entriesRes.json();
                const roomEntries = await roomEntriesRes.json();

                // Count SEED and SELL categories based on truck number
                const seedEntries = entries.filter(e => {
                    const num = parseInt(e.truck_number);
                    return num >= 1 && num <= 1500;
                }).length;

                const sellEntries = entries.filter(e => {
                    const num = parseInt(e.truck_number);
                    return num >= 1501 && num <= 3000;
                }).length;

                // Update UI
                document.getElementById('totalEntries').textContent = entries.length || 0;
                document.getElementById('totalRoomEntries').textContent = roomEntries.length || 0;
                document.getElementById('seedEntries').textContent = seedEntries || 0;
                document.getElementById('sellEntries').textContent = sellEntries || 0;

            } catch (error) {
                console.error('Error loading entry status:', error);
                ['totalEntries', 'totalRoomEntries', 'seedEntries', 'sellEntries'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = 'Error';
                });
            }
        }

        async function refreshData() {
            // Load all data in parallel
            await Promise.all([
                loadActivityLog(),
                loadEntryStatus()
            ]);

            // Show notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-[#a8e0ff] neu-border p-4 rounded-md';
            notification.textContent = i18n.t('data_refreshed', 'Data refreshed successfully!');
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // Load data on page load
        window.addEventListener('load', refreshData);

        // Toggle between recent and all events view
        function toggleView() {
            showAllEvents = !showAllEvents;
            const toggleText = document.getElementById('viewToggleText');
            const toggleBtn = document.getElementById('viewToggle');

            if (showAllEvents) {
                toggleText.textContent = i18n.t('show_recent_events', 'Show Recent Events');
                toggleBtn.classList.remove('bg-[#FFD93D]');
                toggleBtn.classList.add('bg-[#FF6B9D]');
            } else {
                toggleText.textContent = i18n.t('show_all_events', 'Show All Events');
                toggleBtn.classList.remove('bg-[#FF6B9D]');
                toggleBtn.classList.add('bg-[#FFD93D]');
            }

            // Reload data with new view mode
            refreshData();
        }

        // Auto-refresh data every 30 seconds
        setInterval(() => {
            console.log('Auto-refreshing events data...');
            refreshData();
        }, 30000);
    </script>
</body>
</html>
