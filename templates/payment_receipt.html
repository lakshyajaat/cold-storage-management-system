<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Receipt</title>
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link href="/static/css/arbitrary.css" rel="stylesheet">
    <style>
        @media print {
            .no-print {
                display: none;
            }
            @page {
                size: A5;
                margin: 10mm;
            }
        }
        .receipt-border {
            border: 3px solid #000;
            box-shadow: 5px 5px 0 #000;
        }
        .verification-code {
            font-family: monospace;
            word-break: break-all;
            background: #f0f0f0;
            padding: 10px;
            border: 2px dashed #000;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="max-w-2xl mx-auto bg-white receipt-border p-6">
        <!-- Print Button -->
        <div class="no-print mb-4 text-right">
            <button onclick="window.print()" class="bg-blue-600 text-white px-4 py-2 font-bold border-2 border-black shadow-[4px_4px_0_0_#000] hover:shadow-none transition-all">
                üñ®Ô∏è Print Receipt
            </button>
        </div>

        <!-- Company Header -->
        <div class="text-center mb-6 pb-4 border-b-4 border-black">
            <h1 class="text-3xl font-black mb-2">COLD STORAGE</h1>
            <p class="text-sm font-semibold">PAYMENT RECEIPT</p>
        </div>

        <!-- Receipt Details -->
        <div class="mb-6">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <p class="text-xs text-gray-600 font-semibold">RECEIPT NO:</p>
                    <p id="receiptNumber" class="text-lg font-black">-</p>
                </div>
                <div class="text-right">
                    <p class="text-xs text-gray-600 font-semibold">DATE:</p>
                    <p id="paymentDate" class="text-lg font-black">-</p>
                </div>
            </div>

            <div class="border-2 border-black p-4 mb-4">
                <p class="text-xs text-gray-600 font-semibold mb-2">RECEIVED FROM:</p>
                <p id="customerName" class="text-xl font-black mb-1">-</p>
                <p id="customerPhone" class="text-sm font-semibold">-</p>
                <p id="customerVillage" class="text-sm font-semibold">-</p>
            </div>

            <div class="border-2 border-black p-4 bg-yellow-50">
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <div>
                        <p class="text-xs text-gray-600 font-semibold">AMOUNT PAID:</p>
                        <p id="amountPaid" class="text-2xl font-black text-green-700">‚Çπ-</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-600 font-semibold">TOTAL RENT:</p>
                        <p id="totalRent" class="text-lg font-bold">‚Çπ-</p>
                    </div>
                </div>
                <div class="border-t-2 border-black pt-3">
                    <p class="text-xs text-gray-600 font-semibold">BALANCE DUE:</p>
                    <p id="balance" class="text-xl font-black text-red-700">‚Çπ-</p>
                </div>
            </div>

            <div class="mt-4" id="notesSection" style="display: none;">
                <p class="text-xs text-gray-600 font-semibold mb-1">NOTES:</p>
                <p id="notes" class="text-sm border-2 border-black p-2">-</p>
            </div>
        </div>

        <!-- Verification Code -->
        <div class="border-t-4 border-black pt-4 mt-6">
            <p class="text-xs text-gray-600 font-semibold mb-2">VERIFICATION CODE:</p>
            <div class="verification-code text-xs" id="verificationCode">
                Generating verification code...
            </div>
            <p class="text-xs text-gray-500 mt-2 italic">
                This encrypted code verifies the authenticity of this receipt. Keep this receipt safe for your records.
            </p>
        </div>

        <!-- Employee/Collector Info -->
        <div class="mt-6 border-2 border-black p-3 bg-blue-50">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <i class="bi bi-person-badge text-blue-600"></i>
                    <span class="text-xs font-semibold text-gray-700">COLLECTED BY:</span>
                </div>
                <span id="processedBy" class="font-black text-sm">Loading...</span>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-6 text-center border-t-4 border-black pt-4">
            <p class="text-xs font-semibold">Thank you for your business!</p>
            <p class="text-xs text-gray-600 mt-1">For any queries, please contact us.</p>
        </div>
    </div>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const receiptNumber = urlParams.get('receipt');

        if (!receiptNumber) {
            alert('No receipt number provided');
            window.close();
        }

        // Fetch receipt data
        async function loadReceipt() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('Not authenticated');
                    window.location.href = '/login';
                    return;
                }

                const response = await fetch(`/api/rent-payments/receipt/${receiptNumber}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load receipt');
                }

                const payment = await response.json();
                displayReceipt(payment);
            } catch (error) {
                console.error('Error loading receipt:', error);
                alert('Failed to load receipt: ' + error.message);
            }
        }

        async function displayReceipt(payment) {
            document.getElementById('receiptNumber').textContent = payment.receipt_number;
            document.getElementById('paymentDate').textContent = new Date(payment.payment_date).toLocaleString('en-IN');
            document.getElementById('customerName').textContent = payment.customer_name;
            document.getElementById('customerPhone').textContent = payment.customer_phone;
            document.getElementById('amountPaid').textContent = '‚Çπ' + payment.amount_paid.toFixed(2);
            document.getElementById('totalRent').textContent = '‚Çπ' + payment.total_rent.toFixed(2);
            document.getElementById('balance').textContent = '‚Çπ' + payment.balance.toFixed(2);

            if (payment.notes && payment.notes.trim() !== '') {
                document.getElementById('notes').textContent = payment.notes;
                document.getElementById('notesSection').style.display = 'block';
            }

            // Fetch and display employee who processed the payment
            if (payment.processed_by_user_id) {
                await fetchEmployeeDetails(payment.processed_by_user_id);
            }

            // Generate verification code
            generateVerificationCode(payment);
        }

        async function fetchEmployeeDetails(userId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/users/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('processedBy').textContent = `${user.name} (${user.role})`;
                } else {
                    document.getElementById('processedBy').textContent = 'Employee ID: ' + userId;
                }
            } catch (error) {
                console.error('Error fetching employee details:', error);
                document.getElementById('processedBy').textContent = 'Employee ID: ' + userId;
            }
        }

        async function generateVerificationCode(payment) {
            try {
                // Create data string for hashing (including employee ID for security)
                const dataString = `${payment.receipt_number}|${payment.amount_paid}|${payment.payment_date}|${payment.customer_phone}|${payment.processed_by_user_id}`;

                // Use a secret key (in production, this should come from server)
                const secretKey = 'COLD-STORAGE-2025-SECRET-KEY';

                // Encode the data
                const encoder = new TextEncoder();
                const data = encoder.encode(dataString);
                const key = encoder.encode(secretKey);

                // Import the key for HMAC
                const cryptoKey = await crypto.subtle.importKey(
                    'raw',
                    key,
                    { name: 'HMAC', hash: 'SHA-256' },
                    false,
                    ['sign']
                );

                // Generate HMAC
                const signature = await crypto.subtle.sign('HMAC', cryptoKey, data);

                // Convert to hex string
                const hashArray = Array.from(new Uint8Array(signature));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

                // Display verification code
                document.getElementById('verificationCode').textContent = hashHex.toUpperCase();
            } catch (error) {
                console.error('Error generating verification code:', error);
                document.getElementById('verificationCode').textContent = 'Error generating code';
            }
        }

        // Load receipt on page load
        loadReceipt();
    </script>
</body>
</html>
