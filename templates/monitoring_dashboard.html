<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Dashboard - Cold Storage</title>
    <link rel="stylesheet" href="/static/css/bootstrap-icons.min.css">
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link href="/static/css/arbitrary.css" rel="stylesheet">
    <link href="/static/css/fonts.css" rel="stylesheet">
    <link href="/static/css/dark-mode.css" rel="stylesheet">
    <script src="/static/js/prefetch.js?v=2"></script>
    <script src="/static/js/chart.umd.min.js"></script>
    <style>
        * { font-family: 'Space Grotesk', sans-serif; }
        .neu-border { border: 3px solid #000; box-shadow: 4px 4px 0 #000; }
        .status-healthy { background: #10b981; }
        .status-warning { background: #f59e0b; }
        .status-critical { background: #ef4444; }
        .status-unknown { background: #6b7280; }
        .severity-critical { background: #fef2f2; border-left: 4px solid #ef4444; }
        .severity-warning { background: #fffbeb; border-left: 4px solid #f59e0b; }
        .severity-info { background: #eff6ff; border-left: 4px solid #3b82f6; }
        .tab-active { background: #000; color: #fff; }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .metric-card { transition: transform 0.2s; }
        .metric-card:hover { transform: translateY(-2px); }
    </style>
    <script src="/static/js/theme.js"></script>
</head>
<body class="bg-gray-100">
    <!-- Navigation -->
    <nav class="bg-black text-white px-4 md:px-6 py-3 md:py-4">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
            <div class="flex items-center gap-4">
                <a href="/admin/dashboard" class="hover:text-gray-300"><i class="bi bi-arrow-left"></i> Dashboard</a>
                <span class="text-xl md:text-2xl font-bold"><i class="bi bi-graph-up-arrow"></i> Monitoring</span>
            </div>
            <div class="flex flex-wrap items-center gap-2 md:gap-4 w-full md:w-auto">
                <select id="timeRange" onchange="changeTimeRange()" class="bg-gray-800 text-white px-3 py-2 rounded text-sm">
                    <option value="5m">Last 5 min</option>
                    <option value="15m">Last 15 min</option>
                    <option value="1h" selected>Last 1 hour</option>
                    <option value="6h">Last 6 hours</option>
                    <option value="24h">Last 24 hours</option>
                    <option value="7d">Last 7 days</option>
                </select>
                <button onclick="theme.toggle()" class="bg-gray-700 px-3 py-2 rounded hover:bg-gray-600 text-sm" title="Toggle Dark Mode">
                    <i class="bi bi-moon-fill theme-icon-moon"></i>
                    <i class="bi bi-sun-fill theme-icon-sun hidden"></i>
                </button>
                <button onclick="refreshAll()" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700 text-sm">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                <span id="lastUpdate" class="text-sm text-gray-400">--:--:--</span>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-4 md:p-6">
        <!-- Tabs -->
        <div class="flex flex-wrap gap-2 mb-6 overflow-x-auto">
            <button onclick="showTab('overview')" id="tab-overview" class="neu-border px-4 py-2 tab-active">
                <i class="bi bi-grid-1x2"></i> Overview
            </button>
            <button onclick="showTab('nodes')" id="tab-nodes" class="neu-border px-4 py-2 bg-white">
                <i class="bi bi-hdd-stack"></i> K3s Nodes
            </button>
            <button onclick="showTab('postgres')" id="tab-postgres" class="neu-border px-4 py-2 bg-white">
                <i class="bi bi-database"></i> PostgreSQL
            </button>
            <button onclick="showTab('api')" id="tab-api" class="neu-border px-4 py-2 bg-white">
                <i class="bi bi-braces"></i> API Analytics
            </button>
            <button onclick="showTab('alerts')" id="tab-alerts" class="neu-border px-4 py-2 bg-white">
                <i class="bi bi-bell"></i> Alerts
            </button>
        </div>

        <!-- Overview Tab -->
        <div id="content-overview" class="tab-content">
            <!-- Summary Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="neu-border bg-white p-4 metric-card">
                    <div class="text-sm text-gray-600">K3s Nodes</div>
                    <div id="summary-nodes" class="text-2xl font-bold">-/-</div>
                    <div class="text-xs text-green-600"><i class="bi bi-check-circle"></i> Healthy</div>
                </div>
                <div class="neu-border bg-white p-4 metric-card">
                    <div class="text-sm text-gray-600">PostgreSQL</div>
                    <div id="summary-postgres" class="text-2xl font-bold">-/-</div>
                    <div class="text-xs text-green-600"><i class="bi bi-check-circle"></i> Primary + Replicas</div>
                </div>
                <div class="neu-border bg-white p-4 metric-card">
                    <div class="text-sm text-gray-600">API Requests (1h)</div>
                    <div id="summary-requests" class="text-2xl font-bold">-</div>
                    <div id="summary-error-rate" class="text-xs">Error rate: --%</div>
                </div>
                <div class="neu-border bg-white p-4 metric-card">
                    <div class="text-sm text-gray-600">Active Alerts</div>
                    <div id="summary-alerts" class="text-2xl font-bold">-</div>
                    <div id="summary-alerts-breakdown" class="text-xs">- critical, - warning</div>
                </div>
            </div>

            <!-- Cluster Resources -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="neu-border bg-white p-4">
                    <div class="text-sm text-gray-600 mb-2">Cluster CPU</div>
                    <div class="flex items-center gap-2">
                        <div class="flex-1 bg-gray-200 rounded-full h-4">
                            <div id="cluster-cpu-bar" class="bg-blue-500 h-4 rounded-full" style="width: 0%"></div>
                        </div>
                        <span id="cluster-cpu-pct" class="font-bold">--%</span>
                    </div>
                    <div id="cluster-cpu-cores" class="text-xs text-gray-500 mt-1">- cores</div>
                </div>
                <div class="neu-border bg-white p-4">
                    <div class="text-sm text-gray-600 mb-2">Cluster Memory</div>
                    <div class="flex items-center gap-2">
                        <div class="flex-1 bg-gray-200 rounded-full h-4">
                            <div id="cluster-mem-bar" class="bg-green-500 h-4 rounded-full" style="width: 0%"></div>
                        </div>
                        <span id="cluster-mem-pct" class="font-bold">--%</span>
                    </div>
                    <div id="cluster-mem-used" class="text-xs text-gray-500 mt-1">- / - GB</div>
                </div>
                <div class="neu-border bg-white p-4">
                    <div class="text-sm text-gray-600 mb-2">Cluster Disk</div>
                    <div class="flex items-center gap-2">
                        <div class="flex-1 bg-gray-200 rounded-full h-4">
                            <div id="cluster-disk-bar" class="bg-purple-500 h-4 rounded-full" style="width: 0%"></div>
                        </div>
                        <span id="cluster-disk-pct" class="font-bold">--%</span>
                    </div>
                    <div id="cluster-disk-used" class="text-xs text-gray-500 mt-1">- / - GB</div>
                </div>
            </div>

            <!-- Backup Database Status -->
            <div class="neu-border bg-white p-4 mb-6">
                <h3 class="font-bold mb-4"><i class="bi bi-hdd-rack"></i> Backup Database Server (192.168.15.195)</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    <div class="p-3 bg-gray-50 rounded border">
                        <div class="text-xs text-gray-500">Status</div>
                        <div id="backup-db-status" class="font-bold flex items-center gap-1">
                            <span class="w-2 h-2 rounded-full bg-gray-400"></span> Loading...
                        </div>
                    </div>
                    <div class="p-3 bg-gray-50 rounded border">
                        <div class="text-xs text-gray-500">Container</div>
                        <div id="backup-db-container" class="font-bold text-sm">cold-storage-postgres</div>
                    </div>
                    <div class="p-3 bg-gray-50 rounded border">
                        <div class="text-xs text-gray-500">Last Backup</div>
                        <div id="backup-db-last" class="font-bold text-sm">--</div>
                    </div>
                    <div class="p-3 bg-gray-50 rounded border">
                        <div class="text-xs text-gray-500">Total Backups</div>
                        <div id="backup-db-total" class="font-bold text-sm">--</div>
                    </div>
                    <div class="p-3 bg-gray-50 rounded border">
                        <div class="text-xs text-gray-500">Backup Size</div>
                        <div id="backup-db-size" class="font-bold text-sm">--</div>
                    </div>
                    <div class="p-3 bg-gray-50 rounded border">
                        <div class="text-xs text-gray-500">Schedule</div>
                        <div id="backup-db-schedule" class="font-bold text-sm">--</div>
                    </div>
                    <div class="p-3 bg-gray-50 rounded border">
                        <div class="text-xs text-gray-500">CPU</div>
                        <div id="backup-db-cpu" class="font-bold text-sm">--%</div>
                    </div>
                    <div class="p-3 bg-gray-50 rounded border">
                        <div class="text-xs text-gray-500">Memory</div>
                        <div id="backup-db-mem" class="font-bold text-sm">--%</div>
                    </div>
                    <div class="p-3 bg-gray-50 rounded border">
                        <div class="text-xs text-gray-500">Disk</div>
                        <div id="backup-db-disk" class="font-bold text-sm">-- / --</div>
                    </div>
                    <div class="p-3 bg-gray-50 rounded border">
                        <div class="text-xs text-gray-500">NAS Archive</div>
                        <div id="backup-db-nas" class="font-bold text-sm">--</div>
                    </div>
                    <div class="p-3 bg-orange-50 rounded border">
                        <div class="text-xs text-gray-500">Offsite (69.169.105.219)</div>
                        <div id="backup-db-offsite-status" class="font-bold text-sm flex items-center gap-1">
                            <span class="w-2 h-2 rounded-full bg-gray-400"></span> Checking...
                        </div>
                    </div>
                    <div class="p-3 bg-orange-50 rounded border">
                        <div class="text-xs text-gray-500">Offsite Snapshots</div>
                        <div id="backup-db-offsite-snapshots" class="font-bold text-sm">--</div>
                    </div>
                </div>
            </div>

            <!-- K3s Node Charts Row -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="neu-border bg-white p-4">
                    <h3 class="font-bold mb-2"><i class="bi bi-cpu text-blue-500"></i> Node CPU Usage (%)</h3>
                    <div style="height: 250px;">
                        <canvas id="cpuChart"></canvas>
                    </div>
                </div>
                <div class="neu-border bg-white p-4">
                    <h3 class="font-bold mb-2"><i class="bi bi-memory text-green-500"></i> Node Memory Usage (%)</h3>
                    <div style="height: 250px;">
                        <canvas id="memoryChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- PostgreSQL Charts Row -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="neu-border bg-white p-4">
                    <h3 class="font-bold mb-2"><i class="bi bi-plug text-purple-500"></i> PostgreSQL Connections</h3>
                    <div style="height: 220px;">
                        <canvas id="pgConnectionsChart"></canvas>
                    </div>
                </div>
                <div class="neu-border bg-white p-4">
                    <h3 class="font-bold mb-2"><i class="bi bi-lightning text-yellow-500"></i> Cache Hit Ratio (%)</h3>
                    <div style="height: 220px;">
                        <canvas id="pgCacheHitChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="neu-border bg-white p-4">
                    <h3 class="font-bold mb-2"><i class="bi bi-hdd text-red-500"></i> DB Size (MB)</h3>
                    <div style="height: 220px;">
                        <canvas id="pgDbSizeChart"></canvas>
                    </div>
                </div>
                <div class="neu-border bg-white p-4">
                    <h3 class="font-bold mb-2"><i class="bi bi-arrow-repeat text-orange-500"></i> Replication Lag</h3>
                    <div style="height: 220px;">
                        <canvas id="pgReplLagChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Alerts -->
            <div class="neu-border bg-white p-4">
                <h3 class="font-bold mb-4"><i class="bi bi-bell"></i> Recent Alerts</h3>
                <div id="recent-alerts" class="space-y-2">
                    <div class="text-gray-500 text-center py-4">No recent alerts</div>
                </div>
            </div>
        </div>

        <!-- Nodes Tab -->
        <div id="content-nodes" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6" id="nodes-grid">
            </div>
            <div class="neu-border bg-white p-4">
                <h3 class="font-bold mb-2">Node Metrics History</h3>
                <select id="nodeSelect" onchange="loadNodeHistory()" class="border px-3 py-1 mb-4">
                    <option value="">Select a node</option>
                </select>
                <canvas id="nodeHistoryChart" height="300"></canvas>
            </div>
        </div>

        <!-- PostgreSQL Tab -->
        <div id="content-postgres" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="neu-border bg-white p-4">
                    <div class="text-sm text-gray-600">Total Size</div>
                    <div id="pg-total-size" class="text-2xl font-bold">- GB</div>
                </div>
                <div class="neu-border bg-white p-4">
                    <div class="text-sm text-gray-600">Connections</div>
                    <div id="pg-connections" class="text-2xl font-bold">-</div>
                </div>
                <div class="neu-border bg-white p-4">
                    <div class="text-sm text-gray-600">Max Repl. Lag</div>
                    <div id="pg-repl-lag" class="text-2xl font-bold">- s</div>
                </div>
                <div class="neu-border bg-white p-4">
                    <div class="text-sm text-gray-600">Cache Hit Ratio</div>
                    <div id="pg-cache-ratio" class="text-2xl font-bold">--%</div>
                </div>
            </div>
            <div class="neu-border bg-white p-4">
                <h3 class="font-bold mb-4"><i class="bi bi-database"></i> PostgreSQL Pods</h3>
                <table class="w-full text-sm">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-2 text-left">Pod</th>
                            <th class="p-2 text-left">Role</th>
                            <th class="p-2 text-left">Status</th>
                            <th class="p-2 text-left">Node</th>
                            <th class="p-2 text-left">DB Size</th>
                            <th class="p-2 text-left">Connections</th>
                            <th class="p-2 text-left">Repl. Lag</th>
                            <th class="p-2 text-left">Sync %</th>
                            <th class="p-2 text-left">Cache Hit</th>
                        </tr>
                    </thead>
                    <tbody id="postgres-pods-table"></tbody>
                </table>
            </div>
        </div>

        <!-- API Analytics Tab -->
        <div id="content-api" class="tab-content hidden">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="neu-border bg-white p-4">
                    <div class="text-sm text-gray-600">Total Requests</div>
                    <div id="api-total" class="text-2xl font-bold">-</div>
                </div>
                <div class="neu-border bg-white p-4">
                    <div class="text-sm text-gray-600">Success Rate</div>
                    <div id="api-success-rate" class="text-2xl font-bold text-green-600">--%</div>
                </div>
                <div class="neu-border bg-white p-4">
                    <div class="text-sm text-gray-600">Avg Response Time</div>
                    <div id="api-avg-time" class="text-2xl font-bold">- ms</div>
                </div>
                <div class="neu-border bg-white p-4">
                    <div class="text-sm text-gray-600">P95 Response Time</div>
                    <div id="api-p95-time" class="text-2xl font-bold">- ms</div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="neu-border bg-white p-4">
                    <h3 class="font-bold mb-2"><i class="bi bi-fire"></i> Top Endpoints</h3>
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 text-left">Path</th>
                                <th class="p-2 text-right">Requests</th>
                                <th class="p-2 text-right">Avg (ms)</th>
                                <th class="p-2 text-right">Errors</th>
                            </tr>
                        </thead>
                        <tbody id="top-endpoints-table"></tbody>
                    </table>
                </div>
                <div class="neu-border bg-white p-4">
                    <h3 class="font-bold mb-2"><i class="bi bi-hourglass-split"></i> Slowest Endpoints</h3>
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 text-left">Path</th>
                                <th class="p-2 text-right">Avg (ms)</th>
                                <th class="p-2 text-right">P95 (ms)</th>
                                <th class="p-2 text-right">Max (ms)</th>
                            </tr>
                        </thead>
                        <tbody id="slowest-endpoints-table"></tbody>
                    </table>
                </div>
            </div>

            <div class="neu-border bg-white p-4">
                <h3 class="font-bold mb-4"><i class="bi bi-list"></i> Recent API Logs</h3>
                <table class="w-full text-xs">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-2 text-left">Time</th>
                            <th class="p-2 text-left">Method</th>
                            <th class="p-2 text-left">Path</th>
                            <th class="p-2 text-center">Status</th>
                            <th class="p-2 text-right">Duration</th>
                            <th class="p-2 text-left">User</th>
                            <th class="p-2 text-left">IP</th>
                        </tr>
                    </thead>
                    <tbody id="api-logs-table"></tbody>
                </table>
                <div class="mt-4 flex justify-center gap-2">
                    <button onclick="loadAPILogs(Math.max(0, apiLogsOffset - 50))" class="px-3 py-1 border">Previous</button>
                    <span id="api-logs-pagination" class="px-3 py-1">-</span>
                    <button onclick="loadAPILogs(apiLogsOffset + 50)" class="px-3 py-1 border">Next</button>
                </div>
            </div>
        </div>

        <!-- Alerts Tab -->
        <div id="content-alerts" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="neu-border bg-white p-4">
                    <h3 class="font-bold mb-4"><i class="bi bi-exclamation-triangle"></i> Active Alerts</h3>
                    <div id="active-alerts" class="space-y-2">
                        <div class="text-gray-500 text-center py-4">No active alerts</div>
                    </div>
                </div>
                <div class="neu-border bg-white p-4">
                    <h3 class="font-bold mb-4"><i class="bi bi-sliders"></i> Alert Thresholds</h3>
                    <div id="alert-thresholds" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/monitoring';
        let token = localStorage.getItem('token');
        let currentTimeRange = '1h';
        let cpuChart, memoryChart, nodeHistoryChart;
        let pgConnectionsChart, pgCacheHitChart, pgDbSizeChart, pgReplLagChart;
        let apiLogsOffset = 0;

        function authHeaders() {
            return { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
        }

        function formatBytes(bytes) {
            if (!bytes || bytes === 0) return '--';
            const tb = bytes / (1024 * 1024 * 1024 * 1024);
            if (tb >= 1) return tb.toFixed(1) + ' TB';
            const gb = bytes / (1024 * 1024 * 1024);
            return gb.toFixed(0) + ' GB';
        }

        function formatLagBytes(bytes) {
            if (bytes === 0) return '0';
            if (bytes < 0) return 'N/A';
            if (bytes < 1024) return Math.round(bytes) + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        async function fetchAPI(endpoint, options = {}) {
            try {
                const res = await fetch(`${API_BASE}${endpoint}`, {
                    ...options,
                    headers: { ...authHeaders(), ...options.headers }
                });
                if (res.status === 401) {
                    window.location.href = '/login';
                    return null;
                }
                return await res.json();
            } catch (e) {
                console.error('API Error:', e);
                return null;
            }
        }

        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.classList.remove('tab-active');
                el.classList.add('bg-white');
            });
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            document.getElementById(`tab-${tab}`).classList.remove('bg-white');

            if (tab === 'nodes') loadNodes();
            if (tab === 'postgres') loadPostgres();
            if (tab === 'api') loadAPIAnalytics();
            if (tab === 'alerts') loadAlerts();
        }

        function changeTimeRange() {
            currentTimeRange = document.getElementById('timeRange').value;
            refreshAll();
        }

        async function loadOverview() {
            const data = await fetchAPI('/dashboard');
            if (!data) return;

            if (data.cluster_overview) {
                const c = data.cluster_overview;
                document.getElementById('summary-nodes').textContent = `${c.healthy_nodes}/${c.total_nodes}`;
                document.getElementById('cluster-cpu-pct').textContent = `${(c.avg_cpu_percent || 0).toFixed(1)}%`;
                document.getElementById('cluster-cpu-bar').style.width = `${c.avg_cpu_percent || 0}%`;
                document.getElementById('cluster-cpu-cores').textContent = `${c.total_cpu_cores} cores`;
                document.getElementById('cluster-mem-pct').textContent = `${(c.avg_memory_percent || 0).toFixed(1)}%`;
                document.getElementById('cluster-mem-bar').style.width = `${c.avg_memory_percent || 0}%`;
                document.getElementById('cluster-mem-used').textContent = `${(c.used_memory_gb || 0).toFixed(1)} / ${(c.total_memory_gb || 0).toFixed(1)} GB`;
                document.getElementById('cluster-disk-pct').textContent = `${(c.avg_disk_percent || 0).toFixed(1)}%`;
                document.getElementById('cluster-disk-bar').style.width = `${c.avg_disk_percent || 0}%`;
                document.getElementById('cluster-disk-used').textContent = `${(c.used_disk_gb || 0).toFixed(1)} / ${(c.total_disk_gb || 0).toFixed(1)} GB`;
            }

            if (data.postgres_overview) {
                document.getElementById('summary-postgres').textContent = `${data.postgres_overview.healthy_pods}/${data.postgres_overview.total_pods}`;
            }

            if (data.api_analytics) {
                document.getElementById('summary-requests').textContent = (data.api_analytics.total_requests || 0).toLocaleString();
                const errorRate = data.api_analytics.error_rate || 0;
                document.getElementById('summary-error-rate').textContent = `Error rate: ${errorRate.toFixed(2)}%`;
                document.getElementById('summary-error-rate').className = `text-xs ${errorRate > 5 ? 'text-red-600' : 'text-green-600'}`;
            }

            if (data.alert_summary) {
                document.getElementById('summary-alerts').textContent = data.alert_summary.unresolved_alerts || 0;
                document.getElementById('summary-alerts-breakdown').textContent = `${data.alert_summary.critical_alerts || 0} critical, ${data.alert_summary.warning_alerts || 0} warning`;
            }

            if (data.nodes && data.nodes.length > 0) updateNodeCharts(data.nodes);
            if (data.recent_alerts) renderRecentAlerts(data.recent_alerts);

            // Load backup DB status
            loadBackupDBStatus();

            // Load PostgreSQL charts
            loadPgCharts();

            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        async function loadBackupDBStatus() {
            try {
                const data = await fetchAPI('/backup-db');
                if (!data) return;

                // Update status
                const statusEl = document.getElementById('backup-db-status');
                if (data.healthy) {
                    statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> Healthy';
                    statusEl.className = 'font-bold flex items-center gap-1 text-green-600';
                } else {
                    statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500"></span> Unhealthy';
                    statusEl.className = 'font-bold flex items-center gap-1 text-red-600';
                }

                // Update other fields
                document.getElementById('backup-db-last').textContent = data.last_backup || '--';
                document.getElementById('backup-db-total').textContent = data.total_backups || 0;
                document.getElementById('backup-db-size').textContent = data.backup_size || '--';
                document.getElementById('backup-db-schedule').textContent = data.backup_schedule || '--';
                document.getElementById('backup-db-cpu').textContent = `${(data.cpu_percent || 0).toFixed(1)}%`;
                document.getElementById('backup-db-mem').textContent = `${(data.memory_percent || 0).toFixed(1)}%`;
                document.getElementById('backup-db-disk').textContent = `${data.disk_used || '--'} / ${data.disk_total || '--'}`;
                document.getElementById('backup-db-nas').textContent = data.nas_archive_size || '--';

                // Offsite backup status
                const offsiteStatusEl = document.getElementById('backup-db-offsite-status');
                if (data.offsite_reachable) {
                    offsiteStatusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> Online';
                    offsiteStatusEl.className = 'font-bold text-sm flex items-center gap-1 text-green-600';
                } else {
                    offsiteStatusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500"></span> Offline';
                    offsiteStatusEl.className = 'font-bold text-sm flex items-center gap-1 text-red-600';
                }
                document.getElementById('backup-db-offsite-snapshots').textContent = data.offsite_snapshots || '0';
            } catch (e) {
                console.error('Failed to load backup DB status:', e);
            }
        }

        function updateNodeCharts(nodes) {
            // Sort: k3s nodes first, then backup server
            const sortedNodes = nodes.sort((a, b) => {
                if (a.node_name.startsWith('k3s-') && !b.node_name.startsWith('k3s-')) return -1;
                if (!a.node_name.startsWith('k3s-') && b.node_name.startsWith('k3s-')) return 1;
                return a.node_name.localeCompare(b.node_name);
            });

            const labels = sortedNodes.map(n => n.node_name.replace('k3s-', '').replace('backup-server', 'backup'));
            const cpuData = sortedNodes.map(n => n.cpu_percent || 0);
            const memData = sortedNodes.map(n => n.memory_percent || 0);

            // Color based on value
            const cpuColors = cpuData.map(v => v < 50 ? '#22c55e' : v < 75 ? '#f59e0b' : '#ef4444');
            const memColors = memData.map(v => v < 60 ? '#3b82f6' : v < 80 ? '#f59e0b' : '#ef4444');

            const chartConfig = {
                type: 'bar',
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { font: { size: 11, weight: '600' } } },
                        y: { beginAtZero: true, max: 100, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { callback: v => v + '%' } }
                    }
                }
            };

            if (cpuChart) cpuChart.destroy();
            cpuChart = new Chart(document.getElementById('cpuChart'), {
                ...chartConfig,
                data: { labels, datasets: [{ data: cpuData, backgroundColor: cpuColors, borderRadius: 6, barThickness: 35 }] }
            });

            if (memoryChart) memoryChart.destroy();
            memoryChart = new Chart(document.getElementById('memoryChart'), {
                ...chartConfig,
                data: { labels, datasets: [{ data: memData, backgroundColor: memColors, borderRadius: 6, barThickness: 35 }] }
            });
        }

        function initPgCharts() {
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false }, ticks: { font: { size: 10, weight: '600' } } },
                    y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } }
                }
            };

            pgConnectionsChart = new Chart(document.getElementById('pgConnectionsChart'), {
                type: 'bar',
                data: { labels: [], datasets: [{ data: [], backgroundColor: [], borderRadius: 6, barThickness: 30 }] },
                options: commonOptions
            });

            pgCacheHitChart = new Chart(document.getElementById('pgCacheHitChart'), {
                type: 'bar',
                data: { labels: [], datasets: [{ data: [], backgroundColor: [], borderRadius: 6, barThickness: 30 }] },
                options: { ...commonOptions, scales: { ...commonOptions.scales, y: { ...commonOptions.scales.y, min: 90, max: 100, ticks: { callback: v => v + '%' } } } }
            });

            pgDbSizeChart = new Chart(document.getElementById('pgDbSizeChart'), {
                type: 'bar',
                data: { labels: [], datasets: [{ data: [], backgroundColor: [], borderRadius: 6, barThickness: 30 }] },
                options: commonOptions
            });

            pgReplLagChart = new Chart(document.getElementById('pgReplLagChart'), {
                type: 'bar',
                data: { labels: [], datasets: [{ data: [], backgroundColor: [], borderRadius: 6, barThickness: 30 }] },
                options: commonOptions
            });
        }

        async function loadPgCharts() {
            try {
                const res = await fetch('/api/infrastructure/postgresql-pods', { headers: authHeaders() });
                const data = await res.json();
                if (!data.pods || data.pods.length === 0) return;

                const pods = data.pods;
                const labels = pods.map(p => {
                    if (p.name.includes('streaming-replica')) return 'ext-195';
                    return p.name.replace('cold-postgres-', 'pg-');
                });

                // Connections - color by role
                const connData = pods.map(p => parseInt(p.connections) || 0);
                const connColors = pods.map(p => p.role === 'Primary' ? '#3b82f6' : p.role === 'Metrics DB' ? '#8b5cf6' : '#22c55e');
                pgConnectionsChart.data.labels = labels;
                pgConnectionsChart.data.datasets[0].data = connData;
                pgConnectionsChart.data.datasets[0].backgroundColor = connColors;
                pgConnectionsChart.update('none');

                // Cache Hit
                const cacheData = pods.map(p => parseFloat(p.cache_hit) || 0);
                const cacheColors = cacheData.map(v => v >= 99 ? '#22c55e' : v >= 95 ? '#84cc16' : v >= 90 ? '#f59e0b' : '#ef4444');
                pgCacheHitChart.data.labels = labels;
                pgCacheHitChart.data.datasets[0].data = cacheData;
                pgCacheHitChart.data.datasets[0].backgroundColor = cacheColors;
                pgCacheHitChart.update('none');

                // DB Size (MB)
                const sizeData = pods.map(p => {
                    const size = p.disk_used || '0';
                    if (size.includes('MB')) return parseFloat(size);
                    if (size.includes('kB')) return parseFloat(size) / 1024;
                    if (size.includes('GB')) return parseFloat(size) * 1024;
                    return parseFloat(size) / (1024 * 1024) || 0;
                });
                const sizeColors = ['#8b5cf6', '#a78bfa', '#c4b5fd', '#ddd6fe', '#ede9fe'];
                pgDbSizeChart.data.labels = labels;
                pgDbSizeChart.data.datasets[0].data = sizeData;
                pgDbSizeChart.data.datasets[0].backgroundColor = labels.map((_, i) => sizeColors[i % sizeColors.length]);
                pgDbSizeChart.update('none');

                // Replication Lag
                const lagData = pods.map(p => {
                    if (p.role === 'Primary' || p.repl_lag === 'N/A') return 0;
                    const lag = p.repl_lag || '0';
                    if (lag.includes('KB')) return parseFloat(lag) * 1024;
                    if (lag.includes('MB')) return parseFloat(lag) * 1024 * 1024;
                    if (lag.includes('B')) return parseFloat(lag);
                    return parseFloat(lag) || 0;
                });
                const lagColors = lagData.map(v => v === 0 ? '#22c55e' : v < 1024 ? '#84cc16' : v < 10240 ? '#f59e0b' : '#ef4444');
                pgReplLagChart.data.labels = labels;
                pgReplLagChart.data.datasets[0].data = lagData;
                pgReplLagChart.data.datasets[0].backgroundColor = lagColors;
                pgReplLagChart.update('none');
            } catch (e) {
                console.error('Failed to load PG charts:', e);
            }
        }

        function renderRecentAlerts(alerts) {
            const container = document.getElementById('recent-alerts');
            if (!alerts || alerts.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-center py-4">No recent alerts</div>';
                return;
            }
            container.innerHTML = alerts.slice(0, 5).map(a => `
                <div class="p-3 severity-${a.severity}">
                    <div class="flex justify-between">
                        <span class="font-bold">${a.title}</span>
                        <span class="text-xs text-gray-500">${new Date(a.time).toLocaleString()}</span>
                    </div>
                    <div class="text-sm">${a.message}</div>
                </div>
            `).join('');
        }

        async function loadNodes() {
            const data = await fetchAPI('/nodes');
            if (!data || !data.nodes) return;

            document.getElementById('nodes-grid').innerHTML = data.nodes.map(n => `
                <div class="neu-border bg-white p-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold">${n.node_name}</span>
                        <span class="px-2 py-1 rounded text-xs ${n.node_status === 'Ready' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${n.node_status}</span>
                    </div>
                    <div class="text-xs text-gray-500 mb-3">${n.node_ip} | ${n.node_role}</div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span>CPU</span><span class="font-bold">${(n.cpu_percent || 0).toFixed(1)}%</span></div>
                        <div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-blue-500 h-2 rounded-full" style="width: ${n.cpu_percent || 0}%"></div></div>
                        <div class="flex justify-between"><span>Memory</span><span class="font-bold">${(n.memory_percent || 0).toFixed(1)}%</span></div>
                        <div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-green-500 h-2 rounded-full" style="width: ${n.memory_percent || 0}%"></div></div>
                        <div class="flex justify-between"><span>Disk</span><span class="font-bold">${(n.disk_percent || 0).toFixed(1)}%</span></div>
                        <div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-purple-500 h-2 rounded-full" style="width: ${n.disk_percent || 0}%"></div></div>
                        <div class="text-xs text-gray-500 text-right">${formatBytes(n.disk_used_bytes)} / ${formatBytes(n.disk_total_bytes)}</div>
                        <div class="flex justify-between text-gray-600"><span>Load Avg</span><span>${(n.load_average_1m || 0).toFixed(2)}</span></div>
                        <div class="flex justify-between text-gray-600"><span>Pods</span><span>${n.pod_count || 0}</span></div>
                    </div>
                </div>
            `).join('');

            const select = document.getElementById('nodeSelect');
            select.innerHTML = '<option value="">Select a node</option>' + data.nodes.map(n => `<option value="${n.node_name}">${n.node_name}</option>`).join('');
        }

        async function loadNodeHistory() {
            const nodeName = document.getElementById('nodeSelect').value;
            if (!nodeName) return;

            const data = await fetchAPI(`/nodes/${nodeName}/history?range=${currentTimeRange}`);
            if (!data || !data.metrics) return;

            const labels = data.metrics.map(m => new Date(m.time).toLocaleTimeString());
            const cpuData = data.metrics.map(m => m.cpu_percent || 0);
            const memData = data.metrics.map(m => m.memory_percent || 0);

            if (nodeHistoryChart) nodeHistoryChart.destroy();
            nodeHistoryChart = new Chart(document.getElementById('nodeHistoryChart'), {
                type: 'line',
                data: { labels, datasets: [{ label: 'CPU %', data: cpuData, borderColor: '#3b82f6', tension: 0.1 }, { label: 'Memory %', data: memData, borderColor: '#10b981', tension: 0.1 }] },
                options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }

        async function loadPostgres() {
            // Use real-time infrastructure API for live pod data with sync_pct
            const podsResponse = await fetch('/api/infrastructure/postgresql-pods', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const pods = await podsResponse.json();

            if (pods && pods.pods && pods.pods.length > 0) {
                // Calculate overview stats from real-time data
                let totalSize = 0, totalConn = 0, maxLag = 0, totalCacheHit = 0, cacheCount = 0;
                pods.pods.forEach(p => {
                    // Parse disk_used (e.g., "11 MB", "9787 kB")
                    const sizeMatch = (p.disk_used || '0').match(/([0-9.]+)\s*(MB|kB|GB|B)?/i);
                    if (sizeMatch) {
                        let size = parseFloat(sizeMatch[1]) || 0;
                        const unit = (sizeMatch[2] || 'B').toUpperCase();
                        if (unit === 'KB') size /= 1024;
                        else if (unit === 'GB') size *= 1024;
                        else if (unit === 'B') size /= (1024 * 1024);
                        totalSize += size;
                    }
                    // Connections
                    const conn = parseInt(p.connections) || 0;
                    totalConn += conn;
                    // Replication lag
                    if (p.repl_lag && p.repl_lag !== 'N/A') {
                        const lagMatch = p.repl_lag.match(/([0-9.]+)/);
                        if (lagMatch) maxLag = Math.max(maxLag, parseFloat(lagMatch[1]));
                    }
                    // Cache hit
                    const cacheMatch = (p.cache_hit || '0').match(/([0-9.]+)/);
                    if (cacheMatch) {
                        totalCacheHit += parseFloat(cacheMatch[1]);
                        cacheCount++;
                    }
                });

                document.getElementById('pg-total-size').textContent = `${(totalSize / 1024).toFixed(2)} GB`;
                document.getElementById('pg-connections').textContent = totalConn;
                document.getElementById('pg-repl-lag').textContent = maxLag === 0 ? '0' : maxLag;
                document.getElementById('pg-cache-ratio').textContent = `${(cacheCount > 0 ? totalCacheHit / cacheCount : 0).toFixed(1)}%`;

                // Render pods table
                document.getElementById('postgres-pods-table').innerHTML = pods.pods.map(p => {
                    // Sync percentage display
                    let syncDisplay = 'N/A';
                    let syncClass = 'text-gray-400';
                    if (p.role !== 'Primary' && p.sync_pct !== undefined && p.sync_pct >= 0) {
                        syncDisplay = p.sync_pct.toFixed(1) + '%';
                        if (p.sync_pct >= 99.9) syncClass = 'text-green-600';
                        else if (p.sync_pct >= 95) syncClass = 'text-yellow-600';
                        else syncClass = 'text-red-600';
                    }
                    const replLag = p.role === 'Primary' ? 'N/A' : (p.repl_lag || '0');
                    return `
                    <tr class="border-t">
                        <td class="p-2">${p.name}</td>
                        <td class="p-2"><span class="px-2 py-1 rounded text-xs ${p.role === 'Primary' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100'}">${p.role}</span></td>
                        <td class="p-2"><span class="px-2 py-1 rounded text-xs ${p.status === 'Running' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${p.status}</span></td>
                        <td class="p-2">${p.node}</td>
                        <td class="p-2">${p.disk_used}</td>
                        <td class="p-2">${p.connections || 0} / ${p.max_conn || 200}</td>
                        <td class="p-2">${replLag}</td>
                        <td class="p-2 ${syncClass}">${syncDisplay}</td>
                        <td class="p-2">${p.cache_hit || 'N/A'}</td>
                    </tr>
                `}).join('');
            }
        }

        async function loadAPIAnalytics() {
            const analytics = await fetchAPI(`/api/analytics?range=${currentTimeRange}`);
            const topEndpoints = await fetchAPI(`/api/top-endpoints?range=${currentTimeRange}&limit=10`);
            const slowEndpoints = await fetchAPI(`/api/slowest-endpoints?range=${currentTimeRange}&limit=10`);

            if (analytics) {
                document.getElementById('api-total').textContent = (analytics.total_requests || 0).toLocaleString();
                const successRate = analytics.total_requests > 0 ? ((analytics.success_requests / analytics.total_requests) * 100).toFixed(2) : 0;
                document.getElementById('api-success-rate').textContent = `${successRate}%`;
                document.getElementById('api-avg-time').textContent = `${(analytics.avg_duration_ms || 0).toFixed(2)} ms`;
                document.getElementById('api-p95-time').textContent = `${(analytics.p95_duration_ms || 0).toFixed(2)} ms`;
            }

            if (topEndpoints && topEndpoints.endpoints) {
                document.getElementById('top-endpoints-table').innerHTML = topEndpoints.endpoints.map(e => `
                    <tr class="border-t">
                        <td class="p-2 truncate max-w-xs">${e.path}</td>
                        <td class="p-2 text-right">${e.total_requests}</td>
                        <td class="p-2 text-right">${(e.avg_duration_ms || 0).toFixed(2)}</td>
                        <td class="p-2 text-right ${e.error_count > 0 ? 'text-red-600' : ''}">${e.error_count || 0}</td>
                    </tr>
                `).join('');
            }

            if (slowEndpoints && slowEndpoints.endpoints) {
                document.getElementById('slowest-endpoints-table').innerHTML = slowEndpoints.endpoints.map(e => `
                    <tr class="border-t">
                        <td class="p-2 truncate max-w-xs">${e.path}</td>
                        <td class="p-2 text-right">${(e.avg_duration_ms || 0).toFixed(2)}</td>
                        <td class="p-2 text-right">${(e.p95_duration_ms || 0).toFixed(2)}</td>
                        <td class="p-2 text-right">${(e.max_duration_ms || 0).toFixed(2)}</td>
                    </tr>
                `).join('');
            }

            loadAPILogs(0);
        }

        async function loadAPILogs(offset) {
            apiLogsOffset = offset;
            const data = await fetchAPI(`/api/logs?limit=50&offset=${offset}`);
            if (!data || !data.logs) return;

            document.getElementById('api-logs-table').innerHTML = data.logs.map(l => `
                <tr class="border-t ${l.status_code >= 400 ? 'bg-red-50' : ''}">
                    <td class="p-2">${new Date(l.time).toLocaleTimeString()}</td>
                    <td class="p-2"><span class="px-1 rounded text-xs bg-gray-200">${l.method}</span></td>
                    <td class="p-2 truncate max-w-xs">${l.path}</td>
                    <td class="p-2 text-center"><span class="px-2 py-1 rounded text-xs ${l.status_code < 400 ? 'bg-green-100' : 'bg-red-100'}">${l.status_code}</span></td>
                    <td class="p-2 text-right">${(l.duration_ms || 0).toFixed(2)} ms</td>
                    <td class="p-2">${l.user_email || '-'}</td>
                    <td class="p-2">${l.ip_address || '-'}</td>
                </tr>
            `).join('');
            document.getElementById('api-logs-pagination').textContent = `${offset + 1} - ${offset + data.logs.length}`;
        }

        async function loadAlerts() {
            const active = await fetchAPI('/alerts/active');
            const thresholds = await fetchAPI('/alerts/thresholds');

            if (active && active.alerts) {
                const container = document.getElementById('active-alerts');
                if (active.alerts.length === 0) {
                    container.innerHTML = '<div class="text-gray-500 text-center py-4">No active alerts</div>';
                } else {
                    container.innerHTML = active.alerts.map(a => `
                        <div class="p-3 severity-${a.severity}">
                            <div class="flex justify-between items-start">
                                <div>
                                    <span class="font-bold">${a.title}</span>
                                    <div class="text-sm">${a.message}</div>
                                    <div class="text-xs text-gray-500 mt-1">${new Date(a.time).toLocaleString()}</div>
                                </div>
                                <div class="flex gap-2">
                                    ${!a.acknowledged ? `<button onclick="acknowledgeAlert(${a.id})" class="text-xs px-2 py-1 border rounded hover:bg-gray-100">Acknowledge</button>` : ''}
                                    <button onclick="resolveAlert(${a.id})" class="text-xs px-2 py-1 bg-green-500 text-white rounded hover:bg-green-600">Resolve</button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            }

            if (thresholds && thresholds.thresholds) {
                document.getElementById('alert-thresholds').innerHTML = thresholds.thresholds.map(t => `
                    <div class="flex justify-between items-center p-2 border-b">
                        <div>
                            <div class="font-medium">${t.display_name || t.metric_name}</div>
                            <div class="text-xs text-gray-500">${t.description || ''}</div>
                        </div>
                        <div class="text-sm">
                            <span class="text-yellow-600">W: ${t.warning_threshold}</span> |
                            <span class="text-red-600">C: ${t.critical_threshold}</span>
                            <span class="ml-2 ${t.enabled ? 'text-green-600' : 'text-gray-400'}">${t.enabled ? 'Enabled' : 'Disabled'}</span>
                        </div>
                    </div>
                `).join('');
            }
        }

        async function acknowledgeAlert(id) {
            await fetchAPI(`/alerts/${id}/acknowledge`, { method: 'POST' });
            loadAlerts();
            loadOverview();
        }

        async function resolveAlert(id) {
            await fetchAPI(`/alerts/${id}/resolve`, { method: 'POST' });
            loadAlerts();
            loadOverview();
        }

        let lastRefreshTime = Date.now();
        let refreshInterval = 15000; // 15 seconds

        async function refreshAll() {
            // Add pulse animation during refresh
            document.querySelectorAll('.metric-card').forEach(el => el.classList.add('pulse'));

            await loadOverview();
            lastRefreshTime = Date.now();

            // Remove pulse animation
            setTimeout(() => {
                document.querySelectorAll('.metric-card').forEach(el => el.classList.remove('pulse'));
            }, 500);
        }

        function updateCountdown() {
            const elapsed = Math.floor((Date.now() - lastRefreshTime) / 1000);
            const remaining = Math.max(0, Math.floor(refreshInterval / 1000) - elapsed);
            const timeStr = new Date().toLocaleTimeString();
            document.getElementById('lastUpdate').textContent = `${timeStr} (${remaining}s)`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (!token) {
                window.location.href = '/login';
                return;
            }
            initPgCharts();
            loadOverview();
            setInterval(refreshAll, refreshInterval);
            setInterval(updateCountdown, 1000);
        });
    </script>
</body>
</html>
