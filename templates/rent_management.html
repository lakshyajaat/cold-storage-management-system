<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png?v=2">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Management - Cold Storage</title>
    <link rel="stylesheet" href="/static/css/bootstrap-icons.min.css">
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link href="/static/css/arbitrary.css" rel="stylesheet">
    <link href="/static/css/fonts.css" rel="stylesheet">
    <link href="/static/css/dark-mode.css" rel="stylesheet">
    <link href="/static/css/responsive.css" rel="stylesheet">
    <link href="/static/css/inventory-theme.css" rel="stylesheet">

    <style>
        * {
            font-family: 'Space Grotesk', sans-serif;
        }

        /* Tablet/Phone Portrait Optimizations */
        @media (max-width: 1023px) and (orientation: portrait) {
            body {
                font-size: 0.875rem;
            }
            .customer-card {
                margin-bottom: 0.5rem;
            }
            .badge {
                padding: 0.125rem 0.5rem;
                font-size: 0.625rem;
            }
            h1 { font-size: 1.125rem !important; }
            h2 { font-size: 1rem !important; }
            h3 { font-size: 0.875rem !important; }
        }
        .neu-border {
            border: 1px solid var(--border-color, #e0e6ed);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-radius: 16px;
            transition: all 0.2s ease;
        }
        .neu-border:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        .neu-input {
            border: 1px solid var(--border-color, #e0e6ed);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            padding: 0.75rem;
            font-size: 1rem;
            border-radius: 8px;
            background-color: #ffffff;
            color: #2c3e50;
        }
        .neu-button {
            border: 1px solid var(--border-color, #e0e6ed);
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .neu-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .customer-card {
            border: 1px solid var(--border-color, #e0e6ed);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 1rem;
            background: white;
            border-radius: 12px;
        }
        .customer-card.paid {
            border: 1px solid #22c55e;
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.2);
        }
        .truck-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .truck-list.expanded {
            max-height: 1000px;
        }
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            font-weight: 600;
        }
        /* Hide content by default until permission check passes */
        #mainContent {
            display: none;
        }
        #loadingScreen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
    </style>
<script src="/static/js/prefetch.js?v=5"></script>
    <script src="/static/js/theme.js"></script>
</head>
<body class="bg-[#f8fafb] min-h-screen p-2 sm:p-4 md:p-8">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="max-w-7xl mx-auto">
        <div class="neu-border bg-white p-4 md:p-8 text-center">
            <i class="bi bi-hourglass-split text-3xl md:text-4xl animate-pulse"></i>
            <p class="mt-3 md:mt-4 text-sm md:text-base">Verifying permissions...</p>
        </div>
    </div>

    <!-- Main Content (hidden by default) -->
    <div id="mainContent" class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 md:mb-8 neu-border bg-white p-3 md:p-6 gap-3 md:gap-4">
            <div>
                <div class="flex items-center gap-2 md:gap-3">
                    <i class="bi bi-wallet2 text-2xl md:text-4xl text-green-600"></i>
                    <div>
                        <h1 class="text-xl md:text-3xl font-bold">Account Management</h1>
                        <p class="text-gray-600 text-xs md:text-base hidden sm:block">Customer accounts and payment collection</p>
                    </div>
                </div>
            </div>
            <div class="flex flex-wrap gap-2">
                <button id="mergeCustomersBtn" onclick="openMergeModal()" class="neu-button bg-purple-500 text-white px-3 md:px-4 py-2" style="display: none;">
                    <i class="bi bi-people"></i> <span class="hidden sm:inline">Merge Customers</span>
                </button>
                <a href="/account/audit" class="neu-button bg-indigo-500 text-white px-3 md:px-4 py-2">
                    <i class="bi bi-journal-text"></i> <span class="hidden sm:inline">Audit</span>
                </a>
                <a href="/account/debtors" class="neu-button bg-red-500 text-white px-3 md:px-4 py-2">
                    <i class="bi bi-exclamation-triangle"></i> <span class="hidden sm:inline">Debtors</span>
                </a>
                <button onclick="theme.toggle()" class="neu-button bg-gray-200 px-2 md:px-3 py-2" title="Toggle Dark Mode">
                    <i class="bi bi-moon-fill theme-icon-moon"></i>
                    <i class="bi bi-sun-fill theme-icon-sun hidden"></i>
                </button>
                <button onclick="window.history.back()" class="neu-button bg-gray-200 px-3 md:px-4 py-2">
                    <i class="bi bi-arrow-left"></i> <span class="hidden sm:inline">Back</span>
                </button>
            </div>
        </header>

        <!-- Summary Cards -->
        <div class="grid grid-cols-3 md:grid-cols-6 gap-1 md:gap-6 mb-3 md:mb-8">
            <div class="neu-border bg-gradient-to-br from-green-400 to-green-600 text-white p-1.5 md:p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-[10px] md:text-sm opacity-90">Customers</p>
                        <p class="text-sm md:text-3xl font-bold" id="totalCustomers">0</p>
                    </div>
                    <i class="bi bi-people text-lg md:text-5xl opacity-50 hidden md:block"></i>
                </div>
            </div>

            <div class="neu-border bg-gradient-to-br from-blue-400 to-blue-600 text-white p-1.5 md:p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-[10px] md:text-sm opacity-90">Thoks</p>
                        <p class="text-sm md:text-3xl font-bold" id="totalThocks">0</p>
                    </div>
                    <i class="bi bi-truck text-lg md:text-5xl opacity-50 hidden md:block"></i>
                </div>
            </div>

            <div class="neu-border bg-gradient-to-br from-teal-400 to-teal-600 text-white p-1.5 md:p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-[10px] md:text-sm opacity-90">Qty</p>
                        <p class="text-sm md:text-3xl font-bold" id="totalQuantity">0</p>
                    </div>
                    <i class="bi bi-box-seam text-lg md:text-5xl opacity-50 hidden md:block"></i>
                </div>
            </div>

            <div class="neu-border bg-gradient-to-br from-yellow-400 to-yellow-600 text-white p-1.5 md:p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-[10px] md:text-sm opacity-90">Outstanding</p>
                        <p class="text-sm md:text-3xl font-bold" id="totalOutstanding">₹0</p>
                    </div>
                    <i class="bi bi-cash-stack text-lg md:text-5xl opacity-50 hidden md:block"></i>
                </div>
            </div>

            <a href="/account/debtors" class="neu-border bg-gradient-to-br from-red-400 to-red-600 text-white p-1.5 md:p-6 cursor-pointer">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-[10px] md:text-sm opacity-90">Debtors</p>
                        <p class="text-sm md:text-3xl font-bold" id="totalDebtors">0</p>
                    </div>
                    <i class="bi bi-exclamation-triangle text-lg md:text-5xl opacity-50 hidden md:block"></i>
                </div>
            </a>

            <div class="neu-border bg-gradient-to-br from-purple-400 to-purple-600 text-white p-1.5 md:p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-[10px] md:text-sm opacity-90">Collected</p>
                        <p class="text-sm md:text-3xl font-bold" id="totalCollected">₹0</p>
                    </div>
                    <i class="bi bi-check-circle text-lg md:text-5xl opacity-50 hidden md:block"></i>
                </div>
            </div>
        </div>

        <!-- Credit Out Summary Card -->
        <div class="neu-border bg-gradient-to-br from-orange-400 to-orange-600 text-white p-2 md:p-4 mb-3 md:mb-6 cursor-pointer" onclick="toggleCreditOutSection()">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2 md:gap-4">
                    <i class="bi bi-box-arrow-up-right text-2xl md:text-4xl"></i>
                    <div>
                        <p class="text-xs md:text-sm opacity-90">Items Out on Credit</p>
                        <p class="text-xl md:text-3xl font-bold"><span id="creditOutItems">0</span> items | ₹<span id="creditOutValue">0</span></p>
                    </div>
                </div>
                <div class="text-right">
                    <i class="bi bi-chevron-down text-xl md:text-2xl" id="creditOutChevron"></i>
                </div>
            </div>
        </div>

        <!-- Credit Out Details Section (Hidden by default) -->
        <div id="creditOutSection" class="hidden mb-3 md:mb-6">
            <div class="neu-border bg-white p-3 md:p-4">
                <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                    <i class="bi bi-box-arrow-up-right text-orange-500"></i> Items Taken Out on Credit
                </h3>
                <div id="creditOutList">
                    <p class="text-gray-500 text-center py-4">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Today's Collection Card -->
        <div class="neu-border bg-gradient-to-br from-lime-400 to-lime-600 text-white p-2 md:p-4 mb-3 md:mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2 md:gap-4">
                    <i class="bi bi-calendar-check text-2xl md:text-4xl"></i>
                    <div>
                        <p class="text-xs md:text-sm opacity-90">Today's Collection (by me)</p>
                        <p class="text-xl md:text-3xl font-bold" id="todaysCollection">₹0</p>
                    </div>
                </div>
                <div class="text-right hidden md:block">
                    <p class="text-xs opacity-75" id="todaysDate"></p>
                </div>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="neu-border bg-white p-2 md:p-4 mb-3 md:mb-6">
            <div class="flex flex-col md:flex-row gap-2 md:gap-4">
                <div class="flex-1">
                    <input
                        type="text"
                        id="searchInput"
                        class="w-full neu-input"
                        placeholder="Search by name, phone, S/O, village, or thock number..."
                        oninput="debouncedSearch()"
                        onkeydown="if(event.key === 'Enter') filterCustomers()"
                    >
                </div>
                <div class="flex gap-2">
                    <button onclick="filterCustomers()" class="neu-button bg-blue-500 text-white flex-1 md:flex-none">
                        <i class="bi bi-search"></i> Search
                    </button>
                    <button onclick="clearSearch()" class="neu-button bg-gray-300 flex-1 md:flex-none">
                        <i class="bi bi-x-circle"></i> Clear
                    </button>
                </div>
            </div>
        </div>

        <!-- Customer Accounts List -->
        <div id="customersContainer">
            <div class="text-center py-12">
                <i class="bi bi-hourglass-split text-6xl text-gray-400"></i>
                <p class="text-gray-600 mt-4">Loading customer accounts...</p>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white neu-border p-4 md:p-8 max-w-md w-full mx-2 md:mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-6">Collect Payment</h3>

            <div class="mb-4">
                <p class="text-sm text-gray-600">Customer</p>
                <p class="text-xl font-bold" id="paymentCustomerName">-</p>
            </div>

            <div class="mb-4">
                <p class="text-sm text-gray-600">Phone</p>
                <p class="text-lg" id="paymentCustomerPhone">-</p>
            </div>

            <div class="mb-6">
                <p class="text-sm text-gray-600">Total Outstanding</p>
                <p class="text-3xl font-bold text-red-600" id="paymentTotalAmount">₹0</p>
            </div>

            <!-- Family Member Selection -->
            <div class="mb-6" id="familyMemberSection" style="display: none;">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Pay for Family Member *
                </label>
                <select id="paymentFamilyMember" class="w-full neu-input" onchange="updatePaymentForFamilyMember()">
                    <option value="">-- Select Family Member --</option>
                </select>
                <div id="familyMemberBalance" class="mt-2 p-2 bg-yellow-50 border-2 border-yellow-200 hidden">
                    <p class="text-sm text-gray-600">Selected Member Balance</p>
                    <p class="text-xl font-bold text-red-600" id="selectedMemberBalance">₹0</p>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Payment Amount *
                </label>
                <input
                    type="number"
                    id="paymentAmount"
                    class="w-full neu-input"
                    placeholder="Enter amount"
                    step="0.01"
                    min="0"
                >
            </div>

            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Payment Method *
                </label>
                <div class="flex gap-4">
                    <div id="cashOption" onclick="selectPaymentMethod('cash')" class="flex-1 cursor-pointer neu-input p-4 text-center transition-all duration-200 bg-green-500 text-white border-green-600 border-2 shadow-lg scale-105">
                        <i class="bi bi-cash-stack text-2xl"></i>
                        <p class="font-bold mt-1">Cash</p>
                    </div>
                    <div id="onlineOption" onclick="selectPaymentMethod('online')" class="flex-1 cursor-pointer neu-input p-4 text-center transition-all duration-200">
                        <i class="bi bi-phone text-2xl"></i>
                        <p class="font-bold mt-1">Online</p>
                    </div>
                </div>
                <input type="hidden" id="paymentMethod" value="cash">
            </div>

            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Remark (Optional)
                </label>
                <input
                    type="text"
                    id="paymentRemark"
                    class="w-full neu-input"
                    placeholder="Enter remark"
                >
            </div>

            <div class="flex gap-4">
                <button id="collectPaymentBtn" onclick="processPayment()" class="flex-1 neu-button bg-green-500 text-white">
                    <i class="bi bi-check-circle"></i> Collect Payment
                </button>
                <button onclick="closePaymentModal()" class="flex-1 neu-button bg-gray-300">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Entry Reassignment Modal -->
    <div id="reassignModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white neu-border p-4 md:p-8 max-w-lg w-full mx-2 md:mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-arrow-left-right text-blue-600"></i>
                Change Thock Customer
            </h3>

            <div class="mb-4 p-3 bg-blue-50 border-2 border-blue-200">
                <p class="text-sm text-gray-600">Current Assignment</p>
                <p class="font-bold">Thock #<span id="reassignThockNumber">-</span></p>
                <p class="text-sm">Customer: <span id="reassignCurrentCustomer" class="font-semibold">-</span></p>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Search New Customer *
                </label>
                <input
                    type="text"
                    id="reassignCustomerSearch"
                    class="w-full neu-input"
                    placeholder="Search by name or phone..."
                    oninput="searchCustomersForReassign()"
                >
            </div>

            <div class="mb-4 max-h-48 overflow-y-auto" id="reassignCustomerResults">
                <p class="text-gray-500 text-sm p-4 text-center">Type to search customers...</p>
            </div>

            <div class="mb-4 p-3 bg-green-50 border-2 border-green-200 hidden" id="reassignSelectedCustomer">
                <p class="text-sm text-gray-600">Selected Customer</p>
                <p class="font-bold" id="reassignNewCustomerName">-</p>
                <p class="text-sm" id="reassignNewCustomerPhone">-</p>
            </div>

            <input type="hidden" id="reassignEntryId">
            <input type="hidden" id="reassignNewCustomerId">
            <input type="hidden" id="reassignFamilyMemberId">
            <input type="hidden" id="reassignFamilyMemberName">

            <div class="flex gap-4">
                <button id="reassignSubmitBtn" onclick="submitReassign()" class="flex-1 neu-button bg-blue-500 text-white" disabled>
                    <i class="bi bi-arrow-left-right"></i> Reassign
                </button>
                <button onclick="closeReassignModal()" class="flex-1 neu-button bg-gray-300">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Change Family Member Modal -->
    <div id="changeFamilyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white neu-border p-4 md:p-8 max-w-lg w-full mx-2 md:mx-4">
            <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-person-fill text-purple-600"></i>
                Assign to Family Member
            </h3>

            <div class="mb-4 p-3 bg-purple-50 border-2 border-purple-200">
                <p class="text-sm text-gray-600">Thock</p>
                <p class="font-bold">Thock #<span id="changeFamilyThockNumber">-</span></p>
                <p class="text-sm">Current: <span id="changeFamilyCurrentMember" class="font-semibold">-</span></p>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Select Family Member *
                </label>
                <select id="changeFamilySelect" class="w-full neu-input">
                    <option value="">Loading...</option>
                </select>
            </div>

            <input type="hidden" id="changeFamilyEntryId">
            <input type="hidden" id="changeFamilyCustomerId">

            <div class="flex gap-4">
                <button id="changeFamilySubmitBtn" onclick="submitChangeFamilyMember()" class="flex-1 neu-button bg-purple-500 text-white">
                    <i class="bi bi-check-circle"></i> Assign
                </button>
                <button onclick="closeChangeFamilyModal()" class="flex-1 neu-button bg-gray-300">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Bulk Transfer Floating Toolbar -->
    <div id="bulkTransferToolbar" class="hidden fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-40 flex items-center gap-4 neu-border border-blue-800">
        <span class="font-bold"><span id="selectedCount">0</span> thock(s) selected</span>
        <button onclick="openBulkTransferModal()" class="neu-button bg-green-500 text-white py-2 px-4">
            <i class="bi bi-arrow-left-right"></i> Transfer
        </button>
        <button id="bulkDeleteBtn" onclick="bulkDeleteThocks()" class="hidden neu-button bg-red-600 text-white py-2 px-4">
            <i class="bi bi-trash"></i> Delete
        </button>
        <button onclick="clearBulkSelection()" class="neu-button bg-gray-500 text-white py-2 px-4">
            <i class="bi bi-x-circle"></i> Clear
        </button>
    </div>

    <!-- Bulk Transfer Modal -->
    <div id="bulkTransferModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white neu-border p-4 md:p-8 max-w-lg w-full mx-2 md:mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-arrow-left-right text-green-600"></i>
                Bulk Transfer Thocks
            </h3>

            <div class="mb-4 p-3 bg-green-50 border-2 border-green-200">
                <p class="text-sm text-gray-600">Selected Thocks</p>
                <div id="bulkTransferSelectedThocks" class="font-bold text-sm max-h-32 overflow-y-auto"></div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Search Destination Customer *
                </label>
                <input
                    type="text"
                    id="bulkTransferCustomerSearch"
                    class="w-full neu-input"
                    placeholder="Search by name or phone..."
                    oninput="searchCustomersForBulkTransfer()"
                >
            </div>

            <div class="mb-4 max-h-48 overflow-y-auto" id="bulkTransferCustomerResults">
                <p class="text-gray-500 text-sm p-4 text-center">Type to search customers...</p>
            </div>

            <div class="mb-4 p-3 bg-blue-50 border-2 border-blue-200 hidden" id="bulkTransferSelectedCustomer">
                <p class="text-sm text-gray-600">Destination Customer</p>
                <p class="font-bold" id="bulkTransferNewCustomerName">-</p>
                <p class="text-sm" id="bulkTransferNewCustomerPhone">-</p>
            </div>

            <input type="hidden" id="bulkTransferNewCustomerId">

            <div class="flex gap-4">
                <button id="bulkTransferSubmitBtn" onclick="submitBulkTransfer()" class="flex-1 neu-button bg-green-500 text-white" disabled>
                    <i class="bi bi-arrow-left-right"></i> Transfer All
                </button>
                <button onclick="closeBulkTransferModal()" class="flex-1 neu-button bg-gray-300">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Customer Merge Modal -->
    <div id="mergeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white neu-border p-4 md:p-8 max-w-lg w-full mx-2 md:mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-people text-purple-600"></i>
                Merge Customers
            </h3>
            <p class="text-sm text-gray-600 mb-4">Move all entries from source customer to target customer. Source will be marked as merged (can be undone).</p>

            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="bi bi-arrow-right-circle text-purple-600"></i> Source Customer (will be merged) *
                </label>
                <input
                    type="text"
                    id="mergeSourceSearch"
                    class="w-full neu-input"
                    placeholder="Search source customer..."
                    oninput="searchCustomersForMerge('source')"
                >
                <div class="max-h-32 overflow-y-auto mt-2" id="mergeSourceResults"></div>
                <div class="p-2 bg-red-50 border-2 border-red-200 mt-2 hidden" id="mergeSourceSelected">
                    <span id="mergeSourceName" class="font-bold">-</span>
                    <span id="mergeSourcePhone" class="text-sm text-gray-600">-</span>
                    <span id="mergeSourceEntryCount" class="text-xs bg-blue-500 text-white px-2 py-1 rounded ml-2">0 entries</span>
                </div>
            </div>

            <div class="text-center mb-4">
                <i class="bi bi-arrow-down text-3xl text-purple-600"></i>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="bi bi-check-circle text-green-600"></i> Target Customer (will keep) *
                </label>
                <input
                    type="text"
                    id="mergeTargetSearch"
                    class="w-full neu-input"
                    placeholder="Search target customer..."
                    oninput="searchCustomersForMerge('target')"
                >
                <div class="max-h-32 overflow-y-auto mt-2" id="mergeTargetResults"></div>
                <div class="p-2 bg-green-50 border-2 border-green-200 mt-2 hidden" id="mergeTargetSelected">
                    <span id="mergeTargetName" class="font-bold">-</span>
                    <span id="mergeTargetPhone" class="text-sm text-gray-600">-</span>
                </div>
            </div>

            <input type="hidden" id="mergeSourceId">
            <input type="hidden" id="mergeTargetId">

            <div class="flex gap-4">
                <button id="mergeSubmitBtn" onclick="submitMerge()" class="flex-1 neu-button bg-purple-500 text-white" disabled>
                    <i class="bi bi-people"></i> Merge Customers
                </button>
                <button onclick="closeMergeModal()" class="flex-1 neu-button bg-gray-300">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        // Capitalize first letter function
        function capitalizeFirstLetter(input) {
            const value = input.value;
            if (value.length > 0) {
                input.value = value.charAt(0).toUpperCase() + value.slice(1);
            }
        }

        // Capitalize first letter of text (for outputs)
        function capitalizeText(text) {
            if (!text || text.length === 0) return text;
            return text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();
        }

        // Auto-apply capitalization to all text inputs
        document.addEventListener('DOMContentLoaded', function() {
            const textInputs = document.querySelectorAll('input[type="text"]:not([disabled]):not([type="email"]):not([type="tel"])');
            textInputs.forEach(input => {
                input.addEventListener('input', function() {
                    capitalizeFirstLetter(this);
                });
            });
        });

        const token = localStorage.getItem('token');
        let allCustomerAccounts = [];
        let currentPaymentCustomer = null;
        let rentPerItem = 0;
        let canManageEntries = false; // Permission flag for entry reassignment and customer merge
        let isAdmin = false; // Admin role flag for delete functionality
        let creditOutItems = []; // Items taken out via admin approval

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Toggle credit out section visibility
        function toggleCreditOutSection() {
            const section = document.getElementById('creditOutSection');
            const chevron = document.getElementById('creditOutChevron');
            section.classList.toggle('hidden');
            chevron.classList.toggle('bi-chevron-down');
            chevron.classList.toggle('bi-chevron-up');
        }

        // Load items taken out on credit
        async function loadCreditOutItems() {
            try {
                const response = await fetch('/api/debt-requests', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    if (response.status === 401) return;
                    const errorText = await response.text();
                    console.error('Debt requests API error:', response.status, errorText);
                    throw new Error(`Failed to load credit items: ${response.status} - ${errorText}`);
                }

                const allReqs = await response.json() || [];
                // Filter for ONLY used requests (items actually taken out on credit)
                creditOutItems = allReqs.filter(r => r.status === 'used');

                // Calculate totals
                const totalItems = creditOutItems.reduce((sum, r) => sum + (r.requested_quantity || 0), 0);
                const totalValue = totalItems * rentPerItem;

                // Update summary card
                document.getElementById('creditOutItems').textContent = totalItems;
                document.getElementById('creditOutValue').textContent = totalValue.toLocaleString('en-IN');

                // Render list
                renderCreditOutList();

            } catch (error) {
                console.error('Error loading credit out items:', error);
                document.getElementById('creditOutList').innerHTML = `
                    <p class="text-red-500 text-center py-4">Error: ${escapeHtml(error.message)}</p>
                `;
            }
        }

        // Render credit out items list
        function renderCreditOutList() {
            const container = document.getElementById('creditOutList');

            if (!creditOutItems || creditOutItems.length === 0) {
                container.innerHTML = `
                    <p class="text-gray-500 text-center py-4">
                        <i class="bi bi-check-circle text-green-500 text-2xl"></i><br>
                        No items taken out on credit
                    </p>
                `;
                return;
            }

            container.innerHTML = creditOutItems.map(item => {
                const itemValue = (item.requested_quantity || 0) * rentPerItem;
                return `
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center p-3 border-b border-gray-200 last:border-0 gap-2">
                        <div class="flex-1">
                            <p class="font-bold">${escapeHtml(item.customer_name)}</p>
                            <p class="text-sm text-gray-600">
                                <i class="bi bi-telephone"></i> ${escapeHtml(item.customer_phone)}
                                | <i class="bi bi-truck"></i> ${escapeHtml(item.thock_number)}
                            </p>
                            <p class="text-xs text-gray-500">
                                Approved: ${item.approved_at ? new Date(item.approved_at).toLocaleDateString('en-IN') : '-'}
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold text-orange-600">${item.requested_quantity} items</p>
                            <p class="text-red-600 font-bold">₹${itemValue.toLocaleString('en-IN')}</p>
                        </div>
                        <a href="/rent-management?phone=${encodeURIComponent(item.customer_phone)}" class="neu-button bg-blue-500 text-white text-sm px-3 py-1">
                            <i class="bi bi-cash-stack"></i> Collect
                        </a>
                    </div>
                `;
            }).join('');
        }

        // Decode JWT to get user info
        function decodeToken() {
            if (!token) {
                window.location.href = '/login';
                return null;
            }

            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));

                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error('Error decoding token:', error);
                window.location.href = '/login';
                return null;
            }
        }

        // Check permissions before allowing access
        async function checkAccountantPermission() {
            const user = decodeToken();
            if (!user) return false;

            // Check if user is admin or accountant role
            if (user.role === 'admin' || user.role === 'accountant') {
                // Admins always have manage entries access
                if (user.role === 'admin') {
                    canManageEntries = true;
                    isAdmin = true;
                }
                // Admins and accountants always have access
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                updateManageEntriesUI();
                return true;
            }

            // For employees, check has_accountant_access field from the API
            if (user.role === 'employee') {
                try {
                    const response = await fetch(`/api/users/${user.user_id}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to verify permissions');
                    }

                    const userData = await response.json();

                    // Check if employee has accountant access
                    if (!userData.has_accountant_access) {
                        alert('Access denied. You do not have accounting permissions.');
                        window.location.href = '/dashboard';
                        return false;
                    }

                    // Check if employee has manage entries permission
                    canManageEntries = userData.can_manage_entries || false;

                    // Employee has accountant access, show content
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    updateManageEntriesUI();
                    return true;

                } catch (error) {
                    console.error('Error verifying permissions:', error);
                    alert('Access denied. Unable to verify permissions.');
                    window.location.href = '/dashboard';
                    return false;
                }
            } else {
                // Unknown role, deny access
                alert('Access denied. This page is for accountants only.');
                window.location.href = '/dashboard';
                return false;
            }
        }

        // Show/hide manage entries UI based on permission
        function updateManageEntriesUI() {
            const mergeBtn = document.getElementById('mergeCustomersBtn');
            if (mergeBtn) {
                mergeBtn.style.display = canManageEntries ? 'inline-flex' : 'none';
            }
        }

        // Load all customer accounts - OPTIMIZED: Single API call instead of 5+
        async function loadCustomerAccounts(forceRefresh = false) {
            const startTime = performance.now();
            try {
                // Check authentication
                if (!token) {
                    window.location.href = '/login';
                    return;
                }

                // OPTIMIZED: Uses Redis cache (10 min TTL) unless force refresh
                const url = forceRefresh
                    ? '/api/accounts/summary?refresh=' + Date.now()  // Bust browser cache only
                    : '/api/accounts/summary';

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                        // Removed Cache-Control to allow Redis caching
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }
                    if (response.status === 403) {
                        alert('You do not have permission to view account data. Please contact an administrator.');
                        window.location.href = '/dashboard';
                        return;
                    }
                    throw new Error(`Failed to load accounts: ${await response.text()}`);
                }

                const summary = await response.json();
                const apiTime = (performance.now() - startTime).toFixed(0);
                console.log(`API: ${apiTime}ms | Customers: ${summary.total_customers} | X-Cache: ${response.headers.get('X-Cache') || 'unknown'}`);

                // Update summary cards immediately (fast feedback)
                updateSummaryFromServer(summary);

                // Store rent per item from server
                rentPerItem = summary.rent_per_item || 0;

                // Map server response to frontend format
                allCustomerAccounts = summary.customers.map(customer => ({
                    customer_id: customer.customer_id,
                    name: customer.name,
                    phone: customer.phone,
                    so: customer.so || '',
                    village: customer.village || 'N/A',
                    thocks: customer.thocks.map(t => ({
                        id: t.id,
                        thock_number: t.thock_number,
                        family_member_name: t.family_member_name,
                        quantity: t.quantity,
                        qtyDisplay: t.qty_display || t.quantity,
                        rent: t.rent,
                        date: t.date,
                        type: t.type
                    })),
                    payments: customer.payments || [],
                    familyMembers: (customer.family_members || []).map(fm => ({
                        id: fm.id,
                        name: fm.name,
                        relation: fm.relation || '',
                        quantity: fm.quantity,
                        rent: fm.rent,
                        paid: fm.paid,
                        balance: fm.balance,
                        canTakeOut: fm.can_take_out || 0,
                        thocks: fm.thocks || [],
                        payments: fm.payments || [],
                        ledgerPayments: fm.ledger_payments || []
                    })),
                    totalQuantity: customer.total_quantity,
                    totalRent: customer.total_rent,
                    totalPaid: customer.total_paid,
                    totalOutgoing: customer.total_outgoing,
                    outgoingRent: customer.outgoing_rent,
                    balance: customer.balance
                }));

                // Sort payments by date (newest first) for each customer
                allCustomerAccounts.forEach(customer => {
                    if (customer.payments) {
                        customer.payments.sort((a, b) => new Date(b.payment_date) - new Date(a.payment_date));
                    }
                });

                displayCustomerAccounts(allCustomerAccounts);
                updateSummaryFromServer(summary);

                // Fetch payments and calculate today's collection
                try {
                    const paymentsRes = await fetch('/api/rent-payments', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (paymentsRes.ok) {
                        const payments = await paymentsRes.json();
                        const today = new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Kolkata' });
                        const user = decodeToken();
                        const userId = user ? user.user_id : null;

                        // Calculate today's collection by current user
                        const todaysCollection = payments.filter(p => {
                            const paymentDate = new Date(p.payment_date).toLocaleDateString('en-CA', { timeZone: 'Asia/Kolkata' });
                            return paymentDate === today && p.processed_by_user_id === userId;
                        }).reduce((sum, p) => sum + (p.amount_paid || 0), 0);

                        document.getElementById('todaysCollection').textContent = '₹' + todaysCollection.toLocaleString('en-IN', {minimumFractionDigits: 2});
                        document.getElementById('todaysDate').textContent = new Date().toLocaleDateString('en-IN', { weekday: 'long', day: 'numeric', month: 'short' });
                    }
                } catch (paymentError) {
                    console.error('Error loading payments for today collection:', paymentError);
                }

            } catch (error) {
                console.error('Error loading customer accounts:', error);
                document.getElementById('customersContainer').innerHTML = `
                    <div class="neu-border bg-red-50 p-12 text-center">
                        <i class="bi bi-exclamation-triangle text-6xl text-red-500"></i>
                        <p class="text-red-600 mt-4 font-bold">Error loading accounts</p>
                        <p class="text-red-500 text-sm mt-2">${error.message}</p>
                        <button onclick="window.location.href='/login'" class="mt-4 neu-button bg-red-500 text-white">
                            <i class="bi bi-box-arrow-in-right"></i> Login Again
                        </button>
                    </div>
                `;
            }
        }

        // Update summary from server response (faster than recalculating)
        function updateSummaryFromServer(summary) {
            document.getElementById('totalCustomers').textContent = summary.total_customers;
            document.getElementById('totalThocks').textContent = summary.total_thocks;
            document.getElementById('totalQuantity').textContent = summary.total_quantity.toLocaleString('en-IN');
            document.getElementById('totalOutstanding').textContent = '₹' + summary.total_outstanding.toLocaleString('en-IN', {minimumFractionDigits: 2});
            document.getElementById('totalCollected').textContent = '₹' + summary.total_collected.toLocaleString('en-IN', {minimumFractionDigits: 2});
            // Calculate debtors count (customers with balance > 0)
            const debtorsCount = summary.customers ? summary.customers.filter(c => c.balance > 0).length : 0;
            document.getElementById('totalDebtors').textContent = debtorsCount;
        }

        function displayCustomerAccounts(accounts) {
            const container = document.getElementById('customersContainer');

            if (accounts.length === 0) {
                container.innerHTML = `
                    <div class="neu-border bg-white p-12 text-center">
                        <i class="bi bi-inbox text-6xl text-gray-400"></i>
                        <p class="text-gray-600 mt-4 text-lg">No customer accounts found</p>
                    </div>
                `;
                return;
            }

            // Progressive rendering: show first 20 immediately, then batch render rest
            const BATCH_SIZE = 20;
            const renderStart = performance.now();

            // Clear and render first batch immediately
            container.innerHTML = '';
            const firstBatch = accounts.slice(0, BATCH_SIZE);
            container.innerHTML = firstBatch.map((customer, index) => renderCustomerCard(customer, index)).join('');

            // Render remaining in background batches
            if (accounts.length > BATCH_SIZE) {
                let offset = BATCH_SIZE;
                const renderBatch = () => {
                    const batch = accounts.slice(offset, offset + BATCH_SIZE);
                    if (batch.length === 0) {
                        console.log(`Render complete: ${(performance.now() - renderStart).toFixed(0)}ms for ${accounts.length} customers`);
                        return;
                    }
                    const fragment = document.createElement('div');
                    fragment.innerHTML = batch.map((customer, idx) => renderCustomerCard(customer, offset + idx)).join('');
                    while (fragment.firstChild) {
                        container.appendChild(fragment.firstChild);
                    }
                    offset += BATCH_SIZE;
                    requestAnimationFrame(renderBatch); // Non-blocking
                };
                requestAnimationFrame(renderBatch);
            } else {
                console.log(`Render complete: ${(performance.now() - renderStart).toFixed(0)}ms for ${accounts.length} customers`);
            }
        }

        function renderCustomerCard(customer, index) {
            // Calculate SEED and SELL totals
            const seedThocks = customer.thocks.filter(t => {
                    const num = parseInt(t.thock_number);
                    return num >= 1 && num <= 1500;
                });
                const sellThocks = customer.thocks.filter(t => {
                    const num = parseInt(t.thock_number);
                    return num >= 1501 && num <= 3000;
                });

                const seedQuantity = seedThocks.reduce((sum, t) => sum + t.quantity, 0);
                const seedRent = seedThocks.reduce((sum, t) => sum + t.rent, 0);
                const sellQuantity = sellThocks.reduce((sum, t) => sum + t.quantity, 0);
                const sellRent = sellThocks.reduce((sum, t) => sum + t.rent, 0);

                // Calculate per-thock inventory (incoming vs outgoing)
                const thockInventory = new Map();
                customer.thocks.forEach(thock => {
                    if (!thockInventory.has(thock.thock_number)) {
                        thockInventory.set(thock.thock_number, {
                            thock_number: thock.thock_number,
                            incoming: 0,
                            outgoing: 0,
                            incomingRent: 0,
                            outgoingRent: 0
                        });
                    }
                    const inv = thockInventory.get(thock.thock_number);
                    if (thock.type === 'incoming') {
                        inv.incoming += thock.quantity;
                        inv.incomingRent += thock.rent;
                    } else {
                        inv.outgoing += Math.abs(thock.quantity);
                        inv.outgoingRent += Math.abs(thock.rent);
                    }
                });
                const inventoryArray = Array.from(thockInventory.values());
                const hasOutgoing = inventoryArray.some(inv => inv.outgoing > 0);

                // Debug logging
                if (customer.name.toLowerCase().includes('rakesh')) {
                    console.log('=== RAKESH DEBUG ===');
                    console.log('Total thocks:', customer.thocks.length);
                    console.log('Thocks:', customer.thocks);
                    console.log('Has outgoing:', hasOutgoing);
                    console.log('Inventory array:', inventoryArray);
                }

                return `
                <div class="customer-card ${customer.balance <= 0 ? 'paid' : ''}">
                    <div class="p-6">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <h3 class="text-2xl font-bold">${capitalizeText(customer.name)}</h3>
                                    ${customer.balance > 0 ? `
                                        <span class="badge bg-red-500 text-white">
                                            Outstanding: ₹${customer.balance.toLocaleString('en-IN', {minimumFractionDigits: 2})}
                                        </span>
                                    ` : `
                                        <span class="badge bg-green-500 text-white">
                                            <i class="bi bi-check-circle"></i> Paid
                                        </span>
                                    `}
                                </div>
                                <div class="flex gap-6 text-gray-600 mb-4">
                                    <div class="flex items-center gap-2">
                                        <i class="bi bi-telephone"></i>
                                        <span>${customer.phone}</span>
                                    </div>
                                    ${customer.so ? `
                                    <div class="flex items-center gap-2">
                                        <i class="bi bi-person"></i>
                                        <span>S/O: ${capitalizeText(customer.so)}</span>
                                    </div>
                                    ` : ''}
                                    <div class="flex items-center gap-2">
                                        <i class="bi bi-geo-alt"></i>
                                        <span>${capitalizeText(customer.village)}</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i class="bi bi-truck"></i>
                                        <span>${new Set(customer.thocks.map(t => t.thock_number)).size} Thoks</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <i class="bi bi-box"></i>
                                        <span>${customer.totalQuantity - (customer.totalOutgoing || 0)} Items</span>
                                    </div>
                                </div>

                                <div class="grid grid-cols-3 gap-4 mb-4">
                                    <div class="p-3 bg-blue-50 border-2 border-blue-200">
                                        <p class="text-sm text-gray-600">Total Rent</p>
                                        <p class="text-xl font-bold text-blue-600">₹${customer.totalRent.toLocaleString('en-IN', {minimumFractionDigits: 2})}</p>
                                    </div>
                                    <div class="p-3 bg-green-50 border-2 border-green-200">
                                        <p class="text-sm text-gray-600">Total Paid</p>
                                        <p class="text-xl font-bold text-green-600">₹${customer.totalPaid.toLocaleString('en-IN', {minimumFractionDigits: 2})}</p>
                                    </div>
                                    <div class="p-3 bg-red-50 border-2 border-red-200">
                                        <p class="text-sm text-gray-600">Balance Due</p>
                                        <p class="text-xl font-bold text-red-600">₹${customer.balance.toLocaleString('en-IN', {minimumFractionDigits: 2})}</p>
                                    </div>
                                </div>

                                ${customer.familyMembers && customer.familyMembers.length > 1 ? `
                                <div class="mb-4 p-3 bg-purple-50 border-2 border-purple-300">
                                    <h4 class="font-bold text-purple-800 mb-2 flex items-center gap-2">
                                        <i class="bi bi-people-fill"></i> Family Member Balances
                                    </h4>
                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                        ${customer.familyMembers.map(fm => `
                                            <div class="p-2 ${fm.balance > 0 ? 'bg-red-100 border-red-300' : 'bg-green-100 border-green-300'} border-2 rounded flex justify-between items-center">
                                                <div>
                                                    <p class="font-bold text-sm">${capitalizeText(fm.name)}${fm.relation ? ` <span class="font-normal text-purple-600">(${fm.relation})</span>` : ''}</p>
                                                    <p class="text-xs text-gray-600">${fm.quantity} items | ₹${fm.rent.toLocaleString('en-IN')}</p>
                                                    <p class="text-xs text-gray-600">Paid: ₹${fm.paid.toLocaleString('en-IN')} | Can Take: <span class="font-bold ${fm.canTakeOut > 0 ? 'text-green-600' : 'text-gray-400'}">${fm.canTakeOut}</span></p>
                                                    <p class="text-sm ${fm.balance > 0 ? 'text-red-600' : 'text-green-600'} font-bold">
                                                        ${fm.balance > 0 ? 'Due: ₹' + fm.balance.toLocaleString('en-IN', {minimumFractionDigits: 2}) : '✓ Paid'}
                                                    </p>
                                                </div>
                                                ${fm.balance > 0 ? `
                                                    <button onclick="openPaymentModal('${customer.phone}', '${fm.name.replace(/'/g, "\\'")}')" class="text-xs neu-button bg-green-500 text-white py-1 px-2" style="padding: 0.25rem 0.5rem;">
                                                        <i class="bi bi-cash"></i>
                                                    </button>
                                                ` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}
                            </div>

                            <div class="flex flex-col gap-2">
                                ${customer.balance > 0 ? `
                                    <button onclick="openPaymentModal('${customer.phone}')" class="neu-button bg-green-500 text-white">
                                        <i class="bi bi-cash"></i> Collect Payment
                                    </button>
                                ` : ''}
                                <button onclick="toggleThockList('${customer.phone}')" class="neu-button bg-blue-500 text-white">
                                    <i class="bi bi-list"></i> <span id="toggleText${customer.phone}">Show Thoks</span>
                                </button>
                                <button onclick="exportCustomerPDF('${customer.phone}')" class="neu-button bg-purple-500 text-white">
                                    <i class="bi bi-file-earmark-pdf"></i> Export PDF
                                </button>
                            </div>
                        </div>

                        <!-- Thok List and Payment History (Hidden by default) -->
                        <div id="thockList${customer.phone}" class="truck-list mt-4">
                            <!-- Current Inventory Per Thok Section -->
                            ${hasOutgoing ? `
                                <div class="mb-6 pb-6 border-b-4 border-blue-300">
                                    <h4 class="font-bold mb-3 flex items-center gap-2 text-blue-700">
                                        <i class="bi bi-box-seam"></i>
                                        Current Inventory Per Thok (After Outgoing)
                                    </h4>
                                    <div class="overflow-auto" style="max-height: 400px;">
                                    <table class="w-full">
                                        <thead class="bg-blue-100 border-2 border-blue-500 sticky top-0">
                                            <tr>
                                                <th class="text-left p-3 font-bold">Thok Number</th>
                                                <th class="text-left p-3 font-bold">Entered Qty</th>
                                                <th class="text-left p-3 font-bold">Outgoing</th>
                                                <th class="text-left p-3 font-bold">Inventory Qty</th>
                                                <th class="text-left p-3 font-bold">Current Rent</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${inventoryArray.map(inv => {
                                                const current = inv.incoming - inv.outgoing;
                                                const currentRent = inv.incomingRent - inv.outgoingRent;
                                                const thockColorClass = getThockColor(inv.thock_number);
                                                const currentClass = current === 0 ? 'text-gray-500 line-through' : (current < inv.incoming ? 'text-blue-700 font-bold' : '');

                                                return `
                                                <tr class="border-b border-blue-200 ${current === 0 ? 'bg-gray-50' : 'bg-white'}">
                                                    <td class="p-3 font-bold ${thockColorClass}">${inv.thock_number}</td>
                                                    <td class="p-3">${inv.incoming}</td>
                                                    <td class="p-3 text-red-600 font-bold">${inv.outgoing}</td>
                                                    <td class="p-3 ${currentClass}">${current} ${current === 0 ? '(Empty)' : ''}</td>
                                                    <td class="p-3 ${currentClass}">₹${currentRent.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                                                </tr>
                                            `}).join('')}
                                        </tbody>
                                    </table>
                                    </div>
                                </div>
                            ` : ''}

                            <div class="grid grid-cols-2 gap-6">
                                <!-- Thoks -->
                                <div>
                                    <h4 class="font-bold mb-3 flex items-center gap-2">
                                        <i class="bi bi-truck"></i>
                                        All Thoks for ${capitalizeText(customer.name)}
                                    </h4>
                                    <div class="overflow-auto" style="max-height: 400px;">
                                    ${(() => {
                                        // Group thocks by family member
                                        const groupedThocks = {};
                                        customer.thocks.forEach(thock => {
                                            const memberName = thock.family_member_name || customer.name;
                                            if (!groupedThocks[memberName]) {
                                                groupedThocks[memberName] = [];
                                            }
                                            groupedThocks[memberName].push(thock);
                                        });
                                        const memberNames = Object.keys(groupedThocks);
                                        const hasMultipleMembers = memberNames.length > 1;

                                        // Render thocks table (with optional family member headers)
                                        const selectAllCheckbox = canManageEntries ? '<th class="p-3 w-10"><input type="checkbox" class="select-all-thock cursor-pointer" data-customer="' + customer.customer_id + '" onchange="toggleSelectAllThocks(this, ' + customer.customer_id + ')"></th>' : '';
                                        let tableHtml = '<table class="w-full"><thead class="bg-gray-100 border-2 border-black sticky top-0"><tr>' + selectAllCheckbox + '<th class="text-left p-3 font-bold">Thok Number</th><th class="text-left p-3 font-bold">Quantity</th><th class="text-left p-3 font-bold">Rent</th><th class="text-left p-3 font-bold">Date</th>' + (canManageEntries ? '<th class="text-left p-3 font-bold">Action</th>' : '') + '</tr></thead><tbody>';

                                        memberNames.forEach(memberName => {
                                            const memberThocks = groupedThocks[memberName];
                                            // Add family member header if multiple members
                                            if (hasMultipleMembers) {
                                                const memberQty = memberThocks.filter(t => t.type !== 'outgoing').reduce((sum, t) => sum + Math.abs(t.quantity), 0);
                                                const memberRent = memberThocks.filter(t => t.type !== 'outgoing').reduce((sum, t) => sum + Math.abs(t.rent), 0);
                                                tableHtml += '<tr class="bg-purple-100 border-t-2 border-purple-400"><td colspan="' + (canManageEntries ? 6 : 4) + '" class="p-2 font-bold text-purple-800"><i class="bi bi-person-fill"></i> ' + capitalizeText(memberName) + ' <span class="text-sm font-normal">(' + memberThocks.length + ' thoks, ' + memberQty + ' qty, ₹' + memberRent.toLocaleString('en-IN', {minimumFractionDigits: 2}) + ')</span></td></tr>';
                                            }

                                            memberThocks.forEach(thock => {
                                                const isOutgoing = thock.type === 'outgoing';
                                                const rowClass = isOutgoing ? 'bg-red-50 border-l-4 border-red-500' : '';
                                                const thockColorClass = isOutgoing ? 'text-red-700' : getThockColor(thock.thock_number);
                                                const quantityClass = isOutgoing ? 'text-red-700 font-bold' : '';
                                                const rentClass = isOutgoing ? 'text-red-700' : '';
                                                const typeLabel = isOutgoing ? ' ⬅️ OUT' : ' ➡️ IN';
                                                const displayQty = thock.qtyDisplay || Math.abs(thock.quantity);
                                                const familyBtnHtml = !isOutgoing && customer.familyMembers && customer.familyMembers.length > 0 ? '<button onclick="openChangeFamilyModal(' + thock.id + ', \'' + thock.thock_number + '\', \'' + (thock.family_member_name || customer.name).replace(/'/g, "\\'") + '\', ' + customer.customer_id + ')" class="text-xs neu-button bg-purple-500 text-white py-1 px-2 ml-1" style="padding: 0.25rem 0.5rem;" title="Change Family Member"><i class="bi bi-person"></i></button>' : '';
                                                const deleteBtnHtml = isAdmin && !isOutgoing ? '<button onclick="deleteThock(' + thock.id + ', \'' + thock.thock_number + '\')" class="text-xs neu-button bg-red-500 text-white py-1 px-2 ml-1" style="padding: 0.25rem 0.5rem;" title="Delete Thock"><i class="bi bi-trash"></i></button>' : '';
                                                const checkboxHtml = canManageEntries && !isOutgoing ? '<td class="p-3"><input type="checkbox" class="thock-select cursor-pointer" data-entry-id="' + thock.id + '" data-thock="' + thock.thock_number + '" data-customer-id="' + customer.customer_id + '" data-customer-name="' + customer.name.replace(/'/g, "\\'") + '" data-customer-phone="' + customer.phone + '" onchange="updateBulkSelection()"></td>' : (canManageEntries ? '<td class="p-3"></td>' : '');
                                                tableHtml += '<tr class="border-b border-gray-200 ' + rowClass + '">' + checkboxHtml + '<td class="p-3 font-bold ' + thockColorClass + '">' + thock.thock_number + typeLabel + '</td><td class="p-3 ' + quantityClass + '">' + displayQty + '</td><td class="p-3 font-bold ' + rentClass + '">₹' + Math.abs(thock.rent).toLocaleString('en-IN', {minimumFractionDigits: 2}) + '</td><td class="p-3 text-sm">' + thock.date + '</td>' + (canManageEntries ? '<td class="p-3"><button onclick="openReassignModal(' + thock.id + ', \'' + thock.thock_number + '\', \'' + customer.name.replace(/'/g, "\\'") + '\', \'' + customer.phone + '\')" class="text-xs neu-button bg-blue-500 text-white py-1 px-2" style="padding: 0.25rem 0.5rem;"><i class="bi bi-arrow-left-right"></i></button>' + familyBtnHtml + deleteBtnHtml + '</td>' : '') + '</tr>';
                                            });
                                        });
                                        return tableHtml;
                                    })()}
                                            ${seedQuantity > 0 ? `
                                            <tr class="bg-green-50 font-bold border-t-2 border-green-400">
                                                <td class="p-3 text-green-700">SEED TOTAL</td>
                                                <td class="p-3 text-green-700">${seedQuantity}</td>
                                                <td class="p-3 text-green-700">₹${seedRent.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                                                <td class="p-3">-</td>
                                            </tr>
                                            ` : ''}
                                            ${sellQuantity > 0 ? `
                                            <tr class="bg-orange-50 font-bold border-t-2 border-orange-400">
                                                <td class="p-3 text-orange-700">SELL TOTAL</td>
                                                <td class="p-3 text-orange-700">${sellQuantity}</td>
                                                <td class="p-3 text-orange-700">₹${sellRent.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                                                <td class="p-3">-</td>
                                            </tr>
                                            ` : ''}
                                            ${customer.totalOutgoing > 0 ? `
                                            <tr class="bg-red-100 font-bold border-t-2 border-red-500">
                                                <td class="p-3 text-red-700">⬅️ OUTGOING TOTAL</td>
                                                <td class="p-3 text-red-700">${customer.totalOutgoing}</td>
                                                <td class="p-3 text-red-700">₹${customer.outgoingRent.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                                                <td class="p-3">-</td>
                                            </tr>
                                            ` : ''}
                                            <tr class="bg-gray-800 text-white font-bold border-t-4 border-black">
                                                <td class="p-3">NET TOTAL (IN - OUT)</td>
                                                <td class="p-3">${customer.totalQuantity - customer.totalOutgoing}</td>
                                                <td class="p-3">₹${(customer.totalRent - customer.outgoingRent).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                                                <td class="p-3">-</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    </div>
                                </div>

                                <!-- Payment History -->
                                <div>
                                    <h4 class="font-bold mb-3 flex items-center gap-2">
                                        <i class="bi bi-receipt"></i>
                                        Payment History
                                    </h4>
                                    <div id="paymentHistory${index}" class="space-y-2">
                                        ${(() => {
                                            // Get ALL payments from ledger (single source of truth)
                                            const allPayments = [];
                                            (customer.familyMembers || []).forEach(fm => {
                                                (fm.ledgerPayments || []).forEach(lp => {
                                                    allPayments.push({
                                                        type: 'ledger',
                                                        amount: lp.amount,
                                                        date: new Date(lp.created_at),
                                                        isOnline: lp.entry_type === 'ONLINE_PAYMENT',
                                                        processedBy: 'System',
                                                        notes: lp.notes || lp.description || '',
                                                        entryType: lp.entry_type,
                                                        familyMemberName: lp.family_member_name || fm.name || ''
                                                    });
                                                });
                                            });

                                            // Sort by date (newest first)
                                            allPayments.sort((a, b) => b.date - a.date);

                                            if (allPayments.length === 0) {
                                                return '<p class="text-gray-500 text-sm p-4 bg-gray-50 border-2 border-gray-200">No payments yet</p>';
                                            }

                                            return allPayments.map(payment => {
                                                const methodBadge = payment.isOnline
                                                    ? '<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-semibold bg-cyan-100 text-cyan-800"><i class="bi bi-credit-card"></i> Online</span>'
                                                    : '<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-semibold bg-gray-100 text-gray-600"><i class="bi bi-cash"></i> Cash</span>';

                                                const receiptBtn = payment.receiptNumber
                                                    ? `<button onclick="viewReceipt('${payment.receiptNumber}')" class="text-xs neu-button bg-blue-500 text-white py-1 px-2" style="padding: 0.25rem 0.5rem;"><i class="bi bi-printer"></i> Receipt</button>`
                                                    : '';

                                                const familyBadge = payment.familyMemberName
                                                    ? `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-semibold bg-purple-100 text-purple-800"><i class="bi bi-person"></i> ${capitalizeText(payment.familyMemberName)}</span>`
                                                    : '';

                                                return `
                                                <div class="p-3 ${payment.isOnline ? 'bg-cyan-50 border-2 border-cyan-200' : 'bg-green-50 border-2 border-green-200'}">
                                                    <div class="flex justify-between items-start mb-2">
                                                        <div class="flex-1">
                                                            <div class="flex items-center gap-2 mb-1 flex-wrap">
                                                                <p class="font-bold ${payment.isOnline ? 'text-cyan-700' : 'text-green-700'}">₹${payment.amount.toLocaleString('en-IN', {minimumFractionDigits: 2})}</p>
                                                                ${methodBadge}
                                                                ${familyBadge}
                                                            </div>
                                                            <p class="text-xs text-gray-600">${payment.date.toLocaleDateString('en-IN')} ${payment.date.toLocaleTimeString('en-IN')}</p>
                                                        </div>
                                                        ${receiptBtn}
                                                    </div>
                                                    ${payment.notes ? `<p class="text-xs text-gray-500 mt-2">${payment.notes}</p>` : ''}
                                                </div>
                                            `}).join('');
                                        })()}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleThockList(phone) {
            const thockList = document.getElementById(`thockList${phone}`);
            const toggleText = document.getElementById(`toggleText${phone}`);

            if (thockList.classList.contains('expanded')) {
                thockList.classList.remove('expanded');
                toggleText.textContent = 'Show Thoks';
            } else {
                thockList.classList.add('expanded');
                toggleText.textContent = 'Hide Thoks';
            }
        }

        function exportCustomerPDF(phone) {
            // Open the PDF export page in a new tab
            window.open(`/customer-export?phone=${encodeURIComponent(phone)}`, '_blank');
        }

        function getThockColor(thockNumber) {
            const numMatch = thockNumber.match(/^(\d+)/);
            if (numMatch) {
                const num = parseInt(numMatch[1]);
                return num <= 1500 ? 'text-green-600' : 'text-orange-600';
            }
            return 'text-gray-700';
        }

        // Debounced search - waits 300ms after user stops typing
        let searchTimeout;
        function debouncedSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(filterCustomers, 300);
        }

        function filterCustomers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();

            if (!searchTerm) {
                displayCustomerAccounts(allCustomerAccounts);
                return;
            }

            const filtered = allCustomerAccounts.filter(customer => {
                // Search by name, phone, S/O, village
                if (customer.name.toLowerCase().includes(searchTerm) ||
                    customer.phone.includes(searchTerm) ||
                    (customer.so && customer.so.toLowerCase().includes(searchTerm)) ||
                    customer.village.toLowerCase().includes(searchTerm)) {
                    return true;
                }

                // Search by thock number or family member name
                if (customer.thocks && customer.thocks.some(thock =>
                    (thock.thock_number && thock.thock_number.toLowerCase().includes(searchTerm)) ||
                    (thock.family_member_name && thock.family_member_name.toLowerCase().includes(searchTerm))
                )) {
                    return true;
                }

                return false;
            });

            displayCustomerAccounts(filtered);
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            displayCustomerAccounts(allCustomerAccounts);
        }

        function updateSummary() {
            const totalCustomers = allCustomerAccounts.length;
            const totalThocks = allCustomerAccounts.reduce((sum, c) => sum + new Set(c.thocks.map(t => t.thock_number)).size, 0);
            const totalQty = allCustomerAccounts.reduce((sum, c) => sum + (c.totalQuantity - (c.totalOutgoing || 0)), 0);
            const totalOutstanding = allCustomerAccounts.reduce((sum, c) => sum + c.balance, 0);
            const totalCollected = allCustomerAccounts.reduce((sum, c) => sum + c.totalPaid, 0);

            document.getElementById('totalCustomers').textContent = totalCustomers;
            document.getElementById('totalThocks').textContent = totalThocks;
            document.getElementById('totalQuantity').textContent = totalQty.toLocaleString('en-IN');
            document.getElementById('totalOutstanding').textContent = '₹' + totalOutstanding.toLocaleString('en-IN', {minimumFractionDigits: 2});
            document.getElementById('totalCollected').textContent = '₹' + totalCollected.toLocaleString('en-IN', {minimumFractionDigits: 2});
        }

        let selectedFamilyMember = null;

        function openPaymentModal(phone, familyMemberName = null) {
            currentPaymentCustomer = allCustomerAccounts.find(c => c.phone === phone);
            if (!currentPaymentCustomer) {
                alert('Customer not found');
                return;
            }

            document.getElementById('paymentCustomerName').textContent = capitalizeText(currentPaymentCustomer.name);
            document.getElementById('paymentCustomerPhone').textContent = currentPaymentCustomer.phone;
            document.getElementById('paymentTotalAmount').textContent = '₹' + currentPaymentCustomer.balance.toLocaleString('en-IN', {minimumFractionDigits: 2});
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentRemark').value = '';
            // Reset payment method to Cash
            selectPaymentMethod('cash');

            // Populate family members dropdown if multiple exist
            const familyMemberSection = document.getElementById('familyMemberSection');
            const familyMemberSelect = document.getElementById('paymentFamilyMember');
            const familyMembers = currentPaymentCustomer.familyMembers || [];

            if (familyMembers.length > 1) {
                familyMemberSection.style.display = 'block';
                familyMemberSelect.innerHTML = '<option value="">-- Pay for Entire Account --</option>' +
                    familyMembers.filter(fm => fm.balance > 0).map(fm =>
                        `<option value="${escapeHtml(fm.name)}" ${familyMemberName === fm.name ? 'selected' : ''}>
                            ${capitalizeText(fm.name)} - ₹${fm.balance.toLocaleString('en-IN', {minimumFractionDigits: 2})} due
                        </option>`
                    ).join('');

                // Pre-select if familyMemberName was provided
                if (familyMemberName) {
                    familyMemberSelect.value = familyMemberName;
                    updatePaymentForFamilyMember();
                } else {
                    selectedFamilyMember = null;
                    document.getElementById('familyMemberBalance').classList.add('hidden');
                }
            } else {
                familyMemberSection.style.display = 'none';
                selectedFamilyMember = null;
            }

            document.getElementById('paymentModal').classList.remove('hidden');
        }

        function updatePaymentForFamilyMember() {
            const familyMemberName = document.getElementById('paymentFamilyMember').value;
            const familyMembers = currentPaymentCustomer.familyMembers || [];
            const balanceDiv = document.getElementById('familyMemberBalance');

            if (familyMemberName) {
                selectedFamilyMember = familyMembers.find(fm => fm.name === familyMemberName);
                if (selectedFamilyMember) {
                    document.getElementById('selectedMemberBalance').textContent =
                        '₹' + selectedFamilyMember.balance.toLocaleString('en-IN', {minimumFractionDigits: 2});
                    balanceDiv.classList.remove('hidden');
                }
            } else {
                selectedFamilyMember = null;
                balanceDiv.classList.add('hidden');
            }
        }

        function selectPaymentMethod(method) {
            document.getElementById('paymentMethod').value = method;
            const cashOption = document.getElementById('cashOption');
            const onlineOption = document.getElementById('onlineOption');

            if (method === 'cash') {
                cashOption.className = 'flex-1 cursor-pointer neu-input p-4 text-center transition-all duration-200 bg-green-500 text-white border-green-600 border-2 shadow-lg scale-105';
                onlineOption.className = 'flex-1 cursor-pointer neu-input p-4 text-center transition-all duration-200';
            } else {
                onlineOption.className = 'flex-1 cursor-pointer neu-input p-4 text-center transition-all duration-200 bg-blue-500 text-white border-blue-600 border-2 shadow-lg scale-105';
                cashOption.className = 'flex-1 cursor-pointer neu-input p-4 text-center transition-all duration-200';
            }
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.add('hidden');
            currentPaymentCustomer = null;
            selectedFamilyMember = null;
            // Reset button state when modal closes
            const btn = document.getElementById('collectPaymentBtn');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-circle"></i> Collect Payment';
            }
            isProcessingPayment = false;
        }

        let isProcessingPayment = false; // Debounce flag to prevent double submission

        async function processPayment() {
            // Prevent double submission
            if (isProcessingPayment) {
                console.log('Payment already in progress, ignoring');
                return;
            }

            const submitBtn = document.getElementById('collectPaymentBtn');
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const paymentMethod = document.getElementById('paymentMethod').value;
            const remark = document.getElementById('paymentRemark').value.trim();

            if (!amount || amount <= 0) {
                alert('Please enter a valid payment amount');
                return;
            }

            const relevantBalanceForCheck = selectedFamilyMember ? selectedFamilyMember.balance : currentPaymentCustomer.balance;
            if (amount > relevantBalanceForCheck) {
                if (!confirm(`Payment amount (₹${amount}) is more than balance (₹${relevantBalanceForCheck.toFixed(2)}). Continue?`)) {
                    return;
                }
            }

            // Validate customer data
            if (!currentPaymentCustomer || !currentPaymentCustomer.phone || !currentPaymentCustomer.name) {
                alert('Error: Customer information is missing. Please refresh the page and try again.');
                console.error('Invalid customer data:', currentPaymentCustomer);
                return;
            }

            // Disable button and set loading state
            isProcessingPayment = true;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';

            try {
                // Get first entry ID for this customer
                const entryId = currentPaymentCustomer.thocks[0].id;

                // Calculate new balance based on whether paying for family member or entire account
                const relevantBalance = selectedFamilyMember ? selectedFamilyMember.balance : currentPaymentCustomer.balance;
                const newBalance = relevantBalance - amount;

                const paymentData = {
                    entry_id: entryId,
                    customer_name: currentPaymentCustomer.name,
                    customer_phone: currentPaymentCustomer.phone,
                    total_rent: selectedFamilyMember ? selectedFamilyMember.rent : currentPaymentCustomer.totalRent,
                    amount_paid: amount,
                    balance: newBalance < 0 ? 0 : newBalance,
                    notes: `${paymentMethod.toUpperCase()}${remark ? ' - ' + remark : ''}`
                };

                // Add family member info if selected
                if (selectedFamilyMember) {
                    paymentData.family_member_name = selectedFamilyMember.name;
                    // Find family member ID from thocks
                    const fmThock = currentPaymentCustomer.thocks.find(t => t.family_member_name === selectedFamilyMember.name);
                    if (fmThock && fmThock.id) {
                        // We need the family_member_id not entry_id - this will be handled by backend
                    }
                }

                console.log('Creating payment with data:', paymentData);

                const response = await fetch('/api/rent-payments', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(paymentData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to process payment: ${errorText}`);
                }

                const result = await response.json();

                // 5 second cooldown before allowing next payment
                let countdown = 5;
                submitBtn.innerHTML = `<i class="bi bi-check-circle"></i> Success! Wait ${countdown}s...`;

                const cooldownInterval = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        submitBtn.innerHTML = `<i class="bi bi-check-circle"></i> Success! Wait ${countdown}s...`;
                    } else {
                        clearInterval(cooldownInterval);
                        // Close modal and reload accounts
                        closePaymentModal();
                        loadCustomerAccounts();
                        loadCreditOutItems();
                    }
                }, 1000);

                // Show success message and open receipt
                alert(`Payment of ₹${amount.toFixed(2)} collected successfully!\nReceipt: ${result.receipt_number}`);

                if (result.receipt_number) {
                    window.open(`/payment-receipt?receipt=${result.receipt_number}`, '_blank', 'width=800,height=600');
                }

            } catch (error) {
                console.error('Error processing payment:', error);
                alert('Error processing payment: ' + error.message);
                // Re-enable button on error
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Collect Payment';
                isProcessingPayment = false;
            }
        }

        function viewReceipt(receiptNumber) {
            window.open(`/payment-receipt?receipt=${receiptNumber}`, '_blank', 'width=800,height=600');
        }

        // ===============================
        // Entry Reassignment Functions
        // ===============================
        let reassignSearchTimeout;
        let currentReassignEntryId = null;

        function openReassignModal(entryId, thockNumber, customerName, customerPhone) {
            currentReassignEntryId = entryId;
            document.getElementById('reassignEntryId').value = entryId;
            document.getElementById('reassignThockNumber').textContent = thockNumber;
            document.getElementById('reassignCurrentCustomer').textContent = `${customerName} (${customerPhone})`;
            document.getElementById('reassignCustomerSearch').value = '';
            document.getElementById('reassignCustomerResults').innerHTML = '<p class="text-gray-500 text-sm p-4 text-center">Type to search customers...</p>';
            document.getElementById('reassignSelectedCustomer').classList.add('hidden');
            document.getElementById('reassignNewCustomerId').value = '';
            document.getElementById('reassignSubmitBtn').disabled = true;
            document.getElementById('reassignModal').classList.remove('hidden');
        }

        function closeReassignModal() {
            document.getElementById('reassignModal').classList.add('hidden');
            currentReassignEntryId = null;
        }

        function searchCustomersForReassign() {
            clearTimeout(reassignSearchTimeout);
            reassignSearchTimeout = setTimeout(async () => {
                const searchTerm = document.getElementById('reassignCustomerSearch').value.trim();
                const resultsDiv = document.getElementById('reassignCustomerResults');

                if (searchTerm.length < 2) {
                    resultsDiv.innerHTML = '<p class="text-gray-500 text-sm p-4 text-center">Type at least 2 characters to search...</p>';
                    return;
                }

                resultsDiv.innerHTML = '<p class="text-gray-500 text-sm p-4 text-center"><i class="bi bi-hourglass-split"></i> Searching...</p>';

                try {
                    let results = [];

                    // Always search database first to get proper customer IDs
                    const response = await fetch(`/api/customers/search?phone=${encodeURIComponent(searchTerm)}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const dbCustomers = await response.json() || [];
                        dbCustomers.forEach(c => {
                            results.push({
                                type: 'customer',
                                customerId: c.id,
                                name: c.name,
                                phone: c.phone,
                                so: c.so || '',
                                village: c.village || 'N/A',
                                familyMemberId: null,
                                familyMemberName: ''
                            });

                            // Also fetch family members for this customer
                            fetch(`/api/customers/${c.id}/family-members`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            }).then(fmRes => fmRes.json()).then(fmData => {
                                const familyMembers = fmData?.family_members || [];
                                if (familyMembers.length > 0) {
                                    const matchingFm = familyMembers.filter(fm =>
                                        fm.name.toLowerCase().includes(searchTerm.toLowerCase())
                                    );
                                    if (matchingFm.length > 0) {
                                        matchingFm.forEach(fm => {
                                            if (!results.find(r => r.familyMemberId === fm.id)) {
                                                results.push({
                                                    type: 'family_member',
                                                    customerId: c.id,
                                                    name: c.name,
                                                    phone: c.phone,
                                                    so: c.so || '',
                                                    village: c.village || 'N/A',
                                                    familyMemberId: fm.id,
                                                    familyMemberName: fm.name,
                                                    relation: fm.relation
                                                });
                                            }
                                        });
                                        renderReassignResults(results);
                                    }
                                }
                            }).catch(() => {});
                        });
                    }

                    // Also search from cached accounts (for name matching)
                    const filteredFromCache = allCustomerAccounts.filter(c =>
                        (c.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         c.phone.includes(searchTerm)) &&
                        !results.find(r => r.phone === c.phone)
                    ).slice(0, 5);

                    // For cached results, we need to fetch their ID from database
                    for (const c of filteredFromCache) {
                        const idResponse = await fetch(`/api/customers/search?phone=${encodeURIComponent(c.phone)}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (idResponse.ok) {
                            const idData = await idResponse.json();
                            if (idData && idData.length > 0) {
                                results.push({
                                    type: 'customer',
                                    customerId: idData[0].id,
                                    name: c.name,
                                    phone: c.phone,
                                    so: c.so || '',
                                    village: c.village || 'N/A',
                                    familyMemberId: null,
                                    familyMemberName: ''
                                });
                            }
                        }
                    }

                    if (results.length === 0) {
                        resultsDiv.innerHTML = '<p class="text-gray-500 text-sm p-4 text-center">No customers or family members found</p>';
                        return;
                    }

                    renderReassignResults(results);
                } catch (error) {
                    console.error('Error searching customers:', error);
                    resultsDiv.innerHTML = '<p class="text-red-500 text-sm p-4 text-center">Error searching customers</p>';
                }
            }, 300);
        }

        function renderReassignResults(results) {
            const resultsDiv = document.getElementById('reassignCustomerResults');
            resultsDiv.innerHTML = results.map(r => {
                if (r.type === 'family_member') {
                    return `
                        <div onclick="selectCustomerForReassign(${r.customerId}, '${r.name.replace(/'/g, "\\'")}', '${r.phone}', '${(r.so || '').replace(/'/g, "\\'")}', '${(r.village || '').replace(/'/g, "\\'")}', ${r.familyMemberId}, '${r.familyMemberName.replace(/'/g, "\\'")}')"
                             class="p-2 border-b border-gray-200 hover:bg-purple-50 cursor-pointer bg-purple-50">
                            <p class="font-bold"><i class="bi bi-person text-purple-600"></i> ${capitalizeText(r.familyMemberName)} <span class="text-xs text-purple-600">(${r.relation})</span></p>
                            <p class="text-sm text-gray-600">Under: ${capitalizeText(r.name)} • ${r.phone}</p>
                        </div>
                    `;
                } else {
                    return `
                        <div onclick="selectCustomerForReassign(${r.customerId}, '${r.name.replace(/'/g, "\\'")}', '${r.phone}', '${(r.so || '').replace(/'/g, "\\'")}', '${(r.village || '').replace(/'/g, "\\'")}', null, '')"
                             class="p-2 border-b border-gray-200 hover:bg-blue-50 cursor-pointer">
                            <p class="font-bold">${capitalizeText(r.name)}</p>
                            <p class="text-sm text-gray-600">${r.phone}${r.so ? ' • S/O: ' + capitalizeText(r.so) : ''} • ${capitalizeText(r.village || 'N/A')}</p>
                        </div>
                    `;
                }
            }).join('');
        }

        async function selectCustomerForReassign(customerId, customerName, phone, so, village, familyMemberId = null, familyMemberName = '') {
            // Set customer and family member info
            document.getElementById('reassignNewCustomerId').value = customerId;
            document.getElementById('reassignFamilyMemberId').value = familyMemberId || '';
            document.getElementById('reassignFamilyMemberName').value = familyMemberName || '';

            // Display selected customer/family member
            if (familyMemberId && familyMemberName) {
                document.getElementById('reassignNewCustomerName').innerHTML = `<i class="bi bi-person text-purple-600"></i> ${capitalizeText(familyMemberName)} <span class="text-xs text-purple-600">(Family Member)</span>`;
                document.getElementById('reassignNewCustomerPhone').textContent = `Under: ${capitalizeText(customerName)} • ${phone}`;
            } else {
                document.getElementById('reassignNewCustomerName').textContent = capitalizeText(customerName);
                document.getElementById('reassignNewCustomerPhone').textContent = phone + (so ? ' • S/O: ' + capitalizeText(so) : '') + ' • ' + capitalizeText(village || 'N/A');
            }

            document.getElementById('reassignSelectedCustomer').classList.remove('hidden');
            document.getElementById('reassignCustomerResults').innerHTML = '';
            document.getElementById('reassignSubmitBtn').disabled = false;
        }

        async function submitReassign() {
            const entryId = document.getElementById('reassignEntryId').value;
            const newCustomerId = document.getElementById('reassignNewCustomerId').value;
            const familyMemberId = document.getElementById('reassignFamilyMemberId').value;
            const familyMemberName = document.getElementById('reassignFamilyMemberName').value;

            if (!entryId || !newCustomerId) {
                alert('Please select a new customer');
                return;
            }

            const submitBtn = document.getElementById('reassignSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Reassigning...';

            try {
                const requestBody = {
                    new_customer_id: parseInt(newCustomerId)
                };

                // Add family member info if selected
                if (familyMemberId) {
                    requestBody.family_member_id = parseInt(familyMemberId);
                    requestBody.family_member_name = familyMemberName;
                }

                const response = await fetch(`/api/entries/${entryId}/reassign`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to reassign entry');
                }

                const result = await response.json();
                alert('Entry reassigned successfully!');
                closeReassignModal();
                loadCustomerAccounts(true); // Force refresh
            } catch (error) {
                console.error('Error reassigning entry:', error);
                alert('Error reassigning entry: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-arrow-left-right"></i> Reassign';
            }
        }

        // ===============================
        // Change Family Member Functions
        // ===============================
        async function openChangeFamilyModal(entryId, thockNumber, currentMember, customerId) {
            document.getElementById('changeFamilyEntryId').value = entryId;
            document.getElementById('changeFamilyCustomerId').value = customerId;
            document.getElementById('changeFamilyThockNumber').textContent = thockNumber;
            document.getElementById('changeFamilyCurrentMember').textContent = currentMember;
            document.getElementById('changeFamilySelect').innerHTML = '<option value="">Loading...</option>';
            document.getElementById('changeFamilyModal').classList.remove('hidden');

            // Load family members for this customer
            try {
                const response = await fetch(`/api/customers/${customerId}/family-members`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    const members = data.family_members || [];
                    if (members.length > 0) {
                        document.getElementById('changeFamilySelect').innerHTML =
                            members.map(m => `<option value="${m.id}" data-name="${escapeHtml(m.name)}" ${m.name === currentMember ? 'selected' : ''}>${capitalizeText(m.name)} (${m.relation})</option>`).join('');
                    } else {
                        document.getElementById('changeFamilySelect').innerHTML = '<option value="">No family members found</option>';
                    }
                } else {
                    document.getElementById('changeFamilySelect').innerHTML = '<option value="">Failed to load</option>';
                }
            } catch (error) {
                console.error('Error loading family members:', error);
                document.getElementById('changeFamilySelect').innerHTML = '<option value="">Error loading</option>';
            }
        }

        function closeChangeFamilyModal() {
            document.getElementById('changeFamilyModal').classList.add('hidden');
        }

        async function submitChangeFamilyMember() {
            const entryId = document.getElementById('changeFamilyEntryId').value;
            const select = document.getElementById('changeFamilySelect');
            const familyMemberId = select.value;
            const familyMemberName = select.options[select.selectedIndex]?.dataset?.name || '';

            if (!entryId || !familyMemberId) {
                alert('Please select a family member');
                return;
            }

            const submitBtn = document.getElementById('changeFamilySubmitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';

            try {
                const response = await fetch(`/api/entries/${entryId}/family-member`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        family_member_id: parseInt(familyMemberId),
                        family_member_name: familyMemberName
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to update family member');
                }

                alert('Family member updated successfully!');
                closeChangeFamilyModal();
                loadCustomerAccounts(true); // Force refresh
            } catch (error) {
                console.error('Error updating family member:', error);
                alert('Error: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Assign';
            }
        }

        // ===============================
        // Delete Thock Function (Admin Only)
        // ===============================
        async function deleteThock(entryId, thockNumber) {
            if (!confirm(`Are you sure you want to delete thock ${thockNumber}?\n\nThis is a soft delete and can be undone from Merge & Transfer History.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/entries/${entryId}/soft-delete`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to delete thock');
                }

                alert(`Thock ${thockNumber} deleted successfully!`);
                loadCustomerAccounts(true); // Force refresh
            } catch (error) {
                console.error('Error deleting thock:', error);
                alert('Error: ' + error.message);
            }
        }

        async function bulkDeleteThocks() {
            const thockList = Array.from(selectedThocks.values()).map(t => t.thock).join(', ');
            if (!confirm(`Are you sure you want to delete ${selectedThocks.size} thock(s)?\n\n${thockList}\n\nThis is a soft delete and can be undone from Merge & Transfer History.`)) {
                return;
            }

            const entryIds = Array.from(selectedThocks.keys()).map(id => parseInt(id));

            try {
                const response = await fetch('/api/entries/bulk-delete', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ entry_ids: entryIds })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.errors?.join(', ') || 'Delete failed');
                }

                if (result.errors && result.errors.length > 0) {
                    alert(`Deleted ${result.success_count}/${result.total_count} thocks.\n\nErrors:\n${result.errors.join('\n')}`);
                } else {
                    alert(`Successfully deleted ${result.success_count} thock(s)!`);
                }

                clearBulkSelection();
                loadCustomerAccounts(true); // Force refresh
            } catch (error) {
                console.error('Bulk delete error:', error);
                alert('Error: ' + error.message);
            }
        }

        // ===============================
        // Bulk Transfer Functions
        // ===============================
        let selectedThocks = new Map(); // entryId -> {thock, customerName, customerPhone}
        let bulkTransferSearchTimeout;

        function toggleSelectAllThocks(checkbox, customerId) {
            const thockCheckboxes = document.querySelectorAll(`.thock-select[data-customer-id="${customerId}"]`);
            thockCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateBulkSelection();
        }

        function updateBulkSelection() {
            selectedThocks.clear();
            const checkedBoxes = document.querySelectorAll('.thock-select:checked');
            checkedBoxes.forEach(cb => {
                selectedThocks.set(cb.dataset.entryId, {
                    thock: cb.dataset.thock,
                    customerName: cb.dataset.customerName,
                    customerPhone: cb.dataset.customerPhone
                });
            });

            const toolbar = document.getElementById('bulkTransferToolbar');
            const countSpan = document.getElementById('selectedCount');
            const deleteBtn = document.getElementById('bulkDeleteBtn');

            if (selectedThocks.size > 0) {
                toolbar.classList.remove('hidden');
                countSpan.textContent = selectedThocks.size;
                // Show delete button only for admins
                if (isAdmin) {
                    deleteBtn.classList.remove('hidden');
                }
            } else {
                toolbar.classList.add('hidden');
                deleteBtn.classList.add('hidden');
            }

            // Update select-all checkboxes
            document.querySelectorAll('.select-all-thock').forEach(selectAll => {
                const customerId = selectAll.dataset.customer;
                const customerCheckboxes = document.querySelectorAll(`.thock-select[data-customer-id="${customerId}"]`);
                const checkedCount = document.querySelectorAll(`.thock-select[data-customer-id="${customerId}"]:checked`).length;
                selectAll.checked = customerCheckboxes.length > 0 && checkedCount === customerCheckboxes.length;
                selectAll.indeterminate = checkedCount > 0 && checkedCount < customerCheckboxes.length;
            });
        }

        function clearBulkSelection() {
            document.querySelectorAll('.thock-select:checked').forEach(cb => cb.checked = false);
            document.querySelectorAll('.select-all-thock').forEach(cb => {
                cb.checked = false;
                cb.indeterminate = false;
            });
            selectedThocks.clear();
            document.getElementById('bulkTransferToolbar').classList.add('hidden');
        }

        function openBulkTransferModal() {
            // Show selected thocks
            const thocksHtml = Array.from(selectedThocks.entries()).map(([id, data]) =>
                `<span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded mr-1 mb-1">${data.thock}</span>`
            ).join('');
            document.getElementById('bulkTransferSelectedThocks').innerHTML = thocksHtml;

            // Reset customer search
            document.getElementById('bulkTransferCustomerSearch').value = '';
            document.getElementById('bulkTransferCustomerResults').innerHTML = '<p class="text-gray-500 text-sm p-4 text-center">Type to search customers...</p>';
            document.getElementById('bulkTransferSelectedCustomer').classList.add('hidden');
            document.getElementById('bulkTransferNewCustomerId').value = '';
            document.getElementById('bulkTransferSubmitBtn').disabled = true;

            document.getElementById('bulkTransferModal').classList.remove('hidden');
        }

        function closeBulkTransferModal() {
            document.getElementById('bulkTransferModal').classList.add('hidden');
        }

        async function searchCustomersForBulkTransfer() {
            const searchTerm = document.getElementById('bulkTransferCustomerSearch').value.trim();

            clearTimeout(bulkTransferSearchTimeout);

            if (searchTerm.length < 2) {
                document.getElementById('bulkTransferCustomerResults').innerHTML = '<p class="text-gray-500 text-sm p-4 text-center">Type at least 2 characters...</p>';
                return;
            }

            bulkTransferSearchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/api/customers/search?phone=${encodeURIComponent(searchTerm)}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) throw new Error('Search failed');

                    const customers = await response.json();

                    if (customers.length === 0) {
                        document.getElementById('bulkTransferCustomerResults').innerHTML = '<p class="text-gray-500 text-sm p-4 text-center">No customers found</p>';
                        return;
                    }

                    document.getElementById('bulkTransferCustomerResults').innerHTML = customers.map(c => `
                        <div class="p-3 border-b hover:bg-gray-100 cursor-pointer" onclick="selectBulkTransferCustomer(${c.id}, '${c.name.replace(/'/g, "\\'")}', '${c.phone}')">
                            <p class="font-bold">${c.name}</p>
                            <p class="text-sm text-gray-600">${c.phone}</p>
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('Search error:', error);
                    document.getElementById('bulkTransferCustomerResults').innerHTML = '<p class="text-red-500 text-sm p-4 text-center">Search error</p>';
                }
            }, 300);
        }

        function selectBulkTransferCustomer(customerId, name, phone) {
            document.getElementById('bulkTransferNewCustomerId').value = customerId;
            document.getElementById('bulkTransferNewCustomerName').textContent = name;
            document.getElementById('bulkTransferNewCustomerPhone').textContent = phone;
            document.getElementById('bulkTransferSelectedCustomer').classList.remove('hidden');
            document.getElementById('bulkTransferSubmitBtn').disabled = false;
        }

        async function submitBulkTransfer() {
            const newCustomerId = document.getElementById('bulkTransferNewCustomerId').value;

            if (!newCustomerId || selectedThocks.size === 0) {
                alert('Please select a destination customer');
                return;
            }

            const entryIds = Array.from(selectedThocks.keys()).map(id => parseInt(id));

            const submitBtn = document.getElementById('bulkTransferSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Transferring...';

            try {
                const response = await fetch('/api/entries/bulk-reassign', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        entry_ids: entryIds,
                        new_customer_id: parseInt(newCustomerId)
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.errors?.join(', ') || 'Transfer failed');
                }

                if (result.errors && result.errors.length > 0) {
                    alert(`Transferred ${result.success_count}/${result.total_count} thocks.\n\nErrors:\n${result.errors.join('\n')}`);
                } else {
                    alert(`Successfully transferred ${result.success_count} thock(s)!`);
                }

                closeBulkTransferModal();
                clearBulkSelection();
                loadCustomerAccounts(true); // Force refresh
            } catch (error) {
                console.error('Bulk transfer error:', error);
                alert('Error: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-arrow-left-right"></i> Transfer All';
            }
        }

        // ===============================
        // Customer Merge Functions
        // ===============================
        let mergeSourceSearchTimeout;
        let mergeTargetSearchTimeout;

        function openMergeModal() {
            document.getElementById('mergeSourceSearch').value = '';
            document.getElementById('mergeTargetSearch').value = '';
            document.getElementById('mergeSourceResults').innerHTML = '';
            document.getElementById('mergeTargetResults').innerHTML = '';
            document.getElementById('mergeSourceSelected').classList.add('hidden');
            document.getElementById('mergeTargetSelected').classList.add('hidden');
            document.getElementById('mergeSourceId').value = '';
            document.getElementById('mergeTargetId').value = '';
            document.getElementById('mergeSubmitBtn').disabled = true;
            document.getElementById('mergeModal').classList.remove('hidden');
        }

        function closeMergeModal() {
            document.getElementById('mergeModal').classList.add('hidden');
        }

        function searchCustomersForMerge(type) {
            const timeout = type === 'source' ? mergeSourceSearchTimeout : mergeTargetSearchTimeout;
            clearTimeout(timeout);

            const searchFunc = setTimeout(async () => {
                const searchInput = document.getElementById(`merge${type === 'source' ? 'Source' : 'Target'}Search`);
                const resultsDiv = document.getElementById(`merge${type === 'source' ? 'Source' : 'Target'}Results`);
                const searchTerm = searchInput.value.trim();

                if (searchTerm.length < 2) {
                    resultsDiv.innerHTML = '';
                    return;
                }

                resultsDiv.innerHTML = '<p class="text-gray-500 text-sm p-2"><i class="bi bi-hourglass-split"></i> Searching...</p>';

                try {
                    const filtered = allCustomerAccounts.filter(c =>
                        c.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        c.phone.includes(searchTerm)
                    ).slice(0, 5);

                    if (filtered.length === 0) {
                        resultsDiv.innerHTML = '<p class="text-gray-500 text-sm p-2">No customers found</p>';
                        return;
                    }

                    resultsDiv.innerHTML = filtered.map(c => `
                        <div onclick="selectCustomerForMerge('${type}', '${c.phone}', '${c.name.replace(/'/g, "\\'")}', '${(c.so || '').replace(/'/g, "\\'")}', '${(c.village || '').replace(/'/g, "\\'")}')"
                             class="p-2 border-b border-gray-200 hover:bg-${type === 'source' ? 'red' : 'green'}-50 cursor-pointer">
                            <p class="font-bold">${capitalizeText(c.name)}</p>
                            <p class="text-sm text-gray-600">${c.phone}${c.so ? ' • S/O: ' + capitalizeText(c.so) : ''} • ${capitalizeText(c.village || 'N/A')} • ${new Set(c.thocks.map(t => t.thock_number)).size} thoks</p>
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('Error searching customers:', error);
                    resultsDiv.innerHTML = '<p class="text-red-500 text-sm p-2">Error searching</p>';
                }
            }, 300);

            if (type === 'source') {
                mergeSourceSearchTimeout = searchFunc;
            } else {
                mergeTargetSearchTimeout = searchFunc;
            }
        }

        async function selectCustomerForMerge(type, phone, name, so, village) {
            try {
                const response = await fetch(`/api/customers/search?phone=${encodeURIComponent(phone)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch customer');
                }

                const customers = await response.json();
                if (!customers || customers.length === 0) {
                    alert('Customer not found in database');
                    return;
                }

                const customer = customers[0];
                const isSource = type === 'source';
                const prefix = isSource ? 'Source' : 'Target';

                document.getElementById(`merge${prefix}Id`).value = customer.id;
                document.getElementById(`merge${prefix}Name`).textContent = capitalizeText(name);
                document.getElementById(`merge${prefix}Phone`).textContent = phone + (so ? ' • S/O: ' + capitalizeText(so) : '') + ' • ' + capitalizeText(village || 'N/A');
                document.getElementById(`merge${prefix}Results`).innerHTML = '';
                document.getElementById(`merge${prefix}Selected`).classList.remove('hidden');

                // For source, fetch entry count
                if (isSource) {
                    try {
                        const countResponse = await fetch(`/api/customers/${customer.id}/entry-count`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (countResponse.ok) {
                            const countData = await countResponse.json();
                            document.getElementById('mergeSourceEntryCount').textContent = `${countData.entry_count} entries`;
                        }
                    } catch (e) {
                        console.error('Error fetching entry count:', e);
                    }
                }

                checkMergeReady();
            } catch (error) {
                console.error('Error selecting customer:', error);
                alert('Error selecting customer: ' + error.message);
            }
        }

        function checkMergeReady() {
            const sourceId = document.getElementById('mergeSourceId').value;
            const targetId = document.getElementById('mergeTargetId').value;
            const submitBtn = document.getElementById('mergeSubmitBtn');

            if (sourceId && targetId && sourceId !== targetId) {
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
            }
        }

        async function submitMerge() {
            const sourceId = parseInt(document.getElementById('mergeSourceId').value);
            const targetId = parseInt(document.getElementById('mergeTargetId').value);

            if (!sourceId || !targetId) {
                alert('Please select both source and target customers');
                return;
            }

            if (sourceId === targetId) {
                alert('Source and target customers cannot be the same');
                return;
            }

            const sourceName = document.getElementById('mergeSourceName').textContent;
            const targetName = document.getElementById('mergeTargetName').textContent;
            const entryCount = document.getElementById('mergeSourceEntryCount').textContent;

            if (!confirm(`Are you sure you want to merge?\n\nSource: ${sourceName} (${entryCount}) - WILL BE MARKED AS MERGED\nTarget: ${targetName} - WILL KEEP\n\nAll entries from source will be moved to target.\nYou can undo this from Admin > Merge History.`)) {
                return;
            }

            const submitBtn = document.getElementById('mergeSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Merging...';

            try {
                const response = await fetch('/api/customers/merge', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        source_customer_id: sourceId,
                        target_customer_id: targetId
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to merge customers');
                }

                const result = await response.json();
                alert(`Customers merged successfully!\n${result.entries_moved} entries were moved.`);
                closeMergeModal();
                loadCustomerAccounts(true); // Force refresh
            } catch (error) {
                console.error('Error merging customers:', error);
                alert('Error merging customers: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-people"></i> Merge Customers';
            }
        }

        // Load accounts on page load (after permission check)
        window.addEventListener('load', async function() {
            const hasPermission = await checkAccountantPermission();
            if (hasPermission) {
                await loadCustomerAccounts();
                loadCreditOutItems(); // Load after accounts so rentPerItem is available
            }
        });
    </script>
</body>
</html>
