<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png?v=2">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Logs - Cold Storage</title>
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link href="/static/css/arbitrary.css" rel="stylesheet">
    <link href="/static/css/bootstrap-icons.min.css" rel="stylesheet">
    <link href="/static/css/fonts.css" rel="stylesheet">
    <link href="/static/css/dark-mode.css" rel="stylesheet">
    <link href="/static/css/responsive.css" rel="stylesheet">
    <style>
        * {
            font-family: 'Space Grotesk', sans-serif;
        }
        .neu-border {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            transition: all 0.2s ease;
        }
        .neu-border:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #000;
        }
        .neu-button {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .neu-button:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #000;
        }
        .stat-card {
            border: 3px solid #000;
            box-shadow: 4px 4px 0 #000;
            padding: 1.5rem;
            background: white;
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            border: 3px solid #000;
            background: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .tab-button.active {
            background: #3B82F6;
            color: white;
            transform: translateY(3px);
            box-shadow: none;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Tablet/Phone Portrait Optimizations */
        @media (max-width: 1023px) and (orientation: portrait) {
            body { font-size: 0.875rem; }
            .neu-border, .neu-button, .stat-card, .tab-button {
                border-width: 2px;
                box-shadow: 2px 2px 0 #000;
            }
            .neu-border:hover, .neu-button:hover {
                transform: none;
                box-shadow: 2px 2px 0 #000;
            }
            .stat-card {
                padding: 0.75rem;
            }
            .stat-card p.text-3xl { font-size: 1.25rem; }
            .stat-card i.text-4xl { font-size: 1.5rem; }
            .tab-button {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
            }
            .tab-button i { margin-right: 0.25rem; }
            h1 { font-size: 1.25rem !important; }
            h2 { font-size: 1rem !important; }
            h3 { font-size: 0.875rem !important; }
            table th, table td { padding: 0.375rem 0.5rem; font-size: 0.75rem; }
        }
    </style>
<script src="/static/js/prefetch.js?v=5"></script>
    <script src="/static/js/theme.js"></script>
</head>
<body class="bg-[#FFF9E6] min-h-screen p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 md:mb-8 neu-border bg-white p-4 md:p-6 gap-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold flex items-center gap-3">
                    <i class="bi bi-clipboard-data text-purple-600"></i>
                    System Logs
                </h1>
                <p class="text-gray-600 mt-2 text-sm md:text-base">Employee activity tracking and system audit logs</p>
            </div>
            <div class="flex gap-2 md:gap-4 w-full md:w-auto justify-end">
                <button onclick="theme.toggle()" class="neu-button bg-gray-200" title="Toggle Dark Mode">
                    <i class="bi bi-moon-fill theme-icon-moon"></i>
                    <i class="bi bi-sun-fill theme-icon-sun hidden"></i>
                </button>
                <button onclick="refreshAllData()" class="neu-button bg-blue-500 text-white">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                <button onclick="window.location.href='/admin/dashboard'" class="neu-button bg-gray-200">
                    <i class="bi bi-arrow-left"></i> Back
                </button>
            </div>
        </header>

        <!-- System Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stat-card bg-green-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Total Entries</p>
                        <p class="text-3xl font-bold text-green-600" id="totalEntries">0</p>
                    </div>
                    <i class="bi bi-box-seam text-4xl text-green-600"></i>
                </div>
            </div>

            <div class="stat-card bg-blue-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Room Assignments</p>
                        <p class="text-3xl font-bold text-blue-600" id="totalRoomEntries">0</p>
                    </div>
                    <i class="bi bi-door-open text-4xl text-blue-600"></i>
                </div>
            </div>

            <div class="stat-card bg-yellow-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Total Payments</p>
                        <p class="text-3xl font-bold text-yellow-600" id="totalPayments">₹0</p>
                    </div>
                    <i class="bi bi-cash-coin text-4xl text-yellow-600"></i>
                </div>
            </div>

            <div class="stat-card bg-purple-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Active Users</p>
                        <p class="text-3xl font-bold text-purple-600" id="totalUsers">0</p>
                    </div>
                    <i class="bi bi-people text-4xl text-purple-600"></i>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-2 mb-6 flex-wrap">
            <button class="tab-button active" onclick="switchTab('activity')">
                <i class="bi bi-activity"></i> Employee Activity
            </button>
            <button class="tab-button" onclick="switchTab('loginlogs')">
                <i class="bi bi-clock-history"></i> Login/Logout Logs
            </button>
            <button class="tab-button" onclick="switchTab('editlogs')">
                <i class="bi bi-pencil-square"></i> Edit Logs
            </button>
            <button class="tab-button" onclick="switchTab('adminactions')">
                <i class="bi bi-shield-check"></i> Admin Actions
            </button>
            <button class="tab-button" onclick="switchTab('employeeactions')">
                <i class="bi bi-person-gear"></i> Employee Actions
            </button>
            <button class="tab-button" onclick="switchTab('entries')">
                <i class="bi bi-box"></i> Entry Logs
            </button>
            <button class="tab-button" onclick="switchTab('rooms')">
                <i class="bi bi-door-closed"></i> Room Assignment Logs
            </button>
            <button class="tab-button" onclick="switchTab('payments')">
                <i class="bi bi-cash"></i> Payment Logs
            </button>
            <button class="tab-button" onclick="switchTab('gatepasses')">
                <i class="bi bi-pass"></i> Gate Pass Logs
            </button>
            <button class="tab-button" onclick="switchTab('expired')">
                <i class="bi bi-x-octagon-fill text-red-600"></i> Expired Gate Passes
            </button>
            <button class="tab-button" onclick="switchTab('users')">
                <i class="bi bi-person-badge"></i> User Management
            </button>
            <button class="tab-button" onclick="switchTab('entrymanagement')">
                <i class="bi bi-arrow-left-right text-purple-600"></i> Entry Management
            </button>
        </div>

        <!-- Employee Activity Tab -->
        <div id="activity-tab" class="tab-content active neu-border bg-white p-6">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-person-workspace"></i>
                Employee Activity Summary
            </h2>
            <p class="text-sm text-gray-600 mb-4">Overview of all employee actions in the system</p>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="border-b-2 border-black">
                            <th class="p-3 text-left">Employee</th>
                            <th class="p-3 text-left">ID</th>
                            <th class="p-3 text-left">Role</th>
                            <th class="p-3 text-left">Entries Created</th>
                            <th class="p-3 text-left">Rooms Assigned</th>
                            <th class="p-3 text-left">Payments Processed</th>
                            <th class="p-3 text-left">Gate Passes Issued</th>
                            <th class="p-3 text-left">Gate Passes Approved</th>
                            <th class="p-3 text-left">Last Active</th>
                        </tr>
                    </thead>
                    <tbody id="activityTableBody">
                        <tr>
                            <td colspan="9" class="text-center p-4 text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Login/Logout Logs Tab -->
        <div id="loginlogs-tab" class="tab-content neu-border bg-white p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                    <i class="bi bi-clock-history"></i>
                    Login/Logout Activity Logs
                </h2>
                <input type="text" id="loginLogSearch" placeholder="Search login logs..." class="neu-border p-2" onkeyup="filterLoginLogs()">
            </div>
            <p class="text-sm text-gray-600 mb-4">Track all user login and logout sessions</p>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="border-b-2 border-black">
                            <th class="p-2 text-left">User</th>
                            <th class="p-2 text-left">Email</th>
                            <th class="p-2 text-left">Role</th>
                            <th class="p-2 text-left">Login Time</th>
                            <th class="p-2 text-left">Logout Time</th>
                            <th class="p-2 text-left">Duration</th>
                            <th class="p-2 text-left">IP Address</th>
                            <th class="p-2 text-left">User Agent</th>
                        </tr>
                    </thead>
                    <tbody id="loginLogsBody">
                        <tr>
                            <td colspan="8" class="text-center p-4 text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Edit Logs Tab (Room Entry & Entry Edits) -->
        <div id="editlogs-tab" class="tab-content neu-border bg-white p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                    <i class="bi bi-pencil-square"></i>
                    <span id="editLogTitle">Room Entry Edit History</span>
                </h2>
                <input type="text" id="editLogSearch" placeholder="Search edit logs..." class="neu-border p-2" onkeyup="filterEditLogs()">
            </div>
            <p class="text-sm text-gray-600 mb-4" id="editLogDesc">Track all changes made to room entries with who edited what and when</p>

            <!-- Toggle between Room Entry Edits and Entry Edits -->
            <div class="flex gap-2 mb-4">
                <button onclick="setEditLogType('room')" id="editType-room"
                        class="px-4 py-2 rounded border-2 border-black bg-blue-500 text-white text-sm font-bold ring-2 ring-black">
                    <i class="bi bi-door-open"></i> Room Entry Edits
                </button>
                <button onclick="setEditLogType('entry')" id="editType-entry"
                        class="px-4 py-2 rounded border-2 border-black bg-green-100 text-sm font-bold">
                    <i class="bi bi-box-seam"></i> Entry Edits
                </button>
            </div>

            <!-- Filter by Change Type (Room Entry) -->
            <div class="flex gap-2 mb-4 flex-wrap" id="roomEditFilters">
                <button onclick="setEditLogFilter('all')" id="editFilter-all"
                        class="px-3 py-1 rounded border-2 border-black bg-gray-200 text-sm font-bold ring-2 ring-black">
                    All
                </button>
                <button onclick="setEditLogFilter('quantity')" id="editFilter-quantity"
                        class="px-3 py-1 rounded border-2 border-black bg-purple-100 text-sm font-bold">
                    Quantity
                </button>
                <button onclick="setEditLogFilter('room')" id="editFilter-room"
                        class="px-3 py-1 rounded border-2 border-black bg-blue-100 text-sm font-bold">
                    Room No
                </button>
                <button onclick="setEditLogFilter('floor')" id="editFilter-floor"
                        class="px-3 py-1 rounded border-2 border-black bg-green-100 text-sm font-bold">
                    Floor
                </button>
                <button onclick="setEditLogFilter('gate')" id="editFilter-gate"
                        class="px-3 py-1 rounded border-2 border-black bg-yellow-100 text-sm font-bold">
                    Gate No
                </button>
                <button onclick="setEditLogFilter('remark')" id="editFilter-remark"
                        class="px-3 py-1 rounded border-2 border-black bg-orange-100 text-sm font-bold">
                    Remark
                </button>
            </div>

            <!-- Filter by Change Type (Entry) -->
            <div class="flex gap-2 mb-4 flex-wrap" id="entryEditFilters" style="display: none;">
                <button onclick="setEntryEditLogFilter('all')" id="entryEditFilter-all"
                        class="px-3 py-1 rounded border-2 border-black bg-gray-200 text-sm font-bold ring-2 ring-black">
                    All
                </button>
                <button onclick="setEntryEditLogFilter('name')" id="entryEditFilter-name"
                        class="px-3 py-1 rounded border-2 border-black bg-blue-100 text-sm font-bold">
                    Name
                </button>
                <button onclick="setEntryEditLogFilter('phone')" id="entryEditFilter-phone"
                        class="px-3 py-1 rounded border-2 border-black bg-purple-100 text-sm font-bold">
                    Phone
                </button>
                <button onclick="setEntryEditLogFilter('village')" id="entryEditFilter-village"
                        class="px-3 py-1 rounded border-2 border-black bg-green-100 text-sm font-bold">
                    Village
                </button>
                <button onclick="setEntryEditLogFilter('so')" id="entryEditFilter-so"
                        class="px-3 py-1 rounded border-2 border-black bg-yellow-100 text-sm font-bold">
                    S/O
                </button>
                <button onclick="setEntryEditLogFilter('quantity')" id="entryEditFilter-quantity"
                        class="px-3 py-1 rounded border-2 border-black bg-orange-100 text-sm font-bold">
                    Quantity
                </button>
                <button onclick="setEntryEditLogFilter('category')" id="entryEditFilter-category"
                        class="px-3 py-1 rounded border-2 border-black bg-pink-100 text-sm font-bold">
                    Category
                </button>
                <button onclick="setEntryEditLogFilter('remark')" id="entryEditFilter-remark"
                        class="px-3 py-1 rounded border-2 border-black bg-red-100 text-sm font-bold">
                    Remark
                </button>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="border-b-2 border-black">
                            <th class="p-2 text-left">Thok NO</th>
                            <th class="p-2 text-left">Edited By</th>
                            <th class="p-2 text-left">Field Changed</th>
                            <th class="p-2 text-left">Old Value</th>
                            <th class="p-2 text-left">New Value</th>
                            <th class="p-2 text-left">Edited At</th>
                        </tr>
                    </thead>
                    <tbody id="editLogsBody">
                        <tr>
                            <td colspan="7" class="text-center p-4 text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Admin Actions Tab -->
        <div id="adminactions-tab" class="tab-content neu-border bg-white p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                    <i class="bi bi-shield-check"></i>
                    Admin Actions Log
                </h2>
                <input type="text" id="adminActionSearch" placeholder="Search admin actions..." class="neu-border p-2" onkeyup="filterAdminActions()">
            </div>
            <p class="text-sm text-gray-600 mb-4">Track all administrative actions: user management, permission changes, system settings</p>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="border-b-2 border-black">
                            <th class="p-2 text-left">Admin</th>
                            <th class="p-2 text-left">Action Type</th>
                            <th class="p-2 text-left">Target</th>
                            <th class="p-2 text-left">Description</th>
                            <th class="p-2 text-left">IP Address</th>
                            <th class="p-2 text-left">Timestamp</th>
                        </tr>
                    </thead>
                    <tbody id="adminActionsBody">
                        <tr>
                            <td colspan="6" class="text-center p-4 text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Employee Actions Tab -->
        <div id="employeeactions-tab" class="tab-content neu-border bg-white p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                    <i class="bi bi-person-gear text-blue-600"></i>
                    Employee Actions Log
                </h2>
                <div class="flex gap-2">
                    <select id="employeeFilter" class="neu-border p-2" onchange="filterEmployeeActions()">
                        <option value="">All Employees</option>
                    </select>
                    <select id="actionTypeFilter" class="neu-border p-2" onchange="filterEmployeeActions()">
                        <option value="">All Actions</option>
                        <option value="ENTRY_CREATED">Entry Created</option>
                        <option value="ROOM_ASSIGNED">Room Assigned</option>
                        <option value="PAYMENT_PROCESSED">Payment Processed</option>
                        <option value="GATE_PASS_ISSUED">Gate Pass Issued</option>
                        <option value="GATE_PASS_APPROVED">Gate Pass Approved</option>
                        <option value="ROOM_EDITED">Room Edited</option>
                    </select>
                    <input type="text" id="employeeActionSearch" placeholder="Search..." class="neu-border p-2" onkeyup="filterEmployeeActions()">
                </div>
            </div>
            <p class="text-sm text-gray-600 mb-4">Detailed log of all employee actions: entries, room assignments, payments, gate passes, and edits</p>
            <div class="overflow-x-auto" style="max-height: 600px; overflow-y: auto;">
                <table class="w-full border-collapse">
                    <thead class="sticky top-0 bg-white">
                        <tr class="border-b-2 border-black">
                            <th class="p-2 text-left">Employee</th>
                            <th class="p-2 text-left">ID</th>
                            <th class="p-2 text-left">Role</th>
                            <th class="p-2 text-left">Action</th>
                            <th class="p-2 text-left">Target</th>
                            <th class="p-2 text-left">Details</th>
                            <th class="p-2 text-left">Timestamp</th>
                        </tr>
                    </thead>
                    <tbody id="employeeActionsBody">
                        <tr>
                            <td colspan="7" class="text-center p-4 text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Entry Logs Tab -->
        <div id="entries-tab" class="tab-content neu-border bg-white p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                    <i class="bi bi-clipboard-data"></i>
                    Entry Creation Logs
                </h2>
                <input type="text" id="entrySearch" placeholder="Search entries..." class="neu-border p-2" onkeyup="filterEntries()">
            </div>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="border-b-2 border-black">
                            <th class="p-2 text-left">Thok NO</th>
                            <th class="p-2 text-left">Customer</th>
                            <th class="p-2 text-left">Village</th>
                            <th class="p-2 text-left">Qty</th>
                            <th class="p-2 text-left">Created By</th>
                            <th class="p-2 text-left">Created At</th>
                        </tr>
                    </thead>
                    <tbody id="entriesLogBody">
                        <tr>
                            <td colspan="7" class="text-center p-4 text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Room Assignment Logs Tab -->
        <div id="rooms-tab" class="tab-content neu-border bg-white p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                    <i class="bi bi-door-open-fill"></i>
                    Room Assignment Logs
                </h2>
                <input type="text" id="roomSearch" placeholder="Search rooms..." class="neu-border p-2" onkeyup="filterRooms()">
            </div>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="border-b-2 border-black">
                            <th class="p-2 text-left">Thok NO</th>
                            <th class="p-2 text-left">Room</th>
                            <th class="p-2 text-left">Floor</th>
                            <th class="p-2 text-left">Gatar</th>
                            <th class="p-2 text-left">Qty</th>
                            <th class="p-2 text-left">Assigned By</th>
                            <th class="p-2 text-left">Assigned At</th>
                        </tr>
                    </thead>
                    <tbody id="roomsLogBody">
                        <tr>
                            <td colspan="8" class="text-center p-4 text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Payment Logs Tab -->
        <div id="payments-tab" class="tab-content neu-border bg-white p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                    <i class="bi bi-wallet2"></i>
                    Payment Processing Logs
                </h2>
                <input type="text" id="paymentSearch" placeholder="Search payments..." class="neu-border p-2" onkeyup="filterPayments()">
            </div>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="border-b-2 border-black">
                            <th class="p-2 text-left">Receipt #</th>
                            <th class="p-2 text-left">Customer</th>
                            <th class="p-2 text-left">Phone</th>
                            <th class="p-2 text-left">Amount Paid</th>
                            <th class="p-2 text-left">Balance</th>
                            <th class="p-2 text-left">Processed By</th>
                            <th class="p-2 text-left">Payment Date</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsLogBody">
                        <tr>
                            <td colspan="8" class="text-center p-4 text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Gate Pass Logs Tab -->
        <div id="gatepasses-tab" class="tab-content neu-border bg-white p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                    <i class="bi bi-pass-fill text-purple-600"></i>
                    Gate Pass Activity Logs
                </h2>
                <input type="text" id="gatePassSearch" placeholder="Search gate passes..." class="neu-border p-2" onkeyup="filterGatePasses()">
            </div>
            <p class="text-sm text-gray-600 mb-4">Track all gate pass creation, approvals, and completions with employee information</p>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="border-b-2 border-black">
                            <th class="p-2 text-left">Thok NO</th>
                            <th class="p-2 text-left">Customer</th>
                            <th class="p-2 text-left">Qty</th>
                            <th class="p-2 text-left">Status</th>
                            <th class="p-2 text-left">Issued By</th>
                            <th class="p-2 text-left">Approved By</th>
                            <th class="p-2 text-left">Expires In</th>
                            <th class="p-2 text-left">Issued At</th>
                        </tr>
                    </thead>
                    <tbody id="gatePassesLogBody">
                        <tr>
                            <td colspan="10" class="text-center p-4 text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Expired Gate Passes Tab -->
        <div id="expired-tab" class="tab-content neu-border bg-red-50 p-6" style="border-color: #DC2626;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold flex items-center gap-2 text-red-700">
                    <i class="bi bi-exclamation-triangle-fill text-red-600"></i>
                    Expired Gate Passes (Last 7 Days)
                </h2>
                <input type="text" id="expiredSearch" placeholder="Search expired passes..." class="neu-border p-2 border-red-500" onkeyup="filterExpired()">
            </div>
            <p class="text-sm text-red-700 mb-4 font-semibold">Gate passes that expired before all items were picked up - 15-hour approval window exceeded</p>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="border-b-2 border-red-600 bg-red-100">
                            <th class="p-2 text-left text-red-900">Thok NO</th>
                            <th class="p-2 text-left text-red-900">Customer</th>
                            <th class="p-2 text-left text-red-900">Phone</th>
                            <th class="p-2 text-left text-red-900">Requested</th>
                            <th class="p-2 text-left text-red-900">Picked Up</th>
                            <th class="p-2 text-left text-red-900">Remaining</th>
                            <th class="p-2 text-left text-red-900">Final Approved</th>
                            <th class="p-2 text-left text-red-900">Approval Expired At</th>
                            <th class="p-2 text-left text-red-900">Status Updated</th>
                        </tr>
                    </thead>
                    <tbody id="expiredPassesBody">
                        <tr>
                            <td colspan="9" class="text-center p-4 text-red-600">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- User Management Tab -->
        <div id="users-tab" class="tab-content neu-border bg-white p-6">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-people-fill"></i>
                User Management & Permissions
            </h2>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="border-b-2 border-black">
                            <th class="p-3 text-left">Name</th>
                            <th class="p-3 text-left">Email</th>
                            <th class="p-3 text-left">Role</th>
                            <th class="p-3 text-left">Accountant Access</th>
                            <th class="p-3 text-left">Status</th>
                            <th class="p-3 text-left">Created At</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="6" class="text-center p-4 text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Entry Management Tab (Reassignments & Merges) -->
        <div id="entrymanagement-tab" class="tab-content neu-border bg-white p-6">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-arrow-left-right text-purple-600"></i>
                Entry Management Logs
            </h2>
            <p class="text-sm text-gray-600 mb-4">Track thock ownership changes and customer merges</p>

            <!-- Toggle between Reassignments and Merges -->
            <div class="flex gap-2 mb-4">
                <button onclick="setManagementLogType('all')" id="mgmtType-all"
                        class="px-4 py-2 rounded border-2 border-black bg-purple-500 text-white text-sm font-bold ring-2 ring-black">
                    <i class="bi bi-list-ul"></i> All
                </button>
                <button onclick="setManagementLogType('reassign')" id="mgmtType-reassign"
                        class="px-4 py-2 rounded border-2 border-black bg-blue-100 text-sm font-bold">
                    <i class="bi bi-arrow-left-right"></i> Reassignments
                </button>
                <button onclick="setManagementLogType('merge')" id="mgmtType-merge"
                        class="px-4 py-2 rounded border-2 border-black bg-green-100 text-sm font-bold">
                    <i class="bi bi-people"></i> Merges
                </button>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="border-b-2 border-black">
                            <th class="p-3 text-left">Date/Time</th>
                            <th class="p-3 text-left">Action</th>
                            <th class="p-3 text-left">Details</th>
                            <th class="p-3 text-left">Performed By</th>
                        </tr>
                    </thead>
                    <tbody id="managementLogsTableBody">
                        <tr>
                            <td colspan="4" class="text-center p-4 text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        const token = localStorage.getItem('token');
        let allEntries = [];
        let allRoomEntries = [];
        let allPayments = [];
        let allUsers = [];
        let allLoginLogs = [];
        let allEditLogs = [];
        let allEntryEditLogs = [];
        let allAdminActions = [];
        let allGatePasses = [];
        let allExpiredPasses = [];
        let allManagementLogs = [];
        let editLogFilter = 'all';  // Filter: 'all', 'quantity', 'room', 'floor', 'gate', 'remark'
        let editLogType = 'room';  // Filter: 'room' for room entries, 'entry' for entries
        let entryEditLogFilter = 'all';  // Filter for entry edits: 'all', 'name', 'phone', 'village', 'so', 'quantity', 'category', 'remark'
        let managementLogType = 'all';  // Filter: 'all', 'reassign', 'merge'

        // Security: Escape HTML to prevent XSS attacks
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Capitalize first letter function
        function capitalizeText(text) {
            if (!text || text.length === 0) return text;
            return text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();
        }

        // Check admin access
        (function() {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                window.location.href = '/login';
                return;
            }

            const user = JSON.parse(userStr);
            if (user.role !== 'admin') {
                alert('Access Denied: Admin access required');
                window.location.href = '/dashboard';
                return;
            }
        })();

        // Load all data on page load
        window.addEventListener('load', function() {
            loadAllData();
        });

        async function loadAllData() {
            await Promise.all([
                loadUsers(),
                loadEntries(),
                loadRoomEntries(),
                loadPayments(),
                loadLoginLogs(),
                loadEditLogs(),
                loadEntryEditLogs(),
                loadAdminActions(),
                loadManagementLogs(),
                loadGatePasses(),
                loadExpiredPasses()
            ]);

            updateStatistics();
            displayEmployeeActivity();
            generateEmployeeActions();
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load users');

                allUsers = await response.json() || [];
                displayUsers();
            } catch (error) {
                console.error('Error loading users:', error);
                allUsers = [];
                displayUsers();
            }
        }

        async function loadEntries() {
            try {
                const response = await fetch('/api/entries', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load entries');

                allEntries = await response.json() || [];
                displayEntries();
            } catch (error) {
                console.error('Error loading entries:', error);
                allEntries = [];
                displayEntries();
            }
        }

        async function loadRoomEntries() {
            try {
                const response = await fetch('/api/room-entries', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load room entries');

                allRoomEntries = await response.json() || [];
                displayRoomEntries();
            } catch (error) {
                console.error('Error loading room entries:', error);
                allRoomEntries = [];
                displayRoomEntries();
            }
        }

        async function loadPayments() {
            try {
                const response = await fetch('/api/rent-payments', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load payments');

                allPayments = await response.json() || [];
                displayPayments();
            } catch (error) {
                console.error('Error loading payments:', error);
                allPayments = [];
                displayPayments();
            }
        }

        async function loadLoginLogs() {
            try {
                const response = await fetch('/api/login-logs', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load login logs');

                allLoginLogs = await response.json() || [];
                displayLoginLogs();
            } catch (error) {
                console.error('Error loading login logs:', error);
                allLoginLogs = [];
                displayLoginLogs();
            }
        }

        async function loadEditLogs() {
            try {
                const response = await fetch('/api/edit-logs', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load edit logs');

                allEditLogs = await response.json() || [];
                displayEditLogs();
            } catch (error) {
                console.error('Error loading edit logs:', error);
                allEditLogs = [];
                displayEditLogs();
            }
        }

        async function loadEntryEditLogs() {
            try {
                const response = await fetch('/api/entry-edit-logs', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load entry edit logs');

                allEntryEditLogs = await response.json() || [];
                // Refresh display if entry type is selected
                if (editLogType === 'entry') {
                    displayEditLogs();
                }
            } catch (error) {
                console.error('Error loading entry edit logs:', error);
                allEntryEditLogs = [];
            }
        }

        async function loadAdminActions() {
            try {
                const response = await fetch('/api/admin-action-logs', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load admin actions');

                allAdminActions = await response.json() || [];
                displayAdminActions();
            } catch (error) {
                console.error('Error loading admin actions:', error);
                allAdminActions = [];
                displayAdminActions();
            }
        }

        async function loadManagementLogs() {
            try {
                const url = managementLogType === 'all'
                    ? '/api/entry-management-logs'
                    : `/api/entry-management-logs?type=${managementLogType}`;
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load management logs');

                allManagementLogs = await response.json() || [];
                displayManagementLogs();
            } catch (error) {
                console.error('Error loading management logs:', error);
                allManagementLogs = [];
                displayManagementLogs();
            }
        }

        async function loadGatePasses() {
            try {
                const response = await fetch('/api/gate-passes', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load gate passes');

                allGatePasses = await response.json() || [];
                displayGatePasses();
            } catch (error) {
                console.error('Error loading gate passes:', error);
                allGatePasses = [];
                displayGatePasses();
            }
        }

        async function loadExpiredPasses() {
            try {
                const response = await fetch('/api/gate-passes/expired', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load expired gate passes');

                allExpiredPasses = await response.json() || [];
                displayExpiredPasses();
            } catch (error) {
                console.error('Error loading expired gate passes:', error);
                allExpiredPasses = [];
                displayExpiredPasses();
            }
        }

        function updateStatistics() {
            document.getElementById('totalEntries').textContent = allEntries.length;
            document.getElementById('totalRoomEntries').textContent = allRoomEntries.length;

            const totalPaid = allPayments.reduce((sum, p) => sum + p.amount_paid, 0);
            document.getElementById('totalPayments').textContent = '₹' + totalPaid.toLocaleString('en-IN');

            const activeUsers = allUsers.filter(u => u.is_active).length;
            document.getElementById('totalUsers').textContent = activeUsers;
        }

        function displayEmployeeActivity() {
            const tbody = document.getElementById('activityTableBody');

            if (allUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center p-4 text-gray-500">No users found</td></tr>';
                return;
            }

            const activityData = allUsers.map(user => {
                const entriesCreated = allEntries.filter(e => e.created_by_user_id === user.id).length;
                const roomsAssigned = allRoomEntries.filter(r => r.created_by_user_id === user.id).length;
                const paymentsProcessed = allPayments.filter(p => p.processed_by_user_id === user.id).length;
                const gatePassesIssued = allGatePasses.filter(gp => gp.issued_by_id === user.id).length;
                const gatePassesApproved = allGatePasses.filter(gp => gp.approved_by_id === user.id).length;

                // Find most recent activity
                const lastEntry = allEntries.filter(e => e.created_by_user_id === user.id).sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];
                const lastRoom = allRoomEntries.filter(r => r.created_by_user_id === user.id).sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];
                const lastPayment = allPayments.filter(p => p.processed_by_user_id === user.id).sort((a, b) => new Date(b.payment_date) - new Date(a.payment_date))[0];
                const lastGatePassIssued = allGatePasses.filter(gp => gp.issued_by_id === user.id).sort((a, b) => new Date(b.issued_at) - new Date(a.issued_at))[0];
                const lastGatePassApproved = allGatePasses.filter(gp => gp.approved_by_id === user.id).sort((a, b) => new Date(b.issued_at) - new Date(a.issued_at))[0];

                const dates = [lastEntry?.created_at, lastRoom?.created_at, lastPayment?.payment_date, lastGatePassIssued?.issued_at, lastGatePassApproved?.issued_at].filter(Boolean);
                const mostRecent = dates.length > 0 ? new Date(Math.max(...dates.map(d => new Date(d)))) : null;

                return {
                    user,
                    entriesCreated,
                    roomsAssigned,
                    paymentsProcessed,
                    gatePassesIssued,
                    gatePassesApproved,
                    lastActive: mostRecent
                };
            });

            tbody.innerHTML = activityData.map(data => {
                const lastActiveStr = data.lastActive ?
                    data.lastActive.toLocaleString('en-IN', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : 'Never';

                const safeRole = escapeHtml(data.user.role);
                return `
                    <tr class="border-b border-gray-200 hover:bg-yellow-50">
                        <td class="p-3 font-semibold">${escapeHtml(capitalizeText(data.user.name))}</td>
                        <td class="p-3">#${parseInt(data.user.id)}</td>
                        <td class="p-3">
                            <span class="px-2 py-1 rounded text-white ${safeRole === 'admin' ? 'bg-red-500' : safeRole === 'accountant' ? 'bg-green-500' : 'bg-blue-500'}">
                                ${safeRole.toUpperCase()}
                            </span>
                        </td>
                        <td class="p-3 text-center"><span class="text-lg font-bold text-green-600">${parseInt(data.entriesCreated)}</span></td>
                        <td class="p-3 text-center"><span class="text-lg font-bold text-blue-600">${parseInt(data.roomsAssigned)}</span></td>
                        <td class="p-3 text-center"><span class="text-lg font-bold text-yellow-600">${parseInt(data.paymentsProcessed)}</span></td>
                        <td class="p-3 text-center"><span class="text-lg font-bold text-purple-600">${parseInt(data.gatePassesIssued)}</span></td>
                        <td class="p-3 text-center"><span class="text-lg font-bold text-orange-600">${parseInt(data.gatePassesApproved)}</span></td>
                        <td class="p-3 text-sm">${escapeHtml(lastActiveStr)}</td>
                    </tr>
                `;
            }).join('');
        }

        function displayEntries() {
            const tbody = document.getElementById('entriesLogBody');

            if (allEntries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-gray-500">No entries found</td></tr>';
                return;
            }

            // Get user names for display
            const userMap = {};
            allUsers.forEach(u => userMap[u.id] = capitalizeText(u.name));

            tbody.innerHTML = allEntries.map(entry => {
                const createdDate = new Date(entry.created_at).toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const thockColor = getThockColor(entry.thock_number);
                const createdBy = userMap[entry.created_by_user_id] || 'Unknown';

                return `
                    <tr class="border-b border-gray-200 hover:bg-blue-50">
                        <td class="p-2 font-bold ${thockColor}">${entry.thock_number}</td>
                        <td class="p-2">${capitalizeText(entry.name)}</td>
                        <td class="p-2">${capitalizeText(entry.village)}</td>
                        <td class="p-2">${entry.expected_quantity}</td>
                        <td class="p-2 font-semibold">${createdBy}</td>
                        <td class="p-2 text-sm">${createdDate}</td>
                    </tr>
                `;
            }).join('');
        }

        function displayRoomEntries() {
            const tbody = document.getElementById('roomsLogBody');

            if (allRoomEntries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-gray-500">No room entries found</td></tr>';
                return;
            }

            const userMap = {};
            allUsers.forEach(u => userMap[u.id] = capitalizeText(u.name));

            tbody.innerHTML = allRoomEntries.map(room => {
                const createdDate = new Date(room.created_at).toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const thockColor = getThockColor(room.thock_number);
                const assignedBy = userMap[room.created_by_user_id] || 'Unknown';
                const breakdownDisplay = room.quantity_breakdown ? `<span class="text-xs text-gray-500 block">(${room.quantity_breakdown})</span>` : '';

                return `
                    <tr class="border-b border-gray-200 hover:bg-purple-50">
                        <td class="p-2 font-bold ${thockColor}">${room.thock_number}</td>
                        <td class="p-2">${room.room_no}</td>
                        <td class="p-2">${room.floor}</td>
                        <td class="p-2">${room.gate_no}</td>
                        <td class="p-2">${room.quantity} ${breakdownDisplay}</td>
                        <td class="p-2 font-semibold">${assignedBy}</td>
                        <td class="p-2 text-sm">${createdDate}</td>
                    </tr>
                `;
            }).join('');
        }

        function displayPayments() {
            const tbody = document.getElementById('paymentsLogBody');

            if (allPayments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-gray-500">No payments found</td></tr>';
                return;
            }

            const userMap = {};
            allUsers.forEach(u => userMap[u.id] = capitalizeText(u.name));

            tbody.innerHTML = allPayments.map(payment => {
                const paymentDate = new Date(payment.payment_date).toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const processedBy = userMap[payment.processed_by_user_id] || 'Unknown';
                const balanceClass = payment.balance < 0 ? 'text-red-600 font-bold' : 'text-green-600 font-bold';

                return `
                    <tr class="border-b border-gray-200 hover:bg-green-50">
                        <td class="p-2 font-bold">#${payment.receipt_number}</td>
                        <td class="p-2">${capitalizeText(payment.customer_name)}</td>
                        <td class="p-2">${payment.customer_phone}</td>
                        <td class="p-2">₹${payment.amount_paid.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                        <td class="p-2 ${balanceClass}">₹${payment.balance.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td>
                        <td class="p-2 font-semibold">${processedBy}</td>
                        <td class="p-2 text-sm">${paymentDate}</td>
                    </tr>
                `;
            }).join('');
        }

        function displayUsers() {
            const tbody = document.getElementById('usersTableBody');

            if (allUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-gray-500">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = allUsers.map(user => {
                const createdDate = new Date(user.created_at).toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });

                return `
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="p-3 font-semibold">${capitalizeText(user.name)}</td>
                        <td class="p-3">${user.email}</td>
                        <td class="p-3">
                            <span class="px-2 py-1 rounded text-white ${user.role === 'admin' ? 'bg-red-500' : user.role === 'accountant' ? 'bg-green-500' : 'bg-blue-500'}">
                                ${user.role.toUpperCase()}
                            </span>
                        </td>
                        <td class="p-3 text-center">
                            ${user.has_accountant_access ? '<span class="px-2 py-1 bg-green-500 text-white rounded text-xs">YES</span>' : '<span class="px-2 py-1 bg-gray-300 rounded text-xs">NO</span>'}
                        </td>
                        <td class="p-3">
                            ${user.is_active ? '<span class="px-2 py-1 bg-green-500 text-white rounded text-xs">ACTIVE</span>' : '<span class="px-2 py-1 bg-red-500 text-white rounded text-xs">PAUSED</span>'}
                        </td>
                        <td class="p-3 text-sm">${createdDate}</td>
                    </tr>
                `;
            }).join('');
        }

        function displayLoginLogs() {
            const tbody = document.getElementById('loginLogsBody');

            if (allLoginLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-gray-500">No login logs found</td></tr>';
                return;
            }

            tbody.innerHTML = allLoginLogs.map(log => {
                const loginTime = new Date(log.login_time).toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                let logoutTime = 'Still Active';
                let duration = '-';

                if (log.logout_time) {
                    const logoutDate = new Date(log.logout_time);
                    logoutTime = logoutDate.toLocaleString('en-IN', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });

                    // Calculate duration
                    const diff = logoutDate - new Date(log.login_time);
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    duration = `${hours}h ${minutes}m`;
                }

                const statusClass = log.logout_time ? 'bg-gray-50' : 'bg-green-50';

                return `
                    <tr class="border-b border-gray-200 hover:bg-yellow-50 ${statusClass}">
                        <td class="p-2 font-semibold">${capitalizeText(log.user_name)}</td>
                        <td class="p-2 text-sm">${log.email}</td>
                        <td class="p-2">
                            <span class="px-2 py-1 rounded text-white text-xs ${log.role === 'admin' ? 'bg-red-500' : log.role === 'accountant' ? 'bg-green-500' : 'bg-blue-500'}">
                                ${log.role.toUpperCase()}
                            </span>
                        </td>
                        <td class="p-2 text-sm">${loginTime}</td>
                        <td class="p-2 text-sm ${log.logout_time ? '' : 'text-green-600 font-bold'}">${logoutTime}</td>
                        <td class="p-2 font-semibold">${duration}</td>
                        <td class="p-2 text-xs">${log.ip_address || 'N/A'}</td>
                        <td class="p-2 text-xs" title="${log.user_agent || 'N/A'}">${(log.user_agent || 'N/A').substring(0, 30)}...</td>
                    </tr>
                `;
            }).join('');
        }

        // Set edit log type (room vs entry)
        function setEditLogType(type) {
            editLogType = type;

            // Update type toggle button styles
            const roomBtn = document.getElementById('editType-room');
            const entryBtn = document.getElementById('editType-entry');
            const roomFilters = document.getElementById('roomEditFilters');
            const entryFilters = document.getElementById('entryEditFilters');
            const title = document.getElementById('editLogTitle');
            const desc = document.getElementById('editLogDesc');

            if (type === 'room') {
                roomBtn.classList.add('bg-blue-500', 'text-white', 'ring-2', 'ring-black');
                roomBtn.classList.remove('bg-blue-100');
                entryBtn.classList.remove('bg-green-500', 'text-white', 'ring-2', 'ring-black');
                entryBtn.classList.add('bg-green-100');
                roomFilters.style.display = 'flex';
                entryFilters.style.display = 'none';
                title.textContent = 'Room Entry Edit History';
                desc.textContent = 'Track all changes made to room entries with who edited what and when';
            } else {
                entryBtn.classList.add('bg-green-500', 'text-white', 'ring-2', 'ring-black');
                entryBtn.classList.remove('bg-green-100');
                roomBtn.classList.remove('bg-blue-500', 'text-white', 'ring-2', 'ring-black');
                roomBtn.classList.add('bg-blue-100');
                roomFilters.style.display = 'none';
                entryFilters.style.display = 'flex';
                title.textContent = 'Entry Edit History';
                desc.textContent = 'Track all changes made to entries (customer info, quantity, category) with who edited what and when';
            }

            displayEditLogs();  // Re-render
        }

        // Set edit log filter and update display (room entry edits)
        function setEditLogFilter(filterType) {
            editLogFilter = filterType;

            // Update button styles
            ['all', 'quantity', 'room', 'floor', 'gate', 'remark'].forEach(type => {
                const btn = document.getElementById(`editFilter-${type}`);
                if (btn) {
                    if (type === filterType) {
                        btn.classList.add('ring-2', 'ring-black');
                    } else {
                        btn.classList.remove('ring-2', 'ring-black');
                    }
                }
            });

            displayEditLogs();  // Re-render with filter
        }

        // Set entry edit log filter
        function setEntryEditLogFilter(filterType) {
            entryEditLogFilter = filterType;

            // Update button styles
            ['all', 'name', 'phone', 'village', 'so', 'quantity', 'category', 'remark'].forEach(type => {
                const btn = document.getElementById(`entryEditFilter-${type}`);
                if (btn) {
                    if (type === filterType) {
                        btn.classList.add('ring-2', 'ring-black');
                    } else {
                        btn.classList.remove('ring-2', 'ring-black');
                    }
                }
            });

            displayEditLogs();  // Re-render with filter
        }

        function displayEditLogs() {
            const tbody = document.getElementById('editLogsBody');

            // Display based on type toggle
            if (editLogType === 'room') {
                displayRoomEntryEditLogs(tbody);
            } else {
                displayEntryEditLogs(tbody);
            }
        }

        function displayRoomEntryEditLogs(tbody) {
            if (allEditLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-gray-500">No room entry edit logs found</td></tr>';
                return;
            }

            // Flatten edit logs to show each field change as a separate row
            // Apply filter based on editLogFilter
            const flattenedLogs = [];
            allEditLogs.forEach(log => {
                const editedAt = new Date(log.edited_at).toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // Room No changes
                if ((editLogFilter === 'all' || editLogFilter === 'room') &&
                    (log.old_room_no !== undefined || log.new_room_no !== undefined)) {
                    flattenedLogs.push({
                        thock_number: log.thock_number,
                        editor_name: log.editor_name,
                        edited_by_user_id: log.edited_by_user_id,
                        field: 'Room No',
                        old_value: log.old_room_no || '-',
                        new_value: log.new_room_no || '-',
                        edited_at: editedAt
                    });
                }

                // Floor changes
                if ((editLogFilter === 'all' || editLogFilter === 'floor') &&
                    (log.old_floor !== undefined || log.new_floor !== undefined)) {
                    flattenedLogs.push({
                        thock_number: log.thock_number,
                        editor_name: log.editor_name,
                        edited_by_user_id: log.edited_by_user_id,
                        field: 'Floor',
                        old_value: log.old_floor || '-',
                        new_value: log.new_floor || '-',
                        edited_at: editedAt
                    });
                }

                // Gate No changes
                if ((editLogFilter === 'all' || editLogFilter === 'gate') &&
                    (log.old_gate_no !== undefined || log.new_gate_no !== undefined)) {
                    flattenedLogs.push({
                        thock_number: log.thock_number,
                        editor_name: log.editor_name,
                        edited_by_user_id: log.edited_by_user_id,
                        field: 'Gate No',
                        old_value: log.old_gate_no || '-',
                        new_value: log.new_gate_no || '-',
                        edited_at: editedAt
                    });
                }

                // Quantity changes
                if ((editLogFilter === 'all' || editLogFilter === 'quantity') &&
                    (log.old_quantity !== undefined || log.new_quantity !== undefined)) {
                    flattenedLogs.push({
                        thock_number: log.thock_number,
                        editor_name: log.editor_name,
                        edited_by_user_id: log.edited_by_user_id,
                        field: 'Quantity',
                        old_value: log.old_quantity || '-',
                        new_value: log.new_quantity || '-',
                        edited_at: editedAt
                    });
                }

                // Remark changes
                if ((editLogFilter === 'all' || editLogFilter === 'remark') &&
                    (log.old_remark !== undefined || log.new_remark !== undefined)) {
                    flattenedLogs.push({
                        thock_number: log.thock_number,
                        editor_name: log.editor_name,
                        edited_by_user_id: log.edited_by_user_id,
                        field: 'Remark',
                        old_value: log.old_remark || '-',
                        new_value: log.new_remark || '-',
                        edited_at: editedAt
                    });
                }
            });

            // Show message if no logs match filter
            if (flattenedLogs.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-gray-500">No ${editLogFilter === 'all' ? '' : editLogFilter + ' '}room entry edit logs found</td></tr>`;
                return;
            }

            tbody.innerHTML = flattenedLogs.map(log => {
                const thockColor = getThockColor(log.thock_number);

                return `
                    <tr class="border-b border-gray-200 hover:bg-purple-50">
                        <td class="p-2 font-bold ${thockColor}">${log.thock_number}</td>
                        <td class="p-2 font-semibold">${capitalizeText(log.editor_name)}</td>
                        <td class="p-2">#${log.edited_by_user_id}</td>
                        <td class="p-2"><span class="px-2 py-1 bg-blue-100 rounded text-xs font-bold">${log.field}</span></td>
                        <td class="p-2 text-red-600 line-through">${log.old_value}</td>
                        <td class="p-2 text-green-600 font-semibold">${log.new_value}</td>
                        <td class="p-2 text-sm">${log.edited_at}</td>
                    </tr>
                `;
            }).join('');
        }

        function displayEntryEditLogs(tbody) {
            if (allEntryEditLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-gray-500">No entry edit logs found</td></tr>';
                return;
            }

            // Flatten entry edit logs to show each field change as a separate row
            const flattenedLogs = [];
            allEntryEditLogs.forEach(log => {
                const editedAt = new Date(log.edited_at).toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // Name changes
                if ((entryEditLogFilter === 'all' || entryEditLogFilter === 'name') &&
                    (log.old_name !== undefined || log.new_name !== undefined)) {
                    flattenedLogs.push({
                        thock_number: log.thock_number,
                        customer_name: log.customer_name,
                        editor_name: log.editor_name,
                        edited_by_user_id: log.edited_by_user_id,
                        field: 'Name',
                        old_value: log.old_name || '-',
                        new_value: log.new_name || '-',
                        edited_at: editedAt
                    });
                }

                // Phone changes
                if ((entryEditLogFilter === 'all' || entryEditLogFilter === 'phone') &&
                    (log.old_phone !== undefined || log.new_phone !== undefined)) {
                    flattenedLogs.push({
                        thock_number: log.thock_number,
                        customer_name: log.customer_name,
                        editor_name: log.editor_name,
                        edited_by_user_id: log.edited_by_user_id,
                        field: 'Phone',
                        old_value: log.old_phone || '-',
                        new_value: log.new_phone || '-',
                        edited_at: editedAt
                    });
                }

                // Village changes
                if ((entryEditLogFilter === 'all' || entryEditLogFilter === 'village') &&
                    (log.old_village !== undefined || log.new_village !== undefined)) {
                    flattenedLogs.push({
                        thock_number: log.thock_number,
                        customer_name: log.customer_name,
                        editor_name: log.editor_name,
                        edited_by_user_id: log.edited_by_user_id,
                        field: 'Village',
                        old_value: log.old_village || '-',
                        new_value: log.new_village || '-',
                        edited_at: editedAt
                    });
                }

                // S/O changes
                if ((entryEditLogFilter === 'all' || entryEditLogFilter === 'so') &&
                    (log.old_so !== undefined || log.new_so !== undefined)) {
                    flattenedLogs.push({
                        thock_number: log.thock_number,
                        customer_name: log.customer_name,
                        editor_name: log.editor_name,
                        edited_by_user_id: log.edited_by_user_id,
                        field: 'S/O',
                        old_value: log.old_so || '-',
                        new_value: log.new_so || '-',
                        edited_at: editedAt
                    });
                }

                // Expected Quantity changes
                if ((entryEditLogFilter === 'all' || entryEditLogFilter === 'quantity') &&
                    (log.old_expected_quantity !== undefined || log.new_expected_quantity !== undefined)) {
                    flattenedLogs.push({
                        thock_number: log.thock_number,
                        customer_name: log.customer_name,
                        editor_name: log.editor_name,
                        edited_by_user_id: log.edited_by_user_id,
                        field: 'Expected Qty',
                        old_value: log.old_expected_quantity || '-',
                        new_value: log.new_expected_quantity || '-',
                        edited_at: editedAt
                    });
                }

                // Thock Category changes
                if ((entryEditLogFilter === 'all' || entryEditLogFilter === 'category') &&
                    (log.old_thock_category !== undefined || log.new_thock_category !== undefined)) {
                    flattenedLogs.push({
                        thock_number: log.thock_number,
                        customer_name: log.customer_name,
                        editor_name: log.editor_name,
                        edited_by_user_id: log.edited_by_user_id,
                        field: 'Category',
                        old_value: log.old_thock_category || '-',
                        new_value: log.new_thock_category || '-',
                        edited_at: editedAt
                    });
                }

                // Remark changes
                if ((entryEditLogFilter === 'all' || entryEditLogFilter === 'remark') &&
                    (log.old_remark !== undefined || log.new_remark !== undefined)) {
                    flattenedLogs.push({
                        thock_number: log.thock_number,
                        customer_name: log.customer_name,
                        editor_name: log.editor_name,
                        edited_by_user_id: log.edited_by_user_id,
                        field: 'Remark',
                        old_value: log.old_remark || '-',
                        new_value: log.new_remark || '-',
                        edited_at: editedAt
                    });
                }
            });

            // Show message if no logs match filter
            if (flattenedLogs.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-gray-500">No ${entryEditLogFilter === 'all' ? '' : entryEditLogFilter + ' '}entry edit logs found</td></tr>`;
                return;
            }

            tbody.innerHTML = flattenedLogs.map(log => {
                const thockColor = getThockColor(log.thock_number);

                return `
                    <tr class="border-b border-gray-200 hover:bg-green-50">
                        <td class="p-2 font-bold ${thockColor}">${log.thock_number}</td>
                        <td class="p-2 font-semibold">${capitalizeText(log.editor_name)}</td>
                        <td class="p-2">#${log.edited_by_user_id}</td>
                        <td class="p-2"><span class="px-2 py-1 bg-green-100 rounded text-xs font-bold">${log.field}</span></td>
                        <td class="p-2 text-red-600 line-through">${escapeHtml(log.old_value)}</td>
                        <td class="p-2 text-green-600 font-semibold">${escapeHtml(log.new_value)}</td>
                        <td class="p-2 text-sm">${log.edited_at}</td>
                    </tr>
                `;
            }).join('');
        }

        function displayAdminActions() {
            const tbody = document.getElementById('adminActionsBody');

            if (allAdminActions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-gray-500">No admin actions found</td></tr>';
                return;
            }

            tbody.innerHTML = allAdminActions.map(action => {
                const createdAt = new Date(action.created_at).toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                // Color code action types
                let actionColor = 'bg-blue-500';
                if (action.action_type === 'CREATE') actionColor = 'bg-green-500';
                else if (action.action_type === 'DELETE') actionColor = 'bg-red-500';
                else if (action.action_type === 'UPDATE') actionColor = 'bg-yellow-500';
                else if (action.action_type === 'TOGGLE_STATUS') actionColor = 'bg-purple-500';

                return `
                    <tr class="border-b border-gray-200 hover:bg-blue-50">
                        <td class="p-2 font-semibold">${capitalizeText(action.admin_name)}</td>
                        <td class="p-2">
                            <span class="px-2 py-1 rounded text-white text-xs ${actionColor}">
                                ${action.action_type}
                            </span>
                        </td>
                        <td class="p-2 text-xs uppercase">${action.target_type}${action.target_id ? ' #' + action.target_id : ''}</td>
                        <td class="p-2 text-sm">${action.description}</td>
                        <td class="p-2 text-xs">${action.ip_address || 'N/A'}</td>
                        <td class="p-2 text-sm">${createdAt}</td>
                    </tr>
                `;
            }).join('');
        }

        function setManagementLogType(logType) {
            managementLogType = logType;

            // Update button styles
            const allBtn = document.getElementById('mgmtType-all');
            const reassignBtn = document.getElementById('mgmtType-reassign');
            const mergeBtn = document.getElementById('mgmtType-merge');

            allBtn.className = 'px-4 py-2 rounded border-2 border-black bg-purple-100 text-sm font-bold';
            reassignBtn.className = 'px-4 py-2 rounded border-2 border-black bg-blue-100 text-sm font-bold';
            mergeBtn.className = 'px-4 py-2 rounded border-2 border-black bg-green-100 text-sm font-bold';

            if (logType === 'all') {
                allBtn.className = 'px-4 py-2 rounded border-2 border-black bg-purple-500 text-white text-sm font-bold ring-2 ring-black';
            } else if (logType === 'reassign') {
                reassignBtn.className = 'px-4 py-2 rounded border-2 border-black bg-blue-500 text-white text-sm font-bold ring-2 ring-black';
            } else if (logType === 'merge') {
                mergeBtn.className = 'px-4 py-2 rounded border-2 border-black bg-green-500 text-white text-sm font-bold ring-2 ring-black';
            }

            loadManagementLogs();
        }

        function displayManagementLogs() {
            const tbody = document.getElementById('managementLogsTableBody');

            if (!allManagementLogs || allManagementLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">No entry management logs found</td></tr>';
                return;
            }

            tbody.innerHTML = allManagementLogs.map(log => {
                const createdAt = new Date(log.created_at).toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                let actionBadge = '';
                let details = '';

                if (log.action_type === 'reassign') {
                    actionBadge = '<span class="px-2 py-1 rounded text-white text-xs bg-blue-500"><i class="bi bi-arrow-left-right"></i> Reassign</span>';
                    details = `
                        <div class="text-sm">
                            <div class="font-bold">Thock #${log.thock_number || 'N/A'}</div>
                            <div class="text-red-600">
                                <i class="bi bi-arrow-right"></i> From: ${capitalizeText(log.old_customer_name || 'Unknown')} (${log.old_customer_phone || 'N/A'})
                            </div>
                            <div class="text-green-600">
                                <i class="bi bi-arrow-left"></i> To: ${capitalizeText(log.new_customer_name || 'Unknown')} (${log.new_customer_phone || 'N/A'})
                            </div>
                        </div>
                    `;
                } else if (log.action_type === 'merge') {
                    actionBadge = '<span class="px-2 py-1 rounded text-white text-xs bg-green-500"><i class="bi bi-people"></i> Merge</span>';
                    details = `
                        <div class="text-sm">
                            <div class="text-red-600">
                                <i class="bi bi-trash"></i> Source: ${capitalizeText(log.source_customer_name || 'Unknown')} (${log.source_customer_phone || 'N/A'})
                            </div>
                            <div class="text-green-600">
                                <i class="bi bi-check-circle"></i> Target: ${capitalizeText(log.target_customer_name || 'Unknown')} (${log.target_customer_phone || 'N/A'})
                            </div>
                            <div class="text-blue-600 font-bold">
                                <i class="bi bi-box-seam"></i> ${log.entries_moved || 0} entries moved
                            </div>
                        </div>
                    `;
                }

                return `
                    <tr class="border-b border-gray-200 hover:bg-purple-50">
                        <td class="p-3 text-sm">${createdAt}</td>
                        <td class="p-3">${actionBadge}</td>
                        <td class="p-3">${details}</td>
                        <td class="p-3 font-semibold">${capitalizeText(log.performed_by_name || 'Unknown')}</td>
                    </tr>
                `;
            }).join('');
        }

        function displayGatePasses() {
            const tbody = document.getElementById('gatePassesLogBody');

            if (allGatePasses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center p-4 text-gray-500">No gate passes found</td></tr>';
                return;
            }

            tbody.innerHTML = allGatePasses.map(gp => {
                const issuedAt = new Date(gp.issued_at).toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const statusColors = {
                    'pending': 'bg-yellow-100 text-yellow-700',
                    'approved': 'bg-blue-100 text-blue-700',
                    'completed': 'bg-green-100 text-green-700',
                    'expired': 'bg-red-100 text-red-700'
                };

                const statusColor = statusColors[gp.status] || 'bg-gray-100 text-gray-700';

                // Calculate remaining time
                const remaining = gp.status === 'pending' ? getRemainingTime(gp.expires_at) : { text: '-', color: 'text-gray-400' };

                const thockColor = getThockColor(gp.thock_number);
                // Handle issued_by for customer portal vs employee issued gate passes
                let issuedByName;
                if (gp.request_source === 'customer_portal') {
                    issuedByName = 'Customer Portal';
                } else {
                    issuedByName = gp.issued_by_name ? capitalizeText(gp.issued_by_name) : 'System';
                }
                const approvedByName = gp.approved_by_name ? capitalizeText(gp.approved_by_name) : '-';

                return `
                    <tr class="border-b border-gray-200 hover:bg-purple-50">
                        <td class="p-2 font-bold ${thockColor}">${gp.thock_number}</td>
                        <td class="p-2">${capitalizeText(gp.customer_name)}</td>
                        <td class="p-2 font-bold">${gp.requested_quantity}</td>
                        <td class="p-2"><span class="px-2 py-1 rounded text-xs font-bold ${statusColor}">${gp.status.toUpperCase()}</span></td>
                        <td class="p-2 font-semibold">${issuedByName}</td>
                        <td class="p-2 font-semibold">${approvedByName}</td>
                        <td class="p-2 text-xs font-bold ${remaining.color}">${remaining.text}</td>
                        <td class="p-2 text-sm">${issuedAt}</td>
                    </tr>
                `;
            }).join('');
        }

        function getRemainingTime(expiresAt) {
            if (!expiresAt) return { text: 'N/A', color: 'text-gray-500' };

            const now = new Date();
            const expires = new Date(expiresAt);
            const diff = expires - now;

            if (diff <= 0) {
                return { text: 'EXPIRED', color: 'text-red-600 font-bold' };
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

            let color = 'text-green-600'; // >24h
            if (hours < 6) {
                color = 'text-red-600 font-bold'; // <6h critical
            } else if (hours < 12) {
                color = 'text-orange-600 font-bold'; // <12h warning
            } else if (hours < 24) {
                color = 'text-yellow-600'; // <24h caution
            }

            return { text: `${hours}h ${minutes}m`, color: color };
        }

        function getThockColor(thockNumber) {
            const numMatch = thockNumber.match(/^(\d+)/);
            if (numMatch) {
                const num = parseInt(numMatch[1]);
                return num <= 1500 ? 'text-green-600' : 'text-orange-600';
            }
            return 'text-gray-700';
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Activate button
            event.target.classList.add('active');
        }

        function filterEntries() {
            const search = document.getElementById('entrySearch').value.toLowerCase();
            const rows = document.querySelectorAll('#entriesLogBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function filterRooms() {
            const search = document.getElementById('roomSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#roomsLogBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function filterPayments() {
            const search = document.getElementById('paymentSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#paymentsLogBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function filterLoginLogs() {
            const search = document.getElementById('loginLogSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#loginLogsBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function filterEditLogs() {
            const search = document.getElementById('editLogSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#editLogsBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function filterAdminActions() {
            const search = document.getElementById('adminActionSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#adminActionsBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function filterGatePasses() {
            const search = document.getElementById('gatePassSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#gatePassesLogBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function displayExpiredPasses() {
            const tbody = document.getElementById('expiredPassesBody');

            if (allExpiredPasses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center p-4 text-red-600 font-semibold">No expired gate passes in the last 7 days</td></tr>';
                return;
            }

            tbody.innerHTML = allExpiredPasses.map(exp => {
                const approvalExpiredAt = new Date(exp.approval_expires_at).toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const updatedAt = new Date(exp.updated_at).toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const thockColor = getThockColor(exp.thock_number);
                const finalApprovedQty = exp.final_approved_quantity !== undefined ? exp.final_approved_quantity : exp.total_picked_up;

                return `
                    <tr class="border-b-2 border-red-300 hover:bg-red-100 bg-white">
                        <td class="p-2 font-bold ${thockColor}">${exp.thock_number}</td>
                        <td class="p-2 font-semibold">${capitalizeText(exp.customer_name)}</td>
                        <td class="p-2 text-sm">${exp.customer_phone}</td>
                        <td class="p-2 text-center font-bold text-blue-700">${exp.requested_quantity}</td>
                        <td class="p-2 text-center font-bold text-green-700">${exp.total_picked_up}</td>
                        <td class="p-2 text-center font-bold text-red-700">${exp.remaining_quantity}</td>
                        <td class="p-2 text-center font-bold text-orange-700">${finalApprovedQty}</td>
                        <td class="p-2 text-sm text-red-600 font-bold">${approvalExpiredAt}</td>
                        <td class="p-2 text-sm">${updatedAt}</td>
                    </tr>
                `;
            }).join('');
        }

        function filterExpired() {
            const search = document.getElementById('expiredSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#expiredPassesBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        // Employee Actions - combined from all activities
        let allEmployeeActions = [];

        function generateEmployeeActions() {
            allEmployeeActions = [];

            const userMap = {};
            allUsers.forEach(u => {
                userMap[u.id] = {
                    name: capitalizeText(u.name),
                    role: u.role
                };
            });

            // Entries created
            allEntries.forEach(entry => {
                if (entry.created_by_user_id) {
                    const user = userMap[entry.created_by_user_id] || { name: 'Unknown', role: 'unknown' };
                    allEmployeeActions.push({
                        user_id: entry.created_by_user_id,
                        user_name: user.name,
                        role: user.role,
                        action_type: 'ENTRY_CREATED',
                        target: entry.thock_number,
                        details: `Customer: ${capitalizeText(entry.name)}, Qty: ${entry.expected_quantity}`,
                        timestamp: new Date(entry.created_at)
                    });
                }
            });

            // Room assignments
            allRoomEntries.forEach(room => {
                if (room.created_by_user_id) {
                    const user = userMap[room.created_by_user_id] || { name: 'Unknown', role: 'unknown' };
                    const breakdownText = room.quantity_breakdown ? ` (${room.quantity_breakdown})` : '';
                    allEmployeeActions.push({
                        user_id: room.created_by_user_id,
                        user_name: user.name,
                        role: user.role,
                        action_type: 'ROOM_ASSIGNED',
                        target: room.thock_number,
                        details: `Room: ${room.room_no}, Floor: ${room.floor}, Gatar: ${room.gate_no}, Qty: ${room.quantity}${breakdownText}`,
                        timestamp: new Date(room.created_at)
                    });
                }
            });

            // Payments processed
            allPayments.forEach(payment => {
                if (payment.processed_by_user_id) {
                    const user = userMap[payment.processed_by_user_id] || { name: 'Unknown', role: 'unknown' };
                    allEmployeeActions.push({
                        user_id: payment.processed_by_user_id,
                        user_name: user.name,
                        role: user.role,
                        action_type: 'PAYMENT_PROCESSED',
                        target: `Receipt #${payment.receipt_number}`,
                        details: `Customer: ${capitalizeText(payment.customer_name)}, Amount: ₹${payment.amount_paid.toLocaleString('en-IN')}`,
                        timestamp: new Date(payment.payment_date)
                    });
                }
            });

            // Gate passes issued
            allGatePasses.forEach(gp => {
                if (gp.issued_by_id && gp.request_source !== 'customer_portal') {
                    const user = userMap[gp.issued_by_id] || { name: 'Unknown', role: 'unknown' };
                    allEmployeeActions.push({
                        user_id: gp.issued_by_id,
                        user_name: user.name,
                        role: user.role,
                        action_type: 'GATE_PASS_ISSUED',
                        target: gp.thock_number,
                        details: `Customer: ${capitalizeText(gp.customer_name)}, Qty: ${gp.requested_quantity}`,
                        timestamp: new Date(gp.issued_at)
                    });
                }

                // Gate passes approved
                if (gp.approved_by_id) {
                    const user = userMap[gp.approved_by_id] || { name: 'Unknown', role: 'unknown' };
                    allEmployeeActions.push({
                        user_id: gp.approved_by_id,
                        user_name: user.name,
                        role: user.role,
                        action_type: 'GATE_PASS_APPROVED',
                        target: gp.thock_number,
                        details: `Approved: ${gp.approved_quantity || gp.requested_quantity} items, Status: ${gp.status}`,
                        timestamp: new Date(gp.updated_at || gp.issued_at)
                    });
                }
            });

            // Room edits
            allEditLogs.forEach(log => {
                const user = userMap[log.edited_by_user_id] || { name: log.editor_name || 'Unknown', role: 'unknown' };
                const changes = [];
                if (log.old_room_no !== log.new_room_no) changes.push(`Room: ${log.old_room_no}→${log.new_room_no}`);
                if (log.old_floor !== log.new_floor) changes.push(`Floor: ${log.old_floor}→${log.new_floor}`);
                if (log.old_gate_no !== log.new_gate_no) changes.push(`Gatar: ${log.old_gate_no}→${log.new_gate_no}`);
                if (log.old_quantity !== log.new_quantity) changes.push(`Qty: ${log.old_quantity}→${log.new_quantity}`);
                if (log.old_remark !== log.new_remark) changes.push(`Remark changed`);

                if (changes.length > 0) {
                    allEmployeeActions.push({
                        user_id: log.edited_by_user_id,
                        user_name: capitalizeText(user.name),
                        role: user.role,
                        action_type: 'ROOM_EDITED',
                        target: log.thock_number,
                        details: changes.join(', '),
                        timestamp: new Date(log.edited_at)
                    });
                }
            });

            // Sort by timestamp descending (most recent first)
            allEmployeeActions.sort((a, b) => b.timestamp - a.timestamp);

            // Populate employee filter dropdown
            const employeeFilter = document.getElementById('employeeFilter');
            const uniqueEmployees = [...new Set(allEmployeeActions.map(a => a.user_name))].sort();
            employeeFilter.innerHTML = '<option value="">All Employees</option>' +
                uniqueEmployees.map(name => `<option value="${name}">${name}</option>`).join('');

            displayEmployeeActions();
        }

        function displayEmployeeActions() {
            const tbody = document.getElementById('employeeActionsBody');

            if (allEmployeeActions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-gray-500">No employee actions found</td></tr>';
                return;
            }

            const actionColors = {
                'ENTRY_CREATED': 'bg-green-100 text-green-700',
                'ROOM_ASSIGNED': 'bg-blue-100 text-blue-700',
                'PAYMENT_PROCESSED': 'bg-yellow-100 text-yellow-700',
                'GATE_PASS_ISSUED': 'bg-purple-100 text-purple-700',
                'GATE_PASS_APPROVED': 'bg-orange-100 text-orange-700',
                'ROOM_EDITED': 'bg-pink-100 text-pink-700'
            };

            const roleColors = {
                'admin': 'bg-red-500',
                'employee': 'bg-blue-500',
                'accountant': 'bg-green-500'
            };

            tbody.innerHTML = allEmployeeActions.map(action => {
                const timestamp = action.timestamp.toLocaleString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const actionColor = actionColors[action.action_type] || 'bg-gray-100 text-gray-700';
                const roleColor = roleColors[action.role] || 'bg-gray-500';
                const thockColor = getThockColor(action.target);

                return `
                    <tr class="border-b border-gray-200 hover:bg-blue-50" data-employee="${action.user_name}" data-action="${action.action_type}">
                        <td class="p-2 font-semibold">${action.user_name}</td>
                        <td class="p-2">#${action.user_id}</td>
                        <td class="p-2">
                            <span class="px-2 py-1 rounded text-white text-xs ${roleColor}">
                                ${action.role.toUpperCase()}
                            </span>
                        </td>
                        <td class="p-2">
                            <span class="px-2 py-1 rounded text-xs font-bold ${actionColor}">
                                ${action.action_type.replace(/_/g, ' ')}
                            </span>
                        </td>
                        <td class="p-2 font-bold ${thockColor}">${action.target}</td>
                        <td class="p-2 text-sm">${action.details}</td>
                        <td class="p-2 text-sm">${timestamp}</td>
                    </tr>
                `;
            }).join('');
        }

        function filterEmployeeActions() {
            const employeeFilter = document.getElementById('employeeFilter').value;
            const actionTypeFilter = document.getElementById('actionTypeFilter').value;
            const searchText = document.getElementById('employeeActionSearch').value.toLowerCase();

            const rows = document.querySelectorAll('#employeeActionsBody tr');

            rows.forEach(row => {
                const employee = row.getAttribute('data-employee') || '';
                const actionType = row.getAttribute('data-action') || '';
                const text = row.textContent.toLowerCase();

                const matchesEmployee = !employeeFilter || employee === employeeFilter;
                const matchesAction = !actionTypeFilter || actionType === actionTypeFilter;
                const matchesSearch = !searchText || text.includes(searchText);

                row.style.display = (matchesEmployee && matchesAction && matchesSearch) ? '' : 'none';
            });
        }

        function refreshAllData() {
            loadAllData();
        }
    </script>
</body>
</html>
