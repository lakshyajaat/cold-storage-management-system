name: Deploy to K3s

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.5.40) - leave empty for auto'
        required: false
        type: string

env:
  IMAGE_NAME: lakshyajaat/cold-backend
  K3S_NODES: "192.168.15.110 192.168.15.111 192.168.15.112 192.168.15.113 192.168.15.114"

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION=$(echo "${{ inputs.version }}" | xargs)
          else
            VERSION="v1.5.${{ github.run_number }}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "=== Deploying version: ${VERSION} ==="

      - name: Build and package
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Build Go binary once (not in Docker)
          export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-w -s" -o server ./cmd/server
          echo "✓ Go binary built"

          # Build minimal Docker image (uses pre-built binary)
          DOCKER_BUILDKIT=1 docker build \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            -f Dockerfile.ci \
            -t ${{ env.IMAGE_NAME }}:${VERSION} .
          echo "✓ Docker image built"

          # Save with gzip compression (~60% smaller)
          docker save ${{ env.IMAGE_NAME }}:${VERSION} | gzip > /tmp/cold-backend-${VERSION}.tar.gz
          echo "✓ Image saved ($(du -h /tmp/cold-backend-${VERSION}.tar.gz | cut -f1) compressed)"

      - name: Deploy to all nodes (parallel)
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAR_FILE="/tmp/cold-backend-${VERSION}.tar.gz"

          echo "=== Deploying to all nodes in parallel ==="
          for NODE in ${{ env.K3S_NODES }}; do
            (
              scp -o StrictHostKeyChecking=no -o ConnectTimeout=10 ${TAR_FILE} root@${NODE}:/tmp/ && \
              ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 root@${NODE} \
                "gunzip -c /tmp/cold-backend-${VERSION}.tar.gz | k3s ctr -n k8s.io images import - && rm /tmp/cold-backend-${VERSION}.tar.gz" && \
              echo "✓ Node ${NODE}: done"
            ) &
          done

          # Wait for all parallel jobs
          wait
          echo "=== All nodes updated ==="

      - name: Update Kubernetes deployments
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Update deployments (no wait - rollout happens in background)
          kubectl set image deployment/cold-backend-employee cold-backend=${{ env.IMAGE_NAME }}:${VERSION} -n default
          kubectl set image deployment/cold-backend-customer cold-backend=${{ env.IMAGE_NAME }}:${VERSION} -n default

          echo "=== Rollout started: ${VERSION} (pods updating in background) ==="

      - name: Cleanup
        if: always()
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          rm -f /tmp/cold-backend-${VERSION}.tar.gz server || true

      - name: Verify
        run: |
          sleep 5  # Brief wait for pods to start updating
          kubectl get pods -l app=cold-backend -n default -o custom-columns="POD:.metadata.name,IMAGE:.spec.containers[0].image,READY:.status.containerStatuses[0].ready" --no-headers
