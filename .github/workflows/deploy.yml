name: Deploy to K3s

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.5.40) - leave empty for auto'
        required: false
        type: string

env:
  IMAGE_NAME: lakshyajaat/cold-backend
  K3S_NODES: "192.168.15.110 192.168.15.111 192.168.15.112 192.168.15.113 192.168.15.114"

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION=$(echo "${{ inputs.version }}" | xargs)
          else
            VERSION="v1.5.${{ github.run_number }}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "=== Deploying version: ${VERSION} ==="

      - name: Build and package
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Build Go binary
          export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-w -s" -o server ./cmd/server
          echo "✓ Go binary built"

          # Build Docker image
          DOCKER_BUILDKIT=1 docker build \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            -f Dockerfile.ci \
            -t ${{ env.IMAGE_NAME }}:${VERSION} .
          echo "✓ Docker image built"

          # Save with gzip compression
          docker save ${{ env.IMAGE_NAME }}:${VERSION} | gzip > /tmp/cold-backend-${VERSION}.tar.gz
          echo "✓ Image saved ($(du -h /tmp/cold-backend-${VERSION}.tar.gz | cut -f1) compressed)"

      - name: Deploy to all nodes (parallel)
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAR_FILE="/tmp/cold-backend-${VERSION}.tar.gz"

          echo "=== Deploying to all nodes in parallel ==="
          for NODE in ${{ env.K3S_NODES }}; do
            (
              scp -o StrictHostKeyChecking=no -o ConnectTimeout=10 ${TAR_FILE} root@${NODE}:/tmp/ && \
              ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 root@${NODE} \
                "gunzip -c /tmp/cold-backend-${VERSION}.tar.gz | k3s ctr -n k8s.io images import - && rm /tmp/cold-backend-${VERSION}.tar.gz" && \
              echo "✓ Node ${NODE}: done"
            ) &
          done
          wait
          echo "=== All nodes updated ==="

      - name: Update Kubernetes deployments
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Update deployments
          kubectl set image deployment/cold-backend-employee cold-backend=${{ env.IMAGE_NAME }}:${VERSION} -n default
          kubectl set image deployment/cold-backend-customer cold-backend=${{ env.IMAGE_NAME }}:${VERSION} -n default

          echo "=== Rolling out ${VERSION} ==="

      - name: Wait for rollout
        run: |
          echo "=== Waiting for employee deployment ==="
          kubectl rollout status deployment/cold-backend-employee -n default --timeout=120s || true

          echo "=== Waiting for customer deployment ==="
          kubectl rollout status deployment/cold-backend-customer -n default --timeout=120s || true

      - name: Verify deployment
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "=== Deployment Status ==="
          kubectl get pods -l app=cold-backend -n default -o custom-columns="POD:.metadata.name,IMAGE:.spec.containers[0].image,READY:.status.containerStatuses[0].ready,RESTARTS:.status.containerStatuses[0].restartCount" --no-headers

          # Check if new version pods are running
          RUNNING=$(kubectl get pods -l app=cold-backend -n default -o jsonpath='{.items[*].spec.containers[0].image}' | grep -c "${VERSION}" || echo "0")
          echo ""
          echo "=== ${VERSION} pods running: ${RUNNING} ==="

      - name: Cleanup
        if: always()
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          rm -f /tmp/cold-backend-${VERSION}.tar.gz server || true
